<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Craft Club | Your Creative Space</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --terracotta: #A0695F;
            --dark-brown: #3C2F2F;
            --cream: #F5F1E8;
            --light-beige: #EDE8DC;
            --text-dark: #3C2F2F;
            --text-muted: #8B7E74;
            --gold: #D4AF37;
            --success: #5C8B5A;
            --highlight: #E8C5B5;
            --love: #E74C3C;
        }

        body {
            font-family: 'Georgia', serif;
            color: var(--text-dark);
            line-height: 1.6;
            background: var(--cream);
        }

        header {
            position: fixed;
            top: 0;
            width: 100%;
            z-index: 1000;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            padding: 1rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid rgba(0,0,0,0.05);
        }

        .logo {
            font-size: 1.125rem;
            font-weight: 400;
            letter-spacing: 0.02em;
            color: var(--dark-brown);
        }

        .user-nav {
            display: flex;
            align-items: center;
            gap: 1.5rem;
        }

        .icon-btn {
            position: relative;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: var(--cream);
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.25rem;
            transition: all 0.3s;
        }

        .icon-btn:hover {
            background: var(--highlight);
            transform: scale(1.1);
        }

        .badge-count {
            position: absolute;
            top: -5px;
            right: -5px;
            background: var(--love);
            color: white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            font-size: 0.7rem;
            display: flex;
            align-items: center;
            justify-content: center;
            font-family: -apple-system, sans-serif;
            font-weight: bold;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }

        .avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: var(--terracotta);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            cursor: pointer;
        }

        .avatar img {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            object-fit: cover;
        }

        .user-profile {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            cursor: pointer;
            position: relative;
        }

        .dropdown {
            position: absolute;
            top: 100%;
            right: 0;
            margin-top: 0.5rem;
            background: white;
            border-radius: 12px;
            box-shadow: 0 8px 24px rgba(0,0,0,0.15);
            min-width: 320px;
            max-width: 400px;
            max-height: 500px;
            overflow-y: auto;
            display: none;
            z-index: 1001;
        }

        .dropdown.show { display: block; }

        .dropdown-header {
            padding: 1.25rem;
            border-bottom: 2px solid var(--light-beige);
            font-family: -apple-system, sans-serif;
            font-weight: 600;
            font-size: 1.1rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .dropdown-item {
            padding: 1rem 1.25rem;
            border-bottom: 1px solid var(--light-beige);
            cursor: pointer;
            transition: background 0.3s;
            font-family: -apple-system, sans-serif;
        }

        .dropdown-item:hover {
            background: var(--cream);
        }

        .dropdown-item:last-child {
            border-bottom: none;
        }

        .notif-content {
            font-size: 0.9rem;
            margin-bottom: 0.25rem;
        }

        .notif-time {
            font-size: 0.75rem;
            color: var(--text-muted);
        }

        .notif-unread {
            background: #E8F5E9;
        }

        .main-container {
            margin-top: 80px;
            display: flex;
            min-height: calc(100vh - 80px);
        }

        .sidebar {
            width: 280px;
            background: white;
            padding: 2rem 1.5rem;
            border-right: 1px solid rgba(0,0,0,0.05);
            position: fixed;
            height: calc(100vh - 80px);
            overflow-y: auto;
        }

        .nav-item {
            padding: 0.75rem 1rem;
            color: var(--text-dark);
            text-decoration: none;
            border-radius: 8px;
            transition: all 0.3s;
            font-family: -apple-system, sans-serif;
            font-size: 0.95rem;
            display: flex;
            align-items: center;
            gap: 0.75rem;
            cursor: pointer;
            margin-bottom: 0.5rem;
        }

        .nav-item:hover, .nav-item.active {
            background: var(--light-beige);
            color: var(--terracotta);
        }

        .content {
            margin-left: 280px;
            flex: 1;
            padding: 2rem 3rem;
        }

        .content-section {
            display: none;
        }

        .content-section.active {
            display: block;
        }

        .card {
            background: white;
            padding: 2rem;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
            margin-bottom: 2rem;
        }

        .card h3 {
            margin-bottom: 1.5rem;
            color: var(--dark-brown);
            font-size: 1.25rem;
        }

        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 2rem;
            margin-bottom: 2rem;
        }

        .quick-stats {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 1rem;
        }

        .stat-box {
            text-align: center;
            padding: 1.5rem 1rem;
            background: var(--cream);
            border-radius: 8px;
            transition: transform 0.3s;
        }

        .stat-box:hover {
            transform: translateY(-4px);
        }

        .stat-icon {
            font-size: 2rem;
            margin-bottom: 0.5rem;
        }

        .stat-value {
            font-size: 1.75rem;
            font-weight: bold;
            color: var(--terracotta);
        }

        .stat-label {
            font-size: 0.85rem;
            color: var(--text-muted);
            font-family: -apple-system, sans-serif;
        }

        .project-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 1.5rem;
        }

        .project-card {
            background: white;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
            cursor: pointer;
            transition: all 0.3s;
            position: relative;
        }

        .project-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 6px 20px rgba(0,0,0,0.1);
        }

        .project-image {
            width: 100%;
            height: 200px;
            background: linear-gradient(135deg, var(--light-beige), var(--highlight));
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 3rem;
            position: relative;
        }

        .like-btn {
            position: absolute;
            bottom: 10px;
            right: 10px;
            width: 48px;
            height: 48px;
            border-radius: 50%;
            background: white;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            transition: all 0.3s;
            z-index: 10;
        }

        .like-btn:hover {
            transform: scale(1.1);
        }

        .like-btn.liked {
            animation: heartBeat 0.5s;
        }

        @keyframes heartBeat {
            0%, 100% { transform: scale(1); }
            25% { transform: scale(1.3); }
            50% { transform: scale(1.1); }
        }

        .follow-btn-small {
            position: absolute;
            top: 10px;
            right: 10px;
            padding: 0.4rem 0.8rem;
            background: white;
            border: 1px solid var(--terracotta);
            color: var(--terracotta);
            border-radius: 20px;
            font-size: 0.8rem;
            cursor: pointer;
            font-family: -apple-system, sans-serif;
            z-index: 10;
            transition: all 0.3s;
        }

        .follow-btn-small:hover {
            background: var(--terracotta);
            color: white;
        }

        .follow-btn-small.following {
            background: var(--terracotta);
            color: white;
        }

        .project-info {
            padding: 1.25rem;
        }

        .project-title {
            font-size: 1.1rem;
            margin-bottom: 0.5rem;
            color: var(--dark-brown);
        }

        .project-meta {
            display: flex;
            gap: 1rem;
            font-size: 0.85rem;
            color: var(--text-muted);
            font-family: -apple-system, sans-serif;
        }

        .user-mini {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 0.75rem;
        }

        .user-mini-avatar {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            background: var(--terracotta);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.7rem;
            font-weight: bold;
        }

        .user-mini-avatar img {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            object-fit: cover;
        }

        .feed-item {
            background: white;
            padding: 1.5rem;
            border-radius: 12px;
            margin-bottom: 1rem;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }

        .feed-header {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .feed-avatar {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            background: var(--terracotta);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            cursor: pointer;
        }

        .feed-avatar img {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            object-fit: cover;
        }

        .feed-content {
            font-family: -apple-system, sans-serif;
            line-height: 1.6;
        }

        .feed-time {
            font-size: 0.8rem;
            color: var(--text-muted);
            margin-top: 0.5rem;
        }

        .mention {
            color: var(--terracotta);
            font-weight: 600;
            cursor: pointer;
        }

        .mention:hover {
            text-decoration: underline;
        }

        .btn {
            padding: 0.75rem 2rem;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-family: -apple-system, sans-serif;
            font-size: 0.95rem;
            transition: all 0.3s;
            display: inline-block;
            text-align: center;
        }

        .btn-primary {
            background: var(--terracotta);
            color: white;
        }

        .btn-primary:hover {
            background: var(--dark-brown);
            transform: translateY(-2px);
        }

        .btn-secondary {
            background: var(--light-beige);
            color: var(--dark-brown);
        }

        .btn-danger {
            background: #C75B5B;
            color: white;
        }

        .btn-small {
            padding: 0.5rem 1rem;
            font-size: 0.85rem;
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        label {
            display: block;
            font-family: -apple-system, sans-serif;
            font-size: 0.9rem;
            color: var(--dark-brown);
            margin-bottom: 0.5rem;
            font-weight: 500;
        }

        input, textarea, select {
            width: 100%;
            padding: 0.875rem 1rem;
            border: 2px solid var(--light-beige);
            border-radius: 8px;
            font-family: -apple-system, sans-serif;
            font-size: 1rem;
            transition: all 0.3s;
        }

        input:focus, textarea:focus, select:focus {
            outline: none;
            border-color: var(--terracotta);
        }

        textarea {
            min-height: 120px;
            resize: vertical;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 2000;
            justify-content: center;
            align-items: center;
            padding: 2rem;
            overflow-y: auto;
        }

        .modal.show { display: flex; }

        .modal-content {
            background: white;
            border-radius: 16px;
            max-width: 700px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            padding: 2rem;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
            padding-bottom: 1rem;
            border-bottom: 2px solid var(--light-beige);
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 2rem;
            cursor: pointer;
            color: var(--text-muted);
        }

        .profile-picture-upload {
            text-align: center;
            margin-bottom: 2rem;
        }

        .profile-picture-preview {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            margin: 0 auto 1rem;
            background: var(--terracotta);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 3rem;
            font-weight: bold;
            overflow: hidden;
        }

        .profile-picture-preview img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .craft-specific-fields {
            display: none;
        }

        .empty-state {
            text-align: center;
            padding: 3rem 2rem;
            color: var(--text-muted);
        }

        .empty-state-icon {
            font-size: 4rem;
            margin-bottom: 1rem;
            opacity: 0.5;
        }

        .loading {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 3rem;
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid var(--light-beige);
            border-top-color: var(--terracotta);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Floating Chat Widget */
        .chat-widget {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 380px;
            max-height: 600px;
            background: white;
            border-radius: 16px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.15);
            display: none;
            flex-direction: column;
            z-index: 2001;
            overflow: hidden;
        }

        .chat-widget.show {
            display: flex;
        }

        .chat-widget-header {
            background: var(--terracotta);
            color: white;
            padding: 1rem 1.25rem;
            display: flex;
            align-items: center;
            gap: 0.75rem;
            cursor: move;
        }

        .chat-widget-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: white;
            color: var(--terracotta);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            overflow: hidden;
        }

        .chat-widget-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .chat-widget-info {
            flex: 1;
        }

        .chat-widget-name {
            font-weight: 600;
            font-size: 1rem;
        }

        .chat-widget-status {
            font-size: 0.75rem;
            opacity: 0.9;
        }

        .chat-widget-close {
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            font-size: 1.25rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
        }

        .chat-widget-close:hover {
            background: rgba(255,255,255,0.3);
        }

        .chat-widget-messages {
            flex: 1;
            overflow-y: auto;
            padding: 1rem;
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
            background: var(--cream);
            max-height: 400px;
        }

        .chat-widget-input-area {
            padding: 1rem;
            border-top: 2px solid var(--light-beige);
            background: white;
        }

        .chat-widget-input-form {
            display: flex;
            gap: 0.5rem;
        }

        .chat-widget-input {
            flex: 1;
            padding: 0.75rem 1rem;
            border: 2px solid var(--light-beige);
            border-radius: 24px;
            font-family: -apple-system, sans-serif;
            font-size: 0.9rem;
        }

        .chat-widget-send {
            width: 44px;
            height: 44px;
            border-radius: 50%;
            background: var(--terracotta);
            border: none;
            color: white;
            font-size: 1.25rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
        }

        .chat-widget-send:hover {
            background: var(--dark-brown);
            transform: scale(1.05);
        }

        .chat-bubble {
            max-width: 70%;
            padding: 0.75rem 1rem;
            border-radius: 16px;
            word-wrap: break-word;
            animation: slideIn 0.3s ease;
        }

        .chat-bubble-sent {
            align-self: flex-end;
            background: var(--terracotta);
            color: white;
            border-bottom-right-radius: 4px;
        }

        .chat-bubble-received {
            align-self: flex-start;
            background: white;
            color: var(--text-dark);
            border-bottom-left-radius: 4px;
        }

        .chat-bubble-time {
            font-size: 0.7rem;
            margin-top: 0.25rem;
            opacity: 0.7;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @media (max-width: 768px) {
            .sidebar {
                position: static;
                width: 100%;
                height: auto;
            }

            .content {
                margin-left: 0;
                padding: 1.5rem;
            }

            .dashboard-grid, .project-grid {
                grid-template-columns: 1fr;
            }

            .chat-widget {
                width: calc(100vw - 20px);
                right: 10px;
                bottom: 10px;
                max-height: 500px;
            }
        }
    </style>
</head>
<body>
    <header>
        <a href="index.html" style="text-decoration: none;">
            <div class="logo">üé® Craft Club</div>
        </a>
        <div class="user-nav">
            <button class="icon-btn" onclick="toggleNotifications()">
                üîî
                <span class="badge-count" id="notif-count" style="display: none;">0</span>
            </button>
            <button class="icon-btn" onclick="toggleMessages()">
                üí¨
                <span class="badge-count" id="message-count" style="display: none;">0</span>
            </button>
            <div class="user-profile" onclick="toggleUserMenu()">
                <div class="avatar" id="header-avatar">...</div>
            </div>

            <div class="dropdown" id="notifications-dropdown">
                <div class="dropdown-header">
                    Notifications
                    <button onclick="markAllRead()" style="background: none; border: none; color: var(--terracotta); cursor: pointer; font-size: 0.85rem;">Mark all read</button>
                </div>
                <div id="notifications-list">
                    <div class="loading"><div class="spinner"></div></div>
                </div>
            </div>

            <div class="dropdown" id="messages-dropdown">
                <div class="dropdown-header">Messages</div>
                <div id="conversations-list">
                    <div class="loading"><div class="spinner"></div></div>
                </div>
            </div>

            <div class="dropdown" id="user-menu" style="min-width: 200px;">
                <div class="dropdown-item" onclick="showSection('dashboard'); hideAllDropdowns();">üë§ Dashboard</div>
                <div class="dropdown-item" onclick="showEditProfile()">‚úèÔ∏è Edit Profile</div>
                <div class="dropdown-item" onclick="showSettings()">‚öôÔ∏è Settings</div>
                <div class="dropdown-item" onclick="handleLogout()">üö™ Logout</div>
            </div>
        </div>
    </header>

    <div class="main-container">
        <aside class="sidebar">
            <nav>
                <a class="nav-item active" onclick="showSection('dashboard')">üè† Dashboard</a>
                <a class="nav-item" onclick="showSection('my-projects')">üé® My Projects</a>
                <a class="nav-item" onclick="showSection('community')">üåä Community Feed</a>
                <a class="nav-item" onclick="showSection('friends')">üí´ Friends</a>
                <a class="nav-item" onclick="showSection('members')">üîç Find Makers</a>
                <a class="nav-item" onclick="showSection('chat')">üí¨ Messages</a>
            </nav>
        </aside>

        <main class="content">
            <section id="dashboard" class="content-section active">
                <h1 style="margin-bottom: 2rem;" id="welcome-text">Welcome! üëã</h1>

                <div class="dashboard-grid">
                    <div class="card">
                        <h3>üìä Your Stats</h3>
                        <div class="quick-stats">
                            <div class="stat-box">
                                <div class="stat-icon">üé®</div>
                                <div class="stat-value" id="stat-projects">0</div>
                                <div class="stat-label">Projects</div>
                            </div>
                            <div class="stat-box">
                                <div class="stat-icon">‚ù§Ô∏è</div>
                                <div class="stat-value" id="stat-likes">0</div>
                                <div class="stat-label">Total Likes</div>
                            </div>
                            <div class="stat-box">
                                <div class="stat-icon">üë•</div>
                                <div class="stat-value" id="stat-friends">0</div>
                                <div class="stat-label">Friends</div>
                            </div>
                            <div class="stat-box">
                                <div class="stat-icon">üî•</div>
                                <div class="stat-value" id="stat-streak">0</div>
                                <div class="stat-label">Day Streak</div>
                            </div>
                        </div>
                    </div>
                </div>

                <button class="btn btn-primary" onclick="showAddProject()">+ Add New Project</button>
            </section>

            <section id="my-projects" class="content-section">
                <div style="display: flex; justify-content: space-between; margin-bottom: 2rem;">
                    <h1>üé® My Projects</h1>
                    <button class="btn btn-primary" onclick="showAddProject()">+ New Project</button>
                </div>
                <div id="my-projects-container"><div class="loading"><div class="spinner"></div></div></div>
            </section>

            <section id="community" class="content-section">
                <h1 style="margin-bottom: 2rem;">üåä Community Feed</h1>
                <div id="community-feed"><div class="loading"><div class="spinner"></div></div></div>
            </section>

            <section id="friends" class="content-section">
                <h1 style="margin-bottom: 2rem;">üí´ Your Friends</h1>
                <div id="friends-container"><div class="loading"><div class="spinner"></div></div></div>
            </section>

            <section id="members" class="content-section">
                <h1 style="margin-bottom: 2rem;">üîç Find Makers</h1>
                <input type="text" id="member-search" placeholder="Search by name or username..." style="margin-bottom: 2rem;" oninput="searchMembers()">
                <div id="members-container"><div class="loading"><div class="spinner"></div></div></div>
            </section>

            <section id="chat" class="content-section">
                <h1 style="margin-bottom: 2rem;">üí¨ Messages</h1>
                <div id="chat-area"></div>
            </section>
        </main>
    </div>

    <!-- Edit Profile Modal -->
    <div class="modal" id="edit-profile-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Edit Profile</h2>
                <button class="modal-close" onclick="closeEditProfile()">&times;</button>
            </div>
            <form onsubmit="handleUpdateProfile(event)">
                <div class="profile-picture-upload">
                    <div class="profile-picture-preview" id="profile-pic-preview">
                        <span id="profile-pic-initials">...</span>
                    </div>
                    <input type="file" id="profile-picture-input" accept="image/*" style="display: none;" onchange="handleProfilePictureChange(event)">
                    <button type="button" class="btn btn-secondary btn-small" onclick="document.getElementById('profile-picture-input').click()">
                        Change Picture
                    </button>
                </div>
                <div class="form-group">
                    <label>Username</label>
                    <input type="text" id="edit-username" readonly style="background: #f5f5f5;">
                    <small style="color: var(--text-muted); font-size: 0.8rem;">Username cannot be changed</small>
                </div>
                <div class="form-group">
                    <label>Full Name</label>
                    <input type="text" id="edit-fullname">
                </div>
                <div class="form-group">
                    <label>Bio</label>
                    <textarea id="edit-bio" placeholder="Tell us about yourself..."></textarea>
                </div>
                <div class="form-group">
                    <label>Location</label>
                    <input type="text" id="edit-location" placeholder="City, Country">
                </div>
                <div class="form-group">
                    <label>Interests (comma separated)</label>
                    <input type="text" id="edit-interests" placeholder="Sewing, Knitting, Crochet">
                </div>
                <button type="submit" class="btn btn-primary" style="width: 100%;">Save Changes</button>
            </form>
        </div>
    </div>

    <!-- Settings Modal -->
    <div class="modal" id="settings-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>‚öôÔ∏è Settings</h2>
                <button class="modal-close" onclick="closeSettings()">&times;</button>
            </div>
            <form onsubmit="handleUpdateSettings(event)">
                <div class="form-group">
                    <label>Measurement System</label>
                    <select id="setting-measurement">
                        <option value="metric">Metric (cm, m, kg)</option>
                        <option value="imperial">Imperial (inches, yards, lbs)</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Weight Unit</label>
                    <select id="setting-weight">
                        <option value="kg">Kilograms (kg)</option>
                        <option value="lbs">Pounds (lbs)</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Length Unit</label>
                    <select id="setting-length">
                        <option value="cm">Centimeters (cm)</option>
                        <option value="m">Meters (m)</option>
                        <option value="inches">Inches</option>
                        <option value="yards">Yards</option>
                    </select>
                </div>
                <button type="submit" class="btn btn-primary" style="width: 100%;">Save Settings</button>
            </form>
        </div>
    </div>

    <!-- Profile View Modal -->
    <div class="modal" id="profile-view-modal">
        <div class="modal-content" style="max-width: 800px;">
            <div class="modal-header">
                <h2>Profile</h2>
                <button class="modal-close" onclick="closeProfileView()">&times;</button>
            </div>
            <div id="profile-view-content"></div>
        </div>
    </div>

    <!-- Add Project Modal -->
    <div class="modal" id="add-project-modal">
        <div class="modal-content" style="max-width: 700px;">
            <div class="modal-header">
                <h2>Add New Project</h2>
                <button class="modal-close" onclick="closeAddProject()">&times;</button>
            </div>
            <form onsubmit="handleAddProject(event)">
                <div class="form-group">
                    <label>Title *</label>
                    <input type="text" id="project-title" required>
                </div>
                <div class="form-group">
                    <label>Description</label>
                    <textarea id="project-description"></textarea>
                </div>
                <div class="form-group">
                    <label>Craft Type *</label>
                    <select id="project-craft-type" required onchange="showCraftFields()">
                        <option value="">Select...</option>
                        <option value="Sewing">Sewing</option>
                        <option value="Knitting">Knitting</option>
                        <option value="Crochet">Crochet</option>
                        <option value="Embroidery">Embroidery</option>
                        <option value="Weaving">Weaving</option>
                        <option value="Quilting">Quilting</option>
                        <option value="Leather Work">Leather Work</option>
                        <option value="Other">Other</option>
                    </select>
                </div>

                <!-- Crochet Fields -->
                <div id="crochet-fields" class="craft-specific-fields">
                    <h3 style="margin: 1.5rem 0 1rem; color: var(--terracotta); font-size: 1.1rem;">üß∂ Crochet Details</h3>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                        <div class="form-group">
                            <label>Hook Size</label>
                            <input type="text" id="crochet-hook-size" placeholder="e.g., 5mm, H/8">
                        </div>
                        <div class="form-group">
                            <label>Yarn Weight</label>
                            <input type="text" id="crochet-yarn-weight" placeholder="e.g., Worsted (4)">
                        </div>
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                        <div class="form-group">
                            <label>Yarn Brand</label>
                            <input type="text" id="crochet-yarn-brand" placeholder="e.g., Lion Brand">
                        </div>
                        <div class="form-group">
                            <label>Yarn Color</label>
                            <input type="text" id="crochet-yarn-color" placeholder="e.g., Terracotta">
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Yardage Needed</label>
                        <input type="text" id="crochet-yardage" placeholder="e.g., 300 yards">
                    </div>
                    <div class="form-group">
                        <label>Gauge</label>
                        <input type="text" id="crochet-gauge" placeholder="e.g., 16 sts x 20 rows = 4 inches">
                    </div>
                    <div class="form-group">
                        <label>üîó Where to Buy Yarn</label>
                        <input type="url" id="crochet-yarn-link" placeholder="https://...">
                    </div>
                    <div class="form-group">
                        <label>üîó Pattern Link (Optional)</label>
                        <input type="url" id="crochet-pattern-link" placeholder="https://...">
                    </div>
                </div>

                <!-- Knitting Fields -->
                <div id="knitting-fields" class="craft-specific-fields">
                    <h3 style="margin: 1.5rem 0 1rem; color: var(--terracotta); font-size: 1.1rem;">üß∂ Knitting Details</h3>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                        <div class="form-group">
                            <label>Needle Size</label>
                            <input type="text" id="knitting-needle-size" placeholder="e.g., US 8, 5mm">
                        </div>
                        <div class="form-group">
                            <label>Needle Type</label>
                            <input type="text" id="knitting-needle-type" placeholder="e.g., Circular, DPN">
                        </div>
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                        <div class="form-group">
                            <label>Yarn Weight</label>
                            <input type="text" id="knitting-yarn-weight" placeholder="e.g., DK (3)">
                        </div>
                        <div class="form-group">
                            <label>Yarn Brand</label>
                            <input type="text" id="knitting-yarn-brand" placeholder="e.g., Malabrigo">
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Yardage Needed</label>
                        <input type="text" id="knitting-yardage" placeholder="e.g., 400 yards">
                    </div>
                    <div class="form-group">
                        <label>üîó Where to Buy Yarn</label>
                        <input type="url" id="knitting-yarn-link" placeholder="https://...">
                    </div>
                </div>

                <!-- Sewing Fields -->
                <div id="sewing-fields" class="craft-specific-fields">
                    <h3 style="margin: 1.5rem 0 1rem; color: var(--terracotta); font-size: 1.1rem;">üßµ Sewing Details</h3>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                        <div class="form-group">
                            <label>Needle Type</label>
                            <input type="text" id="sewing-needle-type" placeholder="e.g., Universal 80/12">
                        </div>
                        <div class="form-group">
                            <label>Fabric Type</label>
                            <input type="text" id="sewing-fabric-type" placeholder="e.g., Cotton, Linen">
                        </div>
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                        <div class="form-group">
                            <label>Fabric Amount</label>
                            <input type="text" id="sewing-fabric-amount" placeholder="e.g., 2 yards">
                        </div>
                        <div class="form-group">
                            <label>Fabric Brand</label>
                            <input type="text" id="sewing-fabric-brand" placeholder="e.g., Riley Blake">
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Notions Needed</label>
                        <input type="text" id="sewing-notions" placeholder="e.g., Buttons, zipper, interfacing">
                    </div>
                    <div class="form-group">
                        <label>Pattern Size</label>
                        <input type="text" id="sewing-pattern-size" placeholder="e.g., Medium, 10">
                    </div>
                    <div class="form-group">
                        <label>üîó Where to Buy Fabric</label>
                        <input type="url" id="sewing-fabric-link" placeholder="https://...">
                    </div>
                    <div class="form-group">
                        <label>üîó Pattern Link (Optional)</label>
                        <input type="url" id="sewing-pattern-link" placeholder="https://...">
                    </div>
                </div>

                <!-- Embroidery Fields -->
                <div id="embroidery-fields" class="craft-specific-fields">
                    <h3 style="margin: 1.5rem 0 1rem; color: var(--terracotta); font-size: 1.1rem;">ü™° Embroidery Details</h3>
                    <div class="form-group">
                        <label>Thread Type</label>
                        <input type="text" id="embroidery-thread-type" placeholder="e.g., DMC Floss">
                    </div>
                    <div class="form-group">
                        <label>Thread Colors</label>
                        <input type="text" id="embroidery-thread-colors" placeholder="e.g., 310, 666, 972">
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                        <div class="form-group">
                            <label>Fabric Type</label>
                            <input type="text" id="embroidery-fabric-type" placeholder="e.g., Aida 14 count">
                        </div>
                        <div class="form-group">
                            <label>Hoop Size</label>
                            <input type="text" id="embroidery-hoop-size" placeholder="e.g., 6 inches">
                        </div>
                    </div>
                    <div class="form-group">
                        <label>üîó Supplies Link</label>
                        <input type="url" id="embroidery-supplies-link" placeholder="https://...">
                    </div>
                </div>

                <!-- Weaving Fields -->
                <div id="weaving-fields" class="craft-specific-fields">
                    <h3 style="margin: 1.5rem 0 1rem; color: var(--terracotta); font-size: 1.1rem;">üßµ Weaving Details</h3>
                    <div class="form-group">
                        <label>Loom Type</label>
                        <input type="text" id="weaving-loom-type" placeholder="e.g., Rigid heddle">
                    </div>
                    <div class="form-group">
                        <label>Yarn/Fiber Type</label>
                        <input type="text" id="weaving-yarn-type" placeholder="e.g., Cotton warp, wool weft">
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 1rem;">
                        <div class="form-group">
                            <label>Reed Size</label>
                            <input type="text" id="weaving-reed-size" placeholder="e.g., 12 dent">
                        </div>
                        <div class="form-group">
                            <label>Width</label>
                            <input type="text" id="weaving-width" placeholder="e.g., 10 inches">
                        </div>
                        <div class="form-group">
                            <label>Length</label>
                            <input type="text" id="weaving-length" placeholder="e.g., 2 yards">
                        </div>
                    </div>
                    <div class="form-group">
                        <label>üîó Supplies Link</label>
                        <input type="url" id="weaving-supplies-link" placeholder="https://...">
                    </div>
                </div>

                <!-- Quilting Fields -->
                <div id="quilting-fields" class="craft-specific-fields">
                    <h3 style="margin: 1.5rem 0 1rem; color: var(--terracotta); font-size: 1.1rem;">üßµ Quilting Details</h3>
                    <div class="form-group">
                        <label>Quilt Size</label>
                        <input type="text" id="quilting-quilt-size" placeholder="e.g., Throw (60x72)">
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                        <div class="form-group">
                            <label>Fabric Collection</label>
                            <input type="text" id="quilting-fabric-collection" placeholder="e.g., Modern Solids">
                        </div>
                        <div class="form-group">
                            <label>Batting Type</label>
                            <input type="text" id="quilting-batting-type" placeholder="e.g., Cotton 80/20">
                        </div>
                    </div>
                    <div class="form-group">
                        <label>üîó Fabric Link</label>
                        <input type="url" id="quilting-fabric-link" placeholder="https://...">
                    </div>
                </div>

                <!-- Leather Work Fields -->
                <div id="leather-fields" class="craft-specific-fields">
                    <h3 style="margin: 1.5rem 0 1rem; color: var(--terracotta); font-size: 1.1rem;">üëú Leather Work Details</h3>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                        <div class="form-group">
                            <label>Leather Type</label>
                            <input type="text" id="leather-leather-type" placeholder="e.g., Vegetable tanned">
                        </div>
                        <div class="form-group">
                            <label>Leather Weight</label>
                            <input type="text" id="leather-leather-weight" placeholder="e.g., 5-6 oz">
                        </div>
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                        <div class="form-group">
                            <label>Thread Type</label>
                            <input type="text" id="leather-thread-type" placeholder="e.g., Waxed polyester">
                        </div>
                        <div class="form-group">
                            <label>Needle Size</label>
                            <input type="text" id="leather-needle-size" placeholder="e.g., Size 2">
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Hardware</label>
                        <input type="text" id="leather-hardware" placeholder="e.g., Brass rivets, D-rings">
                    </div>
                    <div class="form-group">
                        <label>üîó Supplies Link</label>
                        <input type="url" id="leather-supplies-link" placeholder="https://...">
                    </div>
                </div>

                <button type="submit" class="btn btn-primary" style="width: 100%; margin-top: 1.5rem;">Create Project</button>
            </form>
        </div>
    </div>

    <!-- Edit Project Modal -->
    <div class="modal" id="edit-project-modal">
        <div class="modal-content" style="max-width: 700px; max-height: 90vh; overflow-y: auto;">
            <div class="modal-header">
                <h2>Edit Project</h2>
                <button class="modal-close" onclick="closeEditProject()">&times;</button>
            </div>
            <form onsubmit="handleUpdateProject(event)">
                <input type="hidden" id="edit-project-id">
                <input type="hidden" id="edit-project-craft-type">
                
                <div class="form-group">
                    <label>Title *</label>
                    <input type="text" id="edit-project-title" required>
                </div>
                
                <div class="form-group">
                    <label>Description</label>
                    <textarea id="edit-project-description"></textarea>
                </div>
                
                <div class="form-group">
                    <label>Status</label>
                    <select id="edit-project-status">
                        <option value="planning">Planning</option>
                        <option value="in_progress">In Progress</option>
                        <option value="completed">Completed</option>
                        <option value="on_hold">On Hold</option>
                    </select>
                </div>

                <!-- Crochet Fields -->
                <div id="edit-crochet-fields" class="craft-fields" style="display: none;">
                    <h4 style="margin: 1.5rem 0 1rem; color: var(--terracotta);">üß∂ Crochet Details</h4>
                    <div class="form-group">
                        <label>ü™ù Hook Size</label>
                        <input type="text" id="edit-crochet-hook" placeholder="e.g., 5mm, H/8">
                    </div>
                    <div class="form-group">
                        <label>üßµ Yarn Brand</label>
                        <input type="text" id="edit-crochet-yarn-brand">
                    </div>
                    <div class="form-group">
                        <label>üé® Yarn Color</label>
                        <input type="text" id="edit-crochet-yarn-color">
                    </div>
                    <div class="form-group">
                        <label>‚öñÔ∏è Yarn Weight</label>
                        <select id="edit-crochet-yarn-weight">
                            <option value="">Select weight</option>
                            <option value="Lace">Lace</option>
                            <option value="Fingering">Fingering</option>
                            <option value="Sport">Sport</option>
                            <option value="DK">DK</option>
                            <option value="Worsted">Worsted</option>
                            <option value="Bulky">Bulky</option>
                            <option value="Super Bulky">Super Bulky</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>üìè Gauge</label>
                        <input type="text" id="edit-crochet-gauge" placeholder="e.g., 16 sts x 20 rows = 4 inches">
                    </div>
                    <div class="form-group">
                        <label>üìê Yardage Used</label>
                        <input type="text" id="edit-crochet-yardage" placeholder="e.g., 400 yards">
                    </div>
                    <div class="form-group">
                        <label>üîó Pattern Link</label>
                        <input type="url" id="edit-crochet-pattern-link" placeholder="https://...">
                    </div>
                    <div class="form-group">
                        <label>üîó Supplies Link</label>
                        <input type="url" id="edit-crochet-supplies-link" placeholder="https://...">
                    </div>
                </div>

                <!-- Knitting Fields -->
                <div id="edit-knitting-fields" class="craft-fields" style="display: none;">
                    <h4 style="margin: 1.5rem 0 1rem; color: var(--terracotta);">üß∂ Knitting Details</h4>
                    <div class="form-group">
                        <label>ü™° Needle Type</label>
                        <select id="edit-knitting-needle-type">
                            <option value="">Select type</option>
                            <option value="Straight">Straight</option>
                            <option value="Circular">Circular</option>
                            <option value="DPN">Double Pointed (DPN)</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>üìè Needle Size</label>
                        <input type="text" id="edit-knitting-needle-size" placeholder="e.g., US 8, 5mm">
                    </div>
                    <div class="form-group">
                        <label>üßµ Yarn Brand</label>
                        <input type="text" id="edit-knitting-yarn-brand">
                    </div>
                    <div class="form-group">
                        <label>üé® Yarn Color</label>
                        <input type="text" id="edit-knitting-yarn-color">
                    </div>
                    <div class="form-group">
                        <label>‚öñÔ∏è Yarn Weight</label>
                        <select id="edit-knitting-yarn-weight">
                            <option value="">Select weight</option>
                            <option value="Lace">Lace</option>
                            <option value="Fingering">Fingering</option>
                            <option value="Sport">Sport</option>
                            <option value="DK">DK</option>
                            <option value="Worsted">Worsted</option>
                            <option value="Bulky">Bulky</option>
                            <option value="Super Bulky">Super Bulky</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>üìê Yardage Used</label>
                        <input type="text" id="edit-knitting-yardage">
                    </div>
                    <div class="form-group">
                        <label>üîó Pattern Link</label>
                        <input type="url" id="edit-knitting-pattern-link" placeholder="https://...">
                    </div>
                    <div class="form-group">
                        <label>üîó Supplies Link</label>
                        <input type="url" id="edit-knitting-supplies-link" placeholder="https://...">
                    </div>
                </div>

                <!-- Sewing Fields -->
                <div id="edit-sewing-fields" class="craft-fields" style="display: none;">
                    <h4 style="margin: 1.5rem 0 1rem; color: var(--terracotta);">ü™° Sewing Details</h4>
                    <div class="form-group">
                        <label>üßµ Fabric Type</label>
                        <input type="text" id="edit-sewing-fabric-type" placeholder="e.g., Cotton, Linen">
                    </div>
                    <div class="form-group">
                        <label>üìè Fabric Amount</label>
                        <input type="text" id="edit-sewing-fabric-amount" placeholder="e.g., 2 yards">
                    </div>
                    <div class="form-group">
                        <label>üè∑Ô∏è Fabric Brand</label>
                        <input type="text" id="edit-sewing-fabric-brand">
                    </div>
                    <div class="form-group">
                        <label>ü™° Needle Type/Size</label>
                        <input type="text" id="edit-sewing-needle-info" placeholder="e.g., Universal 80/12">
                    </div>
                    <div class="form-group">
                        <label>‚úÇÔ∏è Notions Used</label>
                        <input type="text" id="edit-sewing-notions" placeholder="e.g., Zipper, buttons">
                    </div>
                    <div class="form-group">
                        <label>üîó Pattern Link</label>
                        <input type="url" id="edit-sewing-pattern-link" placeholder="https://...">
                    </div>
                    <div class="form-group">
                        <label>üîó Supplies Link</label>
                        <input type="url" id="edit-sewing-supplies-link" placeholder="https://...">
                    </div>
                </div>

                <!-- Embroidery Fields -->
                <div id="edit-embroidery-fields" class="craft-fields" style="display: none;">
                    <h4 style="margin: 1.5rem 0 1rem; color: var(--terracotta);">ü™° Embroidery Details</h4>
                    <div class="form-group">
                        <label>üßµ Thread Brand</label>
                        <input type="text" id="edit-embroidery-thread-brand" placeholder="e.g., DMC">
                    </div>
                    <div class="form-group">
                        <label>üé® Thread Colors</label>
                        <input type="text" id="edit-embroidery-colors" placeholder="e.g., 310, 498, 666">
                    </div>
                    <div class="form-group">
                        <label>üßµ Fabric Type</label>
                        <input type="text" id="edit-embroidery-fabric">
                    </div>
                    <div class="form-group">
                        <label>‚≠ï Hoop Size</label>
                        <input type="text" id="edit-embroidery-hoop" placeholder="e.g., 6 inch">
                    </div>
                    <div class="form-group">
                        <label>üîó Pattern Link</label>
                        <input type="url" id="edit-embroidery-pattern-link" placeholder="https://...">
                    </div>
                    <div class="form-group">
                        <label>üîó Supplies Link</label>
                        <input type="url" id="edit-embroidery-supplies-link" placeholder="https://...">
                    </div>
                </div>

                <!-- Weaving Fields -->
                <div id="edit-weaving-fields" class="craft-fields" style="display: none;">
                    <h4 style="margin: 1.5rem 0 1rem; color: var(--terracotta);">üßµ Weaving Details</h4>
                    <div class="form-group">
                        <label>üßµ Loom Type</label>
                        <input type="text" id="edit-weaving-loom" placeholder="e.g., Floor loom, Rigid heddle">
                    </div>
                    <div class="form-group">
                        <label>üìè Reed Size</label>
                        <input type="text" id="edit-weaving-reed" placeholder="e.g., 12 dent">
                    </div>
                    <div class="form-group">
                        <label>üìê Warp Yarn</label>
                        <input type="text" id="edit-weaving-warp">
                    </div>
                    <div class="form-group">
                        <label>üßµ Weft Yarn</label>
                        <input type="text" id="edit-weaving-weft">
                    </div>
                    <div class="form-group">
                        <label>üìè Dimensions</label>
                        <input type="text" id="edit-weaving-dimensions" placeholder="e.g., 24 x 36 inches">
                    </div>
                    <div class="form-group">
                        <label>üîó Supplies Link</label>
                        <input type="url" id="edit-weaving-supplies-link" placeholder="https://...">
                    </div>
                </div>

                <!-- Quilting Fields -->
                <div id="edit-quilting-fields" class="craft-fields" style="display: none;">
                    <h4 style="margin: 1.5rem 0 1rem; color: var(--terracotta);">üßµ Quilting Details</h4>
                    <div class="form-group">
                        <label>üìè Quilt Size</label>
                        <input type="text" id="edit-quilting-size" placeholder="e.g., Twin, Queen">
                    </div>
                    <div class="form-group">
                        <label>üßµ Batting Type</label>
                        <input type="text" id="edit-quilting-batting" placeholder="e.g., Cotton, Polyester">
                    </div>
                    <div class="form-group">
                        <label>üé® Fabric Collection</label>
                        <input type="text" id="edit-quilting-fabric">
                    </div>
                    <div class="form-group">
                        <label>üìê Block Pattern</label>
                        <input type="text" id="edit-quilting-block" placeholder="e.g., Log Cabin">
                    </div>
                    <div class="form-group">
                        <label>üîó Pattern Link</label>
                        <input type="url" id="edit-quilting-pattern-link" placeholder="https://...">
                    </div>
                    <div class="form-group">
                        <label>üîó Supplies Link</label>
                        <input type="url" id="edit-quilting-supplies-link" placeholder="https://...">
                    </div>
                </div>

                <!-- Leather Work Fields -->
                <div id="edit-leather-fields" class="craft-fields" style="display: none;">
                    <h4 style="margin: 1.5rem 0 1rem; color: var(--terracotta);">üß≥ Leather Work Details</h4>
                    <div class="form-group">
                        <label>üß≥ Leather Type</label>
                        <input type="text" id="edit-leather-type" placeholder="e.g., Veg-tan, Chrome-tan">
                    </div>
                    <div class="form-group">
                        <label>üìè Leather Weight</label>
                        <input type="text" id="edit-leather-weight" placeholder="e.g., 4-5 oz">
                    </div>
                    <div class="form-group">
                        <label>üé® Color/Finish</label>
                        <input type="text" id="edit-leather-color">
                    </div>
                    <div class="form-group">
                        <label>üîß Hardware Used</label>
                        <input type="text" id="edit-leather-hardware" placeholder="e.g., Brass buckle">
                    </div>
                    <div class="form-group">
                        <label>üîó Pattern Link</label>
                        <input type="url" id="edit-leather-pattern-link" placeholder="https://...">
                    </div>
                    <div class="form-group">
                        <label>üîó Supplies Link</label>
                        <input type="url" id="edit-leather-supplies-link" placeholder="https://...">
                    </div>
                </div>

                <button type="submit" class="btn btn-primary" style="width: 100%; margin-top: 1.5rem;">Save Changes</button>
            </form>
        </div>
    </div>

    <!-- Add Update Modal -->
    <div class="modal" id="add-update-modal">
        <div class="modal-content" style="max-width: 700px;">
            <div class="modal-header">
                <h2>Add Project Update</h2>
                <button class="modal-close" onclick="closeAddUpdate()">&times;</button>
            </div>
            <form onsubmit="handleAddUpdate(event)">
                <input type="hidden" id="update-project-id">
                <div class="form-group">
                    <label>What's new? *</label>
                    <textarea id="update-content" required placeholder="Made progress on the sleeves today..."></textarea>
                </div>
                <div class="form-group">
                    <label>Add Photo (Optional)</label>
                    <input type="file" id="update-photo" accept="image/*">
                    <div id="update-photo-preview" style="margin-top: 1rem; display: none;">
                        <img style="max-width: 100%; border-radius: 8px;">
                    </div>
                </div>
                <button type="submit" class="btn btn-primary" style="width: 100%; margin-top: 1.5rem;">Post Update</button>
            </form>
        </div>
    </div>

    <!-- Floating Chat Widget -->
    <div class="chat-widget" id="chat-widget">
        <div class="chat-widget-header">
            <div class="chat-widget-avatar" id="chat-widget-avatar">...</div>
            <div class="chat-widget-info">
                <div class="chat-widget-name" id="chat-widget-name">Chat</div>
                <div class="chat-widget-status">Online</div>
            </div>
            <button class="chat-widget-close" onclick="closeChatWidget()">√ó</button>
        </div>
        <div class="chat-widget-messages" id="chat-widget-messages">
            <div style="text-align: center; color: var(--text-muted); padding: 2rem;">
                Start your conversation! üëã
            </div>
        </div>
        <div class="chat-widget-input-area">
            <form class="chat-widget-input-form" onsubmit="sendWidgetMessage(event)">
                <input type="text" class="chat-widget-input" id="chat-widget-input" placeholder="Type a message..." required>
                <button type="submit" class="chat-widget-send">‚û§</button>
            </form>
        </div>
    </div>

    <script>
        const SUPABASE_URL = 'https://yzuoujjzupbbekmmymqn.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inl6dW91amp6dXBiYmVrbW15bXFuIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjUwMjYwOTgsImV4cCI6MjA4MDYwMjA5OH0.Ri9ibTKIin_oA0vsHthU_zbnuNnnKQsXkmF5Es8UJWc';
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        let currentUser = null;
        let userProfile = null;
        let allMembers = [];
        let currentChatUser = null;
        let chatRealtimeChannel = null;

        async function checkAuth() {
            const { data: { session } } = await supabase.auth.getSession();
            if (!session) {
                window.location.href = 'login.html';
                return;
            }
            currentUser = session.user;
            await loadUserData();
        }

        async function loadUserData() {
            const { data: profile } = await supabase
                .from('profiles')
                .select('*')
                .eq('id', currentUser.id)
                .single();

            userProfile = profile;
            
            const headerAvatar = document.getElementById('header-avatar');
            if (profile.profile_picture_url) {
                headerAvatar.innerHTML = `<img src="${profile.profile_picture_url}" alt="${profile.full_name}">`;
            } else {
                headerAvatar.textContent = profile.avatar_initials;
            }
            
            document.getElementById('welcome-text').textContent = `Welcome back, ${profile.full_name.split(' ')[0]}! üëã`;

            await loadAllData();
            startRealtimeUpdates();
        }

        async function loadAllData() {
            await Promise.all([
                loadQuickStats(),
                loadMyProjects(),
                loadCommunityFeed(),
                loadFriends(),
                loadMembers(),
                loadNotifications(),
                loadConversations()
            ]);
        }

        async function loadQuickStats() {
            // Get friend count using mutual follow logic
            const { data: iFollow } = await supabase
                .from('follows')
                .select('following_id')
                .eq('follower_id', currentUser.id);

            const { data: followMe } = await supabase
                .from('follows')
                .select('follower_id')
                .eq('following_id', currentUser.id);

            let friendsCount = 0;
            if (iFollow && followMe) {
                const iFollowIds = iFollow.map(f => f.following_id);
                const followMeIds = followMe.map(f => f.follower_id);
                friendsCount = iFollowIds.filter(id => followMeIds.includes(id)).length;
            }
            
            document.getElementById('stat-projects').textContent = userProfile.projects_count || 0;
            document.getElementById('stat-likes').textContent = userProfile.total_likes_received || 0;
            document.getElementById('stat-friends').textContent = friendsCount;
            document.getElementById('stat-streak').textContent = userProfile.streak_days || 0;
        }

        async function loadMyProjects() {
            const { data: projects } = await supabase
                .from('projects')
                .select('*')
                .eq('user_id', currentUser.id)
                .order('created_at', { ascending: false });

            const container = document.getElementById('my-projects-container');
            
            if (!projects || projects.length === 0) {
                container.innerHTML = `
                    <div class="card">
                        <div class="empty-state">
                            <div class="empty-state-icon">üé®</div>
                            <p>No projects yet!</p>
                            <button class="btn btn-primary" style="margin-top: 1rem;" onclick="showAddProject()">Create Your First Project</button>
                        </div>
                    </div>
                `;
                return;
            }

            container.innerHTML = `<div class="project-grid">${projects.map(project => createProjectCard(project, true)).join('')}</div>`;
        }

        async function checkProjectLikeStatus(projectId) {
            const { data } = await supabase
                .from('likes')
                .select('id')
                .eq('project_id', projectId)
                .eq('user_id', currentUser.id)
                .single();

            const btn = document.getElementById(`like-btn-${projectId}`);
            if (btn) {
                if (data) {
                    btn.textContent = '‚ù§Ô∏è';
                    btn.classList.add('liked');
                } else {
                    btn.textContent = 'ü§ç';
                    btn.classList.remove('liked');
                }
            }
        }

        async function checkProjectFollowStatus(projectId) {
            const { data } = await supabase
                .from('project_followers')
                .select('id')
                .eq('project_id', projectId)
                .eq('user_id', currentUser.id)
                .single();

            const btn = document.getElementById(`follow-project-${projectId}`);
            if (btn) {
                btn.textContent = data ? 'Following' : 'Follow';
                btn.className = data ? 'follow-btn-small following' : 'follow-btn-small';
            }
        }

        async function loadCommunityFeed() {
            const { data: feedItems, error } = await supabase.rpc('get_user_feed', { 
                user_uuid: currentUser.id,
                limit_count: 20
            });

            if (error) {
                console.error('Error loading feed:', error);
            }

            const container = document.getElementById('community-feed');
            
            if (!feedItems || feedItems.length === 0) {
                container.innerHTML = `
                    <div class="card">
                        <div class="empty-state">
                            <div class="empty-state-icon">üåä</div>
                            <p>No activity yet. Follow some projects and makers!</p>
                        </div>
                    </div>
                `;
                return;
            }

            container.innerHTML = feedItems.map(item => {
                if (item.type === 'project') {
                    // Display as project card
                    return `
                        <div class="feed-item" style="cursor: pointer;" onclick="showProjectDetail('${item.project_id}')">
                            <div class="feed-header">
                                <div class="feed-avatar" onclick="event.stopPropagation(); showUserProfile('${item.user_id}')">
                                    ${item.profile_picture_url ? 
                                        `<img src="${item.profile_picture_url}" alt="${item.username}">` : 
                                        item.avatar_initials
                                    }
                                </div>
                                <div style="flex: 1;">
                                    <div style="font-weight: 600; cursor: pointer;" onclick="event.stopPropagation(); showUserProfile('${item.user_id}')">
                                        @${item.username}
                                    </div>
                                    <div style="font-size: 0.85rem; color: var(--text-muted);">
                                        created a new ${item.project_craft_type} project
                                    </div>
                                </div>
                            </div>
                            <div style="margin: 1rem 0;">
                                <h3 style="margin-bottom: 0.5rem;">${item.project_title}</h3>
                                ${item.project_description ? `<p style="color: var(--text-muted); font-family: -apple-system, sans-serif;">${item.project_description.substring(0, 150)}${item.project_description.length > 150 ? '...' : ''}</p>` : ''}
                            </div>
                            <div style="display: flex; gap: 1rem; color: var(--text-muted); font-size: 0.9rem;">
                                <span>‚ù§Ô∏è ${item.project_likes_count || 0}</span>
                                <span>üí¨ ${item.project_comments_count || 0}</span>
                                <span>üëÅÔ∏è ${item.project_views_count || 0}</span>
                            </div>
                            <div class="feed-time">${getTimeAgo(item.created_at)}</div>
                        </div>
                    `;
                } else if (item.type === 'update') {
                    // Display as update
                    return `
                        <div class="feed-item" style="cursor: pointer;" onclick="showProjectDetail('${item.project_id}')">
                            <div class="feed-header">
                                <div class="feed-avatar" onclick="event.stopPropagation(); showUserProfile('${item.user_id}')">
                                    ${item.profile_picture_url ? 
                                        `<img src="${item.profile_picture_url}" alt="${item.username}">` : 
                                        item.avatar_initials
                                    }
                                </div>
                                <div style="flex: 1;">
                                    <div style="font-weight: 600; cursor: pointer;" onclick="event.stopPropagation(); showUserProfile('${item.user_id}')">
                                        @${item.username}
                                    </div>
                                    <div style="font-size: 0.85rem; color: var(--text-muted);">
                                        posted an update on "${item.project_title}"
                                    </div>
                                </div>
                            </div>
                            <div style="margin: 1rem 0;">
                                <p style="font-family: -apple-system, sans-serif; line-height: 1.6;">${item.update_content}</p>
                                ${item.update_photo_url ? `
                                    <img src="${item.update_photo_url}" style="width: 100%; border-radius: 8px; margin-top: 1rem; max-height: 400px; object-fit: cover;">
                                ` : ''}
                            </div>
                            <div class="feed-time">${getTimeAgo(item.created_at)}</div>
                        </div>
                    `;
                } else if (item.type === 'edit') {
                    // Display as edit activity
                    return `
                        <div class="feed-item" style="cursor: pointer; border-left: 4px solid var(--terracotta);" onclick="showProjectDetail('${item.project_id}')">
                            <div class="feed-header">
                                <div class="feed-avatar" onclick="event.stopPropagation(); showUserProfile('${item.user_id}')">
                                    ${item.profile_picture_url ? 
                                        `<img src="${item.profile_picture_url}" alt="${item.username}">` : 
                                        item.avatar_initials
                                    }
                                </div>
                                <div style="flex: 1;">
                                    <div style="font-weight: 600; cursor: pointer;" onclick="event.stopPropagation(); showUserProfile('${item.user_id}')">
                                        Update: @${item.username} edited ${item.project_title}
                                    </div>
                                    <div style="font-size: 0.85rem; color: var(--text-muted); margin-top: 0.25rem;">
                                        ${item.update_content}
                                    </div>
                                </div>
                            </div>
                            <div class="feed-time">${getTimeAgo(item.created_at)}</div>
                        </div>
                    `;
                }
            }).join('');
        }

        function getFeedTypeText(type) {
            switch(type) {
                case 'project': return 'created a new project';
                case 'update': return 'posted an update';
                case 'comment': return 'commented';
                default: return 'posted';
            }
        }

        async function checkIfFriends(userId1, userId2) {
            // Check if both users follow each other
            const { data: follow1 } = await supabase
                .from('follows')
                .select('id')
                .eq('follower_id', userId1)
                .eq('following_id', userId2)
                .single();

            const { data: follow2 } = await supabase
                .from('follows')
                .select('id')
                .eq('follower_id', userId2)
                .eq('following_id', userId1)
                .single();

            return follow1 && follow2;
        }

        async function loadFriends() {
            // Get all users I follow
            const { data: iFollow } = await supabase
                .from('follows')
                .select('following_id')
                .eq('follower_id', currentUser.id);

            // Get all users who follow me
            const { data: followMe } = await supabase
                .from('follows')
                .select('follower_id')
                .eq('following_id', currentUser.id);

            const container = document.getElementById('friends-container');
            
            if (!iFollow || !followMe || iFollow.length === 0 || followMe.length === 0) {
                container.innerHTML = `
                    <div class="card">
                        <div class="empty-state">
                            <div class="empty-state-icon">üí´</div>
                            <p>No friends yet!</p>
                            <p style="font-size: 0.9rem; margin-top: 0.5rem;">Follow someone and have them follow you back to become friends!</p>
                        </div>
                    </div>
                `;
                return;
            }

            // Find mutual follows (friends)
            const iFollowIds = iFollow.map(f => f.following_id);
            const followMeIds = followMe.map(f => f.follower_id);
            const friendIds = iFollowIds.filter(id => followMeIds.includes(id));

            if (friendIds.length === 0) {
                container.innerHTML = `
                    <div class="card">
                        <div class="empty-state">
                            <div class="empty-state-icon">üí´</div>
                            <p>No friends yet!</p>
                            <p style="font-size: 0.9rem; margin-top: 0.5rem;">You follow ${iFollowIds.length} people and ${followMeIds.length} people follow you.</p>
                            <p style="font-size: 0.9rem; margin-top: 0.5rem;">Follow each other to become friends!</p>
                        </div>
                    </div>
                `;
                return;
            }

            // Get friend profiles
            const { data: friends } = await supabase
                .from('profiles')
                .select('*')
                .in('id', friendIds);

            container.innerHTML = `
                <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 1.5rem;">
                    ${friends.map(friend => `
                        <div class="card" style="text-align: center;">
                            <div style="width: 80px; height: 80px; border-radius: 50%; background: var(--terracotta); margin: 0 auto 1rem; display: flex; align-items: center; justify-content: center; color: white; font-size: 2rem; font-weight: bold; overflow: hidden; cursor: pointer;" onclick="showUserProfile('${friend.id}')">
                                ${friend.profile_picture_url ? 
                                    `<img src="${friend.profile_picture_url}" style="width: 100%; height: 100%; object-fit: cover;">` : 
                                    friend.avatar_initials
                                }
                            </div>
                            <h3 style="margin-bottom: 0.5rem; cursor: pointer;" onclick="showUserProfile('${friend.id}')">@${friend.username}</h3>
                            <p style="color: var(--text-muted); font-family: -apple-system, sans-serif; margin-bottom: 1rem;">${friend.full_name}</p>
                            <div style="display: flex; gap: 0.5rem;">
                                <button class="btn btn-primary btn-small" style="flex: 1;" onclick="openChat('${friend.id}', '${friend.username}', '${friend.profile_picture_url || ''}', '${friend.avatar_initials}')">üí¨ Message</button>
                                <button class="btn btn-secondary btn-small" onclick="showUserProfile('${friend.id}')">üë§ Profile</button>
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;
        }

        async function loadMembers() {
            const { data: members } = await supabase
                .from('profiles')
                .select('*')
                .neq('id', currentUser.id)
                .order('created_at', { ascending: false });

            allMembers = members || [];
            displayMembers(allMembers);
        }

        function displayMembers(members) {
            const container = document.getElementById('members-container');
            
            if (!members || members.length === 0) {
                container.innerHTML = '<div class="card"><div class="empty-state"><p>No other members yet</p></div></div>';
                return;
            }

            container.innerHTML = `
                <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 1.5rem;">
                    ${members.map(member => `
                        <div class="card" style="text-align: center; cursor: pointer;" onclick="showUserProfile('${member.id}')">
                            <div style="width: 80px; height: 80px; border-radius: 50%; background: var(--terracotta); margin: 0 auto 1rem; display: flex; align-items: center; justify-content: center; color: white; font-size: 2rem; font-weight: bold; overflow: hidden;">
                                ${member.profile_picture_url ? 
                                    `<img src="${member.profile_picture_url}" style="width: 100%; height: 100%; object-fit: cover;">` : 
                                    member.avatar_initials
                                }
                            </div>
                            <h3 style="margin-bottom: 0.5rem;">@${member.username}</h3>
                            <p style="color: var(--text-muted); font-family: -apple-system, sans-serif; margin-bottom: 0.5rem;">${member.full_name}</p>
                            <p style="color: var(--text-muted); font-family: -apple-system, sans-serif; font-size: 0.85rem; margin-bottom: 1rem;">${member.location || 'Location not set'}</p>
                            <button class="btn btn-primary btn-small" style="width: 100%;" onclick="event.stopPropagation(); toggleFollow('${member.id}')" id="follow-btn-${member.id}">Follow</button>
                        </div>
                    `).join('')}
                </div>
            `;

            members.forEach(member => checkFollowStatus(member.id));
        }

        function searchMembers() {
            const query = document.getElementById('member-search').value.toLowerCase();
            const filtered = allMembers.filter(m => 
                m.full_name.toLowerCase().includes(query) ||
                m.username.toLowerCase().includes(query)
            );
            displayMembers(filtered);
        }

        async function checkFollowStatus(userId) {
            const { data } = await supabase
                .from('follows')
                .select('id')
                .eq('follower_id', currentUser.id)
                .eq('following_id', userId)
                .single();

            const btn = document.getElementById(`follow-btn-${userId}`);
            if (btn) {
                btn.textContent = data ? 'Following' : 'Follow';
                btn.className = data ? 'btn btn-small' : 'btn btn-primary btn-small';
            }
        }

        async function toggleFollow(userId) {
            const { data: existing } = await supabase
                .from('follows')
                .select('id')
                .eq('follower_id', currentUser.id)
                .eq('following_id', userId)
                .single();

            if (existing) {
                await supabase.from('follows').delete().eq('id', existing.id);
            } else {
                await supabase.from('follows').insert({
                    follower_id: currentUser.id,
                    following_id: userId
                });
            }

            checkFollowStatus(userId);
            loadFriends();
            loadQuickStats();
        }

        function showCraftFields() {
            const craftType = document.getElementById('project-craft-type').value;
            
            document.querySelectorAll('.craft-specific-fields').forEach(el => {
                el.style.display = 'none';
            });

            const fieldMap = {
                'Crochet': 'crochet-fields',
                'Knitting': 'knitting-fields',
                'Sewing': 'sewing-fields',
                'Embroidery': 'embroidery-fields',
                'Weaving': 'weaving-fields',
                'Quilting': 'quilting-fields',
                'Leather Work': 'leather-fields'
            };

            const fieldId = fieldMap[craftType];
            if (fieldId) {
                document.getElementById(fieldId).style.display = 'block';
            }
        }

        function getCraftDetails(craftType) {
            const details = {};

            if (craftType === 'Crochet') {
                details.hook_size = document.getElementById('crochet-hook-size')?.value || '';
                details.yarn_weight = document.getElementById('crochet-yarn-weight')?.value || '';
                details.yarn_brand = document.getElementById('crochet-yarn-brand')?.value || '';
                details.yarn_color = document.getElementById('crochet-yarn-color')?.value || '';
                details.yardage = document.getElementById('crochet-yardage')?.value || '';
                details.gauge = document.getElementById('crochet-gauge')?.value || '';
                details.yarn_link = document.getElementById('crochet-yarn-link')?.value || '';
                details.pattern_link = document.getElementById('crochet-pattern-link')?.value || '';
            } else if (craftType === 'Knitting') {
                details.needle_size = document.getElementById('knitting-needle-size')?.value || '';
                details.needle_type = document.getElementById('knitting-needle-type')?.value || '';
                details.yarn_weight = document.getElementById('knitting-yarn-weight')?.value || '';
                details.yarn_brand = document.getElementById('knitting-yarn-brand')?.value || '';
                details.yardage = document.getElementById('knitting-yardage')?.value || '';
                details.yarn_link = document.getElementById('knitting-yarn-link')?.value || '';
            } else if (craftType === 'Sewing') {
                details.needle_type = document.getElementById('sewing-needle-type')?.value || '';
                details.fabric_type = document.getElementById('sewing-fabric-type')?.value || '';
                details.fabric_amount = document.getElementById('sewing-fabric-amount')?.value || '';
                details.fabric_brand = document.getElementById('sewing-fabric-brand')?.value || '';
                details.notions = document.getElementById('sewing-notions')?.value || '';
                details.pattern_size = document.getElementById('sewing-pattern-size')?.value || '';
                details.fabric_link = document.getElementById('sewing-fabric-link')?.value || '';
                details.pattern_link = document.getElementById('sewing-pattern-link')?.value || '';
            } else if (craftType === 'Embroidery') {
                details.thread_type = document.getElementById('embroidery-thread-type')?.value || '';
                details.thread_colors = document.getElementById('embroidery-thread-colors')?.value || '';
                details.fabric_type = document.getElementById('embroidery-fabric-type')?.value || '';
                details.hoop_size = document.getElementById('embroidery-hoop-size')?.value || '';
                details.supplies_link = document.getElementById('embroidery-supplies-link')?.value || '';
            } else if (craftType === 'Weaving') {
                details.loom_type = document.getElementById('weaving-loom-type')?.value || '';
                details.yarn_type = document.getElementById('weaving-yarn-type')?.value || '';
                details.reed_size = document.getElementById('weaving-reed-size')?.value || '';
                details.width = document.getElementById('weaving-width')?.value || '';
                details.length = document.getElementById('weaving-length')?.value || '';
                details.supplies_link = document.getElementById('weaving-supplies-link')?.value || '';
            } else if (craftType === 'Quilting') {
                details.quilt_size = document.getElementById('quilting-quilt-size')?.value || '';
                details.fabric_collection = document.getElementById('quilting-fabric-collection')?.value || '';
                details.batting_type = document.getElementById('quilting-batting-type')?.value || '';
                details.fabric_link = document.getElementById('quilting-fabric-link')?.value || '';
            } else if (craftType === 'Leather Work') {
                details.leather_type = document.getElementById('leather-leather-type')?.value || '';
                details.leather_weight = document.getElementById('leather-leather-weight')?.value || '';
                details.thread_type = document.getElementById('leather-thread-type')?.value || '';
                details.needle_size = document.getElementById('leather-needle-size')?.value || '';
                details.hardware = document.getElementById('leather-hardware')?.value || '';
                details.supplies_link = document.getElementById('leather-supplies-link')?.value || '';
            }

            Object.keys(details).forEach(key => {
                if (!details[key]) delete details[key];
            });

            return details;
        }

        function displayCraftDetails(craftType, craftDetails) {
            if (!craftDetails || Object.keys(craftDetails).length === 0) {
                return '';
            }

            let html = '<div style="background: var(--cream); padding: 1.5rem; border-radius: 12px; margin-top: 2rem;"><h3 style="margin-bottom: 1rem; color: var(--terracotta);">üìù Project Details</h3>';

            const formatLabel = (key) => {
                return key.split('_').map(word => word.charAt(0).toUpperCase() + word.slice(1)).join(' ');
            };

            const renderField = (label, value) => {
                if (!value) return '';
                
                if (value.startsWith('http://') || value.startsWith('https://')) {
                    return `
                        <div style="margin-bottom: 0.75rem;">
                            <strong style="color: var(--dark-brown); font-family: -apple-system, sans-serif; font-size: 0.9rem;">${label}:</strong>
                            <a href="${value}" target="_blank" style="color: var(--terracotta); text-decoration: none; font-family: -apple-system, sans-serif; margin-left: 0.5rem;">üîó View Link</a>
                        </div>
                    `;
                }
                
                return `
                    <div style="margin-bottom: 0.75rem;">
                        <strong style="color: var(--dark-brown); font-family: -apple-system, sans-serif; font-size: 0.9rem;">${label}:</strong>
                        <span style="font-family: -apple-system, sans-serif; margin-left: 0.5rem;">${value}</span>
                    </div>
                `;
            };

            Object.keys(craftDetails).forEach(key => {
                const label = formatLabel(key);
                html += renderField(label, craftDetails[key]);
            });

            html += '</div>';
            return html;
        }

        function createProjectCard(project, isOwner) {
            let craftPreview = '';
            if (project.craft_details && Object.keys(project.craft_details).length > 0) {
                const details = project.craft_details;
                if (project.craft_type === 'Crochet' && details.hook_size) {
                    craftPreview = ` ‚Ä¢ Hook: ${details.hook_size}`;
                } else if (project.craft_type === 'Knitting' && details.needle_size) {
                    craftPreview = ` ‚Ä¢ Needles: ${details.needle_size}`;
                } else if (project.craft_type === 'Sewing' && details.fabric_type) {
                    craftPreview = ` ‚Ä¢ ${details.fabric_type}`;
                }
            }

            return `
                <div class="project-card">
                    <div class="project-image" onclick="showProjectDetail('${project.id}')">
                        ${getCraftIcon(project.craft_type)}
                        ${!isOwner ? `
                            <button class="like-btn" id="like-btn-${project.id}" onclick="event.stopPropagation(); toggleLike(event, '${project.id}')">ü§ç</button>
                            <button class="follow-btn-small" id="follow-project-${project.id}" onclick="event.stopPropagation(); toggleProjectFollow('${project.id}')">Follow</button>
                        ` : ''}
                    </div>
                    <div class="project-info" onclick="showProjectDetail('${project.id}')">
                        <h3 class="project-title">${project.title}</h3>
                        <p style="font-size: 0.85rem; color: var(--text-muted); font-family: -apple-system, sans-serif; margin-bottom: 0.5rem;">${project.craft_type}${craftPreview}</p>
                        <div class="project-meta">
                            <span>‚ù§Ô∏è ${project.likes_count || 0}</span>
                            <span>üí¨ ${project.comments_count || 0}</span>
                        </div>
                        ${isOwner ? `
                            <div style="display: flex; gap: 0.5rem; margin-top: 1rem;">
                                <button class="btn btn-secondary btn-small" style="flex: 1;" onclick="event.stopPropagation(); showEditProject('${project.id}')">
                                    ‚úèÔ∏è Edit
                                </button>
                                <button class="btn btn-primary btn-small" style="flex: 1;" onclick="event.stopPropagation(); showAddUpdate('${project.id}')">
                                    üìù Update
                                </button>
                            </div>
                            <button class="btn btn-danger btn-small" style="width: 100%; margin-top: 0.5rem;" onclick="event.stopPropagation(); deleteProject('${project.id}')">
                                üóëÔ∏è Delete
                            </button>
                        ` : ''}
                    </div>
                </div>
            `;
        }

        async function showProjectDetail(projectId) {
            const { data: project } = await supabase
                .from('projects')
                .select('*, profiles(full_name, username, avatar_initials, profile_picture_url)')
                .eq('id', projectId)
                .single();

            if (!project) return;

            // Load project updates
            const { data: updates } = await supabase
                .from('project_updates')
                .select('*, profiles(username, avatar_initials, profile_picture_url)')
                .eq('project_id', projectId)
                .order('created_at', { ascending: false });

            const isOwner = project.user_id === currentUser.id;
            const craftDetailsHTML = displayCraftDetails(project.craft_type, project.craft_details);

            const updatesHTML = updates && updates.length > 0 ? `
                <div style="margin-top: 2rem; padding-top: 2rem; border-top: 2px solid var(--light-beige);">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                        <h3 style="margin: 0;">üìù Project Updates (${updates.length})</h3>
                        ${isOwner ? `
                            <button class="btn btn-primary btn-small" onclick="event.stopPropagation(); document.getElementById('project-detail-temp').remove(); showAddUpdate('${projectId}')">
                                + Add Update
                            </button>
                        ` : ''}
                    </div>
                    <div style="display: flex; flex-direction: column; gap: 1.5rem;">
                        ${updates.map(update => `
                            <div style="background: var(--cream); padding: 1.5rem; border-radius: 12px;">
                                <div style="display: flex; align-items: center; gap: 0.75rem; margin-bottom: 1rem;">
                                    <div style="width: 36px; height: 36px; border-radius: 50%; background: var(--terracotta); color: white; display: flex; align-items: center; justify-content: center; font-weight: bold; overflow: hidden;">
                                        ${update.profiles?.profile_picture_url ? 
                                            `<img src="${update.profiles.profile_picture_url}" style="width: 100%; height: 100%; object-fit: cover;">` : 
                                            update.profiles?.avatar_initials
                                        }
                                    </div>
                                    <div style="flex: 1;">
                                        <div style="font-weight: 600; font-size: 0.9rem;">@${update.profiles?.username}</div>
                                        <div style="font-size: 0.75rem; color: var(--text-muted); font-family: -apple-system, sans-serif;">${getTimeAgo(update.created_at)}</div>
                                    </div>
                                </div>
                                <p style="font-family: -apple-system, sans-serif; line-height: 1.6; margin-bottom: ${update.photo_url ? '1rem' : '0'};">${update.content}</p>
                                ${update.photo_url ? `
                                    <img src="${update.photo_url}" style="width: 100%; border-radius: 8px; max-height: 400px; object-fit: cover;">
                                ` : ''}
                            </div>
                        `).join('')}
                    </div>
                </div>
            ` : isOwner ? `
                <div style="margin-top: 2rem; padding-top: 2rem; border-top: 2px solid var(--light-beige); text-align: center;">
                    <p style="color: var(--text-muted); margin-bottom: 1rem;">No updates yet. Share your progress!</p>
                    <button class="btn btn-primary" onclick="event.stopPropagation(); document.getElementById('project-detail-temp').remove(); showAddUpdate('${projectId}')">
                        + Add First Update
                    </button>
                </div>
            ` : '';

            const modalHTML = `
                <div class="modal show" id="project-detail-temp" onclick="if(event.target === this) this.remove()" style="display: flex;">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h2>${project.title}</h2>
                            <button class="modal-close" onclick="document.getElementById('project-detail-temp').remove()">&times;</button>
                        </div>
                        
                        <div style="margin-bottom: 1rem;">
                            <div style="display: inline-block; padding: 0.5rem 1rem; background: var(--light-beige); border-radius: 20px; font-family: -apple-system, sans-serif; font-size: 0.9rem;">
                                ${getCraftIcon(project.craft_type)} ${project.craft_type} ‚Ä¢ ${project.status.replace('_', ' ')}
                            </div>
                        </div>

                        <div style="display: flex; align-items: center; gap: 1rem; margin-bottom: 2rem; padding-bottom: 1rem; border-bottom: 2px solid var(--light-beige); cursor: pointer;" onclick="document.getElementById('project-detail-temp').remove(); showUserProfile('${project.profiles.id || project.user_id}')">
                            <div style="width: 48px; height: 48px; border-radius: 50%; background: var(--terracotta); color: white; display: flex; align-items: center; justify-content: center; font-size: 1.25rem; font-weight: bold; overflow: hidden;">
                                ${project.profiles.profile_picture_url ? 
                                    `<img src="${project.profiles.profile_picture_url}" style="width: 100%; height: 100%; object-fit: cover;">` : 
                                    project.profiles.avatar_initials
                                }
                            </div>
                            <div>
                                <div style="font-weight: 600;">@${project.profiles.username}</div>
                                <div style="font-size: 0.85rem; color: var(--text-muted); font-family: -apple-system, sans-serif;">Posted ${getTimeAgo(project.created_at)}</div>
                            </div>
                        </div>

                        <div style="margin-bottom: 2rem;">
                            <h3 style="margin-bottom: 0.75rem;">About This Project</h3>
                            <p style="font-family: -apple-system, sans-serif; line-height: 1.6;">${project.description || 'No description provided.'}</p>
                        </div>

                        ${craftDetailsHTML}

                        ${updatesHTML}

                        <div style="margin-top: 2rem; padding-top: 2rem; border-top: 2px solid var(--light-beige); display: flex; gap: 2rem; font-family: -apple-system, sans-serif; color: var(--text-muted);">
                            <span>‚ù§Ô∏è ${project.likes_count || 0} likes</span>
                            <span>üí¨ ${project.comments_count || 0} comments</span>
                            <span>üëÅÔ∏è ${project.views_count || 0} views</span>
                        </div>

                        ${!isOwner ? `
                            <button class="btn btn-primary" style="width: 100%; margin-top: 1.5rem;" onclick="toggleLike(event, '${project.id}'); setTimeout(() => document.getElementById('project-detail-temp').remove(), 500);" id="detail-like-btn-${project.id}">
                                Like This Project ‚ù§Ô∏è
                            </button>
                        ` : `
                            <div style="display: flex; gap: 1rem; margin-top: 1.5rem;">
                                <button class="btn btn-secondary" style="flex: 1;" onclick="event.stopPropagation(); document.getElementById('project-detail-temp').remove(); showEditProject('${project.id}')">
                                    ‚úèÔ∏è Edit Project
                                </button>
                                <button class="btn btn-primary" style="flex: 1;" onclick="event.stopPropagation(); document.getElementById('project-detail-temp').remove(); showAddUpdate('${project.id}')">
                                    üìù Add Update
                                </button>
                            </div>
                        `}
                    </div>
                </div>
            `;

            document.body.insertAdjacentHTML('beforeend', modalHTML);
            
            if (!isOwner) {
                const { data } = await supabase
                    .from('likes')
                    .select('id')
                    .eq('project_id', projectId)
                    .eq('user_id', currentUser.id)
                    .single();

                const btn = document.getElementById(`detail-like-btn-${project.id}`);
                if (btn && data) {
                    btn.textContent = 'Unlike ‚ù§Ô∏è';
                }
            }
        }

        async function toggleProjectFollow(projectId) {
            const { data: existing } = await supabase
                .from('project_followers')
                .select('id')
                .eq('project_id', projectId)
                .eq('user_id', currentUser.id)
                .single();

            if (existing) {
                await supabase.from('project_followers').delete().eq('id', existing.id);
            } else {
                await supabase.from('project_followers').insert({
                    project_id: projectId,
                    user_id: currentUser.id
                });
            }

            const btn = document.getElementById(`follow-project-${projectId}`);
            if (btn) {
                btn.textContent = existing ? 'Follow' : 'Following';
                btn.className = existing ? 'follow-btn-small' : 'follow-btn-small following';
            }
        }

        async function toggleLike(event, projectId) {
            const btn = document.getElementById(`like-btn-${projectId}`);
            if (!btn) return;
            
            const isLiked = btn.classList.contains('liked');

            if (isLiked) {
                await supabase.from('likes').delete().eq('project_id', projectId).eq('user_id', currentUser.id);
                btn.textContent = 'ü§ç';
                btn.classList.remove('liked');
            } else {
                await supabase.from('likes').insert({ project_id: projectId, user_id: currentUser.id });
                btn.textContent = '‚ù§Ô∏è';
                btn.classList.add('liked');
                setTimeout(() => btn.classList.remove('liked'), 500);
            }

            loadMyProjects();
            loadQuickStats();
        }

        async function deleteProject(projectId) {
            if (!confirm('Are you sure you want to delete this project? This cannot be undone.')) {
                return;
            }

            try {
                await supabase.from('projects').delete().eq('id', projectId);
                await supabase.from('profiles').update({ 
                    projects_count: Math.max(0, userProfile.projects_count - 1)
                }).eq('id', currentUser.id);
                
                alert('Project deleted successfully!');
                await loadUserData();
            } catch (error) {
                console.error('Error deleting project:', error);
                alert('Failed to delete project');
            }
        }

        function showAddProject() {
            document.getElementById('add-project-modal').classList.add('show');
        }

        function closeAddProject() {
            document.getElementById('add-project-modal').classList.remove('show');
            document.querySelectorAll('.craft-specific-fields').forEach(el => el.style.display = 'none');
        }

        async function handleAddProject(event) {
            event.preventDefault();
            
            const craftType = document.getElementById('project-craft-type').value;
            const craftDetails = getCraftDetails(craftType);

            await supabase.from('projects').insert({
                user_id: currentUser.id,
                title: document.getElementById('project-title').value,
                description: document.getElementById('project-description').value,
                craft_type: craftType,
                status: 'in_progress',
                craft_details: craftDetails
            });

            await supabase.from('profiles').update({ 
                projects_count: userProfile.projects_count + 1 
            }).eq('id', currentUser.id);

            closeAddProject();
            event.target.reset();
            await loadUserData();
        }

        async function showEditProject(projectId) {
            const { data: project } = await supabase
                .from('projects')
                .select('*')
                .eq('id', projectId)
                .single();

            if (!project) return;

            // Set basic fields
            document.getElementById('edit-project-id').value = project.id;
            document.getElementById('edit-project-craft-type').value = project.craft_type;
            document.getElementById('edit-project-title').value = project.title;
            document.getElementById('edit-project-description').value = project.description || '';
            document.getElementById('edit-project-status').value = project.status;
            
            // Hide all craft fields first
            document.querySelectorAll('#edit-project-modal .craft-fields').forEach(el => {
                el.style.display = 'none';
            });
            
            // Show and populate craft-specific fields
            const details = project.craft_details || {};
            
            if (project.craft_type === 'Crochet') {
                document.getElementById('edit-crochet-fields').style.display = 'block';
                document.getElementById('edit-crochet-hook').value = details.hook_size || '';
                document.getElementById('edit-crochet-yarn-brand').value = details.yarn_brand || '';
                document.getElementById('edit-crochet-yarn-color').value = details.yarn_color || '';
                document.getElementById('edit-crochet-yarn-weight').value = details.yarn_weight || '';
                document.getElementById('edit-crochet-gauge').value = details.gauge || '';
                document.getElementById('edit-crochet-yardage').value = details.yardage || '';
                document.getElementById('edit-crochet-pattern-link').value = details.pattern_link || '';
                document.getElementById('edit-crochet-supplies-link').value = details.supplies_link || '';
            } else if (project.craft_type === 'Knitting') {
                document.getElementById('edit-knitting-fields').style.display = 'block';
                document.getElementById('edit-knitting-needle-type').value = details.needle_type || '';
                document.getElementById('edit-knitting-needle-size').value = details.needle_size || '';
                document.getElementById('edit-knitting-yarn-brand').value = details.yarn_brand || '';
                document.getElementById('edit-knitting-yarn-color').value = details.yarn_color || '';
                document.getElementById('edit-knitting-yarn-weight').value = details.yarn_weight || '';
                document.getElementById('edit-knitting-yardage').value = details.yardage || '';
                document.getElementById('edit-knitting-pattern-link').value = details.pattern_link || '';
                document.getElementById('edit-knitting-supplies-link').value = details.supplies_link || '';
            } else if (project.craft_type === 'Sewing') {
                document.getElementById('edit-sewing-fields').style.display = 'block';
                document.getElementById('edit-sewing-fabric-type').value = details.fabric_type || '';
                document.getElementById('edit-sewing-fabric-amount').value = details.fabric_amount || '';
                document.getElementById('edit-sewing-fabric-brand').value = details.fabric_brand || '';
                document.getElementById('edit-sewing-needle-info').value = details.needle_info || '';
                document.getElementById('edit-sewing-notions').value = details.notions || '';
                document.getElementById('edit-sewing-pattern-link').value = details.pattern_link || '';
                document.getElementById('edit-sewing-supplies-link').value = details.supplies_link || '';
            } else if (project.craft_type === 'Embroidery') {
                document.getElementById('edit-embroidery-fields').style.display = 'block';
                document.getElementById('edit-embroidery-thread-brand').value = details.thread_brand || '';
                document.getElementById('edit-embroidery-colors').value = details.thread_colors || '';
                document.getElementById('edit-embroidery-fabric').value = details.fabric || '';
                document.getElementById('edit-embroidery-hoop').value = details.hoop_size || '';
                document.getElementById('edit-embroidery-pattern-link').value = details.pattern_link || '';
                document.getElementById('edit-embroidery-supplies-link').value = details.supplies_link || '';
            } else if (project.craft_type === 'Weaving') {
                document.getElementById('edit-weaving-fields').style.display = 'block';
                document.getElementById('edit-weaving-loom').value = details.loom_type || '';
                document.getElementById('edit-weaving-reed').value = details.reed_size || '';
                document.getElementById('edit-weaving-warp').value = details.warp_yarn || '';
                document.getElementById('edit-weaving-weft').value = details.weft_yarn || '';
                document.getElementById('edit-weaving-dimensions').value = details.dimensions || '';
                document.getElementById('edit-weaving-supplies-link').value = details.supplies_link || '';
            } else if (project.craft_type === 'Quilting') {
                document.getElementById('edit-quilting-fields').style.display = 'block';
                document.getElementById('edit-quilting-size').value = details.quilt_size || '';
                document.getElementById('edit-quilting-batting').value = details.batting_type || '';
                document.getElementById('edit-quilting-fabric').value = details.fabric_collection || '';
                document.getElementById('edit-quilting-block').value = details.block_pattern || '';
                document.getElementById('edit-quilting-pattern-link').value = details.pattern_link || '';
                document.getElementById('edit-quilting-supplies-link').value = details.supplies_link || '';
            } else if (project.craft_type === 'Leather Work') {
                document.getElementById('edit-leather-fields').style.display = 'block';
                document.getElementById('edit-leather-type').value = details.leather_type || '';
                document.getElementById('edit-leather-weight').value = details.leather_weight || '';
                document.getElementById('edit-leather-color').value = details.color_finish || '';
                document.getElementById('edit-leather-hardware').value = details.hardware || '';
                document.getElementById('edit-leather-pattern-link').value = details.pattern_link || '';
                document.getElementById('edit-leather-supplies-link').value = details.supplies_link || '';
            }
            
            document.getElementById('edit-project-modal').classList.add('show');
        }

        function closeEditProject() {
            document.getElementById('edit-project-modal').classList.remove('show');
        }

        async function handleUpdateProject(event) {
            event.preventDefault();
            
            const projectId = document.getElementById('edit-project-id').value;
            const craftType = document.getElementById('edit-project-craft-type').value;
            
            console.log('Updating project:', projectId);
            
            // Get old project data to compare
            const { data: oldProject } = await supabase
                .from('projects')
                .select('title, craft_details')
                .eq('id', projectId)
                .single();
            
            const newTitle = document.getElementById('edit-project-title').value;
            const newCraftDetails = getEditCraftDetails(craftType);
            
            // Build changes summary
            let changes = [];
            if (oldProject.title !== newTitle) {
                changes.push('title');
            }
            
            // Check if craft details changed
            const oldDetails = oldProject.craft_details || {};
            const newDetails = newCraftDetails;
            
            if (Object.keys(newDetails).length > Object.keys(oldDetails).length) {
                changes.push('added craft details');
            } else if (JSON.stringify(oldDetails) !== JSON.stringify(newDetails)) {
                changes.push('updated craft details');
            }

            const { data, error } = await supabase.from('projects').update({
                title: newTitle,
                description: document.getElementById('edit-project-description').value,
                status: document.getElementById('edit-project-status').value,
                craft_details: newCraftDetails
            }).eq('id', projectId).select();

            if (error) {
                console.error('Error updating project:', error);
                alert('Failed to update project: ' + error.message);
                return;
            }

            console.log('Project updated successfully:', data);

            // Log the edit for the feed
            if (changes.length > 0) {
                await supabase.from('project_edits').insert({
                    project_id: projectId,
                    user_id: currentUser.id,
                    changes_summary: 'Updated: ' + changes.join(', ')
                });
            }

            closeEditProject();
            alert('Project updated successfully!');
            
            // Reload all data
            await loadUserData();
            
            // Reopen the project to show changes
            setTimeout(() => {
                showProjectDetail(projectId);
            }, 500);
        }

        function getEditCraftDetails(craftType) {
            const details = {};
            
            if (craftType === 'Crochet') {
                const hook = document.getElementById('edit-crochet-hook').value;
                const brand = document.getElementById('edit-crochet-yarn-brand').value;
                const color = document.getElementById('edit-crochet-yarn-color').value;
                const weight = document.getElementById('edit-crochet-yarn-weight').value;
                const gauge = document.getElementById('edit-crochet-gauge').value;
                const yardage = document.getElementById('edit-crochet-yardage').value;
                const pattern = document.getElementById('edit-crochet-pattern-link').value;
                const supplies = document.getElementById('edit-crochet-supplies-link').value;
                
                if (hook) details.hook_size = hook;
                if (brand) details.yarn_brand = brand;
                if (color) details.yarn_color = color;
                if (weight) details.yarn_weight = weight;
                if (gauge) details.gauge = gauge;
                if (yardage) details.yardage = yardage;
                if (pattern) details.pattern_link = pattern;
                if (supplies) details.supplies_link = supplies;
            } else if (craftType === 'Knitting') {
                const needleType = document.getElementById('edit-knitting-needle-type').value;
                const needleSize = document.getElementById('edit-knitting-needle-size').value;
                const brand = document.getElementById('edit-knitting-yarn-brand').value;
                const color = document.getElementById('edit-knitting-yarn-color').value;
                const weight = document.getElementById('edit-knitting-yarn-weight').value;
                const yardage = document.getElementById('edit-knitting-yardage').value;
                const pattern = document.getElementById('edit-knitting-pattern-link').value;
                const supplies = document.getElementById('edit-knitting-supplies-link').value;
                
                if (needleType) details.needle_type = needleType;
                if (needleSize) details.needle_size = needleSize;
                if (brand) details.yarn_brand = brand;
                if (color) details.yarn_color = color;
                if (weight) details.yarn_weight = weight;
                if (yardage) details.yardage = yardage;
                if (pattern) details.pattern_link = pattern;
                if (supplies) details.supplies_link = supplies;
            } else if (craftType === 'Sewing') {
                const fabricType = document.getElementById('edit-sewing-fabric-type').value;
                const fabricAmount = document.getElementById('edit-sewing-fabric-amount').value;
                const fabricBrand = document.getElementById('edit-sewing-fabric-brand').value;
                const needleInfo = document.getElementById('edit-sewing-needle-info').value;
                const notions = document.getElementById('edit-sewing-notions').value;
                const pattern = document.getElementById('edit-sewing-pattern-link').value;
                const supplies = document.getElementById('edit-sewing-supplies-link').value;
                
                if (fabricType) details.fabric_type = fabricType;
                if (fabricAmount) details.fabric_amount = fabricAmount;
                if (fabricBrand) details.fabric_brand = fabricBrand;
                if (needleInfo) details.needle_info = needleInfo;
                if (notions) details.notions = notions;
                if (pattern) details.pattern_link = pattern;
                if (supplies) details.supplies_link = supplies;
            } else if (craftType === 'Embroidery') {
                const threadBrand = document.getElementById('edit-embroidery-thread-brand').value;
                const colors = document.getElementById('edit-embroidery-colors').value;
                const fabric = document.getElementById('edit-embroidery-fabric').value;
                const hoop = document.getElementById('edit-embroidery-hoop').value;
                const pattern = document.getElementById('edit-embroidery-pattern-link').value;
                const supplies = document.getElementById('edit-embroidery-supplies-link').value;
                
                if (threadBrand) details.thread_brand = threadBrand;
                if (colors) details.thread_colors = colors;
                if (fabric) details.fabric = fabric;
                if (hoop) details.hoop_size = hoop;
                if (pattern) details.pattern_link = pattern;
                if (supplies) details.supplies_link = supplies;
            } else if (craftType === 'Weaving') {
                const loom = document.getElementById('edit-weaving-loom').value;
                const reed = document.getElementById('edit-weaving-reed').value;
                const warp = document.getElementById('edit-weaving-warp').value;
                const weft = document.getElementById('edit-weaving-weft').value;
                const dimensions = document.getElementById('edit-weaving-dimensions').value;
                const supplies = document.getElementById('edit-weaving-supplies-link').value;
                
                if (loom) details.loom_type = loom;
                if (reed) details.reed_size = reed;
                if (warp) details.warp_yarn = warp;
                if (weft) details.weft_yarn = weft;
                if (dimensions) details.dimensions = dimensions;
                if (supplies) details.supplies_link = supplies;
            } else if (craftType === 'Quilting') {
                const size = document.getElementById('edit-quilting-size').value;
                const batting = document.getElementById('edit-quilting-batting').value;
                const fabric = document.getElementById('edit-quilting-fabric').value;
                const block = document.getElementById('edit-quilting-block').value;
                const pattern = document.getElementById('edit-quilting-pattern-link').value;
                const supplies = document.getElementById('edit-quilting-supplies-link').value;
                
                if (size) details.quilt_size = size;
                if (batting) details.batting_type = batting;
                if (fabric) details.fabric_collection = fabric;
                if (block) details.block_pattern = block;
                if (pattern) details.pattern_link = pattern;
                if (supplies) details.supplies_link = supplies;
            } else if (craftType === 'Leather Work') {
                const type = document.getElementById('edit-leather-type').value;
                const weight = document.getElementById('edit-leather-weight').value;
                const color = document.getElementById('edit-leather-color').value;
                const hardware = document.getElementById('edit-leather-hardware').value;
                const pattern = document.getElementById('edit-leather-pattern-link').value;
                const supplies = document.getElementById('edit-leather-supplies-link').value;
                
                if (type) details.leather_type = type;
                if (weight) details.leather_weight = weight;
                if (color) details.color_finish = color;
                if (hardware) details.hardware = hardware;
                if (pattern) details.pattern_link = pattern;
                if (supplies) details.supplies_link = supplies;
            }
            
            return details;
        }

        function showAddUpdate(projectId) {
            document.getElementById('update-project-id').value = projectId;
            document.getElementById('update-content').value = '';
            document.getElementById('update-photo').value = '';
            document.getElementById('update-photo-preview').style.display = 'none';
            document.getElementById('add-update-modal').classList.add('show');
        }

        function closeAddUpdate() {
            document.getElementById('add-update-modal').classList.remove('show');
        }

        async function handleAddUpdate(event) {
            event.preventDefault();
            
            const projectId = document.getElementById('update-project-id').value;
            const content = document.getElementById('update-content').value;
            const photoInput = document.getElementById('update-photo');
            
            console.log('Adding update for project:', projectId);
            
            let photoUrl = null;
            
            // Upload photo if provided
            if (photoInput.files && photoInput.files[0]) {
                const file = photoInput.files[0];
                const fileExt = file.name.split('.').pop();
                const fileName = `${projectId}/${Date.now()}.${fileExt}`;
                
                console.log('Uploading photo:', fileName);
                
                const { data, error: uploadError } = await supabase.storage
                    .from('project-images')
                    .upload(fileName, file);
                
                if (uploadError) {
                    console.warn('Photo upload failed:', uploadError.message);
                    // Continue without photo
                } else {
                    const { data: urlData } = supabase.storage
                        .from('project-images')
                        .getPublicUrl(fileName);
                    photoUrl = urlData.publicUrl;
                    console.log('Photo uploaded:', photoUrl);
                }
            }
            
            // Create update
            const { data, error } = await supabase.from('project_updates').insert({
                project_id: projectId,
                user_id: currentUser.id,
                content: content,
                photo_url: photoUrl
            }).select();
            
            if (error) {
                console.error('Error creating update:', error);
                alert('Failed to post update: ' + error.message);
                return;
            }
            
            console.log('Update posted successfully:', data);
            
            closeAddUpdate();
            alert('Update posted!');
            
            // Reload everything
            await loadUserData();
            
            // Reopen the project to show the update
            setTimeout(() => {
                showProjectDetail(projectId);
            }, 500);
        }

        // Preview photo before upload
        document.addEventListener('DOMContentLoaded', () => {
            const photoInput = document.getElementById('update-photo');
            if (photoInput) {
                photoInput.addEventListener('change', (e) => {
                    const file = e.target.files[0];
                    if (file) {
                        const reader = new FileReader();
                        reader.onload = (e) => {
                            const preview = document.getElementById('update-photo-preview');
                            preview.querySelector('img').src = e.target.result;
                            preview.style.display = 'block';
                        };
                        reader.readAsDataURL(file);
                    }
                });
            }
        });

        function showEditProfile() {
            document.getElementById('edit-username').value = userProfile.username;
            document.getElementById('edit-fullname').value = userProfile.full_name;
            document.getElementById('edit-bio').value = userProfile.bio || '';
            document.getElementById('edit-location').value = userProfile.location || '';
            document.getElementById('edit-interests').value = userProfile.interests ? userProfile.interests.join(', ') : '';
            
            const preview = document.getElementById('profile-pic-preview');
            if (userProfile.profile_picture_url) {
                preview.innerHTML = `<img src="${userProfile.profile_picture_url}">`;
            } else {
                preview.innerHTML = `<span id="profile-pic-initials">${userProfile.avatar_initials}</span>`;
            }
            
            document.getElementById('edit-profile-modal').classList.add('show');
            hideAllDropdowns();
        }

        function closeEditProfile() {
            document.getElementById('edit-profile-modal').classList.remove('show');
        }

        async function handleProfilePictureChange(event) {
            const file = event.target.files[0];
            if (!file) return;

            const fileExt = file.name.split('.').pop();
            const fileName = `${currentUser.id}/${Date.now()}.${fileExt}`;

            const { error: uploadError } = await supabase.storage
                .from('profile-pictures')
                .upload(fileName, file);

            if (uploadError) {
                console.error('Upload error:', uploadError);
                return;
            }

            const { data: { publicUrl } } = supabase.storage
                .from('profile-pictures')
                .getPublicUrl(fileName);

            document.getElementById('profile-pic-preview').innerHTML = `<img src="${publicUrl}">`;
            userProfile.profile_picture_url = publicUrl;
        }

        async function handleUpdateProfile(event) {
            event.preventDefault();

            const interests = document.getElementById('edit-interests').value
                .split(',')
                .map(i => i.trim())
                .filter(i => i);

            await supabase.from('profiles').update({
                full_name: document.getElementById('edit-fullname').value,
                bio: document.getElementById('edit-bio').value,
                location: document.getElementById('edit-location').value,
                interests: interests,
                profile_picture_url: userProfile.profile_picture_url
            }).eq('id', currentUser.id);

            closeEditProfile();
            await loadUserData();
            alert('Profile updated!');
        }

        function showSettings() {
            document.getElementById('setting-measurement').value = userProfile.measurement_system || 'metric';
            document.getElementById('setting-weight').value = userProfile.weight_unit || 'kg';
            document.getElementById('setting-length').value = userProfile.length_unit || 'cm';
            
            document.getElementById('settings-modal').classList.add('show');
            hideAllDropdowns();
        }

        function closeSettings() {
            document.getElementById('settings-modal').classList.remove('show');
        }

        async function handleUpdateSettings(event) {
            event.preventDefault();

            await supabase.from('profiles').update({
                measurement_system: document.getElementById('setting-measurement').value,
                weight_unit: document.getElementById('setting-weight').value,
                length_unit: document.getElementById('setting-length').value
            }).eq('id', currentUser.id);

            closeSettings();
            await loadUserData();
            alert('Settings saved!');
        }

        async function showUserProfile(userId) {
            // Fetch profile directly from profiles table
            const { data: user, error } = await supabase
                .from('profiles')
                .select('*')
                .eq('id', userId)
                .single();
            
            if (error || !user) {
                console.error('Error loading profile:', error);
                alert('Could not load user profile');
                return;
            }
            
            const isOwnProfile = userId === currentUser.id;

            // Get user's projects
            const { data: userProjects } = await supabase
                .from('projects')
                .select('*')
                .eq('user_id', userId)
                .order('created_at', { ascending: false })
                .limit(6);

            // Get friend count using the same mutual follow logic
            const { data: userIFollow } = await supabase
                .from('follows')
                .select('following_id')
                .eq('follower_id', userId);

            const { data: userFollowMe } = await supabase
                .from('follows')
                .select('follower_id')
                .eq('following_id', userId);

            let friendCount = 0;
            if (userIFollow && userFollowMe) {
                const userIFollowIds = userIFollow.map(f => f.following_id);
                const userFollowMeIds = userFollowMe.map(f => f.follower_id);
                friendCount = userIFollowIds.filter(id => userFollowMeIds.includes(id)).length;
            }

            // Check if we're friends with this user
            const areFriends = await checkIfFriends(currentUser.id, userId);

            const content = `
                <div style="text-align: center;">
                    <div style="width: 120px; height: 120px; border-radius: 50%; background: var(--terracotta); margin: 0 auto 1rem; display: flex; align-items: center; justify-content: center; color: white; font-size: 3rem; font-weight: bold; overflow: hidden;">
                        ${user.profile_picture_url ? 
                            `<img src="${user.profile_picture_url}" style="width: 100%; height: 100%; object-fit: cover;">` : 
                            user.avatar_initials
                        }
                    </div>
                    <h2 style="margin-bottom: 0.5rem;">@${user.username}</h2>
                    <p style="color: var(--text-muted); margin-bottom: 0.5rem; font-size: 1.1rem;">${user.full_name}</p>
                    ${user.location ? `<p style="color: var(--text-muted); margin-bottom: 1rem;">üìç ${user.location}</p>` : ''}
                    ${user.bio ? `<p style="margin: 1.5rem 0; padding: 1rem; background: var(--cream); border-radius: 8px; font-style: italic;">"${user.bio}"</p>` : ''}
                    
                    ${user.interests && user.interests.length > 0 ? `
                        <div style="margin-bottom: 1.5rem;">
                            <h4 style="margin-bottom: 0.75rem; color: var(--dark-brown);">Interests</h4>
                            <div style="display: flex; flex-wrap: wrap; gap: 0.5rem; justify-content: center;">
                                ${user.interests.map(interest => `
                                    <span style="padding: 0.4rem 0.8rem; background: var(--light-beige); border-radius: 20px; font-size: 0.85rem;">${interest}</span>
                                `).join('')}
                            </div>
                        </div>
                    ` : ''}
                    
                    <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 1rem; margin: 2rem 0; padding: 1rem; background: var(--cream); border-radius: 8px;">
                        <div style="text-align: center;">
                            <div style="font-size: 1.5rem; font-weight: bold; color: var(--terracotta);">${user.projects_count}</div>
                            <div style="font-size: 0.8rem; color: var(--text-muted);">Projects</div>
                        </div>
                        <div style="text-align: center;">
                            <div style="font-size: 1.5rem; font-weight: bold; color: var(--terracotta);">${friendCount}</div>
                            <div style="font-size: 0.8rem; color: var(--text-muted);">Friends</div>
                        </div>
                        <div style="text-align: center;">
                            <div style="font-size: 1.5rem; font-weight: bold; color: var(--terracotta);">${user.level}</div>
                            <div style="font-size: 0.8rem; color: var(--text-muted);">Level</div>
                        </div>
                        <div style="text-align: center;">
                            <div style="font-size: 1.5rem; font-weight: bold; color: var(--terracotta);">${user.total_likes_received}</div>
                            <div style="font-size: 0.8rem; color: var(--text-muted);">Likes</div>
                        </div>
                    </div>

                    ${userProjects && userProjects.length > 0 ? `
                        <div style="text-align: left; margin-top: 2rem;">
                            <h3 style="margin-bottom: 1rem; color: var(--dark-brown);">Recent Projects</h3>
                            <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 1rem;">
                                ${userProjects.map(project => `
                                    <div style="background: var(--light-beige); padding: 1rem; border-radius: 8px; cursor: pointer;" onclick="closeProfileView(); showProjectDetail('${project.id}');">
                                        <div style="font-size: 2rem; text-align: center; margin-bottom: 0.5rem;">${getCraftIcon(project.craft_type)}</div>
                                        <h4 style="font-size: 0.9rem; margin-bottom: 0.25rem; text-align: center;">${project.title}</h4>
                                        <div style="text-align: center; font-size: 0.75rem; color: var(--text-muted);">
                                            ‚ù§Ô∏è ${project.likes_count || 0} ¬∑ üí¨ ${project.comments_count || 0}
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    ` : `
                        <div style="padding: 2rem; background: var(--cream); border-radius: 8px; margin-top: 2rem;">
                            <p style="color: var(--text-muted);">No projects yet</p>
                        </div>
                    `}
                    
                    ${!isOwnProfile ? `
                        <div style="display: flex; gap: 1rem; margin-top: 2rem;">
                            <button class="btn btn-primary" style="flex: 1;" onclick="toggleFollow('${userId}'); setTimeout(() => showUserProfile('${userId}'), 500);" id="profile-follow-btn-${userId}">
                                Follow
                            </button>
                            ${areFriends ? `
                                <button class="btn btn-secondary" style="flex: 1;" onclick="closeProfileView(); openChat('${userId}', '${user.username}', '${user.profile_picture_url || ''}', '${user.avatar_initials}');">
                                    üí¨ Message
                                </button>
                            ` : `
                                <div style="flex: 1; padding: 0.75rem; background: var(--light-beige); border-radius: 8px; font-size: 0.85rem; color: var(--text-muted); text-align: center;">
                                    Follow each other to message
                                </div>
                            `}
                        </div>
                    ` : ''}
                </div>
            `;

            document.getElementById('profile-view-content').innerHTML = content;
            document.getElementById('profile-view-modal').classList.add('show');

            // Update follow button state
            if (!isOwnProfile) {
                checkFollowStatusForProfile(userId);
            }
        }

        async function checkFollowStatusForProfile(userId) {
            const { data } = await supabase
                .from('follows')
                .select('id')
                .eq('follower_id', currentUser.id)
                .eq('following_id', userId)
                .single();

            const btn = document.getElementById(`profile-follow-btn-${userId}`);
            if (btn) {
                btn.textContent = data ? 'Following' : 'Follow';
                btn.className = data ? 'btn btn-secondary' : 'btn btn-primary';
            }
        }

        function closeProfileView() {
            document.getElementById('profile-view-modal').classList.remove('show');
        }

        async function loadNotifications() {
            const { data: notifs } = await supabase
                .from('notifications')
                .select('*')
                .eq('user_id', currentUser.id)
                .order('created_at', { ascending: false })
                .limit(20);

            const unreadCount = notifs?.filter(n => !n.is_read).length || 0;
            const badge = document.getElementById('notif-count');
            if (unreadCount > 0) {
                badge.textContent = unreadCount;
                badge.style.display = 'flex';
            } else {
                badge.style.display = 'none';
            }

            const container = document.getElementById('notifications-list');
            
            if (!notifs || notifs.length === 0) {
                container.innerHTML = '<div class="dropdown-item">No notifications yet</div>';
                return;
            }

            container.innerHTML = notifs.map(notif => `
                <div class="dropdown-item ${!notif.is_read ? 'notif-unread' : ''}" onclick="markNotificationRead('${notif.id}')">
                    <div class="notif-content">${notif.content}</div>
                    <div class="notif-time">${getTimeAgo(notif.created_at)}</div>
                </div>
            `).join('');
        }

        async function markNotificationRead(notifId) {
            await supabase
                .from('notifications')
                .update({ is_read: true })
                .eq('id', notifId);
            
            await loadNotifications();
        }

        async function markAllRead() {
            // Update all unread notifications to read
            await supabase
                .from('notifications')
                .update({ is_read: true })
                .eq('user_id', currentUser.id)
                .eq('is_read', false);
            
            // Reload notifications to update UI
            await loadNotifications();
        }

        async function loadConversations() {
            // Get all users I follow
            const { data: iFollow } = await supabase
                .from('follows')
                .select('following_id')
                .eq('follower_id', currentUser.id);

            // Get all users who follow me
            const { data: followMe } = await supabase
                .from('follows')
                .select('follower_id')
                .eq('following_id', currentUser.id);

            if (!iFollow || !followMe || iFollow.length === 0 || followMe.length === 0) {
                document.getElementById('conversations-list').innerHTML = '<div class="dropdown-item">No friends to message yet</div>';
                document.getElementById('chat-area').innerHTML = `
                    <div class="card">
                        <div class="empty-state">
                            <div class="empty-state-icon">üí¨</div>
                            <p>No conversations yet!</p>
                            <p style="font-size: 0.9rem; margin-top: 0.5rem;">Follow someone and have them follow you back to become friends and message each other!</p>
                        </div>
                    </div>
                `;
                return;
            }

            // Find mutual follows (friends)
            const iFollowIds = iFollow.map(f => f.following_id);
            const followMeIds = followMe.map(f => f.follower_id);
            const friendIds = iFollowIds.filter(id => followMeIds.includes(id));

            if (friendIds.length === 0) {
                document.getElementById('conversations-list').innerHTML = '<div class="dropdown-item">No friends to message yet<br><small>Follow someone and have them follow you back!</small></div>';
                document.getElementById('chat-area').innerHTML = `
                    <div class="card">
                        <div class="empty-state">
                            <div class="empty-state-icon">üí¨</div>
                            <p>No friends yet!</p>
                            <p style="font-size: 0.9rem; margin-top: 0.5rem;">Follow someone and have them follow you back to become friends and start messaging!</p>
                        </div>
                    </div>
                `;
                return;
            }

            // Get messages with friends only
            const { data: messages } = await supabase
                .from('messages')
                .select('*, sender:profiles!messages_sender_id_fkey(username, avatar_initials, profile_picture_url), receiver:profiles!messages_receiver_id_fkey(username, avatar_initials, profile_picture_url)')
                .or(`sender_id.eq.${currentUser.id},receiver_id.eq.${currentUser.id}`)
                .order('created_at', { ascending: false });

            const unreadCount = messages?.filter(m => m.receiver_id === currentUser.id && !m.is_read).length || 0;
            const badge = document.getElementById('message-count');
            if (unreadCount > 0) {
                badge.textContent = unreadCount;
                badge.style.display = 'flex';
            } else {
                badge.style.display = 'none';
            }

            const conversations = {};
            messages?.forEach(msg => {
                const otherId = msg.sender_id === currentUser.id ? msg.receiver_id : msg.sender_id;
                // Only include if they're a friend
                if (friendIds.includes(otherId)) {
                    if (!conversations[otherId]) {
                        conversations[otherId] = {
                            lastMessage: msg,
                            unread: 0,
                            otherUser: msg.sender_id === currentUser.id ? msg.receiver : msg.sender
                        };
                    }
                    if (msg.receiver_id === currentUser.id && !msg.is_read) {
                        conversations[otherId].unread++;
                    }
                }
            });

            const conversationList = Object.keys(conversations);

            if (conversationList.length === 0) {
                document.getElementById('conversations-list').innerHTML = '<div class="dropdown-item">No messages yet<br><small>Start chatting with your friends!</small></div>';
                
                // Show friends list in chat area if no conversations yet
                const { data: friendProfiles } = await supabase
                    .from('profiles')
                    .select('*')
                    .in('id', friendIds);
                
                document.getElementById('chat-area').innerHTML = `
                    <div class="card">
                        <h3 style="margin-bottom: 1.5rem;">üí¨ Your Friends (${friendIds.length})</h3>
                        <p style="color: var(--text-muted); margin-bottom: 1.5rem; font-family: -apple-system, sans-serif;">
                            Click on a friend to start chatting!
                        </p>
                        <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 1rem;">
                            ${friendProfiles.map(friend => `
                                <div class="card" style="cursor: pointer; transition: all 0.3s; padding: 1.5rem;" onclick="openChat('${friend.id}', '${friend.username}', '${friend.profile_picture_url || ''}', '${friend.avatar_initials}')">
                                    <div style="display: flex; align-items: center; gap: 1rem;">
                                        <div style="width: 56px; height: 56px; border-radius: 50%; background: var(--terracotta); display: flex; align-items: center; justify-content: center; color: white; font-size: 1.5rem; font-weight: bold; overflow: hidden; flex-shrink: 0;">
                                            ${friend.profile_picture_url ? 
                                                `<img src="${friend.profile_picture_url}" style="width: 100%; height: 100%; object-fit: cover;">` : 
                                                friend.avatar_initials
                                            }
                                        </div>
                                        <div style="flex: 1; min-width: 0;">
                                            <h4 style="margin-bottom: 0.25rem;">@${friend.username}</h4>
                                            <p style="color: var(--text-muted); font-family: -apple-system, sans-serif; font-size: 0.9rem;">${friend.full_name}</p>
                                        </div>
                                        <div style="font-size: 1.5rem;">üí¨</div>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            } else {
                // Update dropdown conversations
                document.getElementById('conversations-list').innerHTML = conversationList.map(userId => {
                    const conv = conversations[userId];
                    return `
                        <div class="dropdown-item ${conv.unread > 0 ? 'notif-unread' : ''}" onclick="hideAllDropdowns(); openChat('${userId}', '${conv.otherUser.username}', '${conv.otherUser.profile_picture_url || ''}', '${conv.otherUser.avatar_initials}')">
                            <div style="display: flex; align-items: center; gap: 0.75rem;">
                                <div style="width: 40px; height: 40px; border-radius: 50%; background: var(--terracotta); display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; overflow: hidden;">
                                    ${conv.otherUser.profile_picture_url ? 
                                        `<img src="${conv.otherUser.profile_picture_url}" style="width: 100%; height: 100%; object-fit: cover;">` : 
                                        conv.otherUser.avatar_initials
                                    }
                                </div>
                                <div style="flex: 1;">
                                    <div style="font-weight: 600;">@${conv.otherUser.username}</div>
                                    <div class="notif-content" style="margin: 0;">${conv.lastMessage.content.substring(0, 50)}${conv.lastMessage.content.length > 50 ? '...' : ''}</div>
                                </div>
                                ${conv.unread > 0 ? `<div style="background: var(--love); color: white; border-radius: 50%; width: 24px; height: 24px; display: flex; align-items: center; justify-content: center; font-size: 0.75rem; font-weight: bold;">${conv.unread}</div>` : ''}
                            </div>
                        </div>
                    `;
                }).join('');

                // Show conversation list in chat area (main Messages section)
                document.getElementById('chat-area').innerHTML = `
                    <div class="card">
                        <h3 style="margin-bottom: 1.5rem;">üí¨ Conversations</h3>
                        <div style="display: flex; flex-direction: column; gap: 1rem;">
                            ${conversationList.map(userId => {
                                const conv = conversations[userId];
                                return `
                                    <div class="card" style="cursor: pointer; background: ${conv.unread > 0 ? 'var(--cream)' : 'white'}; padding: 1.5rem; transition: all 0.3s; border: 2px solid ${conv.unread > 0 ? 'var(--terracotta)' : 'transparent'};" 
                                         onclick="openChat('${userId}', '${conv.otherUser.username}', '${conv.otherUser.profile_picture_url || ''}', '${conv.otherUser.avatar_initials}')"
                                         onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 20px rgba(0,0,0,0.1)'"
                                         onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 2px 8px rgba(0,0,0,0.05)'">
                                        <div style="display: flex; align-items: center; gap: 1rem;">
                                            <div style="width: 64px; height: 64px; border-radius: 50%; background: var(--terracotta); display: flex; align-items: center; justify-content: center; color: white; font-size: 1.75rem; font-weight: bold; overflow: hidden; flex-shrink: 0;">
                                                ${conv.otherUser.profile_picture_url ? 
                                                    `<img src="${conv.otherUser.profile_picture_url}" style="width: 100%; height: 100%; object-fit: cover;">` : 
                                                    conv.otherUser.avatar_initials
                                                }
                                            </div>
                                            <div style="flex: 1; min-width: 0;">
                                                <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem;">
                                                    <h4 style="margin: 0;">@${conv.otherUser.username}</h4>
                                                    ${conv.unread > 0 ? `
                                                        <div style="background: var(--love); color: white; border-radius: 12px; padding: 0.25rem 0.5rem; font-size: 0.75rem; font-weight: bold; font-family: -apple-system, sans-serif;">
                                                            ${conv.unread} new
                                                        </div>
                                                    ` : ''}
                                                </div>
                                                <p style="color: var(--text-muted); font-family: -apple-system, sans-serif; font-size: 0.95rem; margin-bottom: 0.5rem; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">
                                                    ${conv.lastMessage.sender_id === currentUser.id ? 'You: ' : ''}${conv.lastMessage.content}
                                                </p>
                                                <p style="color: var(--text-muted); font-size: 0.8rem; font-family: -apple-system, sans-serif;">
                                                    ${getTimeAgo(conv.lastMessage.created_at)}
                                                </p>
                                            </div>
                                            <div style="font-size: 2rem; flex-shrink: 0;">üí¨</div>
                                        </div>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    </div>
                `;
            }
        }

        async function openChat(friendId, friendUsername, friendPicture, friendInitials) {
            // Verify users are friends before opening chat
            const areFriends = await checkIfFriends(currentUser.id, friendId);
            
            if (!areFriends) {
                alert('You can only message friends! Follow each other to become friends.');
                return;
            }

            currentChatUser = { id: friendId, username: friendUsername, picture: friendPicture, initials: friendInitials };
            
            console.log('Opening chat with:', friendUsername, friendId);
            
            // Update widget header
            const widgetAvatar = document.getElementById('chat-widget-avatar');
            if (friendPicture) {
                widgetAvatar.innerHTML = `<img src="${friendPicture}" alt="${friendUsername}">`;
            } else {
                widgetAvatar.textContent = friendInitials;
            }
            document.getElementById('chat-widget-name').textContent = `@${friendUsername}`;
            
            // Show widget
            document.getElementById('chat-widget').classList.add('show');
            
            // Mark messages as read
            await supabase
                .from('messages')
                .update({ is_read: true })
                .eq('sender_id', friendId)
                .eq('receiver_id', currentUser.id)
                .eq('is_read', false);
            
            // Load messages
            await loadWidgetMessages(friendId);
            
            // Setup real-time - remove old channel first
            if (chatRealtimeChannel) {
                await supabase.removeChannel(chatRealtimeChannel);
            }
            
            // Create new channel for this conversation
            const channelName = `chat-${currentUser.id}-${friendId}`;
            console.log('Setting up real-time channel:', channelName);
            
            chatRealtimeChannel = supabase
                .channel(channelName)
                .on('postgres_changes', {
                    event: 'INSERT',
                    schema: 'public',
                    table: 'messages'
                }, (payload) => {
                    console.log('New message received:', payload);
                    // Check if message is for this conversation
                    if ((payload.new.sender_id === friendId && payload.new.receiver_id === currentUser.id) ||
                        (payload.new.sender_id === currentUser.id && payload.new.receiver_id === friendId)) {
                        loadWidgetMessages(friendId);
                        loadConversations(); // Update conversation list
                    }
                })
                .subscribe((status) => {
                    console.log('Channel status:', status);
                });
        }

        function closeChatWidget() {
            document.getElementById('chat-widget').classList.remove('show');
            if (chatRealtimeChannel) {
                supabase.removeChannel(chatRealtimeChannel);
            }
            currentChatUser = null;
        }

        async function loadWidgetMessages(friendId) {
            console.log('Loading messages with friend:', friendId);
            
            const { data: messages, error } = await supabase
                .from('messages')
                .select('*')
                .or(`and(sender_id.eq.${currentUser.id},receiver_id.eq.${friendId}),and(sender_id.eq.${friendId},receiver_id.eq.${currentUser.id})`)
                .order('created_at', { ascending: true });

            console.log('Messages loaded:', messages?.length || 0, 'messages');
            
            if (error) {
                console.error('Error loading messages:', error);
                return;
            }

            const container = document.getElementById('chat-widget-messages');
            
            if (!messages || messages.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; color: var(--text-muted); padding: 2rem;">
                        <p>No messages yet. Start the conversation! üëã</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = messages.map(msg => {
                const isSent = msg.sender_id === currentUser.id;
                return `
                    <div class="chat-bubble ${isSent ? 'chat-bubble-sent' : 'chat-bubble-received'}">
                        <div>${msg.content}</div>
                        <div class="chat-bubble-time">${getTimeAgo(msg.created_at)}</div>
                    </div>
                `;
            }).join('');
            
            // Scroll to bottom
            setTimeout(() => {
                container.scrollTop = container.scrollHeight;
            }, 100);
        }

        async function sendWidgetMessage(event) {
            event.preventDefault();
            
            console.log('Sending message...');
            
            if (!currentChatUser) {
                console.error('No chat user selected');
                return;
            }
            
            const input = document.getElementById('chat-widget-input');
            const content = input.value.trim();
            
            if (!content) {
                console.log('Empty message');
                return;
            }
            
            console.log('Message content:', content);
            console.log('Sending to:', currentChatUser.id);
            
            // Send message
            const { data, error } = await supabase.from('messages').insert({
                sender_id: currentUser.id,
                receiver_id: currentChatUser.id,
                content: content
            }).select();
            
            if (error) {
                console.error('Error sending message:', error);
                alert('Failed to send message: ' + error.message);
                return;
            }
            
            console.log('Message sent successfully:', data);
            
            // Send notification to receiver
            await supabase.from('notifications').insert({
                user_id: currentChatUser.id,
                type: 'message',
                content: `New message from @${userProfile.username}`,
                related_user_id: currentUser.id
            });
            
            // Clear input
            input.value = '';
            
            // Reload messages
            await loadWidgetMessages(currentChatUser.id);
            
            // Reload conversations list
            await loadConversations();
        }

        async function loadChatMessages(friendId) {
            const { data: messages } = await supabase
                .from('messages')
                .select('*')
                .or(`and(sender_id.eq.${currentUser.id},receiver_id.eq.${friendId}),and(sender_id.eq.${friendId},receiver_id.eq.${currentUser.id})`)
                .order('created_at', { ascending: true });

            const chatArea = document.getElementById('chat-area');
            
            chatArea.innerHTML = `
                <div class="card" style="height: calc(100vh - 250px); display: flex; flex-direction: column;">
                    <div style="display: flex; align-items: center; gap: 1rem; padding-bottom: 1rem; border-bottom: 2px solid var(--light-beige); margin-bottom: 1rem;">
                        <div style="width: 48px; height: 48px; border-radius: 50%; background: var(--terracotta); display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; overflow: hidden; cursor: pointer;" onclick="showUserProfile('${currentChatUser.id}')">
                            ${currentChatUser.picture ? 
                                `<img src="${currentChatUser.picture}" style="width: 100%; height: 100%; object-fit: cover;">` : 
                                currentChatUser.initials
                            }
                        </div>
                        <div style="flex: 1;">
                            <h3 style="margin: 0; cursor: pointer;" onclick="showUserProfile('${currentChatUser.id}')">@${currentChatUser.username}</h3>
                        </div>
                        <button onclick="showSection('chat'); currentChatUser = null; loadConversations();" style="background: none; border: none; font-size: 1.5rem; cursor: pointer; color: var(--text-muted);">‚úï</button>
                    </div>
                    
                    <div id="chat-messages" style="flex: 1; overflow-y: auto; padding: 1rem 0; display: flex; flex-direction: column; gap: 1rem;">
                        ${messages.length === 0 ? `
                            <div style="text-align: center; color: var(--text-muted); padding: 2rem;">
                                <p>No messages yet. Start the conversation! üëã</p>
                            </div>
                        ` : messages.map(msg => {
                            const isSent = msg.sender_id === currentUser.id;
                            return `
                                <div style="display: flex; justify-content: ${isSent ? 'flex-end' : 'flex-start'};">
                                    <div style="max-width: 70%; padding: 0.75rem 1rem; border-radius: 16px; background: ${isSent ? 'var(--terracotta)' : 'var(--light-beige)'}; color: ${isSent ? 'white' : 'var(--text-dark)'};">
                                        <div style="font-family: -apple-system, sans-serif; word-wrap: break-word;">${msg.content}</div>
                                        <div style="font-size: 0.7rem; margin-top: 0.25rem; opacity: 0.7;">${getTimeAgo(msg.created_at)}</div>
                                    </div>
                                </div>
                            `;
                        }).join('')}
                    </div>
                    
                    <form onsubmit="sendMessage(event, '${friendId}')" style="display: flex; gap: 0.75rem; padding-top: 1rem; border-top: 2px solid var(--light-beige);">
                        <input type="text" id="message-input" placeholder="Type a message..." style="flex: 1; border: 2px solid var(--light-beige); padding: 0.75rem 1rem; border-radius: 24px; font-family: -apple-system, sans-serif;" required>
                        <button type="submit" class="btn btn-primary" style="border-radius: 24px; padding: 0.75rem 2rem;">Send</button>
                    </form>
                </div>
            `;
            
            setTimeout(() => {
                const messagesDiv = document.getElementById('chat-messages');
                if (messagesDiv) {
                    messagesDiv.scrollTop = messagesDiv.scrollHeight;
                }
            }, 100);
        }

        async function sendMessage(event, receiverId) {
            event.preventDefault();
            
            const input = document.getElementById('message-input');
            const content = input.value.trim();
            
            if (!content) return;
            
            await supabase.from('messages').insert({
                sender_id: currentUser.id,
                receiver_id: receiverId,
                content: content
            });
            
            input.value = '';
            await loadChatMessages(receiverId);
        }

        function startRealtimeUpdates() {
            supabase
                .channel('notifications')
                .on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'notifications', filter: `user_id=eq.${currentUser.id}` }, () => {
                    loadNotifications();
                })
                .subscribe();
            
            supabase
                .channel('messages-updates')
                .on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'messages', filter: `receiver_id=eq.${currentUser.id}` }, () => {
                    loadConversations();
                })
                .subscribe();
        }

        function toggleNotifications() {
            hideAllDropdowns();
            document.getElementById('notifications-dropdown').classList.toggle('show');
        }

        function toggleMessages() {
            hideAllDropdowns();
            document.getElementById('messages-dropdown').classList.toggle('show');
        }

        function toggleUserMenu() {
            hideAllDropdowns();
            document.getElementById('user-menu').classList.toggle('show');
        }

        function hideAllDropdowns() {
            document.querySelectorAll('.dropdown').forEach(d => d.classList.remove('show'));
        }

        function showSection(sectionId) {
            document.querySelectorAll('.content-section').forEach(s => s.classList.remove('active'));
            document.getElementById(sectionId).classList.add('active');
            document.querySelectorAll('.nav-item').forEach(item => item.classList.remove('active'));
            
            const navItems = document.querySelectorAll('.nav-item');
            navItems.forEach(item => {
                const onclickAttr = item.getAttribute('onclick');
                if (onclickAttr && onclickAttr.includes(`'${sectionId}'`)) {
                    item.classList.add('active');
                }
            });
            
            if (sectionId === 'chat' && !currentChatUser) {
                loadConversations();
            }
        }

        async function handleLogout() {
            await supabase.auth.signOut();
            window.location.href = 'login.html';
        }

        function getCraftIcon(craftType) {
            const icons = { 'Sewing': 'üßµ', 'Knitting': 'üß∂', 'Crochet': 'ü™°', 'Weaving': 'üßµ', 'Embroidery': 'ü™°', 'Quilting': 'üßµ', 'Leather Work': 'üëú', 'Other': 'üé®' };
            return icons[craftType] || 'üé®';
        }

        function formatMentions(text) {
            return text.replace(/@(\w+)/g, '<span class="mention">@$1</span>');
        }

        function getTimeAgo(timestamp) {
            const now = new Date();
            const past = new Date(timestamp);
            const diffMs = now - past;
            const diffMins = Math.floor(diffMs / 60000);
            const diffHours = Math.floor(diffMs / 3600000);
            const diffDays = Math.floor(diffMs / 86400000);

            if (diffMins < 1) return 'Just now';
            if (diffMins < 60) return `${diffMins}m ago`;
            if (diffHours < 24) return `${diffHours}h ago`;
            return `${diffDays}d ago`;
        }

        document.addEventListener('click', function(event) {
            if (!event.target.closest('.icon-btn') && !event.target.closest('.user-profile') && !event.target.closest('.dropdown')) {
                hideAllDropdowns();
            }
        });

        checkAuth();
    </script>
</body>
</html><!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Craft Club | Your Creative Space</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --terracotta: #A0695F;
            --dark-brown: #3C2F2F;
            --cream: #F5F1E8;
            --light-beige: #EDE8DC;
            --text-dark: #3C2F2F;
            --text-muted: #8B7E74;
            --gold: #D4AF37;
            --success: #5C8B5A;
            --highlight: #E8C5B5;
            --love: #E74C3C;
        }

        body {
            font-family: 'Georgia', serif;
            color: var(--text-dark);
            line-height: 1.6;
            background: var(--cream);
        }

        header {
            position: fixed;
            top: 0;
            width: 100%;
            z-index: 1000;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            padding: 1rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid rgba(0,0,0,0.05);
        }

        .logo {
            font-size: 1.125rem;
            font-weight: 400;
            letter-spacing: 0.02em;
            color: var(--dark-brown);
        }

        .user-nav {
            display: flex;
            align-items: center;
            gap: 1.5rem;
        }

        .icon-btn {
            position: relative;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: var(--cream);
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.25rem;
            transition: all 0.3s;
        }

        .icon-btn:hover {
            background: var(--highlight);
            transform: scale(1.1);
        }

        .badge-count {
            position: absolute;
            top: -5px;
            right: -5px;
            background: var(--love);
            color: white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            font-size: 0.7rem;
            display: flex;
            align-items: center;
            justify-content: center;
            font-family: -apple-system, sans-serif;
            font-weight: bold;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }

        .avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: var(--terracotta);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            cursor: pointer;
        }

        .avatar img {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            object-fit: cover;
        }

        .user-profile {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            cursor: pointer;
            position: relative;
        }

        .dropdown {
            position: absolute;
            top: 100%;
            right: 0;
            margin-top: 0.5rem;
            background: white;
            border-radius: 12px;
            box-shadow: 0 8px 24px rgba(0,0,0,0.15);
            min-width: 320px;
            max-width: 400px;
            max-height: 500px;
            overflow-y: auto;
            display: none;
            z-index: 1001;
        }

        .dropdown.show { display: block; }

        .dropdown-header {
            padding: 1.25rem;
            border-bottom: 2px solid var(--light-beige);
            font-family: -apple-system, sans-serif;
            font-weight: 600;
            font-size: 1.1rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .dropdown-item {
            padding: 1rem 1.25rem;
            border-bottom: 1px solid var(--light-beige);
            cursor: pointer;
            transition: background 0.3s;
            font-family: -apple-system, sans-serif;
        }

        .dropdown-item:hover {
            background: var(--cream);
        }

        .dropdown-item:last-child {
            border-bottom: none;
        }

        .notif-content {
            font-size: 0.9rem;
            margin-bottom: 0.25rem;
        }

        .notif-time {
            font-size: 0.75rem;
            color: var(--text-muted);
        }

        .notif-unread {
            background: #E8F5E9;
        }

        .main-container {
            margin-top: 80px;
            display: flex;
            min-height: calc(100vh - 80px);
        }

        .sidebar {
            width: 280px;
            background: white;
            padding: 2rem 1.5rem;
            border-right: 1px solid rgba(0,0,0,0.05);
            position: fixed;
            height: calc(100vh - 80px);
            overflow-y: auto;
        }

        .nav-item {
            padding: 0.75rem 1rem;
            color: var(--text-dark);
            text-decoration: none;
            border-radius: 8px;
            transition: all 0.3s;
            font-family: -apple-system, sans-serif;
            font-size: 0.95rem;
            display: flex;
            align-items: center;
            gap: 0.75rem;
            cursor: pointer;
            margin-bottom: 0.5rem;
        }

        .nav-item:hover, .nav-item.active {
            background: var(--light-beige);
            color: var(--terracotta);
        }

        .content {
            margin-left: 280px;
            flex: 1;
            padding: 2rem 3rem;
        }

        .content-section {
            display: none;
        }

        .content-section.active {
            display: block;
        }

        .card {
            background: white;
            padding: 2rem;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
            margin-bottom: 2rem;
        }

        .card h3 {
            margin-bottom: 1.5rem;
            color: var(--dark-brown);
            font-size: 1.25rem;
        }

        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 2rem;
            margin-bottom: 2rem;
        }

        .quick-stats {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 1rem;
        }

        .stat-box {
            text-align: center;
            padding: 1.5rem 1rem;
            background: var(--cream);
            border-radius: 8px;
            transition: transform 0.3s;
        }

        .stat-box:hover {
            transform: translateY(-4px);
        }

        .stat-icon {
            font-size: 2rem;
            margin-bottom: 0.5rem;
        }

        .stat-value {
            font-size: 1.75rem;
            font-weight: bold;
            color: var(--terracotta);
        }

        .stat-label {
            font-size: 0.85rem;
            color: var(--text-muted);
            font-family: -apple-system, sans-serif;
        }

        .project-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 1.5rem;
        }

        .project-card {
            background: white;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
            cursor: pointer;
            transition: all 0.3s;
            position: relative;
        }

        .project-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 6px 20px rgba(0,0,0,0.1);
        }

        .project-image {
            width: 100%;
            height: 200px;
            background: linear-gradient(135deg, var(--light-beige), var(--highlight));
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 3rem;
            position: relative;
        }

        .like-btn {
            position: absolute;
            bottom: 10px;
            right: 10px;
            width: 48px;
            height: 48px;
            border-radius: 50%;
            background: white;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            transition: all 0.3s;
            z-index: 10;
        }

        .like-btn:hover {
            transform: scale(1.1);
        }

        .like-btn.liked {
            animation: heartBeat 0.5s;
        }

        @keyframes heartBeat {
            0%, 100% { transform: scale(1); }
            25% { transform: scale(1.3); }
            50% { transform: scale(1.1); }
        }

        .follow-btn-small {
            position: absolute;
            top: 10px;
            right: 10px;
            padding: 0.4rem 0.8rem;
            background: white;
            border: 1px solid var(--terracotta);
            color: var(--terracotta);
            border-radius: 20px;
            font-size: 0.8rem;
            cursor: pointer;
            font-family: -apple-system, sans-serif;
            z-index: 10;
            transition: all 0.3s;
        }

        .follow-btn-small:hover {
            background: var(--terracotta);
            color: white;
        }

        .follow-btn-small.following {
            background: var(--terracotta);
            color: white;
        }

        .project-info {
            padding: 1.25rem;
        }

        .project-title {
            font-size: 1.1rem;
            margin-bottom: 0.5rem;
            color: var(--dark-brown);
        }

        .project-meta {
            display: flex;
            gap: 1rem;
            font-size: 0.85rem;
            color: var(--text-muted);
            font-family: -apple-system, sans-serif;
        }

        .user-mini {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 0.75rem;
        }

        .user-mini-avatar {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            background: var(--terracotta);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.7rem;
            font-weight: bold;
        }

        .user-mini-avatar img {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            object-fit: cover;
        }

        .feed-item {
            background: white;
            padding: 1.5rem;
            border-radius: 12px;
            margin-bottom: 1rem;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }

        .feed-header {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .feed-avatar {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            background: var(--terracotta);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            cursor: pointer;
        }

        .feed-avatar img {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            object-fit: cover;
        }

        .feed-content {
            font-family: -apple-system, sans-serif;
            line-height: 1.6;
        }

        .feed-time {
            font-size: 0.8rem;
            color: var(--text-muted);
            margin-top: 0.5rem;
        }

        .mention {
            color: var(--terracotta);
            font-weight: 600;
            cursor: pointer;
        }

        .mention:hover {
            text-decoration: underline;
        }

        .btn {
            padding: 0.75rem 2rem;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-family: -apple-system, sans-serif;
            font-size: 0.95rem;
            transition: all 0.3s;
            display: inline-block;
            text-align: center;
        }

        .btn-primary {
            background: var(--terracotta);
            color: white;
        }

        .btn-primary:hover {
            background: var(--dark-brown);
            transform: translateY(-2px);
        }

        .btn-secondary {
            background: var(--light-beige);
            color: var(--dark-brown);
        }

        .btn-danger {
            background: #C75B5B;
            color: white;
        }

        .btn-small {
            padding: 0.5rem 1rem;
            font-size: 0.85rem;
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        label {
            display: block;
            font-family: -apple-system, sans-serif;
            font-size: 0.9rem;
            color: var(--dark-brown);
            margin-bottom: 0.5rem;
            font-weight: 500;
        }

        input, textarea, select {
            width: 100%;
            padding: 0.875rem 1rem;
            border: 2px solid var(--light-beige);
            border-radius: 8px;
            font-family: -apple-system, sans-serif;
            font-size: 1rem;
            transition: all 0.3s;
        }

        input:focus, textarea:focus, select:focus {
            outline: none;
            border-color: var(--terracotta);
        }

        textarea {
            min-height: 120px;
            resize: vertical;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 2000;
            justify-content: center;
            align-items: center;
            padding: 2rem;
            overflow-y: auto;
        }

        .modal.show { display: flex; }

        .modal-content {
            background: white;
            border-radius: 16px;
            max-width: 700px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            padding: 2rem;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
            padding-bottom: 1rem;
            border-bottom: 2px solid var(--light-beige);
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 2rem;
            cursor: pointer;
            color: var(--text-muted);
        }

        .profile-picture-upload {
            text-align: center;
            margin-bottom: 2rem;
        }

        .profile-picture-preview {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            margin: 0 auto 1rem;
            background: var(--terracotta);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 3rem;
            font-weight: bold;
            overflow: hidden;
        }

        .profile-picture-preview img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .craft-specific-fields {
            display: none;
        }

        .empty-state {
            text-align: center;
            padding: 3rem 2rem;
            color: var(--text-muted);
        }

        .empty-state-icon {
            font-size: 4rem;
            margin-bottom: 1rem;
            opacity: 0.5;
        }

        .loading {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 3rem;
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid var(--light-beige);
            border-top-color: var(--terracotta);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Floating Chat Widget */
        .chat-widget {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 380px;
            max-height: 600px;
            background: white;
            border-radius: 16px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.15);
            display: none;
            flex-direction: column;
            z-index: 2001;
            overflow: hidden;
        }

        .chat-widget.show {
            display: flex;
        }

        .chat-widget-header {
            background: var(--terracotta);
            color: white;
            padding: 1rem 1.25rem;
            display: flex;
            align-items: center;
            gap: 0.75rem;
            cursor: move;
        }

        .chat-widget-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: white;
            color: var(--terracotta);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            overflow: hidden;
        }

        .chat-widget-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .chat-widget-info {
            flex: 1;
        }

        .chat-widget-name {
            font-weight: 600;
            font-size: 1rem;
        }

        .chat-widget-status {
            font-size: 0.75rem;
            opacity: 0.9;
        }

        .chat-widget-close {
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            font-size: 1.25rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
        }

        .chat-widget-close:hover {
            background: rgba(255,255,255,0.3);
        }

        .chat-widget-messages {
            flex: 1;
            overflow-y: auto;
            padding: 1rem;
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
            background: var(--cream);
            max-height: 400px;
        }

        .chat-widget-input-area {
            padding: 1rem;
            border-top: 2px solid var(--light-beige);
            background: white;
        }

        .chat-widget-input-form {
            display: flex;
            gap: 0.5rem;
        }

        .chat-widget-input {
            flex: 1;
            padding: 0.75rem 1rem;
            border: 2px solid var(--light-beige);
            border-radius: 24px;
            font-family: -apple-system, sans-serif;
            font-size: 0.9rem;
        }

        .chat-widget-send {
            width: 44px;
            height: 44px;
            border-radius: 50%;
            background: var(--terracotta);
            border: none;
            color: white;
            font-size: 1.25rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
        }

        .chat-widget-send:hover {
            background: var(--dark-brown);
            transform: scale(1.05);
        }

        .chat-bubble {
            max-width: 70%;
            padding: 0.75rem 1rem;
            border-radius: 16px;
            word-wrap: break-word;
            animation: slideIn 0.3s ease;
        }

        .chat-bubble-sent {
            align-self: flex-end;
            background: var(--terracotta);
            color: white;
            border-bottom-right-radius: 4px;
        }

        .chat-bubble-received {
            align-self: flex-start;
            background: white;
            color: var(--text-dark);
            border-bottom-left-radius: 4px;
        }

        .chat-bubble-time {
            font-size: 0.7rem;
            margin-top: 0.25rem;
            opacity: 0.7;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @media (max-width: 768px) {
            .sidebar {
                position: static;
                width: 100%;
                height: auto;
            }

            .content {
                margin-left: 0;
                padding: 1.5rem;
            }

            .dashboard-grid, .project-grid {
                grid-template-columns: 1fr;
            }

            .chat-widget {
                width: calc(100vw - 20px);
                right: 10px;
                bottom: 10px;
                max-height: 500px;
            }
        }
    </style>
</head>
<body>
    <header>
        <a href="index.html" style="text-decoration: none;">
            <div class="logo">üé® Craft Club</div>
        </a>
        <div class="user-nav">
            <button class="icon-btn" onclick="toggleNotifications()">
                üîî
                <span class="badge-count" id="notif-count" style="display: none;">0</span>
            </button>
            <button class="icon-btn" onclick="toggleMessages()">
                üí¨
                <span class="badge-count" id="message-count" style="display: none;">0</span>
            </button>
            <div class="user-profile" onclick="toggleUserMenu()">
                <div class="avatar" id="header-avatar">...</div>
            </div>

            <div class="dropdown" id="notifications-dropdown">
                <div class="dropdown-header">
                    Notifications
                    <button onclick="markAllRead()" style="background: none; border: none; color: var(--terracotta); cursor: pointer; font-size: 0.85rem;">Mark all read</button>
                </div>
                <div id="notifications-list">
                    <div class="loading"><div class="spinner"></div></div>
                </div>
            </div>

            <div class="dropdown" id="messages-dropdown">
                <div class="dropdown-header">Messages</div>
                <div id="conversations-list">
                    <div class="loading"><div class="spinner"></div></div>
                </div>
            </div>

            <div class="dropdown" id="user-menu" style="min-width: 200px;">
                <div class="dropdown-item" onclick="showSection('dashboard'); hideAllDropdowns();">üë§ Dashboard</div>
                <div class="dropdown-item" onclick="showEditProfile()">‚úèÔ∏è Edit Profile</div>
                <div class="dropdown-item" onclick="showSettings()">‚öôÔ∏è Settings</div>
                <div class="dropdown-item" onclick="handleLogout()">üö™ Logout</div>
            </div>
        </div>
    </header>

    <div class="main-container">
        <aside class="sidebar">
            <nav>
                <a class="nav-item active" onclick="showSection('dashboard')">üè† Dashboard</a>
                <a class="nav-item" onclick="showSection('my-projects')">üé® My Projects</a>
                <a class="nav-item" onclick="showSection('community')">üåä Community Feed</a>
                <a class="nav-item" onclick="showSection('friends')">üí´ Friends</a>
                <a class="nav-item" onclick="showSection('members')">üîç Find Makers</a>
                <a class="nav-item" onclick="showSection('chat')">üí¨ Messages</a>
                <a class="nav-item" onclick="showSection('my-store')">üõçÔ∏è My Store</a>
            </nav>
        </aside>

        <main class="content">
            <section id="dashboard" class="content-section active">
                <h1 style="margin-bottom: 2rem;" id="welcome-text">Welcome! üëã</h1>

                <div class="dashboard-grid">
                    <div class="card">
                        <h3>üìä Your Stats</h3>
                        <div class="quick-stats">
                            <div class="stat-box">
                                <div class="stat-icon">üé®</div>
                                <div class="stat-value" id="stat-projects">0</div>
                                <div class="stat-label">Projects</div>
                            </div>
                            <div class="stat-box">
                                <div class="stat-icon">‚ù§Ô∏è</div>
                                <div class="stat-value" id="stat-likes">0</div>
                                <div class="stat-label">Total Likes</div>
                            </div>
                            <div class="stat-box">
                                <div class="stat-icon">üë•</div>
                                <div class="stat-value" id="stat-friends">0</div>
                                <div class="stat-label">Friends</div>
                            </div>
                            <div class="stat-box">
                                <div class="stat-icon">üî•</div>
                                <div class="stat-value" id="stat-streak">0</div>
                                <div class="stat-label">Day Streak</div>
                            </div>
                        </div>
                    </div>
                </div>

                <button class="btn btn-primary" onclick="showAddProject()">+ Add New Project</button>
            </section>

            <section id="my-projects" class="content-section">
                <div style="display: flex; justify-content: space-between; margin-bottom: 2rem;">
                    <h1>üé® My Projects</h1>
                    <button class="btn btn-primary" onclick="showAddProject()">+ New Project</button>
                </div>
                <div id="my-projects-container"><div class="loading"><div class="spinner"></div></div></div>
            </section>

            <section id="community" class="content-section">
                <h1 style="margin-bottom: 2rem;">üåä Community Feed</h1>
                <div id="community-feed"><div class="loading"><div class="spinner"></div></div></div>
            </section>

            <section id="friends" class="content-section">
                <h1 style="margin-bottom: 2rem;">üí´ Your Friends</h1>
                <div id="friends-container"><div class="loading"><div class="spinner"></div></div></div>
            </section>

            <section id="members" class="content-section">
                <h1 style="margin-bottom: 2rem;">üîç Find Makers</h1>
                <input type="text" id="member-search" placeholder="Search by name or username..." style="margin-bottom: 2rem;" oninput="searchMembers()">
                <div id="members-container"><div class="loading"><div class="spinner"></div></div></div>
            </section>

            <section id="chat" class="content-section">
                <h1 style="margin-bottom: 2rem;">üí¨ Messages</h1>
                <div id="chat-area"></div>
            </section>
<!-- YOUR STORE SECTION - Add this to your member area HTML -->
<!-- Place this in the tab content area alongside other tabs -->

<div id="my-store" class="tab-content">
    <div class="tab-header">
        <div>
            <h2>Your Store</h2>
            <p style="color: var(--text-muted); margin-top: 0.5rem;">Share your craft with the world. Create listings for handmade items, digital patterns, or special travel finds.</p>
        </div>
        <button class="btn btn-primary" onclick="openNewProductModal()">+ Create New Listing</button>
    </div>

    <!-- Store Stats -->
    <div class="stats-row" style="margin: 2rem 0;">
        <div class="stat-box">
            <div class="stat-number" id="totalProducts">0</div>
            <div class="stat-label">Total Listings</div>
        </div>
        <div class="stat-box">
            <div class="stat-number" id="activeProducts">0</div>
            <div class="stat-label">Active</div>
        </div>
        <div class="stat-box">
            <div class="stat-number" id="totalOrders">0</div>
            <div class="stat-label">Orders</div>
        </div>
        <div class="stat-box">
            <div class="stat-number" id="totalRevenue">‚Ç¨0</div>
            <div class="stat-label">Revenue</div>
        </div>
    </div>

    <!-- Products List -->
    <div class="section-card">
        <h3 style="margin-bottom: 1.5rem;">Your Listings</h3>
        <div id="productsListContainer">
            <div class="empty-state">
                <div class="empty-icon">üõçÔ∏è</div>
                <h4>No listings yet</h4>
                <p>Create your first listing to start selling on the Makers' Market</p>
                <button class="btn btn-primary" onclick="openNewProductModal()" style="margin-top: 1rem;">Create First Listing</button>
            </div>
        </div>
    </div>
</div>

<!-- Product Modal -->
<div id="productModal" class="modal">
    <div class="modal-content" style="max-width: 900px;">
        <div class="modal-header">
            <h2 id="productModalTitle">Create New Listing</h2>
            <button class="close-btn" onclick="closeProductModal()">√ó</button>
        </div>

        <form id="productForm" onsubmit="saveProduct(event)">
            <input type="hidden" id="productId">

            <!-- Basic Information -->
            <div class="form-section">
                <h3 class="form-section-title">Basic Information</h3>
                
                <div class="form-group">
                    <label>Title *</label>
                    <input type="text" id="productTitle" required placeholder="e.g., Handwoven Crochet Blanket">
                </div>

                <div class="form-group">
                    <label>Description *</label>
                    <textarea id="productDescription" rows="4" required placeholder="Tell the story behind your creation. What makes it special?"></textarea>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label>Price *</label>
                        <input type="number" id="productPrice" step="0.01" min="0" required placeholder="0.00">
                    </div>
                    <div class="form-group">
                        <label>Currency *</label>
                        <select id="productCurrency" required>
                            <option value="EUR">EUR (‚Ç¨)</option>
                            <option value="USD">USD ($)</option>
                            <option value="GBP">GBP (¬£)</option>
                        </select>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label>Category *</label>
                        <select id="productCategory" required>
                            <option value="">Select category...</option>
                            <option value="crochet">Crochet</option>
                            <option value="sewing">Sewing</option>
                            <option value="leatherwork">Leatherwork</option>
                            <option value="knitting">Knitting</option>
                            <option value="embroidery">Embroidery</option>
                            <option value="woodwork">Woodwork</option>
                            <option value="pottery">Pottery</option>
                            <option value="weaving">Weaving</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Tags (comma-separated)</label>
                        <input type="text" id="productTags" placeholder="e.g., vintage, handmade, organic">
                    </div>
                </div>
            </div>

            <!-- Product Type -->
            <div class="form-section">
                <h3 class="form-section-title">Product Type</h3>
                
                <div class="product-type-selector">
                    <div class="product-type-option" onclick="selectProductType('handmade')">
                        <input type="radio" name="productType" value="handmade" id="typeHandmade" checked>
                        <label for="typeHandmade">
                            <div class="type-icon">‚úã</div>
                            <div class="type-title">Handmade</div>
                            <div class="type-desc">Custom made-to-order items</div>
                        </label>
                    </div>
                    
                    <div class="product-type-option" onclick="selectProductType('digital')">
                        <input type="radio" name="productType" value="digital" id="typeDigital">
                        <label for="typeDigital">
                            <div class="type-icon">üìÑ</div>
                            <div class="type-title">Digital</div>
                            <div class="type-desc">Patterns, guides, templates</div>
                        </label>
                    </div>
                    
                    <div class="product-type-option" onclick="selectProductType('travel_find')">
                        <input type="radio" name="productType" value="travel_find" id="typeTravelFind">
                        <label for="typeTravelFind">
                            <div class="type-icon">‚úàÔ∏è</div>
                            <div class="type-title">Travel Find</div>
                            <div class="type-desc">Limited batch orders with deadline</div>
                        </label>
                    </div>
                </div>
            </div>

            <!-- Type-Specific Fields -->
            
            <!-- Handmade Fields -->
            <div id="handmadeFields" class="form-section type-fields">
                <h3 class="form-section-title">Made-to-Order Details</h3>
                <div class="form-group">
                    <label>Production Time (days) *</label>
                    <input type="number" id="productionTime" min="1" placeholder="e.g., 10">
                    <small style="display: block; margin-top: 0.5rem; color: var(--text-muted);">How many days do you need to create this item?</small>
                </div>
                <div class="form-group">
                    <label>
                        <input type="checkbox" id="acceptsCustom">
                        I accept custom orders and modifications
                    </label>
                </div>
            </div>

            <!-- Digital Fields -->
            <div id="digitalFields" class="form-section type-fields" style="display: none;">
                <h3 class="form-section-title">Digital Product Details</h3>
                <div class="form-group">
                    <label>Digital File URL *</label>
                    <input type="url" id="digitalFileUrl" placeholder="https://your-storage.com/file.pdf">
                    <small style="display: block; margin-top: 0.5rem; color: var(--text-muted);">Upload your file to cloud storage and paste the link here</small>
                </div>
            </div>

            <!-- Travel Find Fields -->
            <div id="travelFindFields" class="form-section type-fields" style="display: none;">
                <h3 class="form-section-title">Travel Find Details</h3>
                <p style="color: var(--text-muted); margin-bottom: 1.5rem;">Perfect for items you're bringing back from travels. Set a deadline and quantity limit for batch orders.</p>
                
                <div class="form-row">
                    <div class="form-group">
                        <label>Order Until Date *</label>
                        <input type="datetime-local" id="orderUntilDate">
                        <small style="display: block; margin-top: 0.5rem; color: var(--text-muted);">Last day to accept orders</small>
                    </div>
                    <div class="form-group">
                        <label>Maximum Quantity *</label>
                        <input type="number" id="maxQuantity" min="1" placeholder="e.g., 20">
                        <small style="display: block; margin-top: 0.5rem; color: var(--text-muted);">How many items available?</small>
                    </div>
                </div>
            </div>

            <!-- Images -->
            <div class="form-section">
                <h3 class="form-section-title">Product Images</h3>
                <p style="color: var(--text-muted); margin-bottom: 1.5rem;">Upload up to 5 images. First image will be the main thumbnail.</p>
                
                <div class="image-upload-grid" id="imageUploadGrid">
                    <div class="image-upload-slot" onclick="document.getElementById('imageInput1').click()">
                        <input type="file" id="imageInput1" accept="image/*" style="display: none;" onchange="handleImageUpload(0, event)">
                        <div class="upload-placeholder">
                            <div class="upload-icon">üì∑</div>
                            <div>Main Image</div>
                        </div>
                        <img id="imagePreview1" class="image-preview">
                        <button type="button" class="remove-image-btn" onclick="removeImage(0); event.stopPropagation();" style="display: none;">√ó</button>
                    </div>
                    
                    <div class="image-upload-slot" onclick="document.getElementById('imageInput2').click()">
                        <input type="file" id="imageInput2" accept="image/*" style="display: none;" onchange="handleImageUpload(1, event)">
                        <div class="upload-placeholder">
                            <div class="upload-icon">üì∑</div>
                            <div>Image 2</div>
                        </div>
                        <img id="imagePreview2" class="image-preview">
                        <button type="button" class="remove-image-btn" onclick="removeImage(1); event.stopPropagation();" style="display: none;">√ó</button>
                    </div>
                    
                    <div class="image-upload-slot" onclick="document.getElementById('imageInput3').click()">
                        <input type="file" id="imageInput3" accept="image/*" style="display: none;" onchange="handleImageUpload(2, event)">
                        <div class="upload-placeholder">
                            <div class="upload-icon">üì∑</div>
                            <div>Image 3</div>
                        </div>
                        <img id="imagePreview3" class="image-preview">
                        <button type="button" class="remove-image-btn" onclick="removeImage(2); event.stopPropagation();" style="display: none;">√ó</button>
                    </div>
                    
                    <div class="image-upload-slot" onclick="document.getElementById('imageInput4').click()">
                        <input type="file" id="imageInput4" accept="image/*" style="display: none;" onchange="handleImageUpload(3, event)">
                        <div class="upload-placeholder">
                            <div class="upload-icon">üì∑</div>
                            <div>Image 4</div>
                        </div>
                        <img id="imagePreview4" class="image-preview">
                        <button type="button" class="remove-image-btn" onclick="removeImage(3); event.stopPropagation();" style="display: none;">√ó</button>
                    </div>
                    
                    <div class="image-upload-slot" onclick="document.getElementById('imageInput5').click()">
                        <input type="file" id="imageInput5" accept="image/*" style="display: none;" onchange="handleImageUpload(4, event)">
                        <div class="upload-placeholder">
                            <div class="upload-icon">üì∑</div>
                            <div>Image 5</div>
                        </div>
                        <img id="imagePreview5" class="image-preview">
                        <button type="button" class="remove-image-btn" onclick="removeImage(4); event.stopPropagation();" style="display: none;">√ó</button>
                    </div>
                </div>
            </div>

            <!-- Status -->
            <div class="form-section">
                <div class="form-group">
                    <label>
                        <input type="checkbox" id="productActive" checked>
                        Active (visible in marketplace)
                    </label>
                </div>
            </div>

            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="closeProductModal()">Cancel</button>
                <button type="submit" class="btn btn-primary">Save Listing</button>
            </div>
        </form>
    </div>
</div>

<!-- Add these styles to your existing CSS -->
<style>
/* Store Section Styles */
.product-type-selector {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 1rem;
    margin-top: 1rem;
}

.product-type-option {
    position: relative;
    cursor: pointer;
}

.product-type-option input[type="radio"] {
    position: absolute;
    opacity: 0;
}

.product-type-option label {
    display: block;
    padding: 1.5rem;
    border: 2px solid var(--border);
    border-radius: 12px;
    text-align: center;
    cursor: pointer;
    transition: all 0.3s;
}

.product-type-option input[type="radio"]:checked + label {
    border-color: var(--terracotta);
    background: rgba(160, 105, 95, 0.05);
}

.type-icon {
    font-size: 2rem;
    margin-bottom: 0.5rem;
}

.type-title {
    font-weight: 600;
    margin-bottom: 0.25rem;
    color: var(--text-dark);
}

.type-desc {
    font-size: 0.875rem;
    color: var(--text-muted);
}

.image-upload-grid {
    display: grid;
    grid-template-columns: repeat(5, 1fr);
    gap: 1rem;
}

.image-upload-slot {
    aspect-ratio: 1;
    border: 2px dashed var(--border);
    border-radius: 8px;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    position: relative;
    overflow: hidden;
    background: var(--background);
    transition: all 0.3s;
}

.image-upload-slot:hover {
    border-color: var(--terracotta);
    background: rgba(160, 105, 95, 0.05);
}

.upload-placeholder {
    text-align: center;
    color: var(--text-muted);
    font-size: 0.875rem;
}

.upload-icon {
    font-size: 2rem;
    margin-bottom: 0.5rem;
}

.image-preview {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    object-fit: cover;
    display: none;
}

.image-preview.show {
    display: block;
}

.remove-image-btn {
    position: absolute;
    top: 0.5rem;
    right: 0.5rem;
    width: 28px;
    height: 28px;
    border-radius: 50%;
    background: rgba(220, 38, 38, 0.9);
    color: white;
    border: none;
    cursor: pointer;
    font-size: 1.25rem;
    display: none;
    align-items: center;
    justify-content: center;
    z-index: 10;
}

.remove-image-btn:hover {
    background: #dc2626;
}

.product-item {
    display: grid;
    grid-template-columns: 120px 1fr auto;
    gap: 1.5rem;
    padding: 1.5rem;
    background: var(--background);
    border-radius: 12px;
    margin-bottom: 1rem;
    align-items: center;
}

.product-item-image {
    width: 120px;
    height: 120px;
    border-radius: 8px;
    object-fit: cover;
    background: var(--light-beige);
}

.product-item-info h4 {
    font-size: 1.125rem;
    margin-bottom: 0.5rem;
    color: var(--dark-brown);
}

.product-item-meta {
    display: flex;
    gap: 1.5rem;
    color: var(--text-muted);
    font-size: 0.875rem;
    margin-bottom: 0.5rem;
}

.product-item-price {
    font-size: 1.25rem;
    font-weight: 600;
    color: var(--terracotta);
}

.product-item-actions {
    display: flex;
    gap: 0.5rem;
}

.status-badge {
    display: inline-block;
    padding: 0.25rem 0.75rem;
    border-radius: 50px;
    font-size: 0.8125rem;
    font-weight: 500;
}

.status-badge.active {
    background: var(--sage-green);
    color: var(--sage-green-dark);
}

.status-badge.inactive {
    background: var(--light-beige);
    color: var(--text-muted);
}

.form-section {
    margin-bottom: 2rem;
    padding-bottom: 2rem;
    border-bottom: 1px solid var(--border);
}

.form-section:last-of-type {
    border-bottom: none;
}

.form-section-title {
    font-size: 1.25rem;
    margin-bottom: 1rem;
    color: var(--dark-brown);
}
</style>

<script>
// Your Store JavaScript
let userProducts = [];
let productImages = [null, null, null, null, null];
let currentEditProductId = null;

// Load user's products
async function loadUserProducts() {
    try {
        const { data: products, error } = await supabase
            .from('products')
            .select('*')
            .eq('seller_id', currentUser.id)
            .order('created_at', { ascending: false });

        if (error) throw error;

        userProducts = products || [];
        renderProductsList();
        updateStoreStats();
    } catch (error) {
        console.error('Error loading products:', error);
    }
}

// Render products list
function renderProductsList() {
    const container = document.getElementById('productsListContainer');
    
    if (userProducts.length === 0) {
        container.innerHTML = `
            <div class="empty-state">
                <div class="empty-icon">üõçÔ∏è</div>
                <h4>No listings yet</h4>
                <p>Create your first listing to start selling on the Makers' Market</p>
                <button class="btn btn-primary" onclick="openNewProductModal()" style="margin-top: 1rem;">Create First Listing</button>
            </div>
        `;
        return;
    }

    container.innerHTML = userProducts.map(product => {
        const price = formatPrice(product.price, product.currency);
        const image = product.thumbnail_url || (product.images && product.images[0]) || 'placeholder.jpg';
        const statusBadge = product.is_active ? 
            '<span class="status-badge active">Active</span>' : 
            '<span class="status-badge inactive">Inactive</span>';
        
        let typeLabel = '';
        if (product.is_made_to_order) typeLabel = 'Made-to-Order';
        else if (product.is_digital) typeLabel = 'Digital';
        else if (product.is_travel_find) typeLabel = 'Travel Find';
        
        return `
            <div class="product-item">
                <img src="${image}" alt="${product.title}" class="product-item-image">
                <div class="product-item-info">
                    <h4>${product.title}</h4>
                    <div class="product-item-meta">
                        <span>${product.category}</span>
                        <span>‚Ä¢</span>
                        <span>${typeLabel}</span>
                        <span>‚Ä¢</span>
                        ${statusBadge}
                    </div>
                    <div class="product-item-price">${price}</div>
                </div>
                <div class="product-item-actions">
                    <button class="btn btn-small btn-secondary" onclick="editProduct('${product.id}')">Edit</button>
                    <button class="btn btn-small btn-danger" onclick="deleteProduct('${product.id}')">Delete</button>
                </div>
            </div>
        `;
    }).join('');
}

// Update store stats
function updateStoreStats() {
    document.getElementById('totalProducts').textContent = userProducts.length;
    document.getElementById('activeProducts').textContent = userProducts.filter(p => p.is_active).length;
    // TODO: Load actual orders and revenue from database
    document.getElementById('totalOrders').textContent = '0';
    document.getElementById('totalRevenue').textContent = '‚Ç¨0';
}

// Open new product modal
function openNewProductModal() {
    currentEditProductId = null;
    document.getElementById('productModalTitle').textContent = 'Create New Listing';
    document.getElementById('productForm').reset();
    productImages = [null, null, null, null, null];
    
    // Reset image previews
    for (let i = 1; i <= 5; i++) {
        document.getElementById(`imagePreview${i}`).classList.remove('show');
        document.getElementById(`imagePreview${i}`).parentElement.querySelector('.remove-image-btn').style.display = 'none';
    }
    
    // Show handmade fields by default
    selectProductType('handmade');
    
    document.getElementById('productModal').style.display = 'block';
}

// Select product type
function selectProductType(type) {
    document.querySelectorAll('.type-fields').forEach(el => el.style.display = 'none');
    
    if (type === 'handmade') {
        document.getElementById('handmadeFields').style.display = 'block';
        document.getElementById('typeHandmade').checked = true;
    } else if (type === 'digital') {
        document.getElementById('digitalFields').style.display = 'block';
        document.getElementById('typeDigital').checked = true;
    } else if (type === 'travel_find') {
        document.getElementById('travelFindFields').style.display = 'block';
        document.getElementById('typeTravelFind').checked = true;
    }
}

// Handle image upload
async function handleImageUpload(index, event) {
    const file = event.target.files[0];
    if (!file) return;
    
    const preview = document.getElementById(`imagePreview${index + 1}`);
    const removeBtn = preview.parentElement.querySelector('.remove-image-btn');
    
    // Show preview
    const reader = new FileReader();
    reader.onload = (e) => {
        preview.src = e.target.result;
        preview.classList.add('show');
        removeBtn.style.display = 'flex';
    };
    reader.readAsDataURL(file);
    
    // Upload to Supabase
    try {
        const fileExt = file.name.split('.').pop();
        const fileName = `products/${Date.now()}-${Math.random().toString(36).substring(7)}.${fileExt}`;
        
        const { data, error } = await supabase.storage
            .from('site-images')
            .upload(fileName, file);

        if (error) throw error;

        const { data: { publicUrl } } = supabase.storage
            .from('site-images')
            .getPublicUrl(fileName);

        productImages[index] = publicUrl;
    } catch (error) {
        console.error('Upload error:', error);
        alert('Error uploading image: ' + error.message);
    }
}

// Remove image
function removeImage(index) {
    productImages[index] = null;
    const preview = document.getElementById(`imagePreview${index + 1}`);
    preview.classList.remove('show');
    preview.src = '';
    preview.parentElement.querySelector('.remove-image-btn').style.display = 'none';
    document.getElementById(`imageInput${index + 1}`).value = '';
}

// Save product
async function saveProduct(event) {
    event.preventDefault();
    
    const productType = document.querySelector('input[name="productType"]:checked').value;
    
    const productData = {
        seller_id: currentUser.id,
        title: document.getElementById('productTitle').value,
        description: document.getElementById('productDescription').value,
        price: parseFloat(document.getElementById('productPrice').value),
        currency: document.getElementById('productCurrency').value,
        category: document.getElementById('productCategory').value,
        tags: document.getElementById('productTags').value
            .split(',')
            .map(tag => tag.trim())
            .filter(tag => tag),
        product_type: productType,
        is_active: document.getElementById('productActive').checked,
        images: productImages.filter(img => img !== null),
        thumbnail_url: productImages[0]
    };
    
    // Add type-specific fields
    if (productType === 'handmade') {
        productData.is_made_to_order = true;
        productData.production_time_days = parseInt(document.getElementById('productionTime').value) || null;
        productData.accepts_custom_orders = document.getElementById('acceptsCustom').checked;
    } else if (productType === 'digital') {
        productData.is_digital = true;
        productData.digital_file_url = document.getElementById('digitalFileUrl').value;
    } else if (productType === 'travel_find') {
        productData.is_travel_find = true;
        productData.order_until_date = document.getElementById('orderUntilDate').value;
        productData.max_quantity = parseInt(document.getElementById('maxQuantity').value);
        productData.current_quantity = 0;
    }
    
    try {
        if (currentEditProductId) {
            const { error } = await supabase
                .from('products')
                .update(productData)
                .eq('id', currentEditProductId);
            
            if (error) throw error;
            showNotification('Listing updated successfully!');
        } else {
            const { error } = await supabase
                .from('products')
                .insert([productData]);
            
            if (error) throw error;
            showNotification('Listing created successfully!');
        }
        
        closeProductModal();
        await loadUserProducts();
    } catch (error) {
        console.error('Error saving product:', error);
        alert('Error: ' + error.message);
    }
}

// Edit product
async function editProduct(id) {
    const product = userProducts.find(p => p.id === id);
    if (!product) return;
    
    currentEditProductId = id;
    document.getElementById('productModalTitle').textContent = 'Edit Listing';
    
    // Fill form
    document.getElementById('productId').value = product.id;
    document.getElementById('productTitle').value = product.title;
    document.getElementById('productDescription').value = product.description;
    document.getElementById('productPrice').value = product.price;
    document.getElementById('productCurrency').value = product.currency;
    document.getElementById('productCategory').value = product.category;
    document.getElementById('productTags').value = product.tags ? product.tags.join(', ') : '';
    document.getElementById('productActive').checked = product.is_active;
    
    // Set product type
    if (product.is_made_to_order) {
        selectProductType('handmade');
        document.getElementById('productionTime').value = product.production_time_days || '';
        document.getElementById('acceptsCustom').checked = product.accepts_custom_orders || false;
    } else if (product.is_digital) {
        selectProductType('digital');
        document.getElementById('digitalFileUrl').value = product.digital_file_url || '';
    } else if (product.is_travel_find) {
        selectProductType('travel_find');
        document.getElementById('orderUntilDate').value = product.order_until_date || '';
        document.getElementById('maxQuantity').value = product.max_quantity || '';
    }
    
    // Load images
    productImages = product.images || [null, null, null, null, null];
    productImages.forEach((img, index) => {
        if (img) {
            const preview = document.getElementById(`imagePreview${index + 1}`);
            preview.src = img;
            preview.classList.add('show');
            preview.parentElement.querySelector('.remove-image-btn').style.display = 'flex';
        }
    });
    
    document.getElementById('productModal').style.display = 'block';
}

// Delete product
async function deleteProduct(id) {
    if (!confirm('Are you sure you want to delete this listing?')) return;
    
    try {
        const { error } = await supabase
            .from('products')
            .delete()
            .eq('id', id);
        
        if (error) throw error;
        
        showNotification('Listing deleted');
        await loadUserProducts();
    } catch (error) {
        console.error('Error deleting product:', error);
        alert('Error: ' + error.message);
    }
}

// Close product modal
function closeProductModal() {
    document.getElementById('productModal').style.display = 'none';
}

// Format price
function formatPrice(price, currency = 'EUR') {
    const symbol = currency === 'EUR' ? '‚Ç¨' : currency === 'USD' ? '$' : currency === 'GBP' ? '¬£' : currency;
    return `${symbol}${parseFloat(price).toFixed(2)}`;
}

// Show notification
function showNotification(message) {
    // You can implement a toast notification here
    alert(message);
}
</script>
        </main>
    </div>

    <!-- Edit Profile Modal -->
    <div class="modal" id="edit-profile-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Edit Profile</h2>
                <button class="modal-close" onclick="closeEditProfile()">&times;</button>
            </div>
            <form onsubmit="handleUpdateProfile(event)">
                <div class="profile-picture-upload">
                    <div class="profile-picture-preview" id="profile-pic-preview">
                        <span id="profile-pic-initials">...</span>
                    </div>
                    <input type="file" id="profile-picture-input" accept="image/*" style="display: none;" onchange="handleProfilePictureChange(event)">
                    <button type="button" class="btn btn-secondary btn-small" onclick="document.getElementById('profile-picture-input').click()">
                        Change Picture
                    </button>
                </div>
                <div class="form-group">
                    <label>Username</label>
                    <input type="text" id="edit-username" readonly style="background: #f5f5f5;">
                    <small style="color: var(--text-muted); font-size: 0.8rem;">Username cannot be changed</small>
                </div>
                <div class="form-group">
                    <label>Full Name</label>
                    <input type="text" id="edit-fullname">
                </div>
                <div class="form-group">
                    <label>Bio</label>
                    <textarea id="edit-bio" placeholder="Tell us about yourself..."></textarea>
                </div>
                <div class="form-group">
                    <label>Location</label>
                    <input type="text" id="edit-location" placeholder="City, Country">
                </div>
                <div class="form-group">
                    <label>Interests (comma separated)</label>
                    <input type="text" id="edit-interests" placeholder="Sewing, Knitting, Crochet">
                </div>
                <button type="submit" class="btn btn-primary" style="width: 100%;">Save Changes</button>
            </form>
        </div>
    </div>

    <!-- Settings Modal -->
    <div class="modal" id="settings-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>‚öôÔ∏è Settings</h2>
                <button class="modal-close" onclick="closeSettings()">&times;</button>
            </div>
            <form onsubmit="handleUpdateSettings(event)">
                <div class="form-group">
                    <label>Measurement System</label>
                    <select id="setting-measurement">
                        <option value="metric">Metric (cm, m, kg)</option>
                        <option value="imperial">Imperial (inches, yards, lbs)</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Weight Unit</label>
                    <select id="setting-weight">
                        <option value="kg">Kilograms (kg)</option>
                        <option value="lbs">Pounds (lbs)</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Length Unit</label>
                    <select id="setting-length">
                        <option value="cm">Centimeters (cm)</option>
                        <option value="m">Meters (m)</option>
                        <option value="inches">Inches</option>
                        <option value="yards">Yards</option>
                    </select>
                </div>
                <button type="submit" class="btn btn-primary" style="width: 100%;">Save Settings</button>
            </form>
        </div>
    </div>

    <!-- Profile View Modal -->
    <div class="modal" id="profile-view-modal">
        <div class="modal-content" style="max-width: 800px;">
            <div class="modal-header">
                <h2>Profile</h2>
                <button class="modal-close" onclick="closeProfileView()">&times;</button>
            </div>
            <div id="profile-view-content"></div>
        </div>
    </div>

    <!-- Add Project Modal -->
    <div class="modal" id="add-project-modal">
        <div class="modal-content" style="max-width: 700px;">
            <div class="modal-header">
                <h2>Add New Project</h2>
                <button class="modal-close" onclick="closeAddProject()">&times;</button>
            </div>
            <form onsubmit="handleAddProject(event)">
                <div class="form-group">
                    <label>Title *</label>
                    <input type="text" id="project-title" required>
                </div>
                <div class="form-group">
                    <label>Description</label>
                    <textarea id="project-description"></textarea>
                </div>
                <div class="form-group">
                    <label>Craft Type *</label>
                    <select id="project-craft-type" required onchange="showCraftFields()">
                        <option value="">Select...</option>
                        <option value="Sewing">Sewing</option>
                        <option value="Knitting">Knitting</option>
                        <option value="Crochet">Crochet</option>
                        <option value="Embroidery">Embroidery</option>
                        <option value="Weaving">Weaving</option>
                        <option value="Quilting">Quilting</option>
                        <option value="Leather Work">Leather Work</option>
                        <option value="Other">Other</option>
                    </select>
                </div>

                <!-- Crochet Fields -->
                <div id="crochet-fields" class="craft-specific-fields">
                    <h3 style="margin: 1.5rem 0 1rem; color: var(--terracotta); font-size: 1.1rem;">üß∂ Crochet Details</h3>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                        <div class="form-group">
                            <label>Hook Size</label>
                            <input type="text" id="crochet-hook-size" placeholder="e.g., 5mm, H/8">
                        </div>
                        <div class="form-group">
                            <label>Yarn Weight</label>
                            <input type="text" id="crochet-yarn-weight" placeholder="e.g., Worsted (4)">
                        </div>
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                        <div class="form-group">
                            <label>Yarn Brand</label>
                            <input type="text" id="crochet-yarn-brand" placeholder="e.g., Lion Brand">
                        </div>
                        <div class="form-group">
                            <label>Yarn Color</label>
                            <input type="text" id="crochet-yarn-color" placeholder="e.g., Terracotta">
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Yardage Needed</label>
                        <input type="text" id="crochet-yardage" placeholder="e.g., 300 yards">
                    </div>
                    <div class="form-group">
                        <label>Gauge</label>
                        <input type="text" id="crochet-gauge" placeholder="e.g., 16 sts x 20 rows = 4 inches">
                    </div>
                    <div class="form-group">
                        <label>üîó Where to Buy Yarn</label>
                        <input type="url" id="crochet-yarn-link" placeholder="https://...">
                    </div>
                    <div class="form-group">
                        <label>üîó Pattern Link (Optional)</label>
                        <input type="url" id="crochet-pattern-link" placeholder="https://...">
                    </div>
                </div>

                <!-- Knitting Fields -->
                <div id="knitting-fields" class="craft-specific-fields">
                    <h3 style="margin: 1.5rem 0 1rem; color: var(--terracotta); font-size: 1.1rem;">üß∂ Knitting Details</h3>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                        <div class="form-group">
                            <label>Needle Size</label>
                            <input type="text" id="knitting-needle-size" placeholder="e.g., US 8, 5mm">
                        </div>
                        <div class="form-group">
                            <label>Needle Type</label>
                            <input type="text" id="knitting-needle-type" placeholder="e.g., Circular, DPN">
                        </div>
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                        <div class="form-group">
                            <label>Yarn Weight</label>
                            <input type="text" id="knitting-yarn-weight" placeholder="e.g., DK (3)">
                        </div>
                        <div class="form-group">
                            <label>Yarn Brand</label>
                            <input type="text" id="knitting-yarn-brand" placeholder="e.g., Malabrigo">
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Yardage Needed</label>
                        <input type="text" id="knitting-yardage" placeholder="e.g., 400 yards">
                    </div>
                    <div class="form-group">
                        <label>üîó Where to Buy Yarn</label>
                        <input type="url" id="knitting-yarn-link" placeholder="https://...">
                    </div>
                </div>

                <!-- Sewing Fields -->
                <div id="sewing-fields" class="craft-specific-fields">
                    <h3 style="margin: 1.5rem 0 1rem; color: var(--terracotta); font-size: 1.1rem;">üßµ Sewing Details</h3>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                        <div class="form-group">
                            <label>Needle Type</label>
                            <input type="text" id="sewing-needle-type" placeholder="e.g., Universal 80/12">
                        </div>
                        <div class="form-group">
                            <label>Fabric Type</label>
                            <input type="text" id="sewing-fabric-type" placeholder="e.g., Cotton, Linen">
                        </div>
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                        <div class="form-group">
                            <label>Fabric Amount</label>
                            <input type="text" id="sewing-fabric-amount" placeholder="e.g., 2 yards">
                        </div>
                        <div class="form-group">
                            <label>Fabric Brand</label>
                            <input type="text" id="sewing-fabric-brand" placeholder="e.g., Riley Blake">
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Notions Needed</label>
                        <input type="text" id="sewing-notions" placeholder="e.g., Buttons, zipper, interfacing">
                    </div>
                    <div class="form-group">
                        <label>Pattern Size</label>
                        <input type="text" id="sewing-pattern-size" placeholder="e.g., Medium, 10">
                    </div>
                    <div class="form-group">
                        <label>üîó Where to Buy Fabric</label>
                        <input type="url" id="sewing-fabric-link" placeholder="https://...">
                    </div>
                    <div class="form-group">
                        <label>üîó Pattern Link (Optional)</label>
                        <input type="url" id="sewing-pattern-link" placeholder="https://...">
                    </div>
                </div>

                <!-- Embroidery Fields -->
                <div id="embroidery-fields" class="craft-specific-fields">
                    <h3 style="margin: 1.5rem 0 1rem; color: var(--terracotta); font-size: 1.1rem;">ü™° Embroidery Details</h3>
                    <div class="form-group">
                        <label>Thread Type</label>
                        <input type="text" id="embroidery-thread-type" placeholder="e.g., DMC Floss">
                    </div>
                    <div class="form-group">
                        <label>Thread Colors</label>
                        <input type="text" id="embroidery-thread-colors" placeholder="e.g., 310, 666, 972">
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                        <div class="form-group">
                            <label>Fabric Type</label>
                            <input type="text" id="embroidery-fabric-type" placeholder="e.g., Aida 14 count">
                        </div>
                        <div class="form-group">
                            <label>Hoop Size</label>
                            <input type="text" id="embroidery-hoop-size" placeholder="e.g., 6 inches">
                        </div>
                    </div>
                    <div class="form-group">
                        <label>üîó Supplies Link</label>
                        <input type="url" id="embroidery-supplies-link" placeholder="https://...">
                    </div>
                </div>

                <!-- Weaving Fields -->
                <div id="weaving-fields" class="craft-specific-fields">
                    <h3 style="margin: 1.5rem 0 1rem; color: var(--terracotta); font-size: 1.1rem;">üßµ Weaving Details</h3>
                    <div class="form-group">
                        <label>Loom Type</label>
                        <input type="text" id="weaving-loom-type" placeholder="e.g., Rigid heddle">
                    </div>
                    <div class="form-group">
                        <label>Yarn/Fiber Type</label>
                        <input type="text" id="weaving-yarn-type" placeholder="e.g., Cotton warp, wool weft">
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 1rem;">
                        <div class="form-group">
                            <label>Reed Size</label>
                            <input type="text" id="weaving-reed-size" placeholder="e.g., 12 dent">
                        </div>
                        <div class="form-group">
                            <label>Width</label>
                            <input type="text" id="weaving-width" placeholder="e.g., 10 inches">
                        </div>
                        <div class="form-group">
                            <label>Length</label>
                            <input type="text" id="weaving-length" placeholder="e.g., 2 yards">
                        </div>
                    </div>
                    <div class="form-group">
                        <label>üîó Supplies Link</label>
                        <input type="url" id="weaving-supplies-link" placeholder="https://...">
                    </div>
                </div>

                <!-- Quilting Fields -->
                <div id="quilting-fields" class="craft-specific-fields">
                    <h3 style="margin: 1.5rem 0 1rem; color: var(--terracotta); font-size: 1.1rem;">üßµ Quilting Details</h3>
                    <div class="form-group">
                        <label>Quilt Size</label>
                        <input type="text" id="quilting-quilt-size" placeholder="e.g., Throw (60x72)">
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                        <div class="form-group">
                            <label>Fabric Collection</label>
                            <input type="text" id="quilting-fabric-collection" placeholder="e.g., Modern Solids">
                        </div>
                        <div class="form-group">
                            <label>Batting Type</label>
                            <input type="text" id="quilting-batting-type" placeholder="e.g., Cotton 80/20">
                        </div>
                    </div>
                    <div class="form-group">
                        <label>üîó Fabric Link</label>
                        <input type="url" id="quilting-fabric-link" placeholder="https://...">
                    </div>
                </div>

                <!-- Leather Work Fields -->
                <div id="leather-fields" class="craft-specific-fields">
                    <h3 style="margin: 1.5rem 0 1rem; color: var(--terracotta); font-size: 1.1rem;">üëú Leather Work Details</h3>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                        <div class="form-group">
                            <label>Leather Type</label>
                            <input type="text" id="leather-leather-type" placeholder="e.g., Vegetable tanned">
                        </div>
                        <div class="form-group">
                            <label>Leather Weight</label>
                            <input type="text" id="leather-leather-weight" placeholder="e.g., 5-6 oz">
                        </div>
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                        <div class="form-group">
                            <label>Thread Type</label>
                            <input type="text" id="leather-thread-type" placeholder="e.g., Waxed polyester">
                        </div>
                        <div class="form-group">
                            <label>Needle Size</label>
                            <input type="text" id="leather-needle-size" placeholder="e.g., Size 2">
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Hardware</label>
                        <input type="text" id="leather-hardware" placeholder="e.g., Brass rivets, D-rings">
                    </div>
                    <div class="form-group">
                        <label>üîó Supplies Link</label>
                        <input type="url" id="leather-supplies-link" placeholder="https://...">
                    </div>
                </div>

                <button type="submit" class="btn btn-primary" style="width: 100%; margin-top: 1.5rem;">Create Project</button>
            </form>
        </div>
    </div>

    <!-- Edit Project Modal -->
    <div class="modal" id="edit-project-modal">
        <div class="modal-content" style="max-width: 700px; max-height: 90vh; overflow-y: auto;">
            <div class="modal-header">
                <h2>Edit Project</h2>
                <button class="modal-close" onclick="closeEditProject()">&times;</button>
            </div>
            <form onsubmit="handleUpdateProject(event)">
                <input type="hidden" id="edit-project-id">
                <input type="hidden" id="edit-project-craft-type">
                
                <div class="form-group">
                    <label>Title *</label>
                    <input type="text" id="edit-project-title" required>
                </div>
                
                <div class="form-group">
                    <label>Description</label>
                    <textarea id="edit-project-description"></textarea>
                </div>
                
                <div class="form-group">
                    <label>Status</label>
                    <select id="edit-project-status">
                        <option value="planning">Planning</option>
                        <option value="in_progress">In Progress</option>
                        <option value="completed">Completed</option>
                        <option value="on_hold">On Hold</option>
                    </select>
                </div>

                <!-- Crochet Fields -->
                <div id="edit-crochet-fields" class="craft-fields" style="display: none;">
                    <h4 style="margin: 1.5rem 0 1rem; color: var(--terracotta);">üß∂ Crochet Details</h4>
                    <div class="form-group">
                        <label>ü™ù Hook Size</label>
                        <input type="text" id="edit-crochet-hook" placeholder="e.g., 5mm, H/8">
                    </div>
                    <div class="form-group">
                        <label>üßµ Yarn Brand</label>
                        <input type="text" id="edit-crochet-yarn-brand">
                    </div>
                    <div class="form-group">
                        <label>üé® Yarn Color</label>
                        <input type="text" id="edit-crochet-yarn-color">
                    </div>
                    <div class="form-group">
                        <label>‚öñÔ∏è Yarn Weight</label>
                        <select id="edit-crochet-yarn-weight">
                            <option value="">Select weight</option>
                            <option value="Lace">Lace</option>
                            <option value="Fingering">Fingering</option>
                            <option value="Sport">Sport</option>
                            <option value="DK">DK</option>
                            <option value="Worsted">Worsted</option>
                            <option value="Bulky">Bulky</option>
                            <option value="Super Bulky">Super Bulky</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>üìè Gauge</label>
                        <input type="text" id="edit-crochet-gauge" placeholder="e.g., 16 sts x 20 rows = 4 inches">
                    </div>
                    <div class="form-group">
                        <label>üìê Yardage Used</label>
                        <input type="text" id="edit-crochet-yardage" placeholder="e.g., 400 yards">
                    </div>
                    <div class="form-group">
                        <label>üîó Pattern Link</label>
                        <input type="url" id="edit-crochet-pattern-link" placeholder="https://...">
                    </div>
                    <div class="form-group">
                        <label>üîó Supplies Link</label>
                        <input type="url" id="edit-crochet-supplies-link" placeholder="https://...">
                    </div>
                </div>

                <!-- Knitting Fields -->
                <div id="edit-knitting-fields" class="craft-fields" style="display: none;">
                    <h4 style="margin: 1.5rem 0 1rem; color: var(--terracotta);">üß∂ Knitting Details</h4>
                    <div class="form-group">
                        <label>ü™° Needle Type</label>
                        <select id="edit-knitting-needle-type">
                            <option value="">Select type</option>
                            <option value="Straight">Straight</option>
                            <option value="Circular">Circular</option>
                            <option value="DPN">Double Pointed (DPN)</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>üìè Needle Size</label>
                        <input type="text" id="edit-knitting-needle-size" placeholder="e.g., US 8, 5mm">
                    </div>
                    <div class="form-group">
                        <label>üßµ Yarn Brand</label>
                        <input type="text" id="edit-knitting-yarn-brand">
                    </div>
                    <div class="form-group">
                        <label>üé® Yarn Color</label>
                        <input type="text" id="edit-knitting-yarn-color">
                    </div>
                    <div class="form-group">
                        <label>‚öñÔ∏è Yarn Weight</label>
                        <select id="edit-knitting-yarn-weight">
                            <option value="">Select weight</option>
                            <option value="Lace">Lace</option>
                            <option value="Fingering">Fingering</option>
                            <option value="Sport">Sport</option>
                            <option value="DK">DK</option>
                            <option value="Worsted">Worsted</option>
                            <option value="Bulky">Bulky</option>
                            <option value="Super Bulky">Super Bulky</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>üìê Yardage Used</label>
                        <input type="text" id="edit-knitting-yardage">
                    </div>
                    <div class="form-group">
                        <label>üîó Pattern Link</label>
                        <input type="url" id="edit-knitting-pattern-link" placeholder="https://...">
                    </div>
                    <div class="form-group">
                        <label>üîó Supplies Link</label>
                        <input type="url" id="edit-knitting-supplies-link" placeholder="https://...">
                    </div>
                </div>

                <!-- Sewing Fields -->
                <div id="edit-sewing-fields" class="craft-fields" style="display: none;">
                    <h4 style="margin: 1.5rem 0 1rem; color: var(--terracotta);">ü™° Sewing Details</h4>
                    <div class="form-group">
                        <label>üßµ Fabric Type</label>
                        <input type="text" id="edit-sewing-fabric-type" placeholder="e.g., Cotton, Linen">
                    </div>
                    <div class="form-group">
                        <label>üìè Fabric Amount</label>
                        <input type="text" id="edit-sewing-fabric-amount" placeholder="e.g., 2 yards">
                    </div>
                    <div class="form-group">
                        <label>üè∑Ô∏è Fabric Brand</label>
                        <input type="text" id="edit-sewing-fabric-brand">
                    </div>
                    <div class="form-group">
                        <label>ü™° Needle Type/Size</label>
                        <input type="text" id="edit-sewing-needle-info" placeholder="e.g., Universal 80/12">
                    </div>
                    <div class="form-group">
                        <label>‚úÇÔ∏è Notions Used</label>
                        <input type="text" id="edit-sewing-notions" placeholder="e.g., Zipper, buttons">
                    </div>
                    <div class="form-group">
                        <label>üîó Pattern Link</label>
                        <input type="url" id="edit-sewing-pattern-link" placeholder="https://...">
                    </div>
                    <div class="form-group">
                        <label>üîó Supplies Link</label>
                        <input type="url" id="edit-sewing-supplies-link" placeholder="https://...">
                    </div>
                </div>

                <!-- Embroidery Fields -->
                <div id="edit-embroidery-fields" class="craft-fields" style="display: none;">
                    <h4 style="margin: 1.5rem 0 1rem; color: var(--terracotta);">ü™° Embroidery Details</h4>
                    <div class="form-group">
                        <label>üßµ Thread Brand</label>
                        <input type="text" id="edit-embroidery-thread-brand" placeholder="e.g., DMC">
                    </div>
                    <div class="form-group">
                        <label>üé® Thread Colors</label>
                        <input type="text" id="edit-embroidery-colors" placeholder="e.g., 310, 498, 666">
                    </div>
                    <div class="form-group">
                        <label>üßµ Fabric Type</label>
                        <input type="text" id="edit-embroidery-fabric">
                    </div>
                    <div class="form-group">
                        <label>‚≠ï Hoop Size</label>
                        <input type="text" id="edit-embroidery-hoop" placeholder="e.g., 6 inch">
                    </div>
                    <div class="form-group">
                        <label>üîó Pattern Link</label>
                        <input type="url" id="edit-embroidery-pattern-link" placeholder="https://...">
                    </div>
                    <div class="form-group">
                        <label>üîó Supplies Link</label>
                        <input type="url" id="edit-embroidery-supplies-link" placeholder="https://...">
                    </div>
                </div>

                <!-- Weaving Fields -->
                <div id="edit-weaving-fields" class="craft-fields" style="display: none;">
                    <h4 style="margin: 1.5rem 0 1rem; color: var(--terracotta);">üßµ Weaving Details</h4>
                    <div class="form-group">
                        <label>üßµ Loom Type</label>
                        <input type="text" id="edit-weaving-loom" placeholder="e.g., Floor loom, Rigid heddle">
                    </div>
                    <div class="form-group">
                        <label>üìè Reed Size</label>
                        <input type="text" id="edit-weaving-reed" placeholder="e.g., 12 dent">
                    </div>
                    <div class="form-group">
                        <label>üìê Warp Yarn</label>
                        <input type="text" id="edit-weaving-warp">
                    </div>
                    <div class="form-group">
                        <label>üßµ Weft Yarn</label>
                        <input type="text" id="edit-weaving-weft">
                    </div>
                    <div class="form-group">
                        <label>üìè Dimensions</label>
                        <input type="text" id="edit-weaving-dimensions" placeholder="e.g., 24 x 36 inches">
                    </div>
                    <div class="form-group">
                        <label>üîó Supplies Link</label>
                        <input type="url" id="edit-weaving-supplies-link" placeholder="https://...">
                    </div>
                </div>

                <!-- Quilting Fields -->
                <div id="edit-quilting-fields" class="craft-fields" style="display: none;">
                    <h4 style="margin: 1.5rem 0 1rem; color: var(--terracotta);">üßµ Quilting Details</h4>
                    <div class="form-group">
                        <label>üìè Quilt Size</label>
                        <input type="text" id="edit-quilting-size" placeholder="e.g., Twin, Queen">
                    </div>
                    <div class="form-group">
                        <label>üßµ Batting Type</label>
                        <input type="text" id="edit-quilting-batting" placeholder="e.g., Cotton, Polyester">
                    </div>
                    <div class="form-group">
                        <label>üé® Fabric Collection</label>
                        <input type="text" id="edit-quilting-fabric">
                    </div>
                    <div class="form-group">
                        <label>üìê Block Pattern</label>
                        <input type="text" id="edit-quilting-block" placeholder="e.g., Log Cabin">
                    </div>
                    <div class="form-group">
                        <label>üîó Pattern Link</label>
                        <input type="url" id="edit-quilting-pattern-link" placeholder="https://...">
                    </div>
                    <div class="form-group">
                        <label>üîó Supplies Link</label>
                        <input type="url" id="edit-quilting-supplies-link" placeholder="https://...">
                    </div>
                </div>

                <!-- Leather Work Fields -->
                <div id="edit-leather-fields" class="craft-fields" style="display: none;">
                    <h4 style="margin: 1.5rem 0 1rem; color: var(--terracotta);">üß≥ Leather Work Details</h4>
                    <div class="form-group">
                        <label>üß≥ Leather Type</label>
                        <input type="text" id="edit-leather-type" placeholder="e.g., Veg-tan, Chrome-tan">
                    </div>
                    <div class="form-group">
                        <label>üìè Leather Weight</label>
                        <input type="text" id="edit-leather-weight" placeholder="e.g., 4-5 oz">
                    </div>
                    <div class="form-group">
                        <label>üé® Color/Finish</label>
                        <input type="text" id="edit-leather-color">
                    </div>
                    <div class="form-group">
                        <label>üîß Hardware Used</label>
                        <input type="text" id="edit-leather-hardware" placeholder="e.g., Brass buckle">
                    </div>
                    <div class="form-group">
                        <label>üîó Pattern Link</label>
                        <input type="url" id="edit-leather-pattern-link" placeholder="https://...">
                    </div>
                    <div class="form-group">
                        <label>üîó Supplies Link</label>
                        <input type="url" id="edit-leather-supplies-link" placeholder="https://...">
                    </div>
                </div>

                <button type="submit" class="btn btn-primary" style="width: 100%; margin-top: 1.5rem;">Save Changes</button>
            </form>
        </div>
    </div>

    <!-- Add Update Modal -->
    <div class="modal" id="add-update-modal">
        <div class="modal-content" style="max-width: 700px;">
            <div class="modal-header">
                <h2>Add Project Update</h2>
                <button class="modal-close" onclick="closeAddUpdate()">&times;</button>
            </div>
            <form onsubmit="handleAddUpdate(event)">
                <input type="hidden" id="update-project-id">
                <div class="form-group">
                    <label>What's new? *</label>
                    <textarea id="update-content" required placeholder="Made progress on the sleeves today..."></textarea>
                </div>
                <div class="form-group">
                    <label>Add Photo (Optional)</label>
                    <input type="file" id="update-photo" accept="image/*">
                    <div id="update-photo-preview" style="margin-top: 1rem; display: none;">
                        <img style="max-width: 100%; border-radius: 8px;">
                    </div>
                </div>
                <button type="submit" class="btn btn-primary" style="width: 100%; margin-top: 1.5rem;">Post Update</button>
            </form>
        </div>
    </div>

    <!-- Floating Chat Widget -->
    <div class="chat-widget" id="chat-widget">
        <div class="chat-widget-header">
            <div class="chat-widget-avatar" id="chat-widget-avatar">...</div>
            <div class="chat-widget-info">
                <div class="chat-widget-name" id="chat-widget-name">Chat</div>
                <div class="chat-widget-status">Online</div>
            </div>
            <button class="chat-widget-close" onclick="closeChatWidget()">√ó</button>
        </div>
        <div class="chat-widget-messages" id="chat-widget-messages">
            <div style="text-align: center; color: var(--text-muted); padding: 2rem;">
                Start your conversation! üëã
            </div>
        </div>
        <div class="chat-widget-input-area">
            <form class="chat-widget-input-form" onsubmit="sendWidgetMessage(event)">
                <input type="text" class="chat-widget-input" id="chat-widget-input" placeholder="Type a message..." required>
                <button type="submit" class="chat-widget-send">‚û§</button>
            </form>
        </div>
    </div>

    <script>
        const SUPABASE_URL = 'https://yzuoujjzupbbekmmymqn.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inl6dW91amp6dXBiYmVrbW15bXFuIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjUwMjYwOTgsImV4cCI6MjA4MDYwMjA5OH0.Ri9ibTKIin_oA0vsHthU_zbnuNnnKQsXkmF5Es8UJWc';
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        let currentUser = null;
        let userProfile = null;
        let allMembers = [];
        let currentChatUser = null;
        let chatRealtimeChannel = null;

        async function checkAuth() {
            const { data: { session } } = await supabase.auth.getSession();
            if (!session) {
                window.location.href = 'login.html';
                return;
            }
            currentUser = session.user;
            await loadUserData();
        }

        async function loadUserData() {
            const { data: profile } = await supabase
                .from('profiles')
                .select('*')
                .eq('id', currentUser.id)
                .single();

            userProfile = profile;
            
            const headerAvatar = document.getElementById('header-avatar');
            if (profile.profile_picture_url) {
                headerAvatar.innerHTML = `<img src="${profile.profile_picture_url}" alt="${profile.full_name}">`;
            } else {
                headerAvatar.textContent = profile.avatar_initials;
            }
            
            document.getElementById('welcome-text').textContent = `Welcome back, ${profile.full_name.split(' ')[0]}! üëã`;

            await loadAllData();
            startRealtimeUpdates();
        }

        async function loadAllData() {
            await Promise.all([
                loadQuickStats(),
                loadMyProjects(),
                loadCommunityFeed(),
                loadFriends(),
                loadMembers(),
                loadNotifications(),
                loadConversations()
            ]);
        }

        async function loadQuickStats() {
            // Get friend count using mutual follow logic
            const { data: iFollow } = await supabase
                .from('follows')
                .select('following_id')
                .eq('follower_id', currentUser.id);

            const { data: followMe } = await supabase
                .from('follows')
                .select('follower_id')
                .eq('following_id', currentUser.id);

            let friendsCount = 0;
            if (iFollow && followMe) {
                const iFollowIds = iFollow.map(f => f.following_id);
                const followMeIds = followMe.map(f => f.follower_id);
                friendsCount = iFollowIds.filter(id => followMeIds.includes(id)).length;
            }
            
            document.getElementById('stat-projects').textContent = userProfile.projects_count || 0;
            document.getElementById('stat-likes').textContent = userProfile.total_likes_received || 0;
            document.getElementById('stat-friends').textContent = friendsCount;
            document.getElementById('stat-streak').textContent = userProfile.streak_days || 0;
        }

        async function loadMyProjects() {
            const { data: projects } = await supabase
                .from('projects')
                .select('*')
                .eq('user_id', currentUser.id)
                .order('created_at', { ascending: false });

            const container = document.getElementById('my-projects-container');
            
            if (!projects || projects.length === 0) {
                container.innerHTML = `
                    <div class="card">
                        <div class="empty-state">
                            <div class="empty-state-icon">üé®</div>
                            <p>No projects yet!</p>
                            <button class="btn btn-primary" style="margin-top: 1rem;" onclick="showAddProject()">Create Your First Project</button>
                        </div>
                    </div>
                `;
                return;
            }

            container.innerHTML = `<div class="project-grid">${projects.map(project => createProjectCard(project, true)).join('')}</div>`;
        }

        async function checkProjectLikeStatus(projectId) {
            const { data } = await supabase
                .from('likes')
                .select('id')
                .eq('project_id', projectId)
                .eq('user_id', currentUser.id)
                .single();

            const btn = document.getElementById(`like-btn-${projectId}`);
            if (btn) {
                if (data) {
                    btn.textContent = '‚ù§Ô∏è';
                    btn.classList.add('liked');
                } else {
                    btn.textContent = 'ü§ç';
                    btn.classList.remove('liked');
                }
            }
        }

        async function checkProjectFollowStatus(projectId) {
            const { data } = await supabase
                .from('project_followers')
                .select('id')
                .eq('project_id', projectId)
                .eq('user_id', currentUser.id)
                .single();

            const btn = document.getElementById(`follow-project-${projectId}`);
            if (btn) {
                btn.textContent = data ? 'Following' : 'Follow';
                btn.className = data ? 'follow-btn-small following' : 'follow-btn-small';
            }
        }

        async function loadCommunityFeed() {
            const { data: feedItems, error } = await supabase.rpc('get_user_feed', { 
                user_uuid: currentUser.id,
                limit_count: 20
            });

            if (error) {
                console.error('Error loading feed:', error);
            }

            const container = document.getElementById('community-feed');
            
            if (!feedItems || feedItems.length === 0) {
                container.innerHTML = `
                    <div class="card">
                        <div class="empty-state">
                            <div class="empty-state-icon">üåä</div>
                            <p>No activity yet. Follow some projects and makers!</p>
                        </div>
                    </div>
                `;
                return;
            }

            container.innerHTML = feedItems.map(item => {
                if (item.type === 'project') {
                    // Display as project card
                    return `
                        <div class="feed-item" style="cursor: pointer;" onclick="showProjectDetail('${item.project_id}')">
                            <div class="feed-header">
                                <div class="feed-avatar" onclick="event.stopPropagation(); showUserProfile('${item.user_id}')">
                                    ${item.profile_picture_url ? 
                                        `<img src="${item.profile_picture_url}" alt="${item.username}">` : 
                                        item.avatar_initials
                                    }
                                </div>
                                <div style="flex: 1;">
                                    <div style="font-weight: 600; cursor: pointer;" onclick="event.stopPropagation(); showUserProfile('${item.user_id}')">
                                        @${item.username}
                                    </div>
                                    <div style="font-size: 0.85rem; color: var(--text-muted);">
                                        created a new ${item.project_craft_type} project
                                    </div>
                                </div>
                            </div>
                            <div style="margin: 1rem 0;">
                                <h3 style="margin-bottom: 0.5rem;">${item.project_title}</h3>
                                ${item.project_description ? `<p style="color: var(--text-muted); font-family: -apple-system, sans-serif;">${item.project_description.substring(0, 150)}${item.project_description.length > 150 ? '...' : ''}</p>` : ''}
                            </div>
                            <div style="display: flex; gap: 1rem; color: var(--text-muted); font-size: 0.9rem;">
                                <span>‚ù§Ô∏è ${item.project_likes_count || 0}</span>
                                <span>üí¨ ${item.project_comments_count || 0}</span>
                                <span>üëÅÔ∏è ${item.project_views_count || 0}</span>
                            </div>
                            <div class="feed-time">${getTimeAgo(item.created_at)}</div>
                        </div>
                    `;
                } else if (item.type === 'update') {
                    // Display as update
                    return `
                        <div class="feed-item" style="cursor: pointer;" onclick="showProjectDetail('${item.project_id}')">
                            <div class="feed-header">
                                <div class="feed-avatar" onclick="event.stopPropagation(); showUserProfile('${item.user_id}')">
                                    ${item.profile_picture_url ? 
                                        `<img src="${item.profile_picture_url}" alt="${item.username}">` : 
                                        item.avatar_initials
                                    }
                                </div>
                                <div style="flex: 1;">
                                    <div style="font-weight: 600; cursor: pointer;" onclick="event.stopPropagation(); showUserProfile('${item.user_id}')">
                                        @${item.username}
                                    </div>
                                    <div style="font-size: 0.85rem; color: var(--text-muted);">
                                        posted an update on "${item.project_title}"
                                    </div>
                                </div>
                            </div>
                            <div style="margin: 1rem 0;">
                                <p style="font-family: -apple-system, sans-serif; line-height: 1.6;">${item.update_content}</p>
                                ${item.update_photo_url ? `
                                    <img src="${item.update_photo_url}" style="width: 100%; border-radius: 8px; margin-top: 1rem; max-height: 400px; object-fit: cover;">
                                ` : ''}
                            </div>
                            <div class="feed-time">${getTimeAgo(item.created_at)}</div>
                        </div>
                    `;
                } else if (item.type === 'edit') {
                    // Display as edit activity
                    return `
                        <div class="feed-item" style="cursor: pointer; border-left: 4px solid var(--terracotta);" onclick="showProjectDetail('${item.project_id}')">
                            <div class="feed-header">
                                <div class="feed-avatar" onclick="event.stopPropagation(); showUserProfile('${item.user_id}')">
                                    ${item.profile_picture_url ? 
                                        `<img src="${item.profile_picture_url}" alt="${item.username}">` : 
                                        item.avatar_initials
                                    }
                                </div>
                                <div style="flex: 1;">
                                    <div style="font-weight: 600; cursor: pointer;" onclick="event.stopPropagation(); showUserProfile('${item.user_id}')">
                                        Update: @${item.username} edited ${item.project_title}
                                    </div>
                                    <div style="font-size: 0.85rem; color: var(--text-muted); margin-top: 0.25rem;">
                                        ${item.update_content}
                                    </div>
                                </div>
                            </div>
                            <div class="feed-time">${getTimeAgo(item.created_at)}</div>
                        </div>
                    `;
                }
            }).join('');
        }

        function getFeedTypeText(type) {
            switch(type) {
                case 'project': return 'created a new project';
                case 'update': return 'posted an update';
                case 'comment': return 'commented';
                default: return 'posted';
            }
        }

        async function checkIfFriends(userId1, userId2) {
            // Check if both users follow each other
            const { data: follow1 } = await supabase
                .from('follows')
                .select('id')
                .eq('follower_id', userId1)
                .eq('following_id', userId2)
                .single();

            const { data: follow2 } = await supabase
                .from('follows')
                .select('id')
                .eq('follower_id', userId2)
                .eq('following_id', userId1)
                .single();

            return follow1 && follow2;
        }

        async function loadFriends() {
            // Get all users I follow
            const { data: iFollow } = await supabase
                .from('follows')
                .select('following_id')
                .eq('follower_id', currentUser.id);

            // Get all users who follow me
            const { data: followMe } = await supabase
                .from('follows')
                .select('follower_id')
                .eq('following_id', currentUser.id);

            const container = document.getElementById('friends-container');
            
            if (!iFollow || !followMe || iFollow.length === 0 || followMe.length === 0) {
                container.innerHTML = `
                    <div class="card">
                        <div class="empty-state">
                            <div class="empty-state-icon">üí´</div>
                            <p>No friends yet!</p>
                            <p style="font-size: 0.9rem; margin-top: 0.5rem;">Follow someone and have them follow you back to become friends!</p>
                        </div>
                    </div>
                `;
                return;
            }

            // Find mutual follows (friends)
            const iFollowIds = iFollow.map(f => f.following_id);
            const followMeIds = followMe.map(f => f.follower_id);
            const friendIds = iFollowIds.filter(id => followMeIds.includes(id));

            if (friendIds.length === 0) {
                container.innerHTML = `
                    <div class="card">
                        <div class="empty-state">
                            <div class="empty-state-icon">üí´</div>
                            <p>No friends yet!</p>
                            <p style="font-size: 0.9rem; margin-top: 0.5rem;">You follow ${iFollowIds.length} people and ${followMeIds.length} people follow you.</p>
                            <p style="font-size: 0.9rem; margin-top: 0.5rem;">Follow each other to become friends!</p>
                        </div>
                    </div>
                `;
                return;
            }

            // Get friend profiles
            const { data: friends } = await supabase
                .from('profiles')
                .select('*')
                .in('id', friendIds);

            container.innerHTML = `
                <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 1.5rem;">
                    ${friends.map(friend => `
                        <div class="card" style="text-align: center;">
                            <div style="width: 80px; height: 80px; border-radius: 50%; background: var(--terracotta); margin: 0 auto 1rem; display: flex; align-items: center; justify-content: center; color: white; font-size: 2rem; font-weight: bold; overflow: hidden; cursor: pointer;" onclick="showUserProfile('${friend.id}')">
                                ${friend.profile_picture_url ? 
                                    `<img src="${friend.profile_picture_url}" style="width: 100%; height: 100%; object-fit: cover;">` : 
                                    friend.avatar_initials
                                }
                            </div>
                            <h3 style="margin-bottom: 0.5rem; cursor: pointer;" onclick="showUserProfile('${friend.id}')">@${friend.username}</h3>
                            <p style="color: var(--text-muted); font-family: -apple-system, sans-serif; margin-bottom: 1rem;">${friend.full_name}</p>
                            <div style="display: flex; gap: 0.5rem;">
                                <button class="btn btn-primary btn-small" style="flex: 1;" onclick="openChat('${friend.id}', '${friend.username}', '${friend.profile_picture_url || ''}', '${friend.avatar_initials}')">üí¨ Message</button>
                                <button class="btn btn-secondary btn-small" onclick="showUserProfile('${friend.id}')">üë§ Profile</button>
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;
        }

        async function loadMembers() {
            const { data: members } = await supabase
                .from('profiles')
                .select('*')
                .neq('id', currentUser.id)
                .order('created_at', { ascending: false });

            allMembers = members || [];
            displayMembers(allMembers);
        }

        function displayMembers(members) {
            const container = document.getElementById('members-container');
            
            if (!members || members.length === 0) {
                container.innerHTML = '<div class="card"><div class="empty-state"><p>No other members yet</p></div></div>';
                return;
            }

            container.innerHTML = `
                <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 1.5rem;">
                    ${members.map(member => `
                        <div class="card" style="text-align: center; cursor: pointer;" onclick="showUserProfile('${member.id}')">
                            <div style="width: 80px; height: 80px; border-radius: 50%; background: var(--terracotta); margin: 0 auto 1rem; display: flex; align-items: center; justify-content: center; color: white; font-size: 2rem; font-weight: bold; overflow: hidden;">
                                ${member.profile_picture_url ? 
                                    `<img src="${member.profile_picture_url}" style="width: 100%; height: 100%; object-fit: cover;">` : 
                                    member.avatar_initials
                                }
                            </div>
                            <h3 style="margin-bottom: 0.5rem;">@${member.username}</h3>
                            <p style="color: var(--text-muted); font-family: -apple-system, sans-serif; margin-bottom: 0.5rem;">${member.full_name}</p>
                            <p style="color: var(--text-muted); font-family: -apple-system, sans-serif; font-size: 0.85rem; margin-bottom: 1rem;">${member.location || 'Location not set'}</p>
                            <button class="btn btn-primary btn-small" style="width: 100%;" onclick="event.stopPropagation(); toggleFollow('${member.id}')" id="follow-btn-${member.id}">Follow</button>
                        </div>
                    `).join('')}
                </div>
            `;

            members.forEach(member => checkFollowStatus(member.id));
        }

        function searchMembers() {
            const query = document.getElementById('member-search').value.toLowerCase();
            const filtered = allMembers.filter(m => 
                m.full_name.toLowerCase().includes(query) ||
                m.username.toLowerCase().includes(query)
            );
            displayMembers(filtered);
        }

        async function checkFollowStatus(userId) {
            const { data } = await supabase
                .from('follows')
                .select('id')
                .eq('follower_id', currentUser.id)
                .eq('following_id', userId)
                .single();

            const btn = document.getElementById(`follow-btn-${userId}`);
            if (btn) {
                btn.textContent = data ? 'Following' : 'Follow';
                btn.className = data ? 'btn btn-small' : 'btn btn-primary btn-small';
            }
        }

        async function toggleFollow(userId) {
            const { data: existing } = await supabase
                .from('follows')
                .select('id')
                .eq('follower_id', currentUser.id)
                .eq('following_id', userId)
                .single();

            if (existing) {
                await supabase.from('follows').delete().eq('id', existing.id);
            } else {
                await supabase.from('follows').insert({
                    follower_id: currentUser.id,
                    following_id: userId
                });
            }

            checkFollowStatus(userId);
            loadFriends();
            loadQuickStats();
        }

        function showCraftFields() {
            const craftType = document.getElementById('project-craft-type').value;
            
            document.querySelectorAll('.craft-specific-fields').forEach(el => {
                el.style.display = 'none';
            });

            const fieldMap = {
                'Crochet': 'crochet-fields',
                'Knitting': 'knitting-fields',
                'Sewing': 'sewing-fields',
                'Embroidery': 'embroidery-fields',
                'Weaving': 'weaving-fields',
                'Quilting': 'quilting-fields',
                'Leather Work': 'leather-fields'
            };

            const fieldId = fieldMap[craftType];
            if (fieldId) {
                document.getElementById(fieldId).style.display = 'block';
            }
        }

        function getCraftDetails(craftType) {
            const details = {};

            if (craftType === 'Crochet') {
                details.hook_size = document.getElementById('crochet-hook-size')?.value || '';
                details.yarn_weight = document.getElementById('crochet-yarn-weight')?.value || '';
                details.yarn_brand = document.getElementById('crochet-yarn-brand')?.value || '';
                details.yarn_color = document.getElementById('crochet-yarn-color')?.value || '';
                details.yardage = document.getElementById('crochet-yardage')?.value || '';
                details.gauge = document.getElementById('crochet-gauge')?.value || '';
                details.yarn_link = document.getElementById('crochet-yarn-link')?.value || '';
                details.pattern_link = document.getElementById('crochet-pattern-link')?.value || '';
            } else if (craftType === 'Knitting') {
                details.needle_size = document.getElementById('knitting-needle-size')?.value || '';
                details.needle_type = document.getElementById('knitting-needle-type')?.value || '';
                details.yarn_weight = document.getElementById('knitting-yarn-weight')?.value || '';
                details.yarn_brand = document.getElementById('knitting-yarn-brand')?.value || '';
                details.yardage = document.getElementById('knitting-yardage')?.value || '';
                details.yarn_link = document.getElementById('knitting-yarn-link')?.value || '';
            } else if (craftType === 'Sewing') {
                details.needle_type = document.getElementById('sewing-needle-type')?.value || '';
                details.fabric_type = document.getElementById('sewing-fabric-type')?.value || '';
                details.fabric_amount = document.getElementById('sewing-fabric-amount')?.value || '';
                details.fabric_brand = document.getElementById('sewing-fabric-brand')?.value || '';
                details.notions = document.getElementById('sewing-notions')?.value || '';
                details.pattern_size = document.getElementById('sewing-pattern-size')?.value || '';
                details.fabric_link = document.getElementById('sewing-fabric-link')?.value || '';
                details.pattern_link = document.getElementById('sewing-pattern-link')?.value || '';
            } else if (craftType === 'Embroidery') {
                details.thread_type = document.getElementById('embroidery-thread-type')?.value || '';
                details.thread_colors = document.getElementById('embroidery-thread-colors')?.value || '';
                details.fabric_type = document.getElementById('embroidery-fabric-type')?.value || '';
                details.hoop_size = document.getElementById('embroidery-hoop-size')?.value || '';
                details.supplies_link = document.getElementById('embroidery-supplies-link')?.value || '';
            } else if (craftType === 'Weaving') {
                details.loom_type = document.getElementById('weaving-loom-type')?.value || '';
                details.yarn_type = document.getElementById('weaving-yarn-type')?.value || '';
                details.reed_size = document.getElementById('weaving-reed-size')?.value || '';
                details.width = document.getElementById('weaving-width')?.value || '';
                details.length = document.getElementById('weaving-length')?.value || '';
                details.supplies_link = document.getElementById('weaving-supplies-link')?.value || '';
            } else if (craftType === 'Quilting') {
                details.quilt_size = document.getElementById('quilting-quilt-size')?.value || '';
                details.fabric_collection = document.getElementById('quilting-fabric-collection')?.value || '';
                details.batting_type = document.getElementById('quilting-batting-type')?.value || '';
                details.fabric_link = document.getElementById('quilting-fabric-link')?.value || '';
            } else if (craftType === 'Leather Work') {
                details.leather_type = document.getElementById('leather-leather-type')?.value || '';
                details.leather_weight = document.getElementById('leather-leather-weight')?.value || '';
                details.thread_type = document.getElementById('leather-thread-type')?.value || '';
                details.needle_size = document.getElementById('leather-needle-size')?.value || '';
                details.hardware = document.getElementById('leather-hardware')?.value || '';
                details.supplies_link = document.getElementById('leather-supplies-link')?.value || '';
            }

            Object.keys(details).forEach(key => {
                if (!details[key]) delete details[key];
            });

            return details;
        }

        function displayCraftDetails(craftType, craftDetails) {
            if (!craftDetails || Object.keys(craftDetails).length === 0) {
                return '';
            }

            let html = '<div style="background: var(--cream); padding: 1.5rem; border-radius: 12px; margin-top: 2rem;"><h3 style="margin-bottom: 1rem; color: var(--terracotta);">üìù Project Details</h3>';

            const formatLabel = (key) => {
                return key.split('_').map(word => word.charAt(0).toUpperCase() + word.slice(1)).join(' ');
            };

            const renderField = (label, value) => {
                if (!value) return '';
                
                if (value.startsWith('http://') || value.startsWith('https://')) {
                    return `
                        <div style="margin-bottom: 0.75rem;">
                            <strong style="color: var(--dark-brown); font-family: -apple-system, sans-serif; font-size: 0.9rem;">${label}:</strong>
                            <a href="${value}" target="_blank" style="color: var(--terracotta); text-decoration: none; font-family: -apple-system, sans-serif; margin-left: 0.5rem;">üîó View Link</a>
                        </div>
                    `;
                }
                
                return `
                    <div style="margin-bottom: 0.75rem;">
                        <strong style="color: var(--dark-brown); font-family: -apple-system, sans-serif; font-size: 0.9rem;">${label}:</strong>
                        <span style="font-family: -apple-system, sans-serif; margin-left: 0.5rem;">${value}</span>
                    </div>
                `;
            };

            Object.keys(craftDetails).forEach(key => {
                const label = formatLabel(key);
                html += renderField(label, craftDetails[key]);
            });

            html += '</div>';
            return html;
        }

        function createProjectCard(project, isOwner) {
            let craftPreview = '';
            if (project.craft_details && Object.keys(project.craft_details).length > 0) {
                const details = project.craft_details;
                if (project.craft_type === 'Crochet' && details.hook_size) {
                    craftPreview = ` ‚Ä¢ Hook: ${details.hook_size}`;
                } else if (project.craft_type === 'Knitting' && details.needle_size) {
                    craftPreview = ` ‚Ä¢ Needles: ${details.needle_size}`;
                } else if (project.craft_type === 'Sewing' && details.fabric_type) {
                    craftPreview = ` ‚Ä¢ ${details.fabric_type}`;
                }
            }

            return `
                <div class="project-card">
                    <div class="project-image" onclick="showProjectDetail('${project.id}')">
                        ${getCraftIcon(project.craft_type)}
                        ${!isOwner ? `
                            <button class="like-btn" id="like-btn-${project.id}" onclick="event.stopPropagation(); toggleLike(event, '${project.id}')">ü§ç</button>
                            <button class="follow-btn-small" id="follow-project-${project.id}" onclick="event.stopPropagation(); toggleProjectFollow('${project.id}')">Follow</button>
                        ` : ''}
                    </div>
                    <div class="project-info" onclick="showProjectDetail('${project.id}')">
                        <h3 class="project-title">${project.title}</h3>
                        <p style="font-size: 0.85rem; color: var(--text-muted); font-family: -apple-system, sans-serif; margin-bottom: 0.5rem;">${project.craft_type}${craftPreview}</p>
                        <div class="project-meta">
                            <span>‚ù§Ô∏è ${project.likes_count || 0}</span>
                            <span>üí¨ ${project.comments_count || 0}</span>
                        </div>
                        ${isOwner ? `
                            <div style="display: flex; gap: 0.5rem; margin-top: 1rem;">
                                <button class="btn btn-secondary btn-small" style="flex: 1;" onclick="event.stopPropagation(); showEditProject('${project.id}')">
                                    ‚úèÔ∏è Edit
                                </button>
                                <button class="btn btn-primary btn-small" style="flex: 1;" onclick="event.stopPropagation(); showAddUpdate('${project.id}')">
                                    üìù Update
                                </button>
                            </div>
                            <button class="btn btn-danger btn-small" style="width: 100%; margin-top: 0.5rem;" onclick="event.stopPropagation(); deleteProject('${project.id}')">
                                üóëÔ∏è Delete
                            </button>
                        ` : ''}
                    </div>
                </div>
            `;
        }

        async function showProjectDetail(projectId) {
            const { data: project } = await supabase
                .from('projects')
                .select('*, profiles(full_name, username, avatar_initials, profile_picture_url)')
                .eq('id', projectId)
                .single();

            if (!project) return;

            // Load project updates
            const { data: updates } = await supabase
                .from('project_updates')
                .select('*, profiles(username, avatar_initials, profile_picture_url)')
                .eq('project_id', projectId)
                .order('created_at', { ascending: false });

            const isOwner = project.user_id === currentUser.id;
            const craftDetailsHTML = displayCraftDetails(project.craft_type, project.craft_details);

            const updatesHTML = updates && updates.length > 0 ? `
                <div style="margin-top: 2rem; padding-top: 2rem; border-top: 2px solid var(--light-beige);">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                        <h3 style="margin: 0;">üìù Project Updates (${updates.length})</h3>
                        ${isOwner ? `
                            <button class="btn btn-primary btn-small" onclick="event.stopPropagation(); document.getElementById('project-detail-temp').remove(); showAddUpdate('${projectId}')">
                                + Add Update
                            </button>
                        ` : ''}
                    </div>
                    <div style="display: flex; flex-direction: column; gap: 1.5rem;">
                        ${updates.map(update => `
                            <div style="background: var(--cream); padding: 1.5rem; border-radius: 12px;">
                                <div style="display: flex; align-items: center; gap: 0.75rem; margin-bottom: 1rem;">
                                    <div style="width: 36px; height: 36px; border-radius: 50%; background: var(--terracotta); color: white; display: flex; align-items: center; justify-content: center; font-weight: bold; overflow: hidden;">
                                        ${update.profiles?.profile_picture_url ? 
                                            `<img src="${update.profiles.profile_picture_url}" style="width: 100%; height: 100%; object-fit: cover;">` : 
                                            update.profiles?.avatar_initials
                                        }
                                    </div>
                                    <div style="flex: 1;">
                                        <div style="font-weight: 600; font-size: 0.9rem;">@${update.profiles?.username}</div>
                                        <div style="font-size: 0.75rem; color: var(--text-muted); font-family: -apple-system, sans-serif;">${getTimeAgo(update.created_at)}</div>
                                    </div>
                                </div>
                                <p style="font-family: -apple-system, sans-serif; line-height: 1.6; margin-bottom: ${update.photo_url ? '1rem' : '0'};">${update.content}</p>
                                ${update.photo_url ? `
                                    <img src="${update.photo_url}" style="width: 100%; border-radius: 8px; max-height: 400px; object-fit: cover;">
                                ` : ''}
                            </div>
                        `).join('')}
                    </div>
                </div>
            ` : isOwner ? `
                <div style="margin-top: 2rem; padding-top: 2rem; border-top: 2px solid var(--light-beige); text-align: center;">
                    <p style="color: var(--text-muted); margin-bottom: 1rem;">No updates yet. Share your progress!</p>
                    <button class="btn btn-primary" onclick="event.stopPropagation(); document.getElementById('project-detail-temp').remove(); showAddUpdate('${projectId}')">
                        + Add First Update
                    </button>
                </div>
            ` : '';

            const modalHTML = `
                <div class="modal show" id="project-detail-temp" onclick="if(event.target === this) this.remove()" style="display: flex;">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h2>${project.title}</h2>
                            <button class="modal-close" onclick="document.getElementById('project-detail-temp').remove()">&times;</button>
                        </div>
                        
                        <div style="margin-bottom: 1rem;">
                            <div style="display: inline-block; padding: 0.5rem 1rem; background: var(--light-beige); border-radius: 20px; font-family: -apple-system, sans-serif; font-size: 0.9rem;">
                                ${getCraftIcon(project.craft_type)} ${project.craft_type} ‚Ä¢ ${project.status.replace('_', ' ')}
                            </div>
                        </div>

                        <div style="display: flex; align-items: center; gap: 1rem; margin-bottom: 2rem; padding-bottom: 1rem; border-bottom: 2px solid var(--light-beige); cursor: pointer;" onclick="document.getElementById('project-detail-temp').remove(); showUserProfile('${project.profiles.id || project.user_id}')">
                            <div style="width: 48px; height: 48px; border-radius: 50%; background: var(--terracotta); color: white; display: flex; align-items: center; justify-content: center; font-size: 1.25rem; font-weight: bold; overflow: hidden;">
                                ${project.profiles.profile_picture_url ? 
                                    `<img src="${project.profiles.profile_picture_url}" style="width: 100%; height: 100%; object-fit: cover;">` : 
                                    project.profiles.avatar_initials
                                }
                            </div>
                            <div>
                                <div style="font-weight: 600;">@${project.profiles.username}</div>
                                <div style="font-size: 0.85rem; color: var(--text-muted); font-family: -apple-system, sans-serif;">Posted ${getTimeAgo(project.created_at)}</div>
                            </div>
                        </div>

                        <div style="margin-bottom: 2rem;">
                            <h3 style="margin-bottom: 0.75rem;">About This Project</h3>
                            <p style="font-family: -apple-system, sans-serif; line-height: 1.6;">${project.description || 'No description provided.'}</p>
                        </div>

                        ${craftDetailsHTML}

                        ${updatesHTML}

                        <div style="margin-top: 2rem; padding-top: 2rem; border-top: 2px solid var(--light-beige); display: flex; gap: 2rem; font-family: -apple-system, sans-serif; color: var(--text-muted);">
                            <span>‚ù§Ô∏è ${project.likes_count || 0} likes</span>
                            <span>üí¨ ${project.comments_count || 0} comments</span>
                            <span>üëÅÔ∏è ${project.views_count || 0} views</span>
                        </div>

                        ${!isOwner ? `
                            <button class="btn btn-primary" style="width: 100%; margin-top: 1.5rem;" onclick="toggleLike(event, '${project.id}'); setTimeout(() => document.getElementById('project-detail-temp').remove(), 500);" id="detail-like-btn-${project.id}">
                                Like This Project ‚ù§Ô∏è
                            </button>
                        ` : `
                            <div style="display: flex; gap: 1rem; margin-top: 1.5rem;">
                                <button class="btn btn-secondary" style="flex: 1;" onclick="event.stopPropagation(); document.getElementById('project-detail-temp').remove(); showEditProject('${project.id}')">
                                    ‚úèÔ∏è Edit Project
                                </button>
                                <button class="btn btn-primary" style="flex: 1;" onclick="event.stopPropagation(); document.getElementById('project-detail-temp').remove(); showAddUpdate('${project.id}')">
                                    üìù Add Update
                                </button>
                            </div>
                        `}
                    </div>
                </div>
            `;

            document.body.insertAdjacentHTML('beforeend', modalHTML);
            
            if (!isOwner) {
                const { data } = await supabase
                    .from('likes')
                    .select('id')
                    .eq('project_id', projectId)
                    .eq('user_id', currentUser.id)
                    .single();

                const btn = document.getElementById(`detail-like-btn-${project.id}`);
                if (btn && data) {
                    btn.textContent = 'Unlike ‚ù§Ô∏è';
                }
            }
        }

        async function toggleProjectFollow(projectId) {
            const { data: existing } = await supabase
                .from('project_followers')
                .select('id')
                .eq('project_id', projectId)
                .eq('user_id', currentUser.id)
                .single();

            if (existing) {
                await supabase.from('project_followers').delete().eq('id', existing.id);
            } else {
                await supabase.from('project_followers').insert({
                    project_id: projectId,
                    user_id: currentUser.id
                });
            }

            const btn = document.getElementById(`follow-project-${projectId}`);
            if (btn) {
                btn.textContent = existing ? 'Follow' : 'Following';
                btn.className = existing ? 'follow-btn-small' : 'follow-btn-small following';
            }
        }

        async function toggleLike(event, projectId) {
            const btn = document.getElementById(`like-btn-${projectId}`);
            if (!btn) return;
            
            const isLiked = btn.classList.contains('liked');

            if (isLiked) {
                await supabase.from('likes').delete().eq('project_id', projectId).eq('user_id', currentUser.id);
                btn.textContent = 'ü§ç';
                btn.classList.remove('liked');
            } else {
                await supabase.from('likes').insert({ project_id: projectId, user_id: currentUser.id });
                btn.textContent = '‚ù§Ô∏è';
                btn.classList.add('liked');
                setTimeout(() => btn.classList.remove('liked'), 500);
            }

            loadMyProjects();
            loadQuickStats();
        }

        async function deleteProject(projectId) {
            if (!confirm('Are you sure you want to delete this project? This cannot be undone.')) {
                return;
            }

            try {
                await supabase.from('projects').delete().eq('id', projectId);
                await supabase.from('profiles').update({ 
                    projects_count: Math.max(0, userProfile.projects_count - 1)
                }).eq('id', currentUser.id);
                
                alert('Project deleted successfully!');
                await loadUserData();
            } catch (error) {
                console.error('Error deleting project:', error);
                alert('Failed to delete project');
            }
        }

        function showAddProject() {
            document.getElementById('add-project-modal').classList.add('show');
        }

        function closeAddProject() {
            document.getElementById('add-project-modal').classList.remove('show');
            document.querySelectorAll('.craft-specific-fields').forEach(el => el.style.display = 'none');
        }

        async function handleAddProject(event) {
            event.preventDefault();
            
            const craftType = document.getElementById('project-craft-type').value;
            const craftDetails = getCraftDetails(craftType);

            await supabase.from('projects').insert({
                user_id: currentUser.id,
                title: document.getElementById('project-title').value,
                description: document.getElementById('project-description').value,
                craft_type: craftType,
                status: 'in_progress',
                craft_details: craftDetails
            });

            await supabase.from('profiles').update({ 
                projects_count: userProfile.projects_count + 1 
            }).eq('id', currentUser.id);

            closeAddProject();
            event.target.reset();
            await loadUserData();
        }

        async function showEditProject(projectId) {
            const { data: project } = await supabase
                .from('projects')
                .select('*')
                .eq('id', projectId)
                .single();

            if (!project) return;

            // Set basic fields
            document.getElementById('edit-project-id').value = project.id;
            document.getElementById('edit-project-craft-type').value = project.craft_type;
            document.getElementById('edit-project-title').value = project.title;
            document.getElementById('edit-project-description').value = project.description || '';
            document.getElementById('edit-project-status').value = project.status;
            
            // Hide all craft fields first
            document.querySelectorAll('#edit-project-modal .craft-fields').forEach(el => {
                el.style.display = 'none';
            });
            
            // Show and populate craft-specific fields
            const details = project.craft_details || {};
            
            if (project.craft_type === 'Crochet') {
                document.getElementById('edit-crochet-fields').style.display = 'block';
                document.getElementById('edit-crochet-hook').value = details.hook_size || '';
                document.getElementById('edit-crochet-yarn-brand').value = details.yarn_brand || '';
                document.getElementById('edit-crochet-yarn-color').value = details.yarn_color || '';
                document.getElementById('edit-crochet-yarn-weight').value = details.yarn_weight || '';
                document.getElementById('edit-crochet-gauge').value = details.gauge || '';
                document.getElementById('edit-crochet-yardage').value = details.yardage || '';
                document.getElementById('edit-crochet-pattern-link').value = details.pattern_link || '';
                document.getElementById('edit-crochet-supplies-link').value = details.supplies_link || '';
            } else if (project.craft_type === 'Knitting') {
                document.getElementById('edit-knitting-fields').style.display = 'block';
                document.getElementById('edit-knitting-needle-type').value = details.needle_type || '';
                document.getElementById('edit-knitting-needle-size').value = details.needle_size || '';
                document.getElementById('edit-knitting-yarn-brand').value = details.yarn_brand || '';
                document.getElementById('edit-knitting-yarn-color').value = details.yarn_color || '';
                document.getElementById('edit-knitting-yarn-weight').value = details.yarn_weight || '';
                document.getElementById('edit-knitting-yardage').value = details.yardage || '';
                document.getElementById('edit-knitting-pattern-link').value = details.pattern_link || '';
                document.getElementById('edit-knitting-supplies-link').value = details.supplies_link || '';
            } else if (project.craft_type === 'Sewing') {
                document.getElementById('edit-sewing-fields').style.display = 'block';
                document.getElementById('edit-sewing-fabric-type').value = details.fabric_type || '';
                document.getElementById('edit-sewing-fabric-amount').value = details.fabric_amount || '';
                document.getElementById('edit-sewing-fabric-brand').value = details.fabric_brand || '';
                document.getElementById('edit-sewing-needle-info').value = details.needle_info || '';
                document.getElementById('edit-sewing-notions').value = details.notions || '';
                document.getElementById('edit-sewing-pattern-link').value = details.pattern_link || '';
                document.getElementById('edit-sewing-supplies-link').value = details.supplies_link || '';
            } else if (project.craft_type === 'Embroidery') {
                document.getElementById('edit-embroidery-fields').style.display = 'block';
                document.getElementById('edit-embroidery-thread-brand').value = details.thread_brand || '';
                document.getElementById('edit-embroidery-colors').value = details.thread_colors || '';
                document.getElementById('edit-embroidery-fabric').value = details.fabric || '';
                document.getElementById('edit-embroidery-hoop').value = details.hoop_size || '';
                document.getElementById('edit-embroidery-pattern-link').value = details.pattern_link || '';
                document.getElementById('edit-embroidery-supplies-link').value = details.supplies_link || '';
            } else if (project.craft_type === 'Weaving') {
                document.getElementById('edit-weaving-fields').style.display = 'block';
                document.getElementById('edit-weaving-loom').value = details.loom_type || '';
                document.getElementById('edit-weaving-reed').value = details.reed_size || '';
                document.getElementById('edit-weaving-warp').value = details.warp_yarn || '';
                document.getElementById('edit-weaving-weft').value = details.weft_yarn || '';
                document.getElementById('edit-weaving-dimensions').value = details.dimensions || '';
                document.getElementById('edit-weaving-supplies-link').value = details.supplies_link || '';
            } else if (project.craft_type === 'Quilting') {
                document.getElementById('edit-quilting-fields').style.display = 'block';
                document.getElementById('edit-quilting-size').value = details.quilt_size || '';
                document.getElementById('edit-quilting-batting').value = details.batting_type || '';
                document.getElementById('edit-quilting-fabric').value = details.fabric_collection || '';
                document.getElementById('edit-quilting-block').value = details.block_pattern || '';
                document.getElementById('edit-quilting-pattern-link').value = details.pattern_link || '';
                document.getElementById('edit-quilting-supplies-link').value = details.supplies_link || '';
            } else if (project.craft_type === 'Leather Work') {
                document.getElementById('edit-leather-fields').style.display = 'block';
                document.getElementById('edit-leather-type').value = details.leather_type || '';
                document.getElementById('edit-leather-weight').value = details.leather_weight || '';
                document.getElementById('edit-leather-color').value = details.color_finish || '';
                document.getElementById('edit-leather-hardware').value = details.hardware || '';
                document.getElementById('edit-leather-pattern-link').value = details.pattern_link || '';
                document.getElementById('edit-leather-supplies-link').value = details.supplies_link || '';
            }
            
            document.getElementById('edit-project-modal').classList.add('show');
        }

        function closeEditProject() {
            document.getElementById('edit-project-modal').classList.remove('show');
        }

        async function handleUpdateProject(event) {
            event.preventDefault();
            
            const projectId = document.getElementById('edit-project-id').value;
            const craftType = document.getElementById('edit-project-craft-type').value;
            
            console.log('Updating project:', projectId);
            
            // Get old project data to compare
            const { data: oldProject } = await supabase
                .from('projects')
                .select('title, craft_details')
                .eq('id', projectId)
                .single();
            
            const newTitle = document.getElementById('edit-project-title').value;
            const newCraftDetails = getEditCraftDetails(craftType);
            
            // Build changes summary
            let changes = [];
            if (oldProject.title !== newTitle) {
                changes.push('title');
            }
            
            // Check if craft details changed
            const oldDetails = oldProject.craft_details || {};
            const newDetails = newCraftDetails;
            
            if (Object.keys(newDetails).length > Object.keys(oldDetails).length) {
                changes.push('added craft details');
            } else if (JSON.stringify(oldDetails) !== JSON.stringify(newDetails)) {
                changes.push('updated craft details');
            }

            const { data, error } = await supabase.from('projects').update({
                title: newTitle,
                description: document.getElementById('edit-project-description').value,
                status: document.getElementById('edit-project-status').value,
                craft_details: newCraftDetails
            }).eq('id', projectId).select();

            if (error) {
                console.error('Error updating project:', error);
                alert('Failed to update project: ' + error.message);
                return;
            }

            console.log('Project updated successfully:', data);

            // Log the edit for the feed
            if (changes.length > 0) {
                await supabase.from('project_edits').insert({
                    project_id: projectId,
                    user_id: currentUser.id,
                    changes_summary: 'Updated: ' + changes.join(', ')
                });
            }

            closeEditProject();
            alert('Project updated successfully!');
            
            // Reload all data
            await loadUserData();
            
            // Reopen the project to show changes
            setTimeout(() => {
                showProjectDetail(projectId);
            }, 500);
        }

        function getEditCraftDetails(craftType) {
            const details = {};
            
            if (craftType === 'Crochet') {
                const hook = document.getElementById('edit-crochet-hook').value;
                const brand = document.getElementById('edit-crochet-yarn-brand').value;
                const color = document.getElementById('edit-crochet-yarn-color').value;
                const weight = document.getElementById('edit-crochet-yarn-weight').value;
                const gauge = document.getElementById('edit-crochet-gauge').value;
                const yardage = document.getElementById('edit-crochet-yardage').value;
                const pattern = document.getElementById('edit-crochet-pattern-link').value;
                const supplies = document.getElementById('edit-crochet-supplies-link').value;
                
                if (hook) details.hook_size = hook;
                if (brand) details.yarn_brand = brand;
                if (color) details.yarn_color = color;
                if (weight) details.yarn_weight = weight;
                if (gauge) details.gauge = gauge;
                if (yardage) details.yardage = yardage;
                if (pattern) details.pattern_link = pattern;
                if (supplies) details.supplies_link = supplies;
            } else if (craftType === 'Knitting') {
                const needleType = document.getElementById('edit-knitting-needle-type').value;
                const needleSize = document.getElementById('edit-knitting-needle-size').value;
                const brand = document.getElementById('edit-knitting-yarn-brand').value;
                const color = document.getElementById('edit-knitting-yarn-color').value;
                const weight = document.getElementById('edit-knitting-yarn-weight').value;
                const yardage = document.getElementById('edit-knitting-yardage').value;
                const pattern = document.getElementById('edit-knitting-pattern-link').value;
                const supplies = document.getElementById('edit-knitting-supplies-link').value;
                
                if (needleType) details.needle_type = needleType;
                if (needleSize) details.needle_size = needleSize;
                if (brand) details.yarn_brand = brand;
                if (color) details.yarn_color = color;
                if (weight) details.yarn_weight = weight;
                if (yardage) details.yardage = yardage;
                if (pattern) details.pattern_link = pattern;
                if (supplies) details.supplies_link = supplies;
            } else if (craftType === 'Sewing') {
                const fabricType = document.getElementById('edit-sewing-fabric-type').value;
                const fabricAmount = document.getElementById('edit-sewing-fabric-amount').value;
                const fabricBrand = document.getElementById('edit-sewing-fabric-brand').value;
                const needleInfo = document.getElementById('edit-sewing-needle-info').value;
                const notions = document.getElementById('edit-sewing-notions').value;
                const pattern = document.getElementById('edit-sewing-pattern-link').value;
                const supplies = document.getElementById('edit-sewing-supplies-link').value;
                
                if (fabricType) details.fabric_type = fabricType;
                if (fabricAmount) details.fabric_amount = fabricAmount;
                if (fabricBrand) details.fabric_brand = fabricBrand;
                if (needleInfo) details.needle_info = needleInfo;
                if (notions) details.notions = notions;
                if (pattern) details.pattern_link = pattern;
                if (supplies) details.supplies_link = supplies;
            } else if (craftType === 'Embroidery') {
                const threadBrand = document.getElementById('edit-embroidery-thread-brand').value;
                const colors = document.getElementById('edit-embroidery-colors').value;
                const fabric = document.getElementById('edit-embroidery-fabric').value;
                const hoop = document.getElementById('edit-embroidery-hoop').value;
                const pattern = document.getElementById('edit-embroidery-pattern-link').value;
                const supplies = document.getElementById('edit-embroidery-supplies-link').value;
                
                if (threadBrand) details.thread_brand = threadBrand;
                if (colors) details.thread_colors = colors;
                if (fabric) details.fabric = fabric;
                if (hoop) details.hoop_size = hoop;
                if (pattern) details.pattern_link = pattern;
                if (supplies) details.supplies_link = supplies;
            } else if (craftType === 'Weaving') {
                const loom = document.getElementById('edit-weaving-loom').value;
                const reed = document.getElementById('edit-weaving-reed').value;
                const warp = document.getElementById('edit-weaving-warp').value;
                const weft = document.getElementById('edit-weaving-weft').value;
                const dimensions = document.getElementById('edit-weaving-dimensions').value;
                const supplies = document.getElementById('edit-weaving-supplies-link').value;
                
                if (loom) details.loom_type = loom;
                if (reed) details.reed_size = reed;
                if (warp) details.warp_yarn = warp;
                if (weft) details.weft_yarn = weft;
                if (dimensions) details.dimensions = dimensions;
                if (supplies) details.supplies_link = supplies;
            } else if (craftType === 'Quilting') {
                const size = document.getElementById('edit-quilting-size').value;
                const batting = document.getElementById('edit-quilting-batting').value;
                const fabric = document.getElementById('edit-quilting-fabric').value;
                const block = document.getElementById('edit-quilting-block').value;
                const pattern = document.getElementById('edit-quilting-pattern-link').value;
                const supplies = document.getElementById('edit-quilting-supplies-link').value;
                
                if (size) details.quilt_size = size;
                if (batting) details.batting_type = batting;
                if (fabric) details.fabric_collection = fabric;
                if (block) details.block_pattern = block;
                if (pattern) details.pattern_link = pattern;
                if (supplies) details.supplies_link = supplies;
            } else if (craftType === 'Leather Work') {
                const type = document.getElementById('edit-leather-type').value;
                const weight = document.getElementById('edit-leather-weight').value;
                const color = document.getElementById('edit-leather-color').value;
                const hardware = document.getElementById('edit-leather-hardware').value;
                const pattern = document.getElementById('edit-leather-pattern-link').value;
                const supplies = document.getElementById('edit-leather-supplies-link').value;
                
                if (type) details.leather_type = type;
                if (weight) details.leather_weight = weight;
                if (color) details.color_finish = color;
                if (hardware) details.hardware = hardware;
                if (pattern) details.pattern_link = pattern;
                if (supplies) details.supplies_link = supplies;
            }
            
            return details;
        }

        function showAddUpdate(projectId) {
            document.getElementById('update-project-id').value = projectId;
            document.getElementById('update-content').value = '';
            document.getElementById('update-photo').value = '';
            document.getElementById('update-photo-preview').style.display = 'none';
            document.getElementById('add-update-modal').classList.add('show');
        }

        function closeAddUpdate() {
            document.getElementById('add-update-modal').classList.remove('show');
        }

        async function handleAddUpdate(event) {
            event.preventDefault();
            
            const projectId = document.getElementById('update-project-id').value;
            const content = document.getElementById('update-content').value;
            const photoInput = document.getElementById('update-photo');
            
            console.log('Adding update for project:', projectId);
            
            let photoUrl = null;
            
            // Upload photo if provided
            if (photoInput.files && photoInput.files[0]) {
                const file = photoInput.files[0];
                const fileExt = file.name.split('.').pop();
                const fileName = `${projectId}/${Date.now()}.${fileExt}`;
                
                console.log('Uploading photo:', fileName);
                
                const { data, error: uploadError } = await supabase.storage
                    .from('project-images')
                    .upload(fileName, file);
                
                if (uploadError) {
                    console.warn('Photo upload failed:', uploadError.message);
                    // Continue without photo
                } else {
                    const { data: urlData } = supabase.storage
                        .from('project-images')
                        .getPublicUrl(fileName);
                    photoUrl = urlData.publicUrl;
                    console.log('Photo uploaded:', photoUrl);
                }
            }
            
            // Create update
            const { data, error } = await supabase.from('project_updates').insert({
                project_id: projectId,
                user_id: currentUser.id,
                content: content,
                photo_url: photoUrl
            }).select();
            
            if (error) {
                console.error('Error creating update:', error);
                alert('Failed to post update: ' + error.message);
                return;
            }
            
            console.log('Update posted successfully:', data);
            
            closeAddUpdate();
            alert('Update posted!');
            
            // Reload everything
            await loadUserData();
            
            // Reopen the project to show the update
            setTimeout(() => {
                showProjectDetail(projectId);
            }, 500);
        }

        // Preview photo before upload
        document.addEventListener('DOMContentLoaded', () => {
            const photoInput = document.getElementById('update-photo');
            if (photoInput) {
                photoInput.addEventListener('change', (e) => {
                    const file = e.target.files[0];
                    if (file) {
                        const reader = new FileReader();
                        reader.onload = (e) => {
                            const preview = document.getElementById('update-photo-preview');
                            preview.querySelector('img').src = e.target.result;
                            preview.style.display = 'block';
                        };
                        reader.readAsDataURL(file);
                    }
                });
            }
        });

        function showEditProfile() {
            document.getElementById('edit-username').value = userProfile.username;
            document.getElementById('edit-fullname').value = userProfile.full_name;
            document.getElementById('edit-bio').value = userProfile.bio || '';
            document.getElementById('edit-location').value = userProfile.location || '';
            document.getElementById('edit-interests').value = userProfile.interests ? userProfile.interests.join(', ') : '';
            
            const preview = document.getElementById('profile-pic-preview');
            if (userProfile.profile_picture_url) {
                preview.innerHTML = `<img src="${userProfile.profile_picture_url}">`;
            } else {
                preview.innerHTML = `<span id="profile-pic-initials">${userProfile.avatar_initials}</span>`;
            }
            
            document.getElementById('edit-profile-modal').classList.add('show');
            hideAllDropdowns();
        }

        function closeEditProfile() {
            document.getElementById('edit-profile-modal').classList.remove('show');
        }

        async function handleProfilePictureChange(event) {
            const file = event.target.files[0];
            if (!file) return;

            const fileExt = file.name.split('.').pop();
            const fileName = `${currentUser.id}/${Date.now()}.${fileExt}`;

            const { error: uploadError } = await supabase.storage
                .from('profile-pictures')
                .upload(fileName, file);

            if (uploadError) {
                console.error('Upload error:', uploadError);
                return;
            }

            const { data: { publicUrl } } = supabase.storage
                .from('profile-pictures')
                .getPublicUrl(fileName);

            document.getElementById('profile-pic-preview').innerHTML = `<img src="${publicUrl}">`;
            userProfile.profile_picture_url = publicUrl;
        }

        async function handleUpdateProfile(event) {
            event.preventDefault();

            const interests = document.getElementById('edit-interests').value
                .split(',')
                .map(i => i.trim())
                .filter(i => i);

            await supabase.from('profiles').update({
                full_name: document.getElementById('edit-fullname').value,
                bio: document.getElementById('edit-bio').value,
                location: document.getElementById('edit-location').value,
                interests: interests,
                profile_picture_url: userProfile.profile_picture_url
            }).eq('id', currentUser.id);

            closeEditProfile();
            await loadUserData();
            alert('Profile updated!');
        }

        function showSettings() {
            document.getElementById('setting-measurement').value = userProfile.measurement_system || 'metric';
            document.getElementById('setting-weight').value = userProfile.weight_unit || 'kg';
            document.getElementById('setting-length').value = userProfile.length_unit || 'cm';
            
            document.getElementById('settings-modal').classList.add('show');
            hideAllDropdowns();
        }

        function closeSettings() {
            document.getElementById('settings-modal').classList.remove('show');
        }

        async function handleUpdateSettings(event) {
            event.preventDefault();

            await supabase.from('profiles').update({
                measurement_system: document.getElementById('setting-measurement').value,
                weight_unit: document.getElementById('setting-weight').value,
                length_unit: document.getElementById('setting-length').value
            }).eq('id', currentUser.id);

            closeSettings();
            await loadUserData();
            alert('Settings saved!');
        }

        async function showUserProfile(userId) {
            // Fetch profile directly from profiles table
            const { data: user, error } = await supabase
                .from('profiles')
                .select('*')
                .eq('id', userId)
                .single();
            
            if (error || !user) {
                console.error('Error loading profile:', error);
                alert('Could not load user profile');
                return;
            }
            
            const isOwnProfile = userId === currentUser.id;

            // Get user's projects
            const { data: userProjects } = await supabase
                .from('projects')
                .select('*')
                .eq('user_id', userId)
                .order('created_at', { ascending: false })
                .limit(6);

            // Get friend count using the same mutual follow logic
            const { data: userIFollow } = await supabase
                .from('follows')
                .select('following_id')
                .eq('follower_id', userId);

            const { data: userFollowMe } = await supabase
                .from('follows')
                .select('follower_id')
                .eq('following_id', userId);

            let friendCount = 0;
            if (userIFollow && userFollowMe) {
                const userIFollowIds = userIFollow.map(f => f.following_id);
                const userFollowMeIds = userFollowMe.map(f => f.follower_id);
                friendCount = userIFollowIds.filter(id => userFollowMeIds.includes(id)).length;
            }

            // Check if we're friends with this user
            const areFriends = await checkIfFriends(currentUser.id, userId);

            const content = `
                <div style="text-align: center;">
                    <div style="width: 120px; height: 120px; border-radius: 50%; background: var(--terracotta); margin: 0 auto 1rem; display: flex; align-items: center; justify-content: center; color: white; font-size: 3rem; font-weight: bold; overflow: hidden;">
                        ${user.profile_picture_url ? 
                            `<img src="${user.profile_picture_url}" style="width: 100%; height: 100%; object-fit: cover;">` : 
                            user.avatar_initials
                        }
                    </div>
                    <h2 style="margin-bottom: 0.5rem;">@${user.username}</h2>
                    <p style="color: var(--text-muted); margin-bottom: 0.5rem; font-size: 1.1rem;">${user.full_name}</p>
                    ${user.location ? `<p style="color: var(--text-muted); margin-bottom: 1rem;">üìç ${user.location}</p>` : ''}
                    ${user.bio ? `<p style="margin: 1.5rem 0; padding: 1rem; background: var(--cream); border-radius: 8px; font-style: italic;">"${user.bio}"</p>` : ''}
                    
                    ${user.interests && user.interests.length > 0 ? `
                        <div style="margin-bottom: 1.5rem;">
                            <h4 style="margin-bottom: 0.75rem; color: var(--dark-brown);">Interests</h4>
                            <div style="display: flex; flex-wrap: wrap; gap: 0.5rem; justify-content: center;">
                                ${user.interests.map(interest => `
                                    <span style="padding: 0.4rem 0.8rem; background: var(--light-beige); border-radius: 20px; font-size: 0.85rem;">${interest}</span>
                                `).join('')}
                            </div>
                        </div>
                    ` : ''}
                    
                    <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 1rem; margin: 2rem 0; padding: 1rem; background: var(--cream); border-radius: 8px;">
                        <div style="text-align: center;">
                            <div style="font-size: 1.5rem; font-weight: bold; color: var(--terracotta);">${user.projects_count}</div>
                            <div style="font-size: 0.8rem; color: var(--text-muted);">Projects</div>
                        </div>
                        <div style="text-align: center;">
                            <div style="font-size: 1.5rem; font-weight: bold; color: var(--terracotta);">${friendCount}</div>
                            <div style="font-size: 0.8rem; color: var(--text-muted);">Friends</div>
                        </div>
                        <div style="text-align: center;">
                            <div style="font-size: 1.5rem; font-weight: bold; color: var(--terracotta);">${user.level}</div>
                            <div style="font-size: 0.8rem; color: var(--text-muted);">Level</div>
                        </div>
                        <div style="text-align: center;">
                            <div style="font-size: 1.5rem; font-weight: bold; color: var(--terracotta);">${user.total_likes_received}</div>
                            <div style="font-size: 0.8rem; color: var(--text-muted);">Likes</div>
                        </div>
                    </div>

                    ${userProjects && userProjects.length > 0 ? `
                        <div style="text-align: left; margin-top: 2rem;">
                            <h3 style="margin-bottom: 1rem; color: var(--dark-brown);">Recent Projects</h3>
                            <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 1rem;">
                                ${userProjects.map(project => `
                                    <div style="background: var(--light-beige); padding: 1rem; border-radius: 8px; cursor: pointer;" onclick="closeProfileView(); showProjectDetail('${project.id}');">
                                        <div style="font-size: 2rem; text-align: center; margin-bottom: 0.5rem;">${getCraftIcon(project.craft_type)}</div>
                                        <h4 style="font-size: 0.9rem; margin-bottom: 0.25rem; text-align: center;">${project.title}</h4>
                                        <div style="text-align: center; font-size: 0.75rem; color: var(--text-muted);">
                                            ‚ù§Ô∏è ${project.likes_count || 0} ¬∑ üí¨ ${project.comments_count || 0}
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    ` : `
                        <div style="padding: 2rem; background: var(--cream); border-radius: 8px; margin-top: 2rem;">
                            <p style="color: var(--text-muted);">No projects yet</p>
                        </div>
                    `}
                    
                    ${!isOwnProfile ? `
                        <div style="display: flex; gap: 1rem; margin-top: 2rem;">
                            <button class="btn btn-primary" style="flex: 1;" onclick="toggleFollow('${userId}'); setTimeout(() => showUserProfile('${userId}'), 500);" id="profile-follow-btn-${userId}">
                                Follow
                            </button>
                            ${areFriends ? `
                                <button class="btn btn-secondary" style="flex: 1;" onclick="closeProfileView(); openChat('${userId}', '${user.username}', '${user.profile_picture_url || ''}', '${user.avatar_initials}');">
                                    üí¨ Message
                                </button>
                            ` : `
                                <div style="flex: 1; padding: 0.75rem; background: var(--light-beige); border-radius: 8px; font-size: 0.85rem; color: var(--text-muted); text-align: center;">
                                    Follow each other to message
                                </div>
                            `}
                        </div>
                    ` : ''}
                </div>
            `;

            document.getElementById('profile-view-content').innerHTML = content;
            document.getElementById('profile-view-modal').classList.add('show');

            // Update follow button state
            if (!isOwnProfile) {
                checkFollowStatusForProfile(userId);
            }
        }

        async function checkFollowStatusForProfile(userId) {
            const { data } = await supabase
                .from('follows')
                .select('id')
                .eq('follower_id', currentUser.id)
                .eq('following_id', userId)
                .single();

            const btn = document.getElementById(`profile-follow-btn-${userId}`);
            if (btn) {
                btn.textContent = data ? 'Following' : 'Follow';
                btn.className = data ? 'btn btn-secondary' : 'btn btn-primary';
            }
        }

        function closeProfileView() {
            document.getElementById('profile-view-modal').classList.remove('show');
        }

        async function loadNotifications() {
            const { data: notifs } = await supabase
                .from('notifications')
                .select('*')
                .eq('user_id', currentUser.id)
                .order('created_at', { ascending: false })
                .limit(20);

            const unreadCount = notifs?.filter(n => !n.is_read).length || 0;
            const badge = document.getElementById('notif-count');
            if (unreadCount > 0) {
                badge.textContent = unreadCount;
                badge.style.display = 'flex';
            } else {
                badge.style.display = 'none';
            }

            const container = document.getElementById('notifications-list');
            
            if (!notifs || notifs.length === 0) {
                container.innerHTML = '<div class="dropdown-item">No notifications yet</div>';
                return;
            }

            container.innerHTML = notifs.map(notif => `
                <div class="dropdown-item ${!notif.is_read ? 'notif-unread' : ''}" onclick="markNotificationRead('${notif.id}')">
                    <div class="notif-content">${notif.content}</div>
                    <div class="notif-time">${getTimeAgo(notif.created_at)}</div>
                </div>
            `).join('');
        }

        async function markNotificationRead(notifId) {
            await supabase
                .from('notifications')
                .update({ is_read: true })
                .eq('id', notifId);
            
            await loadNotifications();
        }

        async function markAllRead() {
            // Update all unread notifications to read
            await supabase
                .from('notifications')
                .update({ is_read: true })
                .eq('user_id', currentUser.id)
                .eq('is_read', false);
            
            // Reload notifications to update UI
            await loadNotifications();
        }

        async function loadConversations() {
            // Get all users I follow
            const { data: iFollow } = await supabase
                .from('follows')
                .select('following_id')
                .eq('follower_id', currentUser.id);

            // Get all users who follow me
            const { data: followMe } = await supabase
                .from('follows')
                .select('follower_id')
                .eq('following_id', currentUser.id);

            if (!iFollow || !followMe || iFollow.length === 0 || followMe.length === 0) {
                document.getElementById('conversations-list').innerHTML = '<div class="dropdown-item">No friends to message yet</div>';
                document.getElementById('chat-area').innerHTML = `
                    <div class="card">
                        <div class="empty-state">
                            <div class="empty-state-icon">üí¨</div>
                            <p>No conversations yet!</p>
                            <p style="font-size: 0.9rem; margin-top: 0.5rem;">Follow someone and have them follow you back to become friends and message each other!</p>
                        </div>
                    </div>
                `;
                return;
            }

            // Find mutual follows (friends)
            const iFollowIds = iFollow.map(f => f.following_id);
            const followMeIds = followMe.map(f => f.follower_id);
            const friendIds = iFollowIds.filter(id => followMeIds.includes(id));

            if (friendIds.length === 0) {
                document.getElementById('conversations-list').innerHTML = '<div class="dropdown-item">No friends to message yet<br><small>Follow someone and have them follow you back!</small></div>';
                document.getElementById('chat-area').innerHTML = `
                    <div class="card">
                        <div class="empty-state">
                            <div class="empty-state-icon">üí¨</div>
                            <p>No friends yet!</p>
                            <p style="font-size: 0.9rem; margin-top: 0.5rem;">Follow someone and have them follow you back to become friends and start messaging!</p>
                        </div>
                    </div>
                `;
                return;
            }

            // Get messages with friends only
            const { data: messages } = await supabase
                .from('messages')
                .select('*, sender:profiles!messages_sender_id_fkey(username, avatar_initials, profile_picture_url), receiver:profiles!messages_receiver_id_fkey(username, avatar_initials, profile_picture_url)')
                .or(`sender_id.eq.${currentUser.id},receiver_id.eq.${currentUser.id}`)
                .order('created_at', { ascending: false });

            const unreadCount = messages?.filter(m => m.receiver_id === currentUser.id && !m.is_read).length || 0;
            const badge = document.getElementById('message-count');
            if (unreadCount > 0) {
                badge.textContent = unreadCount;
                badge.style.display = 'flex';
            } else {
                badge.style.display = 'none';
            }

            const conversations = {};
            messages?.forEach(msg => {
                const otherId = msg.sender_id === currentUser.id ? msg.receiver_id : msg.sender_id;
                // Only include if they're a friend
                if (friendIds.includes(otherId)) {
                    if (!conversations[otherId]) {
                        conversations[otherId] = {
                            lastMessage: msg,
                            unread: 0,
                            otherUser: msg.sender_id === currentUser.id ? msg.receiver : msg.sender
                        };
                    }
                    if (msg.receiver_id === currentUser.id && !msg.is_read) {
                        conversations[otherId].unread++;
                    }
                }
            });

            const conversationList = Object.keys(conversations);

            if (conversationList.length === 0) {
                document.getElementById('conversations-list').innerHTML = '<div class="dropdown-item">No messages yet<br><small>Start chatting with your friends!</small></div>';
                
                // Show friends list in chat area if no conversations yet
                const { data: friendProfiles } = await supabase
                    .from('profiles')
                    .select('*')
                    .in('id', friendIds);
                
                document.getElementById('chat-area').innerHTML = `
                    <div class="card">
                        <h3 style="margin-bottom: 1.5rem;">üí¨ Your Friends (${friendIds.length})</h3>
                        <p style="color: var(--text-muted); margin-bottom: 1.5rem; font-family: -apple-system, sans-serif;">
                            Click on a friend to start chatting!
                        </p>
                        <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 1rem;">
                            ${friendProfiles.map(friend => `
                                <div class="card" style="cursor: pointer; transition: all 0.3s; padding: 1.5rem;" onclick="openChat('${friend.id}', '${friend.username}', '${friend.profile_picture_url || ''}', '${friend.avatar_initials}')">
                                    <div style="display: flex; align-items: center; gap: 1rem;">
                                        <div style="width: 56px; height: 56px; border-radius: 50%; background: var(--terracotta); display: flex; align-items: center; justify-content: center; color: white; font-size: 1.5rem; font-weight: bold; overflow: hidden; flex-shrink: 0;">
                                            ${friend.profile_picture_url ? 
                                                `<img src="${friend.profile_picture_url}" style="width: 100%; height: 100%; object-fit: cover;">` : 
                                                friend.avatar_initials
                                            }
                                        </div>
                                        <div style="flex: 1; min-width: 0;">
                                            <h4 style="margin-bottom: 0.25rem;">@${friend.username}</h4>
                                            <p style="color: var(--text-muted); font-family: -apple-system, sans-serif; font-size: 0.9rem;">${friend.full_name}</p>
                                        </div>
                                        <div style="font-size: 1.5rem;">üí¨</div>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            } else {
                // Update dropdown conversations
                document.getElementById('conversations-list').innerHTML = conversationList.map(userId => {
                    const conv = conversations[userId];
                    return `
                        <div class="dropdown-item ${conv.unread > 0 ? 'notif-unread' : ''}" onclick="hideAllDropdowns(); openChat('${userId}', '${conv.otherUser.username}', '${conv.otherUser.profile_picture_url || ''}', '${conv.otherUser.avatar_initials}')">
                            <div style="display: flex; align-items: center; gap: 0.75rem;">
                                <div style="width: 40px; height: 40px; border-radius: 50%; background: var(--terracotta); display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; overflow: hidden;">
                                    ${conv.otherUser.profile_picture_url ? 
                                        `<img src="${conv.otherUser.profile_picture_url}" style="width: 100%; height: 100%; object-fit: cover;">` : 
                                        conv.otherUser.avatar_initials
                                    }
                                </div>
                                <div style="flex: 1;">
                                    <div style="font-weight: 600;">@${conv.otherUser.username}</div>
                                    <div class="notif-content" style="margin: 0;">${conv.lastMessage.content.substring(0, 50)}${conv.lastMessage.content.length > 50 ? '...' : ''}</div>
                                </div>
                                ${conv.unread > 0 ? `<div style="background: var(--love); color: white; border-radius: 50%; width: 24px; height: 24px; display: flex; align-items: center; justify-content: center; font-size: 0.75rem; font-weight: bold;">${conv.unread}</div>` : ''}
                            </div>
                        </div>
                    `;
                }).join('');

                // Show conversation list in chat area (main Messages section)
                document.getElementById('chat-area').innerHTML = `
                    <div class="card">
                        <h3 style="margin-bottom: 1.5rem;">üí¨ Conversations</h3>
                        <div style="display: flex; flex-direction: column; gap: 1rem;">
                            ${conversationList.map(userId => {
                                const conv = conversations[userId];
                                return `
                                    <div class="card" style="cursor: pointer; background: ${conv.unread > 0 ? 'var(--cream)' : 'white'}; padding: 1.5rem; transition: all 0.3s; border: 2px solid ${conv.unread > 0 ? 'var(--terracotta)' : 'transparent'};" 
                                         onclick="openChat('${userId}', '${conv.otherUser.username}', '${conv.otherUser.profile_picture_url || ''}', '${conv.otherUser.avatar_initials}')"
                                         onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 20px rgba(0,0,0,0.1)'"
                                         onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 2px 8px rgba(0,0,0,0.05)'">
                                        <div style="display: flex; align-items: center; gap: 1rem;">
                                            <div style="width: 64px; height: 64px; border-radius: 50%; background: var(--terracotta); display: flex; align-items: center; justify-content: center; color: white; font-size: 1.75rem; font-weight: bold; overflow: hidden; flex-shrink: 0;">
                                                ${conv.otherUser.profile_picture_url ? 
                                                    `<img src="${conv.otherUser.profile_picture_url}" style="width: 100%; height: 100%; object-fit: cover;">` : 
                                                    conv.otherUser.avatar_initials
                                                }
                                            </div>
                                            <div style="flex: 1; min-width: 0;">
                                                <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem;">
                                                    <h4 style="margin: 0;">@${conv.otherUser.username}</h4>
                                                    ${conv.unread > 0 ? `
                                                        <div style="background: var(--love); color: white; border-radius: 12px; padding: 0.25rem 0.5rem; font-size: 0.75rem; font-weight: bold; font-family: -apple-system, sans-serif;">
                                                            ${conv.unread} new
                                                        </div>
                                                    ` : ''}
                                                </div>
                                                <p style="color: var(--text-muted); font-family: -apple-system, sans-serif; font-size: 0.95rem; margin-bottom: 0.5rem; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">
                                                    ${conv.lastMessage.sender_id === currentUser.id ? 'You: ' : ''}${conv.lastMessage.content}
                                                </p>
                                                <p style="color: var(--text-muted); font-size: 0.8rem; font-family: -apple-system, sans-serif;">
                                                    ${getTimeAgo(conv.lastMessage.created_at)}
                                                </p>
                                            </div>
                                            <div style="font-size: 2rem; flex-shrink: 0;">üí¨</div>
                                        </div>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    </div>
                `;
            }
        }

        async function openChat(friendId, friendUsername, friendPicture, friendInitials) {
            // Verify users are friends before opening chat
            const areFriends = await checkIfFriends(currentUser.id, friendId);
            
            if (!areFriends) {
                alert('You can only message friends! Follow each other to become friends.');
                return;
            }

            currentChatUser = { id: friendId, username: friendUsername, picture: friendPicture, initials: friendInitials };
            
            console.log('Opening chat with:', friendUsername, friendId);
            
            // Update widget header
            const widgetAvatar = document.getElementById('chat-widget-avatar');
            if (friendPicture) {
                widgetAvatar.innerHTML = `<img src="${friendPicture}" alt="${friendUsername}">`;
            } else {
                widgetAvatar.textContent = friendInitials;
            }
            document.getElementById('chat-widget-name').textContent = `@${friendUsername}`;
            
            // Show widget
            document.getElementById('chat-widget').classList.add('show');
            
            // Mark messages as read
            await supabase
                .from('messages')
                .update({ is_read: true })
                .eq('sender_id', friendId)
                .eq('receiver_id', currentUser.id)
                .eq('is_read', false);
            
            // Load messages
            await loadWidgetMessages(friendId);
            
            // Setup real-time - remove old channel first
            if (chatRealtimeChannel) {
                await supabase.removeChannel(chatRealtimeChannel);
            }
            
            // Create new channel for this conversation
            const channelName = `chat-${currentUser.id}-${friendId}`;
            console.log('Setting up real-time channel:', channelName);
            
            chatRealtimeChannel = supabase
                .channel(channelName)
                .on('postgres_changes', {
                    event: 'INSERT',
                    schema: 'public',
                    table: 'messages'
                }, (payload) => {
                    console.log('New message received:', payload);
                    // Check if message is for this conversation
                    if ((payload.new.sender_id === friendId && payload.new.receiver_id === currentUser.id) ||
                        (payload.new.sender_id === currentUser.id && payload.new.receiver_id === friendId)) {
                        loadWidgetMessages(friendId);
                        loadConversations(); // Update conversation list
                    }
                })
                .subscribe((status) => {
                    console.log('Channel status:', status);
                });
        }

        function closeChatWidget() {
            document.getElementById('chat-widget').classList.remove('show');
            if (chatRealtimeChannel) {
                supabase.removeChannel(chatRealtimeChannel);
            }
            currentChatUser = null;
        }

        async function loadWidgetMessages(friendId) {
            console.log('Loading messages with friend:', friendId);
            
            const { data: messages, error } = await supabase
                .from('messages')
                .select('*')
                .or(`and(sender_id.eq.${currentUser.id},receiver_id.eq.${friendId}),and(sender_id.eq.${friendId},receiver_id.eq.${currentUser.id})`)
                .order('created_at', { ascending: true });

            console.log('Messages loaded:', messages?.length || 0, 'messages');
            
            if (error) {
                console.error('Error loading messages:', error);
                return;
            }

            const container = document.getElementById('chat-widget-messages');
            
            if (!messages || messages.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; color: var(--text-muted); padding: 2rem;">
                        <p>No messages yet. Start the conversation! üëã</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = messages.map(msg => {
                const isSent = msg.sender_id === currentUser.id;
                return `
                    <div class="chat-bubble ${isSent ? 'chat-bubble-sent' : 'chat-bubble-received'}">
                        <div>${msg.content}</div>
                        <div class="chat-bubble-time">${getTimeAgo(msg.created_at)}</div>
                    </div>
                `;
            }).join('');
            
            // Scroll to bottom
            setTimeout(() => {
                container.scrollTop = container.scrollHeight;
            }, 100);
        }

        async function sendWidgetMessage(event) {
            event.preventDefault();
            
            console.log('Sending message...');
            
            if (!currentChatUser) {
                console.error('No chat user selected');
                return;
            }
            
            const input = document.getElementById('chat-widget-input');
            const content = input.value.trim();
            
            if (!content) {
                console.log('Empty message');
                return;
            }
            
            console.log('Message content:', content);
            console.log('Sending to:', currentChatUser.id);
            
            // Send message
            const { data, error } = await supabase.from('messages').insert({
                sender_id: currentUser.id,
                receiver_id: currentChatUser.id,
                content: content
            }).select();
            
            if (error) {
                console.error('Error sending message:', error);
                alert('Failed to send message: ' + error.message);
                return;
            }
            
            console.log('Message sent successfully:', data);
            
            // Send notification to receiver
            await supabase.from('notifications').insert({
                user_id: currentChatUser.id,
                type: 'message',
                content: `New message from @${userProfile.username}`,
                related_user_id: currentUser.id
            });
            
            // Clear input
            input.value = '';
            
            // Reload messages
            await loadWidgetMessages(currentChatUser.id);
            
            // Reload conversations list
            await loadConversations();
        }

        async function loadChatMessages(friendId) {
            const { data: messages } = await supabase
                .from('messages')
                .select('*')
                .or(`and(sender_id.eq.${currentUser.id},receiver_id.eq.${friendId}),and(sender_id.eq.${friendId},receiver_id.eq.${currentUser.id})`)
                .order('created_at', { ascending: true });

            const chatArea = document.getElementById('chat-area');
            
            chatArea.innerHTML = `
                <div class="card" style="height: calc(100vh - 250px); display: flex; flex-direction: column;">
                    <div style="display: flex; align-items: center; gap: 1rem; padding-bottom: 1rem; border-bottom: 2px solid var(--light-beige); margin-bottom: 1rem;">
                        <div style="width: 48px; height: 48px; border-radius: 50%; background: var(--terracotta); display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; overflow: hidden; cursor: pointer;" onclick="showUserProfile('${currentChatUser.id}')">
                            ${currentChatUser.picture ? 
                                `<img src="${currentChatUser.picture}" style="width: 100%; height: 100%; object-fit: cover;">` : 
                                currentChatUser.initials
                            }
                        </div>
                        <div style="flex: 1;">
                            <h3 style="margin: 0; cursor: pointer;" onclick="showUserProfile('${currentChatUser.id}')">@${currentChatUser.username}</h3>
                        </div>
                        <button onclick="showSection('chat'); currentChatUser = null; loadConversations();" style="background: none; border: none; font-size: 1.5rem; cursor: pointer; color: var(--text-muted);">‚úï</button>
                    </div>
                    
                    <div id="chat-messages" style="flex: 1; overflow-y: auto; padding: 1rem 0; display: flex; flex-direction: column; gap: 1rem;">
                        ${messages.length === 0 ? `
                            <div style="text-align: center; color: var(--text-muted); padding: 2rem;">
                                <p>No messages yet. Start the conversation! üëã</p>
                            </div>
                        ` : messages.map(msg => {
                            const isSent = msg.sender_id === currentUser.id;
                            return `
                                <div style="display: flex; justify-content: ${isSent ? 'flex-end' : 'flex-start'};">
                                    <div style="max-width: 70%; padding: 0.75rem 1rem; border-radius: 16px; background: ${isSent ? 'var(--terracotta)' : 'var(--light-beige)'}; color: ${isSent ? 'white' : 'var(--text-dark)'};">
                                        <div style="font-family: -apple-system, sans-serif; word-wrap: break-word;">${msg.content}</div>
                                        <div style="font-size: 0.7rem; margin-top: 0.25rem; opacity: 0.7;">${getTimeAgo(msg.created_at)}</div>
                                    </div>
                                </div>
                            `;
                        }).join('')}
                    </div>
                    
                    <form onsubmit="sendMessage(event, '${friendId}')" style="display: flex; gap: 0.75rem; padding-top: 1rem; border-top: 2px solid var(--light-beige);">
                        <input type="text" id="message-input" placeholder="Type a message..." style="flex: 1; border: 2px solid var(--light-beige); padding: 0.75rem 1rem; border-radius: 24px; font-family: -apple-system, sans-serif;" required>
                        <button type="submit" class="btn btn-primary" style="border-radius: 24px; padding: 0.75rem 2rem;">Send</button>
                    </form>
                </div>
            `;
            
            setTimeout(() => {
                const messagesDiv = document.getElementById('chat-messages');
                if (messagesDiv) {
                    messagesDiv.scrollTop = messagesDiv.scrollHeight;
                }
            }, 100);
        }

        async function sendMessage(event, receiverId) {
            event.preventDefault();
            
            const input = document.getElementById('message-input');
            const content = input.value.trim();
            
            if (!content) return;
            
            await supabase.from('messages').insert({
                sender_id: currentUser.id,
                receiver_id: receiverId,
                content: content
            });
            
            input.value = '';
            await loadChatMessages(receiverId);
        }

        function startRealtimeUpdates() {
            supabase
                .channel('notifications')
                .on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'notifications', filter: `user_id=eq.${currentUser.id}` }, () => {
                    loadNotifications();
                })
                .subscribe();
            
            supabase
                .channel('messages-updates')
                .on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'messages', filter: `receiver_id=eq.${currentUser.id}` }, () => {
                    loadConversations();
                })
                .subscribe();
        }

        function toggleNotifications() {
            hideAllDropdowns();
            document.getElementById('notifications-dropdown').classList.toggle('show');
        }

        function toggleMessages() {
            hideAllDropdowns();
            document.getElementById('messages-dropdown').classList.toggle('show');
        }

        function toggleUserMenu() {
            hideAllDropdowns();
            document.getElementById('user-menu').classList.toggle('show');
        }

        function hideAllDropdowns() {
            document.querySelectorAll('.dropdown').forEach(d => d.classList.remove('show'));
        }

        function showSection(sectionId) {
            document.querySelectorAll('.content-section').forEach(s => s.classList.remove('active'));
            document.getElementById(sectionId).classList.add('active');
            document.querySelectorAll('.nav-item').forEach(item => item.classList.remove('active'));
            
            const navItems = document.querySelectorAll('.nav-item');
            navItems.forEach(item => {
                const onclickAttr = item.getAttribute('onclick');
                if (onclickAttr && onclickAttr.includes(`'${sectionId}'`)) {
                    item.classList.add('active');
                }
            });
            
            if (sectionId === 'chat' && !currentChatUser) {
        function showSection(sectionId) {
            document.querySelectorAll('.content-section').forEach(s => s.classList.remove('active'));
            document.getElementById(sectionId).classList.add('active');
            document.querySelectorAll('.nav-item').forEach(item => item.classList.remove('active'));
            
            const navItems = document.querySelectorAll('.nav-item');
            navItems.forEach(item => {
                const onclickAttr = item.getAttribute('onclick');
                if (onclickAttr && onclickAttr.includes(`'${sectionId}'`)) {
                    item.classList.add('active');
                }
            });
            
            if (sectionId === 'chat' && !currentChatUser) {
                loadConversations();
            }
            
            // Load store products when My Store tab is opened
            if (sectionId === 'my-store') {
                loadUserProducts();
            }
        }
        async function handleLogout() {
            await supabase.auth.signOut();
            window.location.href = 'login.html';
        }

        function getCraftIcon(craftType) {
            const icons = { 'Sewing': 'üßµ', 'Knitting': 'üß∂', 'Crochet': 'ü™°', 'Weaving': 'üßµ', 'Embroidery': 'ü™°', 'Quilting': 'üßµ', 'Leather Work': 'üëú', 'Other': 'üé®' };
            return icons[craftType] || 'üé®';
        }

        function formatMentions(text) {
            return text.replace(/@(\w+)/g, '<span class="mention">@$1</span>');
        }

        function getTimeAgo(timestamp) {
            const now = new Date();
            const past = new Date(timestamp);
            const diffMs = now - past;
            const diffMins = Math.floor(diffMs / 60000);
            const diffHours = Math.floor(diffMs / 3600000);
            const diffDays = Math.floor(diffMs / 86400000);

            if (diffMins < 1) return 'Just now';
            if (diffMins < 60) return `${diffMins}m ago`;
            if (diffHours < 24) return `${diffHours}h ago`;
            return `${diffDays}d ago`;
        }

        document.addEventListener('click', function(event) {
            if (!event.target.closest('.icon-btn') && !event.target.closest('.user-profile') && !event.target.closest('.dropdown')) {
                hideAllDropdowns();
            }
        });

        checkAuth();
    </script>
</body>
</html>