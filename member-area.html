<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Craft Club | Your Creative Space</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --terracotta: #A0695F;
            --dark-brown: #3C2F2F;
            --cream: #F5F1E8;
            --light-beige: #EDE8DC;
            --text-dark: #3C2F2F;
            --text-muted: #8B7E74;
            --gold: #D4AF37;
            --success: #5C8B5A;
            --highlight: #E8C5B5;
            --love: #E74C3C;
        }

        body {
            font-family: 'Georgia', serif;
            color: var(--text-dark);
            line-height: 1.6;
            background: var(--cream);
        }

        header {
            position: fixed;
            top: 0;
            width: 100%;
            z-index: 1000;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            padding: 1rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid rgba(0,0,0,0.05);
        }

        .logo {
            font-size: 1.125rem;
            font-weight: 400;
            letter-spacing: 0.02em;
            color: var(--dark-brown);
        }

        .user-nav {
            display: flex;
            align-items: center;
            gap: 1.5rem;
        }
        .product-type-option.selected {
            border-color: var(--terracotta);
            background: rgba(160, 105, 95, 0.08);
}
        .icon-btn {
            position: relative;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: var(--cream);
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.25rem;
            transition: all 0.3s;
        }

        .icon-btn:hover {
            background: var(--highlight);
            transform: scale(1.1);
        }

        .badge-count {
            position: absolute;
            top: -5px;
            right: -5px;
            background: var(--love);
            color: white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            font-size: 0.7rem;
            display: flex;
            align-items: center;
            justify-content: center;
            font-family: -apple-system, sans-serif;
            font-weight: bold;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }

        .avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: var(--terracotta);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            cursor: pointer;
        }

        .avatar img {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            object-fit: cover;
        }

        .user-profile {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            cursor: pointer;
            position: relative;
        }

        .dropdown {
            position: absolute;
            top: 100%;
            right: 0;
            margin-top: 0.5rem;
            background: white;
            border-radius: 12px;
            box-shadow: 0 8px 24px rgba(0,0,0,0.15);
            min-width: 320px;
            max-width: 400px;
            max-height: 500px;
            overflow-y: auto;
            display: none;
            z-index: 1001;
        }

        .dropdown.show { display: block; }

        .dropdown-header {
            padding: 1.25rem;
            border-bottom: 2px solid var(--light-beige);
            font-family: -apple-system, sans-serif;
            font-weight: 600;
            font-size: 1.1rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .dropdown-item {
            padding: 1rem 1.25rem;
            border-bottom: 1px solid var(--light-beige);
            cursor: pointer;
            transition: background 0.3s;
            font-family: -apple-system, sans-serif;
        }

        .dropdown-item:hover {
            background: var(--cream);
        }

        .dropdown-item:last-child {
            border-bottom: none;
        }

        .notif-content {
            font-size: 0.9rem;
            margin-bottom: 0.25rem;
        }

        .notif-time {
            font-size: 0.75rem;
            color: var(--text-muted);
        }

        .notif-unread {
            background: #E8F5E9;
        }

        .main-container {
            margin-top: 80px;
            display: flex;
            min-height: calc(100vh - 80px);
        }

        .sidebar {
            width: 280px;
            background: white;
            padding: 2rem 1.5rem;
            border-right: 1px solid rgba(0,0,0,0.05);
            position: fixed;
            height: calc(100vh - 80px);
            overflow-y: auto;
        }

        .nav-item {
            padding: 0.75rem 1rem;
            color: var(--text-dark);
            text-decoration: none;
            border-radius: 8px;
            transition: all 0.3s;
            font-family: -apple-system, sans-serif;
            font-size: 0.95rem;
            display: flex;
            align-items: center;
            gap: 0.75rem;
            cursor: pointer;
            margin-bottom: 0.5rem;
        }

        .nav-item:hover, .nav-item.active {
            background: var(--light-beige);
            color: var(--terracotta);
        }

        .content {
            margin-left: 280px;
            flex: 1;
            padding: 2rem 3rem;
        }

        .content-section {
            display: none;
        }

        .content-section.active {
            display: block;
        }

        .card {
            background: white;
            padding: 2rem;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
            margin-bottom: 2rem;
        }

        .card h3 {
            margin-bottom: 1.5rem;
            color: var(--dark-brown);
            font-size: 1.25rem;
        }

        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 2rem;
            margin-bottom: 2rem;
        }

        .quick-stats {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 1rem;
        }

        .stat-box {
            text-align: center;
            padding: 1.5rem 1rem;
            background: var(--cream);
            border-radius: 8px;
            transition: transform 0.3s;
        }

        .stat-box:hover {
            transform: translateY(-4px);
        }

        .stat-icon {
            font-size: 2rem;
            margin-bottom: 0.5rem;
        }

        .stat-value {
            font-size: 1.75rem;
            font-weight: bold;
            color: var(--terracotta);
        }

        .stat-label {
            font-size: 0.85rem;
            color: var(--text-muted);
            font-family: -apple-system, sans-serif;
        }

        .project-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 1.5rem;
        }

        .project-card {
            background: white;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
            cursor: pointer;
            transition: all 0.3s;
            position: relative;
        }

        .project-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 6px 20px rgba(0,0,0,0.1);
        }

        .project-image {
            width: 100%;
            height: 200px;
            background: linear-gradient(135deg, var(--light-beige), var(--highlight));
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 3rem;
            position: relative;
        }

        .like-btn {
            position: absolute;
            bottom: 10px;
            right: 10px;
            width: 48px;
            height: 48px;
            border-radius: 50%;
            background: white;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            transition: all 0.3s;
            z-index: 10;
        }

        .like-btn:hover {
            transform: scale(1.1);
        }

        .like-btn.liked {
            animation: heartBeat 0.5s;
        }

        @keyframes heartBeat {
            0%, 100% { transform: scale(1); }
            25% { transform: scale(1.3); }
            50% { transform: scale(1.1); }
        }

        .follow-btn-small {
            position: absolute;
            top: 10px;
            right: 10px;
            padding: 0.4rem 0.8rem;
            background: white;
            border: 1px solid var(--terracotta);
            color: var(--terracotta);
            border-radius: 20px;
            font-size: 0.8rem;
            cursor: pointer;
            font-family: -apple-system, sans-serif;
            z-index: 10;
            transition: all 0.3s;
        }

        .follow-btn-small:hover {
            background: var(--terracotta);
            color: white;
        }

        .follow-btn-small.following {
            background: var(--terracotta);
            color: white;
        }

        .project-info {
            padding: 1.25rem;
        }

        .project-title {
            font-size: 1.1rem;
            margin-bottom: 0.5rem;
            color: var(--dark-brown);
        }

        .project-meta {
            display: flex;
            gap: 1rem;
            font-size: 0.85rem;
            color: var(--text-muted);
            font-family: -apple-system, sans-serif;
        }

        .user-mini {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 0.75rem;
        }

        .user-mini-avatar {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            background: var(--terracotta);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.7rem;
            font-weight: bold;
        }

        .user-mini-avatar img {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            object-fit: cover;
        }

        .feed-item {
            background: white;
            padding: 1.5rem;
            border-radius: 12px;
            margin-bottom: 1rem;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }

        .feed-header {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .feed-avatar {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            background: var(--terracotta);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            cursor: pointer;
        }

        .feed-avatar img {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            object-fit: cover;
        }

        .feed-content {
            font-family: -apple-system, sans-serif;
            line-height: 1.6;
        }

        .feed-time {
            font-size: 0.8rem;
            color: var(--text-muted);
            margin-top: 0.5rem;
        }

        .mention {
            color: var(--terracotta);
            font-weight: 600;
            cursor: pointer;
        }

        .mention:hover {
            text-decoration: underline;
        }

        .btn {
            padding: 0.75rem 2rem;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-family: -apple-system, sans-serif;
            font-size: 0.95rem;
            transition: all 0.3s;
            display: inline-block;
            text-align: center;
        }

        .btn-primary {
            background: var(--terracotta);
            color: white;
        }

        .btn-primary:hover {
            background: var(--dark-brown);
            transform: translateY(-2px);
        }

        .btn-secondary {
            background: var(--light-beige);
            color: var(--dark-brown);
        }

        .btn-danger {
            background: #C75B5B;
            color: white;
        }

        .btn-small {
            padding: 0.5rem 1rem;
            font-size: 0.85rem;
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        label {
            display: block;
            font-family: -apple-system, sans-serif;
            font-size: 0.9rem;
            color: var(--dark-brown);
            margin-bottom: 0.5rem;
            font-weight: 500;
        }

        input, textarea, select {
            width: 100%;
            padding: 0.875rem 1rem;
            border: 2px solid var(--light-beige);
            border-radius: 8px;
            font-family: -apple-system, sans-serif;
            font-size: 1rem;
            transition: all 0.3s;
        }

        input:focus, textarea:focus, select:focus {
            outline: none;
            border-color: var(--terracotta);
        }

        textarea {
            min-height: 120px;
            resize: vertical;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 2000;
            justify-content: center;
            align-items: center;
            padding: 2rem;
            overflow-y: auto;
        }

        .modal.show { display: flex; }

        .modal-content {
            background: white;
            border-radius: 16px;
            max-width: 700px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            padding: 2rem;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
            padding-bottom: 1rem;
            border-bottom: 2px solid var(--light-beige);
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 2rem;
            cursor: pointer;
            color: var(--text-muted);
        }

        .profile-picture-upload {
            text-align: center;
            margin-bottom: 2rem;
        }

        .profile-picture-preview {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            margin: 0 auto 1rem;
            background: var(--terracotta);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 3rem;
            font-weight: bold;
            overflow: hidden;
        }

        .profile-picture-preview img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .craft-specific-fields {
            display: none;
        }

        .empty-state {
            text-align: center;
            padding: 3rem 2rem;
            color: var(--text-muted);
        }

        .empty-state-icon {
            font-size: 4rem;
            margin-bottom: 1rem;
            opacity: 0.5;
        }

        .loading {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 3rem;
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid var(--light-beige);
            border-top-color: var(--terracotta);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Floating Chat Widget */
        .chat-widget {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 380px;
            max-height: 600px;
            background: white;
            border-radius: 16px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.15);
            display: none;
            flex-direction: column;
            z-index: 2001;
            overflow: hidden;
        }

        .chat-widget.show {
            display: flex;
        }

        .chat-widget-header {
            background: var(--terracotta);
            color: white;
            padding: 1rem 1.25rem;
            display: flex;
            align-items: center;
            gap: 0.75rem;
            cursor: move;
        }

        .chat-widget-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: white;
            color: var(--terracotta);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            overflow: hidden;
        }

        .chat-widget-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .chat-widget-info {
            flex: 1;
        }

        .chat-widget-name {
            font-weight: 600;
            font-size: 1rem;
        }

        .chat-widget-status {
            font-size: 0.75rem;
            opacity: 0.9;
        }

        .chat-widget-close {
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            font-size: 1.25rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
        }

        .chat-widget-close:hover {
            background: rgba(255,255,255,0.3);
        }

        .chat-widget-messages {
            flex: 1;
            overflow-y: auto;
            padding: 1rem;
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
            background: var(--cream);
            max-height: 400px;
        }

        .chat-widget-input-area {
            padding: 1rem;
            border-top: 2px solid var(--light-beige);
            background: white;
        }

        .chat-widget-input-form {
            display: flex;
            gap: 0.5rem;
        }

        .chat-widget-input {
            flex: 1;
            padding: 0.75rem 1rem;
            border: 2px solid var(--light-beige);
            border-radius: 24px;
            font-family: -apple-system, sans-serif;
            font-size: 0.9rem;
        }

        .chat-widget-send {
            width: 44px;
            height: 44px;
            border-radius: 50%;
            background: var(--terracotta);
            border: none;
            color: white;
            font-size: 1.25rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
        }

        .chat-widget-send:hover {
            background: var(--dark-brown);
            transform: scale(1.05);
        }

        .chat-bubble {
            max-width: 70%;
            padding: 0.75rem 1rem;
            border-radius: 16px;
            word-wrap: break-word;
            animation: slideIn 0.3s ease;
        }

        .chat-bubble-sent {
            align-self: flex-end;
            background: var(--terracotta);
            color: white;
            border-bottom-right-radius: 4px;
        }

        .chat-bubble-received {
            align-self: flex-start;
            background: white;
            color: var(--text-dark);
            border-bottom-left-radius: 4px;
        }

        .chat-bubble-time {
            font-size: 0.7rem;
            margin-top: 0.25rem;
            opacity: 0.7;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @media (max-width: 768px) {
            .sidebar {
                position: static;
                width: 100%;
                height: auto;
            }

            .content {
                margin-left: 0;
                padding: 1.5rem;
            }

            .dashboard-grid, .project-grid {
                grid-template-columns: 1fr;
            }

            .chat-widget {
                width: calc(100vw - 20px);
                right: 10px;
                bottom: 10px;
                max-height: 500px;
            }
        }

        /* ========== STORE SECTION STYLES ========== */
        .product-item {
            display: grid;
            grid-template-columns: 120px 1fr auto;
            gap: 1.5rem;
            padding: 1.5rem;
            background: var(--cream);
            border-radius: 12px;
            margin-bottom: 1rem;
            align-items: center;
        }

        .product-item-image {
            width: 120px;
            height: 120px;
            border-radius: 8px;
            object-fit: cover;
            background: var(--light-beige);
        }

        .product-type-selector {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 1rem;
        }

        .product-type-option {
            border: 2px solid var(--light-beige);
            padding: 1.5rem;
            border-radius: 12px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
        }

        .product-type-option:hover {
            border-color: var(--terracotta);
            background: rgba(160, 105, 95, 0.05);
        }

        .product-type-option input[type="radio"]:checked + label {
            border-color: var(--terracotta);
        }
    </style>
</head>
<body>
    <header>
        <a href="index.html" style="text-decoration: none;">
            <div class="logo">üé® Craft Club</div>
        </a>
        <div class="user-nav">
            <button class="icon-btn" onclick="toggleNotifications()">
                üîî
                <span class="badge-count" id="notif-count" style="display: none;">0</span>
            </button>
            <button class="icon-btn" onclick="toggleMessages()">
                üí¨
                <span class="badge-count" id="message-count" style="display: none;">0</span>
            </button>
            <div class="user-profile" onclick="toggleUserMenu()">
                <div class="avatar" id="header-avatar">...</div>
            </div>

            <div class="dropdown" id="notifications-dropdown">
                <div class="dropdown-header">
                    Notifications
                    <button onclick="markAllRead()" style="background: none; border: none; color: var(--terracotta); cursor: pointer; font-size: 0.85rem;">Mark all read</button>
                </div>
                <div id="notifications-list">
                    <div class="loading"><div class="spinner"></div></div>
                </div>
            </div>

            <div class="dropdown" id="messages-dropdown">
                <div class="dropdown-header">Messages</div>
                <div id="conversations-list">
                    <div class="loading"><div class="spinner"></div></div>
                </div>
            </div>

            <div class="dropdown" id="user-menu" style="min-width: 200px;">
                <div class="dropdown-item" onclick="showSection('dashboard'); hideAllDropdowns();">üë§ Dashboard</div>
                <div class="dropdown-item" onclick="showEditProfile()">‚úèÔ∏è Edit Profile</div>
                <div class="dropdown-item" onclick="showSettings()">‚öôÔ∏è Settings</div>
                <div class="dropdown-item" onclick="handleLogout()">üö™ Logout</div>
            </div>
        </div>
    </header>

    <div class="main-container">
        <aside class="sidebar">
            <nav>
                <a class="nav-item active" onclick="showSection('dashboard')">üè† Dashboard</a>
                <a class="nav-item" onclick="showSection('my-projects')">üé® My Projects</a>
                <a class="nav-item" onclick="showSection('community')">üåä Community Feed</a>
                <a class="nav-item" onclick="showSection('friends')">üí´ Friends</a>
                <a class="nav-item" onclick="showSection('members')">üîç Find Makers</a>
                <a class="nav-item" onclick="showSection('chat')">üí¨ Messages</a>
                <a class="nav-item" onclick="showSection('my-store')">üõçÔ∏è My Store</a>
            </nav>
        </aside>

        <main class="content">
            <section id="dashboard" class="content-section active">
                <h1 style="margin-bottom: 2rem;" id="welcome-text">Welcome! üëã</h1>

                <div class="dashboard-grid">
                    <div class="card">
                        <h3>üìä Your Stats</h3>
                        <div class="quick-stats">
                            <div class="stat-box">
                                <div class="stat-icon">üé®</div>
                                <div class="stat-value" id="stat-projects">0</div>
                                <div class="stat-label">Projects</div>
                            </div>
                            <div class="stat-box">
                                <div class="stat-icon">‚ù§Ô∏è</div>
                                <div class="stat-value" id="stat-likes">0</div>
                                <div class="stat-label">Total Likes</div>
                            </div>
                            <div class="stat-box">
                                <div class="stat-icon">üë•</div>
                                <div class="stat-value" id="stat-friends">0</div>
                                <div class="stat-label">Friends</div>
                            </div>
                            <div class="stat-box">
                                <div class="stat-icon">üî•</div>
                                <div class="stat-value" id="stat-streak">0</div>
                                <div class="stat-label">Day Streak</div>
                            </div>
                        </div>
                    </div>
                </div>

                <button class="btn btn-primary" onclick="showAddProject()">+ Add New Project</button>
            </section>

            <section id="my-projects" class="content-section">
                <div style="display: flex; justify-content: space-between; margin-bottom: 2rem;">
                    <h1>üé® My Projects</h1>
                    <button class="btn btn-primary" onclick="showAddProject()">+ New Project</button>
                </div>
                <div id="my-projects-container"><div class="loading"><div class="spinner"></div></div></div>
            </section>

            <section id="community" class="content-section">
                <h1 style="margin-bottom: 2rem;">üåä Community Feed</h1>
                <div id="community-feed"><div class="loading"><div class="spinner"></div></div></div>
            </section>

            <section id="friends" class="content-section">
                <h1 style="margin-bottom: 2rem;">üí´ Your Friends</h1>
                <div id="friends-container"><div class="loading"><div class="spinner"></div></div></div>
            </section>

            <section id="members" class="content-section">
                <h1 style="margin-bottom: 2rem;">üîç Find Makers</h1>
                <input type="text" id="member-search" placeholder="Search by name or username..." style="margin-bottom: 2rem;" oninput="searchMembers()">
                <div id="members-container"><div class="loading"><div class="spinner"></div></div></div>
            </section>

            <section id="chat" class="content-section">
                <h1 style="margin-bottom: 2rem;">üí¨ Messages</h1>
                <div id="chat-area"></div>
            </section>

            <section id="my-store" class="content-section">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
                    <div>
                        <h1>üõçÔ∏è Your Store</h1>
                        <p style="color: var(--text-muted); margin-top: 0.5rem;">Share your craft with the world. Create listings for handmade items, digital patterns, or special travel finds.</p>
                    </div>
                    <button class="btn btn-primary" onclick="openNewProductModal()">+ Create New Listing</button>
                </div>

                <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 1rem; margin-bottom: 2rem;">
                    <div class="card" style="text-align: center;">
                        <div style="font-size: 2rem; font-weight: 600; color: var(--terracotta);" id="totalProducts">0</div>
                        <div style="font-size: 0.875rem; color: var(--text-muted); margin-top: 0.5rem;">Total Listings</div>
                    </div>
                    <div class="card" style="text-align: center;">
                        <div style="font-size: 2rem; font-weight: 600; color: var(--success);" id="activeProducts">0</div>
                        <div style="font-size: 0.875rem; color: var(--text-muted); margin-top: 0.5rem;">Active</div>
                    </div>
                    <div class="card" style="text-align: center;">
                        <div style="font-size: 2rem; font-weight: 600; color: var(--dark-brown);" id="totalOrders">0</div>
                        <div style="font-size: 0.875rem; color: var(--text-muted); margin-top: 0.5rem;">Orders</div>
                    </div>
                    <div class="card" style="text-align: center;">
                        <div style="font-size: 2rem; font-weight: 600; color: var(--gold);" id="totalRevenue">‚Ç¨0</div>
                        <div style="font-size: 0.875rem; color: var(--text-muted); margin-top: 0.5rem;">Revenue</div>
                    </div>
                </div>

                <div class="card">
                    <h3 style="margin-bottom: 1.5rem;">Your Listings</h3>
                    <div id="productsListContainer">
                        <div style="text-align: center; padding: 3rem; color: var(--text-muted);">
                            <div style="font-size: 3rem; margin-bottom: 1rem;">üõçÔ∏è</div>
                            <h4 style="margin-bottom: 0.5rem;">No listings yet</h4>
                            <p>Create your first listing to start selling on the Makers' Market</p>
                            <button class="btn btn-primary" onclick="openNewProductModal()" style="margin-top: 1rem;">Create First Listing</button>
                        </div>
                    </div>
                </div>
            </section>
        </main>
    </div>

    <div class="modal" id="edit-profile-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Edit Profile</h2>
                <button class="modal-close" onclick="closeEditProfile()">&times;</button>
            </div>
            <form onsubmit="handleProfileUpdate(event)">
                <div class="profile-picture-upload">
                    <div class="profile-picture-preview" id="profile-picture-preview">...</div>
                    <input type="file" id="profile-picture-input" accept="image/*" style="display: none;" onchange="handleProfilePictureChange(event)">
                    <button type="button" class="btn btn-secondary btn-small" onclick="document.getElementById('profile-picture-input').click()">
                        Change Picture
                    </button>
                </div>

                <div class="form-group">
                    <label>Username</label>
                    <input type="text" id="edit-username" readonly style="background: #f5f5f5;">
                    <small style="color: var(--text-muted); font-size: 0.8rem;">Username cannot be changed</small>
                </div>
                <div class="form-group">
                    <label>Full Name</label>
                    <input type="text" id="edit-fullname">
                </div>
                <div class="form-group">
                    <label>Bio</label>
                    <textarea id="edit-bio" placeholder="Tell us about yourself..."></textarea>
                </div>
                <div class="form-group">
                    <label>Location</label>
                    <input type="text" id="edit-location" placeholder="City, Country">
                </div>
                <div class="form-group">
                    <label>Interests (comma separated)</label>
                    <input type="text" id="edit-interests" placeholder="Sewing, Knitting, Crochet">
                </div>
                <button type="submit" class="btn btn-primary" style="width: 100%;">Save Changes</button>
            </form>
        </div>
    </div>

    <div class="modal" id="settings-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>‚öôÔ∏è Settings</h2>
                <button class="modal-close" onclick="closeSettings()">&times;</button>
            </div>
            <form onsubmit="handleUpdateSettings(event)">
                <div class="form-group">
                    <label>Measurement System</label>
                    <select id="setting-measurement">
                        <option value="metric">Metric (cm, m, kg)</option>
                        <option value="imperial">Imperial (inches, yards, lbs)</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Weight Unit</label>
                    <select id="setting-weight">
                        <option value="kg">Kilograms (kg)</option>
                        <option value="lbs">Pounds (lbs)</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Length Unit</label>
                    <select id="setting-length">
                        <option value="cm">Centimeters (cm)</option>
                        <option value="m">Meters (m)</option>
                        <option value="in">Inches (in)</option>
                        <option value="yd">Yards (yd)</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Default Craft</label>
                    <select id="setting-default-craft">
                        <option value="">None</option>
                        <option value="Crochet">Crochet üß∂</option>
                        <option value="Knitting">Knitting ü™°</option>
                        <option value="Sewing">Sewing üßµ</option>
                        <option value="Embroidery">Embroidery ‚ú®</option>
                        <option value="Quilting">Quilting ‚úÇÔ∏è</option>
                        <option value="Weaving">Weaving üï∏Ô∏è</option>
                        <option value="Leather Work">Leather Work üëú</option>
                    </select>
                </div>

                <h3 style="margin-top: 3rem; margin-bottom: 1.5rem; color: var(--dark-brown);">Privacy Settings</h3>
                <div class="form-group">
                    <label>
                        <input type="checkbox" id="setting-private-profile">
                        Keep my profile private
                    </label>
                    <small style="color: var(--text-muted); font-size: 0.8rem; display: block;">Only friends can see your projects and activities.</small>
                </div>
                <button type="submit" class="btn btn-primary" style="width: 100%;">Save Settings</button>
            </form>
            <div style="text-align: center; margin-top: 2rem;">
                <button class="btn btn-danger btn-small" onclick="showAccountDeleteConfirmation()">Delete Account</button>
            </div>
        </div>
    </div>

    <div class="modal" id="project-detail-modal">
        <div class="modal-content" style="max-width: 900px;">
            <div class="modal-header">
                <h2 id="project-detail-title">Project Title</h2>
                <button class="modal-close" onclick="closeProjectDetail()">&times;</button>
            </div>
            <div id="project-detail-content">
                <div style="display: flex; gap: 2rem;">
                    <div style="flex: 1;">
                        <div id="project-detail-image" style="height: 300px; background: var(--light-beige); border-radius: 12px; margin-bottom: 1.5rem; display: flex; align-items: center; justify-content: center; font-size: 4rem;">
                            </div>
                        <div id="project-detail-actions" style="display: flex; gap: 1rem; margin-bottom: 1.5rem;">
                            </div>
                        <div id="project-detail-meta" style="font-family: -apple-system, sans-serif; color: var(--text-muted); font-size: 0.9rem; border-top: 1px solid var(--light-beige); padding-top: 1rem;">
                            <p>Status: <span id="detail-status">In Progress</span></p>
                            <p>Craft: <span id="detail-craft-type">Knitting</span></p>
                            <p>Created: <span id="detail-created-at"></span></p>
                            <p>Last Updated: <span id="detail-updated-at"></span></p>
                            <p>By: <span id="detail-owner"></span></p>
                        </div>
                    </div>
                    <div style="flex: 1;">
                        <h3 style="margin-bottom: 1rem; color: var(--dark-brown);">Description</h3>
                        <p id="project-detail-description" style="margin-bottom: 2rem; white-space: pre-wrap;"></p>

                        <h3 style="margin-bottom: 1rem; color: var(--dark-brown);">Craft Details</h3>
                        <div id="project-detail-craft-info" class="card" style="padding: 1.5rem;">
                            </div>

                        <h3 style="margin-bottom: 1rem; color: var(--dark-brown);">Project Updates</h3>
                        <div id="project-updates-container">
                            <form onsubmit="postProjectUpdate(event, currentDetailProjectId)" style="display: flex; gap: 0.5rem; margin-bottom: 1.5rem;">
                                <input type="text" id="update-content-input" placeholder="What's your progress?" style="flex: 1;">
                                <input type="file" id="update-photo-input" accept="image/*" style="display: none;" onchange="previewUpdatePhoto()">
                                <button type="button" class="icon-btn" onclick="document.getElementById('update-photo-input').click()">üì∑</button>
                                <button type="submit" class="btn btn-primary btn-small">Post</button>
                            </form>
                            <div id="update-photo-preview" style="margin-bottom: 1rem; display: none;">
                                <img id="update-photo-img" style="max-width: 100px; max-height: 100px; border-radius: 4px; object-fit: cover; margin-right: 0.5rem;">
                                <button type="button" class="btn btn-danger btn-small" onclick="clearUpdatePhoto()">Remove</button>
                            </div>
                            <div id="project-updates-list">
                                <div class="loading"><div class="spinner"></div></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="modal" id="project-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="projectModalTitle">Add New Project</h2>
                <button class="modal-close" onclick="closeProjectModal()">&times;</button>
            </div>
            <form id="projectForm" onsubmit="handleSaveProject(event)">
                <input type="hidden" id="project-id-input">
                <div class="form-group">
                    <label>Project Title</label>
                    <input type="text" id="project-title" required>
                </div>
                <div class="form-group">
                    <label>Description</label>
                    <textarea id="project-description" placeholder="A brief description of your project..."></textarea>
                </div>
                <div class="form-group">
                    <label>Craft Type</label>
                    <select id="project-craft-type" onchange="toggleCraftFields()" required>
                        <option value="">Select a Craft</option>
                        <option value="Crochet">Crochet üß∂</option>
                        <option value="Knitting">Knitting ü™°</option>
                        <option value="Sewing">Sewing üßµ</option>
                        <option value="Embroidery">Embroidery ‚ú®</option>
                        <option value="Quilting">Quilting ‚úÇÔ∏è</option>
                        <option value="Weaving">Weaving üï∏Ô∏è</option>
                        <option value="Leather Work">Leather Work üëú</option>
                        <option value="Other">Other üé®</option>
                    </select>
                </div>
                <div class="form-group" id="project-status-group" style="display: none;">
                    <label>Status</label>
                    <select id="project-status">
                        <option value="In Progress">In Progress</option>
                        <option value="Completed">Completed</option>
                        <option value="Planned">Planned</option>
                        <option value="Frogged">Frogged</option>
                    </select>
                </div>

                <div id="crochet-fields" class="craft-specific-fields">
                    <h3 style="margin: 1.5rem 0 1rem; color: var(--terracotta); font-size: 1.1rem;">üß∂ Crochet Details</h3>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                        <div class="form-group">
                            <label>Hook Size</label>
                            <input type="text" id="crochet-hook-size" placeholder="e.g., 5.0mm, H-8">
                        </div>
                        <div class="form-group">
                            <label>Yarn Weight</label>
                            <input type="text" id="crochet-yarn-weight" placeholder="e.g., Worsted (4)">
                        </div>
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                        <div class="form-group">
                            <label>Yarn Brand</label>
                            <input type="text" id="crochet-yarn-brand" placeholder="e.g., Lion Brand">
                        </div>
                        <div class="form-group">
                            <label>Yarn Color</label>
                            <input type="text" id="crochet-yarn-color" placeholder="e.g., Terracotta">
                        </div>
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                        <div class="form-group">
                            <label>Yardage Used (approx)</label>
                            <input type="text" id="crochet-yardage" placeholder="e.g., 300 yards">
                        </div>
                        <div class="form-group">
                            <label>Gauge (optional)</label>
                            <input type="text" id="crochet-gauge" placeholder="e.g., 14 sc x 16 rows = 4 inches">
                        </div>
                    </div>
                    <div class="form-group">
                        <label>üîó Where to Buy Yarn</label>
                        <input type="url" id="crochet-yarn-link" placeholder="https://...">
                    </div>
                    <div class="form-group">
                        <label>üîó Pattern Link (Optional)</label>
                        <input type="url" id="crochet-pattern-link" placeholder="https://...">
                    </div>
                </div>

                <div id="knitting-fields" class="craft-specific-fields">
                    <h3 style="margin: 1.5rem 0 1rem; color: var(--terracotta); font-size: 1.1rem;">üß∂ Knitting Details</h3>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                        <div class="form-group">
                            <label>Needle Size</label>
                            <input type="text" id="knitting-needle-size" placeholder="e.g., US 8, 5mm">
                        </div>
                        <div class="form-group">
                            <label>Needle Type</label>
                            <input type="text" id="knitting-needle-type" placeholder="e.g., Circular, DPN">
                        </div>
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                        <div class="form-group">
                            <label>Yarn Weight</label>
                            <input type="text" id="knitting-yarn-weight" placeholder="e.g., DK (3)">
                        </div>
                        <div class="form-group">
                            <label>Yarn Brand</label>
                            <input type="text" id="knitting-yarn-brand" placeholder="e.g., Malabrigo">
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Yardage Needed</label>
                        <input type="text" id="knitting-yardage" placeholder="e.g., 400 yards">
                    </div>
                    <div class="form-group">
                        <label>üîó Where to Buy Yarn</label>
                        <input type="url" id="knitting-yarn-link" placeholder="https://...">
                    </div>
                </div>

                <div id="sewing-fields" class="craft-specific-fields">
                    <h3 style="margin: 1.5rem 0 1rem; color: var(--terracotta); font-size: 1.1rem;">üßµ Sewing Details</h3>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                        <div class="form-group">
                            <label>Fabric Type</label>
                            <input type="text" id="sewing-fabric-type" placeholder="e.g., Cotton Poplin">
                        </div>
                        <div class="form-group">
                            <label>Fabric Amount</label>
                            <input type="text" id="sewing-fabric-amount" placeholder="e.g., 2.5 yards">
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Fabric Brand/Collection</label>
                        <input type="text" id="sewing-fabric-brand" placeholder="e.g., Robert Kaufman">
                    </div>
                    <div class="form-group">
                        <label>Needle Info</label>
                        <input type="text" id="sewing-needle-info" placeholder="e.g., Universal 80/12">
                    </div>
                    <div class="form-group">
                        <label>Notions Used (comma separated)</label>
                        <input type="text" id="sewing-notions" placeholder="e.g., Zipper, Buttons, Interfacing">
                    </div>
                    <div class="form-group">
                        <label>Pattern Size</label>
                        <input type="text" id="sewing-pattern-size" placeholder="e.g., Size 10, Small">
                    </div>
                    <div class="form-group">
                        <label>üîó Fabric Link</label>
                        <input type="url" id="sewing-fabric-link" placeholder="https://...">
                    </div>
                    <div class="form-group">
                        <label>üîó Pattern Link (Optional)</label>
                        <input type="url" id="sewing-pattern-link" placeholder="https://...">
                    </div>
                </div>

                <div id="embroidery-fields" class="craft-specific-fields">
                    <h3 style="margin: 1.5rem 0 1rem; color: var(--terracotta); font-size: 1.1rem;">‚ú® Embroidery Details</h3>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                        <div class="form-group">
                            <label>Thread Brand</label>
                            <input type="text" id="embroidery-thread-brand" placeholder="e.g., DMC">
                        </div>
                        <div class="form-group">
                            <label>Thread Colors (DMC #s)</label>
                            <input type="text" id="embroidery-colors" placeholder="e.g., 310, 840, 740">
                        </div>
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                        <div class="form-group">
                            <label>Fabric Type</label>
                            <input type="text" id="embroidery-fabric-type" placeholder="e.g., Linen, Aida 14ct">
                        </div>
                        <div class="form-group">
                            <label>Hoop Size</label>
                            <input type="text" id="embroidery-hoop" placeholder="e.g., 8 inch round">
                        </div>
                    </div>
                    <div class="form-group">
                        <label>üîó Pattern Link (Optional)</label>
                        <input type="url" id="embroidery-pattern-link" placeholder="https://...">
                    </div>
                </div>

                <div id="weaving-fields" class="craft-specific-fields">
                    <h3 style="margin: 1.5rem 0 1rem; color: var(--terracotta); font-size: 1.1rem;">üï∏Ô∏è Weaving Details</h3>
                    <div class="form-group">
                        <label>Loom Type</label>
                        <input type="text" id="weaving-loom-type" placeholder="e.g., Rigid heddle">
                    </div>
                    <div class="form-group">
                        <label>Yarn/Fiber Type</label>
                        <input type="text" id="weaving-yarn-type" placeholder="e.g., Cotton warp, wool weft">
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 1rem;">
                        <div class="form-group">
                            <label>Reed Size</label>
                            <input type="text" id="weaving-reed-size" placeholder="e.g., 12 dent">
                        </div>
                        <div class="form-group">
                            <label>Width</label>
                            <input type="text" id="weaving-width" placeholder="e.g., 10 inches">
                        </div>
                        <div class="form-group">
                            <label>Length</label>
                            <input type="text" id="weaving-length" placeholder="e.g., 2 yards">
                        </div>
                    </div>
                    <div class="form-group">
                        <label>üîó Supplies Link</label>
                        <input type="url" id="weaving-supplies-link" placeholder="https://...">
                    </div>
                </div>

                <div id="quilting-fields" class="craft-specific-fields">
                    <h3 style="margin: 1.5rem 0 1rem; color: var(--terracotta); font-size: 1.1rem;">üßµ Quilting Details</h3>
                    <div class="form-group">
                        <label>Quilt Size</label>
                        <input type="text" id="quilting-quilt-size" placeholder="e.g., Throw (60x72)">
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                        <div class="form-group">
                            <label>Fabric Collection</label>
                            <input type="text" id="quilting-fabric-collection" placeholder="e.g., Modern Solids">
                        </div>
                        <div class="form-group">
                            <label>Batting Type</label>
                            <input type="text" id="quilting-batting-type" placeholder="e.g., Cotton 80/20">
                        </div>
                    </div>
                    <div class="form-group">
                        <label>üîó Fabric Link</label>
                        <input type="url" id="quilting-fabric-link" placeholder="https://...">
                    </div>
                </div>

                <div id="leather-work-fields" class="craft-specific-fields">
                    <h3 style="margin: 1.5rem 0 1rem; color: var(--terracotta); font-size: 1.1rem;">üëú Leather Work Details</h3>
                    <div class="form-group">
                        <label>Leather Type</label>
                        <input type="text" id="leather-type" placeholder="e.g., Vegetable-tanned leather">
                    </div>
                    <div class="form-group">
                        <label>Thickness/Weight</label>
                        <input type="text" id="leather-thickness" placeholder="e.g., 4-5 oz">
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                        <div class="form-group">
                            <label>Thread Type</label>
                            <input type="text" id="leather-thread-type" placeholder="e.g., Tiger Thread 0.8mm">
                        </div>
                        <div class="form-group">
                            <label>Tools Used</label>
                            <input type="text" id="leather-tools" placeholder="e.g., Stitching Pony, Skiver">
                        </div>
                    </div>
                    <div class="form-group">
                        <label>üîó Supplies Link</label>
                        <input type="url" id="leather-supplies-link" placeholder="https://...">
                    </div>
                </div>

                <div id="other-fields" class="craft-specific-fields">
                    <h3 style="margin: 1.5rem 0 1rem; color: var(--terracotta); font-size: 1.1rem;">üé® Other Craft Details</h3>
                    <div class="form-group">
                        <label>Key Materials</label>
                        <textarea id="other-materials" placeholder="List the main materials used..."></textarea>
                    </div>
                    <div class="form-group">
                        <label>Notes/Instructions</label>
                        <textarea id="other-notes" placeholder="Any other details you want to share..."></textarea>
                    </div>
                </div>

                <div class="form-group">
                    <label>Project Photo</label>
                    <input type="file" id="project-photo-input" accept="image/*" onchange="previewProjectPhoto()">
                    <div id="project-photo-preview" style="margin-top: 1rem; display: none;">
                        <img id="project-photo-img" style="max-width: 200px; max-height: 200px; border-radius: 8px; object-fit: cover; margin-bottom: 0.5rem;">
                        <button type="button" class="btn btn-danger btn-small" onclick="clearProjectPhoto()">Remove Photo</button>
                    </div>
                </div>

                <div style="text-align: right; padding-top: 1rem; border-top: 1px solid var(--light-beige); margin-top: 2rem;">
                    <button type="button" class="btn btn-secondary" onclick="closeProjectModal()" style="margin-right: 1rem;">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save Project</button>
                </div>
            </form>
        </div>
    </div>

    <div class="modal" id="edit-project-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Edit Project: <span id="edit-project-title-display"></span></h2>
                <button class="modal-close" onclick="closeEditProject()">&times;</button>
            </div>
            <form onsubmit="handleUpdateProject(event)">
                <input type="hidden" id="edit-project-id">
                <div class="form-group">
                    <label>Title</label>
                    <input type="text" id="edit-project-title" required>
                </div>
                <div class="form-group">
                    <label>Description</label>
                    <textarea id="edit-project-description"></textarea>
                </div>
                <div class="form-group">
                    <label>Status</label>
                    <select id="edit-project-status">
                        <option value="In Progress">In Progress</option>
                        <option value="Completed">Completed</option>
                        <option value="Planned">Planned</option>
                        <option value="Frogged">Frogged</option>
                    </select>
                </div>

                <h3 style="margin-top: 2rem; margin-bottom: 1rem; color: var(--dark-brown);">Craft Details</h3>
                <div id="edit-craft-details-container">
                    <input type="hidden" id="edit-project-craft-type">
                    <div id="edit-crochet-fields" class="craft-fields" style="display: none;">
                        <h4 style="margin: 1.5rem 0 1rem; color: var(--terracotta);">üß∂ Crochet Details</h4>
                        <div class="form-group">
                            <label>ü™ù Hook Size</label>
                            <input type="text" id="edit-crochet-hook" placeholder="e.g., 5.0mm, H-8">
                        </div>
                        <div class="form-group">
                            <label>üé® Yarn Brand</label>
                            <input type="text" id="edit-crochet-yarn-brand">
                        </div>
                        <div class="form-group">
                            <label>üé® Yarn Color</label>
                            <input type="text" id="edit-crochet-yarn-color">
                        </div>
                        <div class="form-group">
                            <label>‚öñÔ∏è Yarn Weight</label>
                            <select id="edit-crochet-yarn-weight">
                                <option value="">Select weight</option>
                                <option value="Lace">Lace</option>
                                <option value="Fingering">Fingering</option>
                                <option value="Sport">Sport</option>
                                <option value="DK">DK</option>
                                <option value="Worsted">Worsted</option>
                                <option value="Bulky">Bulky</option>
                                <option value="Super Bulky">Super Bulky</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>üìè Gauge</label>
                            <input type="text" id="edit-crochet-gauge" placeholder="e.g., 16 sts x 20 rows = 4 inches">
                        </div>
                        <div class="form-group">
                            <label>üìê Yardage Used</label>
                            <input type="text" id="edit-crochet-yardage" placeholder="e.g., 400 yards">
                        </div>
                        <div class="form-group">
                            <label>üîó Pattern Link</label>
                            <input type="url" id="edit-crochet-pattern-link" placeholder="https://...">
                        </div>
                        <div class="form-group">
                            <label>üîó Supplies Link</label>
                            <input type="url" id="edit-crochet-supplies-link" placeholder="https://...">
                        </div>
                    </div>
                    <div id="edit-knitting-fields" class="craft-fields" style="display: none;">
                        <h4 style="margin: 1.5rem 0 1rem; color: var(--terracotta);">üß∂ Knitting Details</h4>
                        <div class="form-group">
                            <label>ü™° Needle Type</label>
                            <select id="edit-knitting-needle-type">
                                <option value="">Select type</option>
                                <option value="Straight">Straight</option>
                                <option value="Circular">Circular</option>
                                <option value="DPN">Double Pointed (DPN)</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>üìè Needle Size</label>
                            <input type="text" id="edit-knitting-needle-size" placeholder="e.g., US 8, 5mm">
                        </div>
                        <div class="form-group">
                            <label>üé® Yarn Brand</label>
                            <input type="text" id="edit-knitting-yarn-brand">
                        </div>
                        <div class="form-group">
                            <label>üé® Yarn Color</label>
                            <input type="text" id="edit-knitting-yarn-color">
                        </div>
                        <div class="form-group">
                            <label>‚öñÔ∏è Yarn Weight</label>
                            <select id="edit-knitting-yarn-weight">
                                <option value="">Select weight</option>
                                <option value="Lace">Lace</option>
                                <option value="Fingering">Fingering</option>
                                <option value="Sport">Sport</option>
                                <option value="DK">DK</option>
                                <option value="Worsted">Worsted</option>
                                <option value="Bulky">Bulky</option>
                                <option value="Super Bulky">Super Bulky</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>üìê Yardage Used</label>
                            <input type="text" id="edit-knitting-yardage" placeholder="e.g., 400 yards">
                        </div>
                        <div class="form-group">
                            <label>üîó Pattern Link</label>
                            <input type="url" id="edit-knitting-pattern-link" placeholder="https://...">
                        </div>
                        <div class="form-group">
                            <label>üîó Supplies Link</label>
                            <input type="url" id="edit-knitting-supplies-link" placeholder="https://...">
                        </div>
                    </div>
                    <div id="edit-sewing-fields" class="craft-fields" style="display: none;">
                        <h4 style="margin: 1.5rem 0 1rem; color: var(--terracotta);">üßµ Sewing Details</h4>
                        <div class="form-group">
                            <label>Fabric Type</label>
                            <input type="text" id="edit-sewing-fabric-type" placeholder="e.g., Cotton Poplin">
                        </div>
                        <div class="form-group">
                            <label>Fabric Amount</label>
                            <input type="text" id="edit-sewing-fabric-amount" placeholder="e.g., 2.5 yards">
                        </div>
                        <div class="form-group">
                            <label>Fabric Brand/Collection</label>
                            <input type="text" id="edit-sewing-fabric-brand">
                        </div>
                        <div class="form-group">
                            <label>Needle Info</label>
                            <input type="text" id="edit-sewing-needle-info" placeholder="e.g., Universal 80/12">
                        </div>
                        <div class="form-group">
                            <label>Notions Used</label>
                            <input type="text" id="edit-sewing-notions">
                        </div>
                        <div class="form-group">
                            <label>üîó Pattern Link</label>
                            <input type="url" id="edit-sewing-pattern-link" placeholder="https://...">
                        </div>
                        <div class="form-group">
                            <label>üîó Supplies Link</label>
                            <input type="url" id="edit-sewing-supplies-link" placeholder="https://...">
                        </div>
                    </div>
                    <div id="edit-embroidery-fields" class="craft-fields" style="display: none;">
                        <h4 style="margin: 1.5rem 0 1rem; color: var(--terracotta);">‚ú® Embroidery Details</h4>
                        <div class="form-group">
                            <label>üßµ Thread Brand</label>
                            <input type="text" id="edit-embroidery-thread-brand" placeholder="e.g., DMC">
                        </div>
                        <div class="form-group">
                            <label>üåà Thread Colors (DMC #s)</label>
                            <input type="text" id="edit-embroidery-colors" placeholder="e.g., 310, 840, 740">
                        </div>
                        <div class="form-group">
                            <label>ü™° Fabric Type</label>
                            <input type="text" id="edit-embroidery-fabric">
                        </div>
                        <div class="form-group">
                            <label>‚≠ï Hoop Size</label>
                            <input type="text" id="edit-embroidery-hoop" placeholder="e.g., 6 inch">
                        </div>
                        <div class="form-group">
                            <label>üîó Pattern Link</label>
                            <input type="url" id="edit-embroidery-pattern-link" placeholder="https://...">
                        </div>
                        <div class="form-group">
                            <label>üîó Supplies Link</label>
                            <input type="url" id="edit-embroidery-supplies-link" placeholder="https://...">
                        </div>
                    </div>
                    <div id="edit-weaving-fields" class="craft-fields" style="display: none;">
                        <h4 style="margin: 1.5rem 0 1rem; color: var(--terracotta);">üßµ Weaving Details</h4>
                        <div class="form-group">
                            <label>üßµ Loom Type</label>
                            <input type="text" id="edit-weaving-loom" placeholder="e.g., Floor loom, Rigid heddle">
                        </div>
                        <div class="form-group">
                            <label>üìè Reed Size</label>
                            <input type="text" id="edit-weaving-reed" placeholder="e.g., 12 dent">
                        </div>
                        <div class="form-group">
                            <label>üìè Finished Width</label>
                            <input type="text" id="edit-weaving-width" placeholder="e.g., 10 inches">
                        </div>
                        <div class="form-group">
                            <label>üìè Finished Length</label>
                            <input type="text" id="edit-weaving-length" placeholder="e.g., 2 yards">
                        </div>
                        <div class="form-group">
                            <label>üîó Supplies Link</label>
                            <input type="url" id="edit-weaving-supplies-link" placeholder="https://...">
                        </div>
                    </div>
                    <div id="edit-quilting-fields" class="craft-fields" style="display: none;">
                        <h4 style="margin: 1.5rem 0 1rem; color: var(--terracotta);">‚úÇÔ∏è Quilting Details</h4>
                        <div class="form-group">
                            <label>üìè Quilt Size</label>
                            <input type="text" id="edit-quilting-size" placeholder="e.g., Throw (60x72)">
                        </div>
                        <div class="form-group">
                            <label>üßµ Fabric Collection</label>
                            <input type="text" id="edit-quilting-fabric-collection">
                        </div>
                        <div class="form-group">
                            <label>‚òÅÔ∏è Batting Type</label>
                            <input type="text" id="edit-quilting-batting-type">
                        </div>
                        <div class="form-group">
                            <label>üîó Fabric Link</label>
                            <input type="url" id="edit-quilting-fabric-link" placeholder="https://...">
                        </div>
                    </div>
                    <div id="edit-leather-fields" class="craft-fields" style="display: none;">
                        <h4 style="margin: 1.5rem 0 1rem; color: var(--terracotta);">üëú Leather Work Details</h4>
                        <div class="form-group">
                            <label>üß∞ Leather Type</label>
                            <input type="text" id="edit-leather-type">
                        </div>
                        <div class="form-group">
                            <label>üìè Thickness/Weight</label>
                            <input type="text" id="edit-leather-thickness">
                        </div>
                        <div class="form-group">
                            <label>üßµ Thread Type</label>
                            <input type="text" id="edit-leather-thread-type">
                        </div>
                        <div class="form-group">
                            <label>üõ†Ô∏è Tools Used</label>
                            <input type="text" id="edit-leather-tools">
                        </div>
                        <div class="form-group">
                            <label>üîó Supplies Link</label>
                            <input type="url" id="edit-leather-supplies-link" placeholder="https://...">
                        </div>
                    </div>
                    <div id="edit-other-fields" class="craft-fields" style="display: none;">
                        <h4 style="margin: 1.5rem 0 1rem; color: var(--terracotta);">üé® Other Craft Details</h4>
                        <div class="form-group">
                            <label>Key Materials</label>
                            <textarea id="edit-other-materials"></textarea>
                        </div>
                        <div class="form-group">
                            <label>Notes/Instructions</label>
                            <textarea id="edit-other-notes"></textarea>
                        </div>
                    </div>

                </div>

                <div style="text-align: right; padding-top: 1rem; border-top: 1px solid var(--light-beige); margin-top: 2rem;">
                    <button type="button" class="btn btn-secondary" onclick="closeEditProject()" style="margin-right: 1rem;">Cancel</button>
                    <button type="submit" class="btn btn-primary">Update Project</button>
                </div>
            </form>
        </div>
    </div>

    <div class="modal" id="productModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="productModalTitle">Create New Listing</h2>
                <button class="modal-close" onclick="closeProductModal()">&times;</button>
            </div>
            <form id="productForm" onsubmit="saveProduct(event)">
                <input type="hidden" id="productIdInput">

                <div class="form-group">
                    <label>Listing Title</label>
                    <input type="text" id="productTitle" required>
                </div>
                <div class="form-group">
                    <label>Description</label>
                    <textarea id="productDescription" placeholder="A detailed description of your product, materials, and shipping info." required></textarea>
                </div>

                <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 1rem;">
                    <div class="form-group">
                        <label>Price</label>
                        <input type="number" id="productPrice" min="0.01" step="0.01" required>
                    </div>
                    <div class="form-group">
                        <label>Currency</label>
                        <select id="productCurrency" required>
                            <option value="EUR">EUR (‚Ç¨)</option>
                            <option value="USD">USD ($)</option>
                            <option value="GBP">GBP (¬£)</option>
                        </select>
                    </div>
                </div>

                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                    <div class="form-group">
                        <label>Category</label>
                        <select id="productCategory" required>
                            <option value="">Select Category</option>
                            <option value="Apparel">Apparel</option>
                            <option value="Home Decor">Home Decor</option>
                            <option value="Accessories">Accessories</option>
                            <option value="Art">Art</option>
                            <option value="Patterns">Patterns (Digital)</option>
                            <option value="Tools & Supplies">Tools & Supplies</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Photo/Image Upload</label>
                        <input type="file" id="productPhotoInput" accept="image/*">
                    </div>
                </div>

                <div class="form-group">
                    <label>Product Type</label>
                    <div class="product-type-selector">
                        <label class="product-type-option selected" id="handmade-option">
                            <input type="radio" name="productType" value="handmade" style="display: none;" checked>
                            <div style="font-size: 2rem; margin-bottom: 0.5rem;">‚úã</div>
                            <div style="font-weight: 600; margin-bottom: 0.25rem;">Handmade Item</div>
                            <div style="font-size: 0.875rem; color: var(--text-muted);">Physical or made to order</div>
                        </label>

                        <label class="product-type-option" id="digital-option">
                            <input type="radio" name="productType" value="digital" style="display: none;">
                            <div style="font-size: 2rem; margin-bottom: 0.5rem;">üìÑ</div>
                            <div style="font-weight: 600; margin-bottom: 0.25rem;">Digital</div>
                            <div style="font-size: 0.875rem; color: var(--text-muted);">Patterns & guides</div>
                        </label>

                        <label class="product-type-option" id="travel_find-option">
                            <input type="radio" name="productType" value="travel_find" style="display: none;">
                            <div style="font-size: 2rem; margin-bottom: 0.5rem;">‚úàÔ∏è</div>
                            <div style="font-weight: 600; margin-bottom: 0.25rem;">Travel Find</div>
                            <div style="font-size: 0.875rem; color: var(--text-muted);">Limited batch orders</div>
                        </label>
                    </div>
                </div>

                <div style="text-align: right; padding-top: 1rem; border-top: 1px solid var(--light-beige);">
                    <button type="button" class="btn btn-secondary" onclick="closeProductModal()" style="margin-right: 1rem;">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save Listing</button>
                </div>
            </form>
        </div>
    </div>

    <button class="icon-btn" style="position: fixed; bottom: 80px; right: 20px; z-index: 2002; background: var(--terracotta); color: white; transform: scale(1.3); box-shadow: 0 4px 12px rgba(0,0,0,0.15);" onclick="toggleFloatingChat()">
        üí¨
        <span class="badge-count" id="floating-message-count" style="background: var(--gold); display: none;">0</span>
    </button>

    <div class="chat-widget" id="floating-chat-widget">
        <div class="chat-widget-header" id="chat-widget-header">
            <div class="chat-widget-avatar" id="widget-contact-avatar">...</div>
            <div class="chat-widget-info">
                <div class="chat-widget-name" id="widget-contact-name">Chat Support</div>
                <div class="chat-widget-status">Online</div>
            </div>
            <button class="chat-widget-close" onclick="closeFloatingChat()">&times;</button>
        </div>
        <div class="chat-widget-messages" id="widget-chat-messages">
            <div class="chat-bubble chat-bubble-received">
                Welcome to Craft Club support! How can I help you?
                <div class="chat-bubble-time">Just now</div>
            </div>
        </div>
        <div class="chat-widget-input-area">
            <form class="chat-widget-input-form" onsubmit="handleWidgetSendMessage(event)">
                <input type="text" id="widget-message-input" class="chat-widget-input" placeholder="Type a message..." required>
                <button type="submit" class="chat-widget-send">‚û§</button>
            </form>
        </div>
    </div>


    <script>
        // Supabase Client Setup (Ensure you replace with your actual keys)
        const SUPABASE_URL = 'YOUR_SUPABASE_URL';
        const SUPABASE_ANON_KEY = 'YOUR_SUPABASE_ANON_KEY';
        const supabase = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        let currentUser = null;
        let allMembers = [];
        let currentChatReceiverId = null;

        // Utility Functions
        function showSection(sectionId) {
            document.querySelectorAll('.content-section').forEach(s => s.classList.remove('active'));
            document.getElementById(sectionId).classList.add('active');
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
            document.querySelector(`.nav-item[onclick="showSection('${sectionId}')"]`).classList.add('active');
            window.scrollTo({ top: 0, behavior: 'smooth' });
            if (sectionId === 'my-store') loadUserProducts();
            if (sectionId === 'members') loadMembers();
            if (sectionId === 'community') loadCommunityFeed();
            if (sectionId === 'friends') loadFriends();
            if (sectionId === 'my-projects') loadUserProjects();
            if (sectionId === 'chat') loadConversations();
        }

        function toggleCraftFields(isEdit = false) {
            const craftType = isEdit ? document.getElementById('edit-project-craft-type').value : document.getElementById('project-craft-type').value;
            const fields = document.querySelectorAll(isEdit ? '.craft-fields' : '.craft-specific-fields');
            fields.forEach(f => f.style.display = 'none');

            if (craftType) {
                document.getElementById(isEdit ? 'edit-project-status-group' : 'project-status-group').style.display = 'block';
                const fieldContainer = document.getElementById((isEdit ? 'edit-' : '') + craftType.toLowerCase().replace(' ', '-') + '-fields');
                if (fieldContainer) {
                    fieldContainer.style.display = 'block';
                }
            } else {
                document.getElementById(isEdit ? 'edit-project-status-group' : 'project-status-group').style.display = 'none';
            }
        }

        function getCraftIcon(craftType) {
            const icons = { 'Crochet': 'üß∂', 'Knitting': 'ü™°', 'Sewing': 'üßµ', 'Embroidery': '‚ú®', 'Weaving': 'üï∏Ô∏è', 'Quilting': '‚úÇÔ∏è', 'Leather Work': 'üëú', 'Other': 'üé®' };
            return icons[craftType] || 'üé®';
        }

        function formatMentions(text) {
            return text.replace(/@(\w+)/g, '<span class="mention">@$1</span>');
        }

        function getTimeAgo(timestamp) {
            const now = new Date();
            const past = new Date(timestamp);
            const diffMs = now - past;
            const diffMins = Math.floor(diffMs / 60000);
            const diffHours = Math.floor(diffMs / 3600000);
            const diffDays = Math.floor(diffMs / 86400000);

            if (diffMins < 1) return 'Just now';
            if (diffMins < 60) return `${diffMins}m ago`;
            if (diffHours < 24) return `${diffHours}h ago`;
            return `${diffDays}d ago`;
        }


        // ========== AUTH & INITIAL LOAD ==========

        async function checkAuth() {
            const { data: { user } } = await supabase.auth.getUser();
            if (!user) {
                // Redirect to login page
                window.location.href = 'index.html';
            } else {
                currentUser = user;
                await loadUserData();
                startRealtimeUpdates();
            }
        }

        async function loadUserData() {
            const { data: profile, error } = await supabase
                .from('profiles')
                .select('*')
                .eq('id', currentUser.id)
                .single();

            if (error) {
                console.error('Error fetching user profile:', error);
                return;
            }

            const initials = (profile.full_name || profile.username || 'U').split(' ').map(n => n[0]).join('').toUpperCase().substring(0, 2);
            profile.avatar_initials = initials;

            document.getElementById('header-avatar').textContent = initials;
            document.getElementById('welcome-text').textContent = `Welcome back, ${profile.full_name || profile.username}! üëã`;

            // Load initial content sections
            await loadUserProjects();
            await loadUserStats();
            await loadNotifications();
            await loadConversations();
        }

        function handleLogout() {
            supabase.auth.signOut().then(() => {
                window.location.href = 'index.html';
            }).catch(error => {
                console.error('Logout error:', error);
                alert('Could not log out.');
            });
        }


        // ========== USER PROFILE & SETTINGS ==========

        function showEditProfile() {
            hideAllDropdowns();
            document.getElementById('edit-profile-modal').classList.add('show');
            loadProfileDataForEdit();
        }

        function closeEditProfile() {
            document.getElementById('edit-profile-modal').classList.remove('show');
        }

        async function loadProfileDataForEdit() {
            const { data: profile } = await supabase.from('profiles').select('*').eq('id', currentUser.id).single();
            if (!profile) return;

            document.getElementById('edit-username').value = profile.username || '';
            document.getElementById('edit-fullname').value = profile.full_name || '';
            document.getElementById('edit-bio').value = profile.bio || '';
            document.getElementById('edit-location').value = profile.location || '';
            document.getElementById('edit-interests').value = profile.interests ? profile.interests.join(', ') : '';

            const preview = document.getElementById('profile-picture-preview');
            if (profile.profile_picture_url) {
                preview.innerHTML = `<img src="${profile.profile_picture_url}" alt="Profile Picture">`;
            } else {
                preview.textContent = profile.avatar_initials || 'U';
                preview.querySelector('img')?.remove();
            }
        }

        async function handleProfileUpdate(event) {
            event.preventDefault();
            const fullName = document.getElementById('edit-fullname').value;
            const bio = document.getElementById('edit-bio').value;
            const location = document.getElementById('edit-location').value;
            const interests = document.getElementById('edit-interests').value.split(',').map(s => s.trim()).filter(s => s);

            const { error } = await supabase
                .from('profiles')
                .update({
                    full_name: fullName,
                    bio: bio,
                    location: location,
                    interests: interests
                })
                .eq('id', currentUser.id);

            if (error) {
                console.error('Error updating profile:', error);
                alert('Failed to update profile: ' + error.message);
            } else {
                alert('Profile updated successfully!');
                closeEditProfile();
                loadUserData(); // Reload data to update header/dashboard
            }
        }

        function handleProfilePictureChange(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = (e) => {
                const preview = document.getElementById('profile-picture-preview');
                preview.innerHTML = `<img src="${e.target.result}" alt="Profile Picture">`;
            };
            reader.readAsDataURL(file);

            // In a real app, you would upload the file to Supabase Storage here
            // and then update the profile_picture_url in the profiles table.
            console.log("Profile picture selected. Upload logic needed.");
        }

        function showSettings() {
            hideAllDropdowns();
            document.getElementById('settings-modal').classList.add('show');
            loadSettingsData();
        }

        function closeSettings() {
            document.getElementById('settings-modal').classList.remove('show');
        }

        async function loadSettingsData() {
            const { data: profile } = await supabase.from('profiles').select('settings').eq('id', currentUser.id).single();
            const settings = profile?.settings || {};

            document.getElementById('setting-measurement').value = settings.measurement || 'metric';
            document.getElementById('setting-weight').value = settings.weight || 'kg';
            document.getElementById('setting-length').value = settings.length || 'cm';
            document.getElementById('setting-default-craft').value = settings.default_craft || '';
            document.getElementById('setting-private-profile').checked = settings.private_profile || false;
        }

        async function handleUpdateSettings(event) {
            event.preventDefault();
            const newSettings = {
                measurement: document.getElementById('setting-measurement').value,
                weight: document.getElementById('setting-weight').value,
                length: document.getElementById('setting-length').value,
                default_craft: document.getElementById('setting-default-craft').value,
                private_profile: document.getElementById('setting-private-profile').checked
            };

            const { error } = await supabase
                .from('profiles')
                .update({ settings: newSettings })
                .eq('id', currentUser.id);

            if (error) {
                console.error('Error updating settings:', error);
                alert('Failed to update settings: ' + error.message);
            } else {
                alert('Settings updated successfully!');
                closeSettings();
            }
        }


        // ========== DASHBOARD & STATS ==========

        async function loadUserStats() {
            const { data: stats, error } = await supabase.rpc('get_user_stats', { user_uuid: currentUser.id });

            if (error) {
                console.error('Error fetching stats:', error);
                return;
            }

            if (stats && stats.length > 0) {
                const userStats = stats[0];
                document.getElementById('stat-projects').textContent = userStats.project_count;
                document.getElementById('stat-likes').textContent = userStats.total_likes;
                document.getElementById('stat-friends').textContent = userStats.friend_count;
                document.getElementById('stat-streak').textContent = userStats.day_streak || 0;
            }
        }

        // ========== PROJECTS ==========

        async function loadUserProjects() {
            const { data: projects, error } = await supabase
                .from('projects')
                .select('*')
                .eq('user_id', currentUser.id)
                .order('created_at', { ascending: false });

            const container = document.getElementById('my-projects-container');
            container.innerHTML = '';

            if (error) {
                console.error('Error loading projects:', error);
                container.innerHTML = `<div class="card"><div class="empty-state">Error loading projects.</div></div>`;
                return;
            }

            if (!projects || projects.length === 0) {
                container.innerHTML = `
                    <div class="card">
                        <div class="empty-state">
                            <div class="empty-state-icon">‚ú®</div>
                            <h4 style="margin-bottom: 0.5rem;">No projects yet!</h4>
                            <p>Start a new craft project to track your progress and share with the community.</p>
                            <button class="btn btn-primary" onclick="showAddProject()" style="margin-top: 1rem;">+ Add First Project</button>
                        </div>
                    </div>
                `;
                return;
            }

            container.innerHTML = `<div class="project-grid">${projects.map(p => createProjectCard(p, true)).join('')}</div>`;
        }

        function createProjectCard(project, isOwner) {
            let craftPreview = '';
            if (project.craft_details && Object.keys(project.craft_details).length > 0) {
                const details = project.craft_details;
                if (project.craft_type === 'Crochet' && details.hook_size) {
                    craftPreview = ` ‚Ä¢ Hook: ${details.hook_size}`;
                } else if (project.craft_type === 'Knitting' && details.needle_size) {
                    craftPreview = ` ‚Ä¢ Needles: ${details.needle_size}`;
                } else if (project.craft_type === 'Sewing' && details.fabric_type) {
                    craftPreview = ` ‚Ä¢ ${details.fabric_type}`;
                }
            }

            return `
                <div class="project-card">
                    <div class="project-image" onclick="showProjectDetail('${project.id}')">
                        ${getCraftIcon(project.craft_type)}
                        ${!isOwner ? `
                            <button class="like-btn" id="like-btn-${project.id}" onclick="event.stopPropagation(); toggleLike(event, '${project.id}')">ü§ç</button>
                            <button class="follow-btn-small" id="follow-project-${project.id}" onclick="event.stopPropagation(); toggleProjectFollow('${project.id}')">Follow</button>
                        ` : ''}
                    </div>
                    <div class="project-info" onclick="showProjectDetail('${project.id}')">
                        <h3 class="project-title">${project.title}</h3>
                        <p style="font-size: 0.85rem; color: var(--text-muted); font-family: -apple-system, sans-serif; margin-bottom: 0.75rem;">${project.status}${craftPreview}</p>
                        ${isOwner ? `
                            <button class="btn btn-secondary btn-small" style="width: 100%;" onclick="event.stopPropagation(); showEditProject('${project.id}')">Edit Project</button>
                        ` : `
                            <div class="user-mini">
                                <div class="user-mini-avatar">${project.profiles.avatar_initials}</div>
                                <span>@${project.profiles.username}</span>
                            </div>
                        `}
                    </div>
                </div>
            `;
        }

        function showAddProject() {
            document.getElementById('projectModalTitle').textContent = 'Add New Project';
            document.getElementById('projectForm').reset();
            document.getElementById('project-id-input').value = '';
            document.getElementById('project-status-group').style.display = 'none';
            document.getElementById('project-status').value = 'In Progress';
            document.getElementById('project-photo-preview').style.display = 'none';

            // Check for default craft
            supabase.from('profiles').select('settings').eq('id', currentUser.id).single().then(({ data }) => {
                const defaultCraft = data?.settings?.default_craft;
                if (defaultCraft) {
                    document.getElementById('project-craft-type').value = defaultCraft;
                    toggleCraftFields();
                } else {
                    document.getElementById('project-craft-type').value = '';
                    toggleCraftFields(); // Hide fields if no default
                }
            });

            document.getElementById('project-modal').classList.add('show');
        }

        function closeProjectModal() {
            document.getElementById('project-modal').classList.remove('show');
        }

        async function handleSaveProject(event) {
            event.preventDefault();

            const isEdit = !!document.getElementById('project-id-input').value;
            const projectId = document.getElementById('project-id-input').value;

            const title = document.getElementById('project-title').value;
            const description = document.getElementById('project-description').value;
            const craftType = document.getElementById('project-craft-type').value;
            const status = document.getElementById('project-status').value;
            const photoFile = document.getElementById('project-photo-input').files[0];

            let photoUrl = '';
            if (photoFile) {
                const filePath = `${currentUser.id}/${Date.now()}_${photoFile.name}`;
                const { data, error: uploadError } = await supabase.storage
                    .from('project_photos')
                    .upload(filePath, photoFile);

                if (uploadError) {
                    alert('Error uploading photo: ' + uploadError.message);
                    return;
                }
                const { data: publicUrlData } = supabase.storage.from('project_photos').getPublicUrl(filePath);
                photoUrl = publicUrlData.publicUrl;
            }

            let craftDetails = getNewCraftDetails(craftType);
            if (!craftDetails) {
                alert('Please fill out the required craft details');
                return;
            }

            const projectData = {
                user_id: currentUser.id,
                title: title,
                description: description,
                craft_type: craftType,
                status: status,
                craft_details: craftDetails,
                photo_url: photoUrl
            };

            let error;

            if (isEdit) {
                // Edit logic (already in Edit Project Modal) - leaving this as an empty placeholder
                // The actual edit logic is in handleUpdateProject for the dedicated modal
                console.log('Edit logic skipped, use handleUpdateProject');
                return;
            } else {
                // Insert new project
                const { error: insertError } = await supabase.from('projects').insert(projectData);
                error = insertError;
            }

            if (error) {
                console.error('Error saving project:', error);
                alert('Failed to save project: ' + error.message);
            } else {
                alert(`‚úÖ Project ${isEdit ? 'updated' : 'created'} successfully!`);
                closeProjectModal();
                await loadUserProjects();
                await loadUserStats();
            }
        }

        function getNewCraftDetails(craftType) {
            const details = {};
            if (craftType === 'Crochet') {
                details.hook_size = document.getElementById('crochet-hook-size')?.value || '';
                details.yarn_weight = document.getElementById('crochet-yarn-weight')?.value || '';
                details.yarn_brand = document.getElementById('crochet-yarn-brand')?.value || '';
                details.yarn_color = document.getElementById('crochet-yarn-color')?.value || '';
                details.yardage = document.getElementById('crochet-yardage')?.value || '';
                details.gauge = document.getElementById('crochet-gauge')?.value || '';
                details.yarn_link = document.getElementById('crochet-yarn-link')?.value || '';
                details.pattern_link = document.getElementById('crochet-pattern-link')?.value || '';
            } else if (craftType === 'Knitting') {
                details.needle_size = document.getElementById('knitting-needle-size')?.value || '';
                details.needle_type = document.getElementById('knitting-needle-type')?.value || '';
                details.yarn_weight = document.getElementById('knitting-yarn-weight')?.value || '';
                details.yarn_brand = document.getElementById('knitting-yarn-brand')?.value || '';
                details.yardage = document.getElementById('knitting-yardage')?.value || '';
                details.yarn_link = document.getElementById('knitting-yarn-link')?.value || '';
            } else if (craftType === 'Sewing') {
                details.needle_type = document.getElementById('sewing-needle-type')?.value || '';
                details.fabric_type = document.getElementById('sewing-fabric-type')?.value || '';
                details.fabric_amount = document.getElementById('sewing-fabric-amount')?.value || '';
                details.fabric_brand = document.getElementById('sewing-fabric-brand')?.value || '';
                details.notions = document.getElementById('sewing-notions')?.value || '';
                details.pattern_size = document.getElementById('sewing-pattern-size')?.value || '';
                details.fabric_link = document.getElementById('sewing-fabric-link')?.value || '';
                details.pattern_link = document.getElementById('sewing-pattern-link')?.value || '';
            } else if (craftType === 'Embroidery') {
                details.thread_type = document.getElementById('embroidery-thread-type')?.value || '';
                details.thread_colors = document.getElementById('embroidery-thread-colors')?.value || '';
                details.fabric_type = document.getElementById('embroidery-fabric-type')?.value || '';
                details.hoop_size = document.getElementById('embroidery-hoop')?.value || '';
                details.pattern_link = document.getElementById('embroidery-pattern-link')?.value || '';
            } else if (craftType === 'Weaving') {
                details.loom_type = document.getElementById('weaving-loom-type')?.value || '';
                details.yarn_type = document.getElementById('weaving-yarn-type')?.value || '';
                details.reed_size = document.getElementById('weaving-reed-size')?.value || '';
                details.width = document.getElementById('weaving-width')?.value || '';
                details.length = document.getElementById('weaving-length')?.value || '';
                details.supplies_link = document.getElementById('weaving-supplies-link')?.value || '';
            } else if (craftType === 'Quilting') {
                details.quilt_size = document.getElementById('quilting-quilt-size')?.value || '';
                details.fabric_collection = document.getElementById('quilting-fabric-collection')?.value || '';
                details.batting_type = document.getElementById('quilting-batting-type')?.value || '';
                details.fabric_link = document.getElementById('quilting-fabric-link')?.value || '';
            } else if (craftType === 'Leather Work') {
                details.leather_type = document.getElementById('leather-type')?.value || '';
                details.thickness = document.getElementById('leather-thickness')?.value || '';
                details.thread_type = document.getElementById('leather-thread-type')?.value || '';
                details.tools_used = document.getElementById('leather-tools')?.value || '';
                details.supplies_link = document.getElementById('leather-supplies-link')?.value || '';
            } else if (craftType === 'Other') {
                details.materials = document.getElementById('other-materials')?.value || '';
                details.notes = document.getElementById('other-notes')?.value || '';
            }
            return details;
        }

        function previewProjectPhoto() {
            const input = document.getElementById('project-photo-input');
            const preview = document.getElementById('project-photo-preview');
            const img = document.getElementById('project-photo-img');
            const file = input.files[0];

            if (file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    img.src = e.target.result;
                    preview.style.display = 'block';
                };
                reader.readAsDataURL(file);
            } else {
                preview.style.display = 'none';
                img.src = '';
            }
        }

        function clearProjectPhoto() {
            document.getElementById('project-photo-input').value = '';
            document.getElementById('project-photo-preview').style.display = 'none';
            document.getElementById('project-photo-img').src = '';
        }

        // ========== PROJECT DETAIL & EDIT ==========

        let currentDetailProjectId = null;
        async function showProjectDetail(projectId) {
            const { data: project, error } = await supabase
                .from('projects')
                .select('*, profiles (username, full_name, profile_picture_url, avatar_initials)')
                .eq('id', projectId)
                .single();

            if (error) {
                console.error('Error loading project detail:', error);
                alert('Could not load project details.');
                return;
            }

            currentDetailProjectId = projectId;

            document.getElementById('project-detail-title').textContent = project.title;
            document.getElementById('project-detail-description').innerHTML = formatMentions(project.description || 'No description provided.');
            document.getElementById('detail-status').textContent = project.status;
            document.getElementById('detail-craft-type').textContent = project.craft_type;
            document.getElementById('detail-created-at').textContent = new Date(project.created_at).toLocaleDateString();
            document.getElementById('detail-updated-at').textContent = new Date(project.updated_at).toLocaleDateString();
            document.getElementById('detail-owner').textContent = `@${project.profiles.username}`;

            const imageContainer = document.getElementById('project-detail-image');
            if (project.photo_url) {
                imageContainer.style.backgroundImage = `url(${project.photo_url})`;
                imageContainer.style.backgroundSize = 'cover';
                imageContainer.style.backgroundPosition = 'center';
                imageContainer.innerHTML = '';
            } else {
                imageContainer.style.backgroundImage = 'none';
                imageContainer.style.background = 'linear-gradient(135deg, var(--light-beige), var(--highlight))';
                imageContainer.innerHTML = getCraftIcon(project.craft_type);
            }

            // Render Craft Details
            document.getElementById('project-detail-craft-info').innerHTML = renderCraftDetails(project.craft_details, project.craft_type);

            // Render Actions
            const actionsContainer = document.getElementById('project-detail-actions');
            actionsContainer.innerHTML = '';
            if (project.user_id === currentUser.id) {
                actionsContainer.innerHTML = `
                    <button class="btn btn-secondary" onclick="showEditProject('${projectId}')">‚úèÔ∏è Edit Details</button>
                    <button class="btn btn-danger" onclick="deleteProject('${projectId}')">üóëÔ∏è Delete Project</button>
                `;
            } else {
                actionsContainer.innerHTML = `
                    <button class="icon-btn" id="detail-like-btn" onclick="toggleLike(event, '${projectId}', true)">ü§ç Like</button>
                    <button class="btn btn-secondary" id="detail-follow-btn" onclick="toggleProjectFollow('${projectId}', true)">Follow Project</button>
                    <button class="btn btn-primary" onclick="openChat('${project.user_id}', '${project.profiles.username}', '${project.profiles.profile_picture_url || ''}', '${project.profiles.avatar_initials}')">üí¨ Message Maker</button>
                `;
                checkProjectLikeStatus(projectId, 'detail-like-btn');
                checkProjectFollowStatus(projectId, 'detail-follow-btn');
            }

            // Load Updates
            await loadProjectUpdates(projectId);

            document.getElementById('project-detail-modal').classList.add('show');
        }

        function closeProjectDetail() {
            document.getElementById('project-detail-modal').classList.remove('show');
            currentDetailProjectId = null;
        }

        function renderCraftDetails(craftDetails, craftType) {
            if (!craftDetails || Object.keys(craftDetails).length === 0) {
                return '<p style="color: var(--text-muted);">No detailed information was provided for this craft.</p>';
            }

            let html = '<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem 1rem;">';

            const formatLabel = (key) => {
                let label = key.replace(/_/g, ' ');
                return label.charAt(0).toUpperCase() + label.slice(1);
            };

            const renderField = (label, value) => {
                if (!value) return '';
                if (label.toLowerCase().includes('link')) {
                    return `
                        <div style="margin-bottom: 0.75rem;">
                            <strong style="color: var(--dark-brown); font-family: -apple-system, sans-serif; font-size: 0.9rem;">${label}:</strong>
                            <a href="${value}" target="_blank" style="margin-left: 0.5rem; color: var(--terracotta); font-family: -apple-system, sans-serif; font-size: 0.9rem;">üîó View Link</a>
                        </div>
                    `;
                }
                return `
                    <div style="margin-bottom: 0.75rem;">
                        <strong style="color: var(--dark-brown); font-family: -apple-system, sans-serif; font-size: 0.9rem;">${label}:</strong>
                        <span style="font-family: -apple-system, sans-serif; margin-left: 0.5rem;">${value}</span>
                    </div>
                `;
            };

            Object.keys(craftDetails).forEach(key => {
                const label = formatLabel(key);
                html += renderField(label, craftDetails[key]);
            });

            html += '</div>';
            return html;
        }

        async function loadProjectUpdates(projectId) {
            const { data: updates, error } = await supabase
                .from('project_updates')
                .select('*, profiles (username, profile_picture_url, avatar_initials)')
                .eq('project_id', projectId)
                .order('created_at', { ascending: false });

            const list = document.getElementById('project-updates-list');
            list.innerHTML = '';

            if (error) {
                console.error('Error loading project updates:', error);
                list.innerHTML = `<p style="color: var(--text-muted);">Could not load updates.</p>`;
                return;
            }

            if (!updates || updates.length === 0) {
                list.innerHTML = `<p style="color: var(--text-muted); text-align: center; padding: 1rem 0;">No updates yet. Be the first to post!</p>`;
                return;
            }

            updates.forEach(update => {
                const updateHtml = `
                    <div class="feed-item" style="padding: 1rem; margin-bottom: 0.75rem;">
                        <div style="display: flex; align-items: center; gap: 0.75rem; margin-bottom: 0.75rem;">
                            <div class="user-mini-avatar" style="width: 36px; height: 36px;">
                                ${update.profiles?.profile_picture_url ? `<img src="${update.profiles.profile_picture_url}" style="width: 100%; height: 100%; object-fit: cover;">` : update.profiles?.avatar_initials }
                            </div>
                            <div style="flex: 1;">
                                <div style="font-weight: 600; font-size: 0.9rem;">@${update.profiles?.username}</div>
                                <div style="font-size: 0.75rem; color: var(--text-muted); font-family: -apple-system, sans-serif;">${getTimeAgo(update.created_at)}</div>
                            </div>
                        </div>
                        <p style="font-family: -apple-system, sans-serif; line-height: 1.6; margin-bottom: ${update.photo_url ? '1rem' : '0'};">${formatMentions(update.content)}</p>
                        ${update.photo_url ? `
                            <img src="${update.photo_url}" style="width: 100%; border-radius: 8px; max-height: 300px; object-fit: cover; cursor: zoom-in;" onclick="window.open('${update.photo_url}', '_blank')">
                        ` : ''}
                    </div>
                `;
                list.innerHTML += updateHtml;
            });
        }

        async function postProjectUpdate(event, projectId) {
            event.preventDefault();
            const contentInput = document.getElementById('update-content-input');
            const content = contentInput.value.trim();
            const photoFile = document.getElementById('update-photo-input').files[0];

            if (!content && !photoFile) return;

            let photoUrl = '';
            if (photoFile) {
                const filePath = `${currentUser.id}/updates/${Date.now()}_${photoFile.name}`;
                const { error: uploadError } = await supabase.storage
                    .from('project_update_photos')
                    .upload(filePath, photoFile);

                if (uploadError) {
                    alert('Error uploading photo: ' + uploadError.message);
                    return;
                }
                const { data: publicUrlData } = supabase.storage.from('project_update_photos').getPublicUrl(filePath);
                photoUrl = publicUrlData.publicUrl;
            }

            const { error } = await supabase
                .from('project_updates')
                .insert({
                    project_id: projectId,
                    user_id: currentUser.id,
                    content: content,
                    photo_url: photoUrl
                });

            if (error) {
                console.error('Error posting update:', error);
                alert('Failed to post update: ' + error.message);
            } else {
                contentInput.value = '';
                clearUpdatePhoto();
                await loadProjectUpdates(projectId);
            }
        }

        function previewUpdatePhoto() {
            const file = document.getElementById('update-photo-input').files[0];
            const preview = document.getElementById('update-photo-preview');
            const img = document.getElementById('update-photo-img');
            if (file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    img.src = e.target.result;
                    preview.style.display = 'flex';
                };
                reader.readAsDataURL(file);
            }
        }

        function clearUpdatePhoto() {
            document.getElementById('update-photo-input').value = '';
            document.getElementById('update-photo-preview').style.display = 'none';
            document.getElementById('update-photo-img').src = '';
        }

        async function deleteProject(projectId) {
            if (!confirm('Are you sure you want to delete this project? This action cannot be undone.')) return;

            const { error } = await supabase
                .from('projects')
                .delete()
                .eq('id', projectId);

            if (error) {
                console.error('Error deleting project:', error);
                alert('Failed to delete project: ' + error.message);
            } else {
                alert('Project deleted successfully!');
                closeProjectDetail();
                await loadUserProjects();
                await loadUserStats();
            }
        }

        function showEditProject(projectId) {
            closeProjectDetail();
            document.getElementById('edit-project-id').value = projectId;
            loadProjectDataForEdit(projectId);
        }

        function closeEditProject() {
            document.getElementById('edit-project-modal').classList.remove('show');
            document.querySelectorAll('.craft-fields').forEach(f => f.style.display = 'none');
        }

        async function loadProjectDataForEdit(projectId) {
            const { data: project, error } = await supabase
                .from('projects')
                .select('*')
                .eq('id', projectId)
                .single();

            if (error || !project) {
                console.error('Error loading project for edit:', error);
                alert('Could not load project for editing.');
                return;
            }

            document.getElementById('edit-project-title-display').textContent = project.title;
            document.getElementById('edit-project-title').value = project.title;
            document.getElementById('edit-project-description').value = project.description || '';
            document.getElementById('edit-project-status').value = project.status;
            document.getElementById('edit-project-craft-type').value = project.craft_type;

            // Hide all craft fields first
            document.querySelectorAll('.craft-fields').forEach(f => f.style.display = 'none');

            // Populate craft-specific fields
            const details = project.craft_details || {};
            if (project.craft_type === 'Crochet') {
                document.getElementById('edit-crochet-fields').style.display = 'block';
                document.getElementById('edit-crochet-hook').value = details.hook_size || '';
                document.getElementById('edit-crochet-yarn-brand').value = details.yarn_brand || '';
                document.getElementById('edit-crochet-yarn-color').value = details.yarn_color || '';
                document.getElementById('edit-crochet-yarn-weight').value = details.yarn_weight || '';
                document.getElementById('edit-crochet-gauge').value = details.gauge || '';
                document.getElementById('edit-crochet-yardage').value = details.yardage || '';
                document.getElementById('edit-crochet-pattern-link').value = details.pattern_link || '';
                document.getElementById('edit-crochet-supplies-link').value = details.supplies_link || '';
            } else if (project.craft_type === 'Knitting') {
                document.getElementById('edit-knitting-fields').style.display = 'block';
                document.getElementById('edit-knitting-needle-type').value = details.needle_type || '';
                document.getElementById('edit-knitting-needle-size').value = details.needle_size || '';
                document.getElementById('edit-knitting-yarn-brand').value = details.yarn_brand || '';
                document.getElementById('edit-knitting-yarn-color').value = details.yarn_color || '';
                document.getElementById('edit-knitting-yarn-weight').value = details.yarn_weight || '';
                document.getElementById('edit-knitting-yardage').value = details.yardage || '';
                document.getElementById('edit-knitting-pattern-link').value = details.pattern_link || '';
                document.getElementById('edit-knitting-supplies-link').value = details.supplies_link || '';
            } else if (project.craft_type === 'Sewing') {
                document.getElementById('edit-sewing-fields').style.display = 'block';
                document.getElementById('edit-sewing-fabric-type').value = details.fabric_type || '';
                document.getElementById('edit-sewing-fabric-amount').value = details.fabric_amount || '';
                document.getElementById('edit-sewing-fabric-brand').value = details.fabric_brand || '';
                document.getElementById('edit-sewing-needle-info').value = details.needle_info || '';
                document.getElementById('edit-sewing-notions').value = details.notions || '';
                document.getElementById('edit-sewing-pattern-link').value = details.pattern_link || '';
                document.getElementById('edit-sewing-supplies-link').value = details.supplies_link || '';
            } else if (project.craft_type === 'Embroidery') {
                document.getElementById('edit-embroidery-fields').style.display = 'block';
                document.getElementById('edit-embroidery-thread-brand').value = details.thread_brand || '';
                document.getElementById('edit-embroidery-colors').value = details.thread_colors || '';
                document.getElementById('edit-embroidery-fabric').value = details.fabric || '';
                document.getElementById('edit-embroidery-hoop').value = details.hoop_size || '';
                document.getElementById('edit-embroidery-pattern-link').value = details.pattern_link || '';
                document.getElementById('edit-embroidery-supplies-link').value = details.supplies_link || '';
            } else if (project.craft_type === 'Weaving') {
                document.getElementById('edit-weaving-fields').style.display = 'block';
                document.getElementById('edit-weaving-loom').value = details.loom_type || '';
                document.getElementById('edit-weaving-reed').value = details.reed_size || '';
                document.getElementById('edit-weaving-width').value = details.width || '';
                document.getElementById('edit-weaving-length').value = details.length || '';
                document.getElementById('edit-weaving-supplies-link').value = details.supplies_link || '';
            } else if (project.craft_type === 'Quilting') {
                document.getElementById('edit-quilting-fields').style.display = 'block';
                document.getElementById('edit-quilting-size').value = details.quilt_size || '';
                document.getElementById('edit-quilting-fabric-collection').value = details.fabric_collection || '';
                document.getElementById('edit-quilting-batting-type').value = details.batting_type || '';
                document.getElementById('edit-quilting-fabric-link').value = details.fabric_link || '';
            } else if (project.craft_type === 'Leather Work') {
                document.getElementById('edit-leather-fields').style.display = 'block';
                document.getElementById('edit-leather-type').value = details.leather_type || '';
                document.getElementById('edit-leather-thickness').value = details.thickness || '';
                document.getElementById('edit-leather-thread-type').value = details.thread_type || '';
                document.getElementById('edit-leather-tools').value = details.tools_used || '';
                document.getElementById('edit-leather-supplies-link').value = details.supplies_link || '';
            } else if (project.craft_type === 'Other') {
                document.getElementById('edit-other-fields').style.display = 'block';
                document.getElementById('edit-other-materials').value = details.materials || '';
                document.getElementById('edit-other-notes').value = details.notes || '';
            }

            document.getElementById('edit-project-modal').classList.add('show');
        }

        function getEditCraftDetails(craftType) {
            const details = {};
            // This function is repeated from getNewCraftDetails to ensure proper form fetching from the dedicated edit modal
            if (craftType === 'Crochet') {
                const hook = document.getElementById('edit-crochet-hook').value;
                const brand = document.getElementById('edit-crochet-yarn-brand').value;
                const color = document.getElementById('edit-crochet-yarn-color').value;
                const weight = document.getElementById('edit-crochet-yarn-weight').value;
                const gauge = document.getElementById('edit-crochet-gauge').value;
                const yardage = document.getElementById('edit-crochet-yardage').value;
                const pattern = document.getElementById('edit-crochet-pattern-link').value;
                const supplies = document.getElementById('edit-crochet-supplies-link').value;
                return { hook_size: hook, yarn_brand: brand, yarn_color: color, yarn_weight: weight, gauge: gauge, yardage: yardage, pattern_link: pattern, supplies_link: supplies };
            } else if (craftType === 'Knitting') {
                const type = document.getElementById('edit-knitting-needle-type').value;
                const size = document.getElementById('edit-knitting-needle-size').value;
                const brand = document.getElementById('edit-knitting-yarn-brand').value;
                const color = document.getElementById('edit-knitting-yarn-color').value;
                const weight = document.getElementById('edit-knitting-yarn-weight').value;
                const yardage = document.getElementById('edit-knitting-yardage').value;
                const pattern = document.getElementById('edit-knitting-pattern-link').value;
                const supplies = document.getElementById('edit-knitting-supplies-link').value;
                return { needle_type: type, needle_size: size, yarn_brand: brand, yarn_color: color, yarn_weight: weight, yardage: yardage, pattern_link: pattern, supplies_link: supplies };
            } else if (craftType === 'Sewing') {
                const fabricType = document.getElementById('edit-sewing-fabric-type').value;
                const fabricAmount = document.getElementById('edit-sewing-fabric-amount').value;
                const fabricBrand = document.getElementById('edit-sewing-fabric-brand').value;
                const needleInfo = document.getElementById('edit-sewing-needle-info').value;
                const notions = document.getElementById('edit-sewing-notions').value;
                const pattern = document.getElementById('edit-sewing-pattern-link').value;
                const supplies = document.getElementById('edit-sewing-supplies-link').value;
                return { fabric_type: fabricType, fabric_amount: fabricAmount, fabric_brand: fabricBrand, needle_info: needleInfo, notions: notions, pattern_link: pattern, supplies_link: supplies };
            } else if (craftType === 'Embroidery') {
                const brand = document.getElementById('edit-embroidery-thread-brand').value;
                const colors = document.getElementById('edit-embroidery-colors').value;
                const fabric = document.getElementById('edit-embroidery-fabric').value;
                const hoop = document.getElementById('edit-embroidery-hoop').value;
                const pattern = document.getElementById('edit-embroidery-pattern-link').value;
                const supplies = document.getElementById('edit-embroidery-supplies-link').value;
                return { thread_brand: brand, thread_colors: colors, fabric: fabric, hoop_size: hoop, pattern_link: pattern, supplies_link: supplies };
            } else if (craftType === 'Weaving') {
                const loom = document.getElementById('edit-weaving-loom').value;
                const reed = document.getElementById('edit-weaving-reed').value;
                const width = document.getElementById('edit-weaving-width').value;
                const length = document.getElementById('edit-weaving-length').value;
                const supplies = document.getElementById('edit-weaving-supplies-link').value;
                return { loom_type: loom, reed_size: reed, width: width, length: length, supplies_link: supplies };
            } else if (craftType === 'Quilting') {
                const size = document.getElementById('edit-quilting-size').value;
                const collection = document.getElementById('edit-quilting-fabric-collection').value;
                const batting = document.getElementById('edit-quilting-batting-type').value;
                const fabricLink = document.getElementById('edit-quilting-fabric-link').value;
                return { quilt_size: size, fabric_collection: collection, batting_type: batting, fabric_link: fabricLink };
            } else if (craftType === 'Leather Work') {
                const type = document.getElementById('edit-leather-type').value;
                const thickness = document.getElementById('edit-leather-thickness').value;
                const thread = document.getElementById('edit-leather-thread-type').value;
                const tools = document.getElementById('edit-leather-tools').value;
                const supplies = document.getElementById('edit-leather-supplies-link').value;
                return { leather_type: type, thickness: thickness, thread_type: thread, tools_used: tools, supplies_link: supplies };
            } else if (craftType === 'Other') {
                const materials = document.getElementById('edit-other-materials').value;
                const notes = document.getElementById('edit-other-notes').value;
                return { materials: materials, notes: notes };
            }
            return {};
        }

        async function handleUpdateProject(event) {
            event.preventDefault();
            const projectId = document.getElementById('edit-project-id').value;
            const newTitle = document.getElementById('edit-project-title').value;
            const craftType = document.getElementById('edit-project-craft-type').value;

            // Simple change tracking (optional, but good for project_edits table)
            const { data: oldProject } = await supabase.from('projects').select('title, status, craft_details').eq('id', projectId).single();
            let changes = [];
            if (oldProject.title !== newTitle) changes.push('Title');
            if (oldProject.status !== document.getElementById('edit-project-status').value) changes.push('Status');

            const newCraftDetails = getEditCraftDetails(craftType);
            // Deep comparison of craft_details is complex, assume change if fields are modified
            if (JSON.stringify(oldProject.craft_details) !== JSON.stringify(newCraftDetails)) {
                 if (Object.keys(newCraftDetails).length > 0) changes.push('Craft Details');
            }

            if (Object.keys(newCraftDetails).length === 0 && craftType !== 'Other') {
                alert('Please fill out the craft details');
            }

            const { data, error } = await supabase.from('projects').update({
                title: newTitle,
                description: document.getElementById('edit-project-description').value,
                status: document.getElementById('edit-project-status').value,
                craft_details: newCraftDetails
            }).eq('id', projectId).select();

            if (error) {
                console.error('Error updating project:', error);
                alert('Failed to update project: ' + error.message);
                return;
            }

            console.log('Project updated successfully:', data);

            // Log the edit for the feed
            if (changes.length > 0) {
                await supabase.from('project_edits').insert({
                    project_id: projectId,
                    user_id: currentUser.id,
                    changes_summary: 'Updated: ' + changes.join(', ')
                });
            }

            closeEditProject();
            alert('Project updated successfully!');
            // Reload all data
            await loadUserData();
            // Reopen the project to show changes
            setTimeout(() => {
                showProjectDetail(projectId);
            }, 500);
        }

        // ========== COMMUNITY INTERACTIONS (LIKE/FOLLOW) ==========

        async function toggleLike(event, projectId, isDetailView = false) {
            event.preventDefault();
            const { data: existingLike } = await supabase
                .from('likes')
                .select('id')
                .eq('project_id', projectId)
                .eq('user_id', currentUser.id)
                .single();

            const btn = isDetailView ? document.getElementById('detail-like-btn') : document.getElementById(`like-btn-${projectId}`);

            if (existingLike) {
                // Unlike
                const { error } = await supabase.from('likes').delete().eq('id', existingLike.id);
                if (!error) {
                    if (btn) {
                        btn.textContent = isDetailView ? 'ü§ç Like' : 'ü§ç';
                        btn.classList.remove('liked');
                    }
                }
            } else {
                // Like
                const { error } = await supabase.from('likes').insert({ project_id: projectId, user_id: currentUser.id });
                if (!error) {
                    if (btn) {
                        btn.textContent = isDetailView ? '‚ù§Ô∏è Liked' : '‚ù§Ô∏è';
                        btn.classList.add('liked');
                    }
                }
            }
            // Reload stats to reflect new like count
            await loadUserStats();
        }

        async function checkProjectLikeStatus(projectId, buttonId) {
            const { data } = await supabase
                .from('likes')
                .select('id')
                .eq('project_id', projectId)
                .eq('user_id', currentUser.id)
                .single();

            const btn = document.getElementById(buttonId);
            if (btn) {
                if (data) {
                    btn.textContent = '‚ù§Ô∏è Liked';
                    btn.classList.add('liked');
                } else {
                    btn.textContent = 'ü§ç Like';
                    btn.classList.remove('liked');
                }
            }
        }

        async function toggleProjectFollow(projectId, isDetailView = false) {
            const { data: existingFollow } = await supabase
                .from('project_followers')
                .select('id')
                .eq('project_id', projectId)
                .eq('user_id', currentUser.id)
                .single();

            const btn = isDetailView ? document.getElementById('detail-follow-btn') : document.getElementById(`follow-project-${projectId}`);

            if (existingFollow) {
                // Unfollow
                const { error } = await supabase.from('project_followers').delete().eq('id', existingFollow.id);
                if (!error) {
                    if (btn) {
                        btn.textContent = isDetailView ? 'Follow Project' : 'Follow';
                        btn.className = isDetailView ? 'btn btn-secondary' : 'follow-btn-small';
                    }
                }
            } else {
                // Follow
                const { error } = await supabase.from('project_followers').insert({ project_id: projectId, user_id: currentUser.id });
                if (!error) {
                    if (btn) {
                        btn.textContent = isDetailView ? 'Following' : 'Following';
                        btn.className = isDetailView ? 'btn btn-secondary following' : 'follow-btn-small following';
                    }
                }
            }
        }

        async function checkProjectFollowStatus(projectId, buttonId) {
            const { data } = await supabase
                .from('project_followers')
                .select('id')
                .eq('project_id', projectId)
                .eq('user_id', currentUser.id)
                .single();

            const btn = document.getElementById(buttonId);
            if (btn) {
                btn.textContent = data ? (buttonId.includes('detail') ? 'Following' : 'Following') : (buttonId.includes('detail') ? 'Follow Project' : 'Follow');
                btn.className = data ? (buttonId.includes('detail') ? 'btn btn-secondary following' : 'follow-btn-small following') : (buttonId.includes('detail') ? 'btn btn-secondary' : 'follow-btn-small');
            }
        }


        // ========== COMMUNITY FEED ==========

        async function loadCommunityFeed() {
            // This RPC needs to be created in your Supabase database.
            // It should select updates and projects from people the user follows.
            const { data: feedItems, error } = await supabase.rpc('get_user_feed', { user_uuid: currentUser.id, limit_count: 20 });

            const container = document.getElementById('community-feed');
            container.innerHTML = '';

            if (error) {
                console.error('Error loading community feed:', error);
                container.innerHTML = `<div class="card"><div class="empty-state">Error loading feed.</div></div>`;
                return;
            }

            if (!feedItems || feedItems.length === 0) {
                container.innerHTML = `
                    <div class="card">
                        <div class="empty-state">
                            <div class="empty-state-icon">‚ú®</div>
                            <h4 style="margin-bottom: 0.5rem;">The feed is quiet...</h4>
                            <p>Follow some makers to see their latest projects and updates here!</p>
                            <button class="btn btn-secondary" onclick="showSection('members')" style="margin-top: 1rem;">üîç Find Makers</button>
                        </div>
                    </div>
                `;
                return;
            }

            feedItems.forEach(item => {
                if (item.type === 'project') {
                    // Display Project Card (assuming project data includes profile info from RPC)
                    container.innerHTML += createProjectCard(item.data, false);
                } else if (item.type === 'update') {
                    // Display Project Update
                    const update = item.data;
                    const updateHtml = `
                        <div class="feed-item">
                            <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 1rem;">
                                <div style="display: flex; align-items: center; gap: 0.75rem;">
                                    <div class="feed-avatar">
                                        ${update.profiles?.profile_picture_url ? `<img src="${update.profiles.profile_picture_url}" style="width: 100%; height: 100%; object-fit: cover;">` : update.profiles?.avatar_initials }
                                    </div>
                                    <div>
                                        <div style="font-weight: 600;">@${update.profiles?.username}</div>
                                        <div class="feed-time">${getTimeAgo(update.created_at)}</div>
                                    </div>
                                </div>
                                <div class="feed-time">Posted an update on project: <span style="font-weight: 600; cursor: pointer;" onclick="showProjectDetail('${update.project_id}')">${update.project_title}</span></div>
                            </div>
                            <p class="feed-content">${formatMentions(update.content)}</p>
                            ${update.photo_url ? `
                                <img src="${update.photo_url}" style="width: 100%; border-radius: 8px; max-height: 400px; object-fit: cover; margin-top: 1rem; cursor: zoom-in;" onclick="window.open('${update.photo_url}', '_blank')">
                            ` : ''}
                        </div>
                    `;
                    container.innerHTML += updateHtml;
                }
            });
        }


        // ========== FRIENDS & MEMBERS ==========

        async function loadFriends() {
            // This RPC or join query assumes you have a 'friends' table or a similar relationship table.
            const { data: friends, error } = await supabase.rpc('get_user_friends', { user_uuid: currentUser.id });

            const container = document.getElementById('friends-container');
            container.innerHTML = '';

            if (error) {
                console.error('Error loading friends:', error);
                container.innerHTML = `<div class="card"><div class="empty-state">Error loading friends.</div></div>`;
                return;
            }

            if (!friends || friends.length === 0) {
                container.innerHTML = `
                    <div class="card">
                        <div class="empty-state">
                            <div class="empty-state-icon">üëã</div>
                            <h4 style="margin-bottom: 0.5rem;">No friends yet!</h4>
                            <p>Find makers and send them a friend request in the Find Makers section.</p>
                            <button class="btn btn-secondary" onclick="showSection('members')" style="margin-top: 1rem;">üîç Find Makers</button>
                        </div>
                    </div>
                `;
                return;
            }

            container.innerHTML = `
                <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 1.5rem;">
                    ${friends.map(friend => `
                        <div class="card" style="text-align: center;">
                            <div style="width: 80px; height: 80px; border-radius: 50%; background: var(--terracotta); margin: 0 auto 1rem; display: flex; align-items: center; justify-content: center; color: white; font-size: 2rem; font-weight: bold; overflow: hidden;">
                                ${friend.profile_picture_url ? `<img src="${friend.profile_picture_url}" style="width: 100%; height: 100%; object-fit: cover;">` : friend.avatar_initials }
                            </div>
                            <h3 style="margin-bottom: 0.5rem; cursor: pointer;" onclick="showUserProfile('${friend.id}')">@${friend.username}</h3>
                            <p style="color: var(--text-muted); font-family: -apple-system, sans-serif; margin-bottom: 1rem;">${friend.full_name}</p>
                            <div style="display: flex; gap: 0.5rem;">
                                <button class="btn btn-primary btn-small" style="flex: 1;" onclick="openChat('${friend.id}', '${friend.username}', '${friend.profile_picture_url || ''}', '${friend.avatar_initials}')">üí¨ Message</button>
                                <button class="btn btn-secondary btn-small" onclick="showUserProfile('${friend.id}')">üë§ Profile</button>
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;
        }

        async function loadMembers() {
            const { data: members } = await supabase
                .from('profiles')
                .select('*')
                .neq('id', currentUser.id)
                .order('created_at', { ascending: false });

            allMembers = members || [];
            displayMembers(allMembers);
        }

        function displayMembers(members) {
            const container = document.getElementById('members-container');
            if (!members || members.length === 0) {
                container.innerHTML = '<div class="card"><div class="empty-state"><p>No other members yet</p></div></div>';
                return;
            }

            container.innerHTML = `
                <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 1.5rem;">
                    ${members.map(member => `
                        <div class="card" style="text-align: center; cursor: pointer;" onclick="showUserProfile('${member.id}')">
                            <div style="width: 80px; height: 80px; border-radius: 50%; background: var(--terracotta); margin: 0 auto 1rem; display: flex; align-items: center; justify-content: center; color: white; font-size: 2rem; font-weight: bold; overflow: hidden;">
                                ${member.profile_picture_url ? `<img src="${member.profile_picture_url}" style="width: 100%; height: 100%; object-fit: cover;">` : member.avatar_initials }
                            </div>
                            <h3 style="margin-bottom: 0.5rem;">@${member.username}</h3>
                            <p style="color: var(--text-muted); font-family: -apple-system, sans-serif; margin-bottom: 1rem;">${member.full_name || 'Craft Maker'}</p>
                            <div style="display: flex; gap: 0.5rem;">
                                <button class="btn btn-primary btn-small" style="flex: 1;" onclick="event.stopPropagation(); sendFriendRequest('${member.id}')">‚ûï Friend</button>
                                <button class="btn btn-secondary btn-small" onclick="event.stopPropagation(); openChat('${member.id}', '${member.username}', '${member.profile_picture_url || ''}', '${member.avatar_initials}')">üí¨ Message</button>
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;
        }

        function searchMembers() {
            const query = document.getElementById('member-search').value.toLowerCase();
            const filteredMembers = allMembers.filter(member =>
                member.username.toLowerCase().includes(query) ||
                (member.full_name && member.full_name.toLowerCase().includes(query))
            );
            displayMembers(filteredMembers);
        }

        function showUserProfile(userId) {
            // In a real application, this would open a new page or modal with the user's profile
            alert(`Navigating to user profile for ID: ${userId}`);
        }

        async function sendFriendRequest(receiverId) {
            // Logic to insert a new row into a 'friend_requests' table
            const { error } = await supabase
                .from('friend_requests')
                .insert({ sender_id: currentUser.id, receiver_id: receiverId });

            if (error) {
                console.error('Error sending friend request:', error);
                alert('Failed to send friend request: ' + error.message);
            } else {
                alert('Friend request sent!');
            }
        }


        // ========== MESSAGES & CHAT ==========

        let activeChatReceiver = null;

        function openChat(receiverId, username, avatarUrl, initials) {
            currentChatReceiverId = receiverId;
            showSection('chat');
            document.getElementById('chat-area').innerHTML = `
                <div class="card" style="height: calc(100vh - 250px); display: flex; flex-direction: column;">
                    <div style="display: flex; align-items: center; gap: 1rem; padding-bottom: 1rem; border-bottom: 1px solid var(--light-beige);">
                        <div class="feed-avatar" style="width: 40px; height: 40px;">
                            ${avatarUrl ? `<img src="${avatarUrl}" alt="${username}">` : initials}
                        </div>
                        <h3 style="margin: 0;">Chatting with @${username}</h3>
                    </div>
                    <div id="chat-messages" style="flex: 1; overflow-y: auto; padding: 1rem 0; display: flex; flex-direction: column; gap: 0.75rem;">
                        <div class="loading"><div class="spinner"></div></div>
                    </div>
                    <form onsubmit="handleSendMessage(event, '${receiverId}')" style="display: flex; gap: 0.5rem; padding-top: 1rem; border-top: 1px solid var(--light-beige);">
                        <input type="text" id="message-input" placeholder="Type your message..." style="flex: 1;">
                        <button type="submit" class="btn btn-primary btn-small">Send</button>
                    </form>
                </div>
            `;
            loadChatMessages(receiverId);
        }

        async function loadConversations() {
            // This RPC needs to be created to get all users the current user has exchanged messages with
            const { data: conversations, error } = await supabase.rpc('get_user_conversations', { user_uuid: currentUser.id });

            const list = document.getElementById('conversations-list');
            const dropdownList = document.getElementById('messages-dropdown').querySelector('#conversations-list');
            const messageCount = document.getElementById('message-count');
            const floatingCount = document.getElementById('floating-message-count');
            list.innerHTML = '';
            dropdownList.innerHTML = '';

            if (error) {
                console.error('Error loading conversations:', error);
                list.innerHTML = `<div class="dropdown-item">Error loading messages.</div>`;
                dropdownList.innerHTML = `<div class="dropdown-item">Error loading messages.</div>`;
                messageCount.style.display = 'none';
                floatingCount.style.display = 'none';
                return;
            }

            if (!conversations || conversations.length === 0) {
                const emptyMsg = '<div class="dropdown-item" style="color: var(--text-muted);">No recent messages.</div>';
                list.innerHTML = emptyMsg;
                dropdownList.innerHTML = emptyMsg;
                messageCount.style.display = 'none';
                floatingCount.style.display = 'none';
                return;
            }

            let unreadCount = 0;
            conversations.forEach(conv => {
                const isUnread = conv.unread_count > 0;
                if (isUnread) unreadCount++;

                const convHtml = `
                    <div class="dropdown-item ${isUnread ? 'notif-unread' : ''}" onclick="openChat('${conv.contact_id}', '${conv.username}', '${conv.profile_picture_url || ''}', '${conv.avatar_initials}'); hideAllDropdowns();">
                        <div style="display: flex; align-items: center; gap: 0.75rem;">
                            <div class="user-mini-avatar" style="width: 36px; height: 36px;">
                                ${conv.profile_picture_url ? `<img src="${conv.profile_picture_url}" alt="${conv.username}">` : conv.avatar_initials}
                            </div>
                            <div style="flex: 1;">
                                <div style="font-weight: 600;">@${conv.username} ${isUnread ? `<span class="badge-count" style="position: static; transform: none; background: var(--success); margin-left: 0.5rem; font-size: 0.7rem;">${conv.unread_count}</span>` : ''}</div>
                                <div class="notif-content" style="white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">${conv.latest_message_content}</div>
                            </div>
                            <div class="notif-time">${getTimeAgo(conv.latest_message_time)}</div>
                        </div>
                    </div>
                `;
                dropdownList.innerHTML += convHtml;
            });

            if (unreadCount > 0) {
                messageCount.textContent = unreadCount;
                messageCount.style.display = 'flex';
                floatingCount.textContent = unreadCount;
                floatingCount.style.display = 'flex';
            } else {
                messageCount.style.display = 'none';
                floatingCount.style.display = 'none';
            }

            // If the user is on the 'chat' section, also display the list on the main content area
            if (document.getElementById('chat').classList.contains('active')) {
                // For the main chat view, we just render the list of conversations
                list.innerHTML = `
                    <div class="card" style="min-height: calc(100vh - 200px);">
                        <h3 style="margin-bottom: 1rem;">Your Conversations</h3>
                        <div id="main-conversations-list">
                            ${conversations.map(conv => `
                                <div class="product-item" style="grid-template-columns: 48px 1fr auto; cursor: pointer;" onclick="openChat('${conv.contact_id}', '${conv.username}', '${conv.profile_picture_url || ''}', '${conv.avatar_initials}')">
                                    <div class="feed-avatar" style="width: 48px; height: 48px;">
                                        ${conv.profile_picture_url ? `<img src="${conv.profile_picture_url}" alt="${conv.username}">` : conv.avatar_initials}
                                    </div>
                                    <div style="min-width: 0;">
                                        <div style="font-weight: 600; font-size: 1rem;">@${conv.username}</div>
                                        <div style="font-size: 0.85rem; color: var(--text-muted); white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">${conv.latest_message_content}</div>
                                    </div>
                                    <div style="text-align: right;">
                                        <div class="notif-time">${getTimeAgo(conv.latest_message_time)}</div>
                                        ${conv.unread_count > 0 ? `<span class="badge-count" style="position: static; transform: none; background: var(--success); margin-top: 0.5rem; font-size: 0.7rem;">${conv.unread_count} Unread</span>` : ''}
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            }
        }

        async function loadChatMessages(receiverId) {
            const chatBox = document.getElementById('chat-messages');
            chatBox.innerHTML = '<div class="loading"><div class="spinner"></div></div>';

            const { data: messages } = await supabase.rpc('get_conversation', { user1_uuid: currentUser.id, user2_uuid: receiverId });

            // Mark messages as read
            await supabase.from('messages').update({ is_read: true }).eq('receiver_id', currentUser.id).eq('sender_id', receiverId);
            loadConversations(); // Update counts

            chatBox.innerHTML = '';
            if (messages) {
                messages.forEach(msg => {
                    const isSent = msg.sender_id === currentUser.id;
                    const bubble = `
                        <div class="chat-bubble ${isSent ? 'chat-bubble-sent' : 'chat-bubble-received'}">
                            ${msg.content}
                            <div class="chat-bubble-time">${getTimeAgo(msg.created_at)}</div>
                        </div>
                    `;
                    chatBox.innerHTML += bubble;
                });
                chatBox.scrollTop = chatBox.scrollHeight;
            }
        }

        async function handleSendMessage(event, receiverId) {
            event.preventDefault();
            const input = document.getElementById('message-input');
            const content = input.value.trim();
            if (!content) return;

            await supabase.from('messages').insert({
                sender_id: currentUser.id,
                receiver_id: receiverId,
                content: content
            });

            input.value = '';
            await loadChatMessages(receiverId);
        }

        // Floating Chat Widget Functions (for support/system chat)
        let isFloatingChatOpen = false;
        let isChatWidgetDraggable = false;
        let offsetX, offsetY;

        function toggleFloatingChat() {
            const chatWidget = document.getElementById('floating-chat-widget');
            isFloatingChatOpen = !isFloatingChatOpen;
            chatWidget.classList.toggle('show', isFloatingChatOpen);

            // Load some system/support messages when opening for the first time
            if (isFloatingChatOpen) {
                document.getElementById('widget-chat-messages').scrollTop = document.getElementById('widget-chat-messages').scrollHeight;
                // You might load a default support conversation here
            }
        }

        function closeFloatingChat() {
            isFloatingChatOpen = false;
            document.getElementById('floating-chat-widget').classList.remove('show');
        }

        function handleWidgetSendMessage(event) {
            event.preventDefault();
            const input = document.getElementById('widget-message-input');
            const content = input.value.trim();
            if (!content) return;

            const chatBox = document.getElementById('widget-chat-messages');
            const newBubble = `
                <div class="chat-bubble chat-bubble-sent">
                    ${content}
                    <div class="chat-bubble-time">Just now</div>
                </div>
            `;
            chatBox.innerHTML += newBubble;
            input.value = '';
            chatBox.scrollTop = chatBox.scrollHeight;

            // Simple auto-reply simulation
            setTimeout(() => {
                const replyBubble = `
                    <div class="chat-bubble chat-bubble-received">
                        Thanks for your message! Our support team will get back to you shortly.
                        <div class="chat-bubble-time">Just now</div>
                    </div>
                `;
                chatBox.innerHTML += replyBubble;
                chatBox.scrollTop = chatBox.scrollHeight;
            }, 1000);
        }

        // Drag functionality for floating chat (optional)
        const chatWidget = document.getElementById('floating-chat-widget');
        const chatHeader = document.getElementById('chat-widget-header');

        chatHeader.addEventListener('mousedown', (e) => {
            isChatWidgetDraggable = true;
            offsetX = e.clientX - chatWidget.offsetLeft;
            offsetY = e.clientY - chatWidget.offsetTop;
            chatWidget.style.cursor = 'grabbing';
        });

        document.addEventListener('mousemove', (e) => {
            if (!isChatWidgetDraggable) return;
            e.preventDefault();
            let newX = e.clientX - offsetX;
            let newY = e.clientY - offsetY;

            // Keep within bounds
            newX = Math.max(10, Math.min(window.innerWidth - chatWidget.offsetWidth - 10, newX));
            newY = Math.max(10, Math.min(window.innerHeight - chatWidget.offsetHeight - 10, newY));

            chatWidget.style.left = `${newX}px`;
            chatWidget.style.top = `${newY}px`;
            chatWidget.style.right = 'auto';
            chatWidget.style.bottom = 'auto';
        });

        document.addEventListener('mouseup', () => {
            isChatWidgetDraggable = false;
            chatWidget.style.cursor = 'grab';
        });

        // Add 'grab' cursor style on load (unless it's a small screen, which is handled by CSS)
        if (window.innerWidth > 768) {
             chatHeader.style.cursor = 'grab';
        }


        // ========== NOTIFICATIONS ==========

        async function loadNotifications() {
            const { data: notifications, error } = await supabase
                .from('notifications')
                .select('*')
                .eq('user_id', currentUser.id)
                .order('created_at', { ascending: false })
                .limit(10);

            const list = document.getElementById('notifications-list');
            const countBadge = document.getElementById('notif-count');
            list.innerHTML = '';

            if (error) {
                console.error('Error loading notifications:', error);
                list.innerHTML = `<div class="dropdown-item">Error loading notifications.</div>`;
                countBadge.style.display = 'none';
                return;
            }

            if (!notifications || notifications.length === 0) {
                list.innerHTML = '<div class="dropdown-item" style="color: var(--text-muted);">No new notifications.</div>';
                countBadge.style.display = 'none';
                return;
            }

            let unreadCount = 0;
            notifications.forEach(notif => {
                if (!notif.is_read) unreadCount++;

                const notifHtml = `
                    <div class="dropdown-item ${!notif.is_read ? 'notif-unread' : ''}" onclick="handleNotificationClick('${notif.id}', '${notif.type}', '${notif.target_id}')">
                        <div class="notif-content">${notif.message}</div>
                        <div class="notif-time">${getTimeAgo(notif.created_at)}</div>
                    </div>
                `;
                list.innerHTML += notifHtml;
            });

            if (unreadCount > 0) {
                countBadge.textContent = unreadCount;
                countBadge.style.display = 'flex';
            } else {
                countBadge.style.display = 'none';
            }
        }

        async function handleNotificationClick(notifId, type, targetId) {
            // Mark as read
            await supabase.from('notifications').update({ is_read: true }).eq('id', notifId);
            loadNotifications();
            hideAllDropdowns();

            // Handle navigation based on type
            if (type === 'project_like' || type === 'project_update') {
                showProjectDetail(targetId);
            } else if (type === 'friend_request') {
                showUserProfile(targetId);
            }
            // Add more navigation logic here
        }

        async function markAllRead() {
            await supabase.from('notifications').update({ is_read: true }).eq('user_id', currentUser.id).eq('is_read', false);
            loadNotifications();
        }

        // ========== GLOBAL UI CONTROLS ==========

        function startRealtimeUpdates() {
            supabase
                .channel('notifications')
                .on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'notifications', filter: `user_id=eq.${currentUser.id}` }, () => {
                    loadNotifications();
                })
                .subscribe();

            supabase
                .channel('messages-updates')
                .on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'messages', filter: `receiver_id=eq.${currentUser.id}` }, () => {
                    loadConversations();
                })
                .subscribe();
        }

        function toggleNotifications() {
            hideAllDropdowns();
            document.getElementById('notifications-dropdown').classList.toggle('show');
        }

        function toggleMessages() {
            hideAllDropdowns();
            document.getElementById('messages-dropdown').classList.toggle('show');
        }

        function toggleUserMenu() {
            hideAllDropdowns();
            document.getElementById('user-menu').classList.toggle('show');
        }

        function hideAllDropdowns() {
            document.querySelectorAll('.dropdown').forEach(d => d.classList.remove('show'));
        }

        // ========== STORE FUNCTIONS ==========

        let userProducts = [];
        let currentEditProductId = null;

        async function loadUserProducts() {
            try {
                const { data: { user } } = await supabase.auth.getUser();
                if (!user) return;

                const { data: products, error } = await supabase
                    .from('products')
                    .select('*')
                    .eq('seller_id', user.id)
                    .order('created_at', { ascending: false });

                if (error) throw error;
                userProducts = products || [];
                renderProductsList();
                updateStoreStats();
            } catch (error) {
                console.error('Error loading products:', error);
            }
        }

        function renderProductsList() {
            const container = document.getElementById('productsListContainer');
            if (userProducts.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 3rem; color: var(--text-muted);">
                        <div style="font-size: 3rem; margin-bottom: 1rem;">üõçÔ∏è</div>
                        <h4 style="margin-bottom: 0.5rem;">No listings yet</h4>
                        <p>Create your first listing to start selling on the Makers' Market</p>
                        <button class="btn btn-primary" onclick="openNewProductModal()" style="margin-top: 1rem;">Create First Listing</button>
                    </div>
                `;
                return;
            }

            container.innerHTML = userProducts.map(product => {
                const typeIcon = { 'handmade': '‚úã', 'digital': 'üìÑ', 'travel_find': '‚úàÔ∏è' }[product.product_type] || '‚ú®';
                const statusColor = product.is_active ? 'var(--success)' : 'var(--text-muted)';
                const statusText = product.is_active ? 'Active' : 'Draft/Inactive';
                const priceDisplay = `${product.currency}${product.price.toFixed(2)}`;

                return `
                    <div class="product-item">
                        <img src="${product.photo_url || 'https://via.placeholder.com/120/EDE8DC/8B7E74?text=No+Image'}" alt="${product.title}" class="product-item-image">
                        <div style="min-width: 0;">
                            <h4 style="margin-bottom: 0.25rem;">${product.title}</h4>
                            <p style="font-size: 0.85rem; color: var(--text-muted); margin-bottom: 0.5rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">${product.description}</p>
                            <div style="font-size: 0.85rem; display: flex; gap: 1rem;">
                                <span style="font-weight: 600; color: var(--terracotta);">${priceDisplay}</span>
                                <span style="color: ${statusColor};">‚óè ${statusText}</span>
                                <span style="color: var(--dark-brown);">${typeIcon} ${product.product_type.toUpperCase().replace('_', ' ')}</span>
                            </div>
                        </div>
                        <div style="display: flex; flex-direction: column; gap: 0.5rem;">
                            <button class="btn btn-secondary btn-small" onclick="editProduct('${product.id}')">Edit</button>
                            <button class="btn btn-danger btn-small" style="background: var(--love); color: white;" onclick="deleteProduct('${product.id}')">Delete</button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function updateStoreStats() {
            document.getElementById('totalProducts').textContent = userProducts.length;
            document.getElementById('activeProducts').textContent = userProducts.filter(p => p.is_active).length;
            // Placeholders for real-time order/revenue data:
            document.getElementById('totalOrders').textContent = '0';
            document.getElementById('totalRevenue').textContent = '‚Ç¨0';
        }

        function openNewProductModal() {
            currentEditProductId = null;
            document.getElementById('productModalTitle').textContent = 'Create New Listing';
            document.getElementById('productForm').reset();
            document.getElementById('productPhotoInput').value = '';
            document.getElementById('productModal').classList.add('show');

            // Set default radio selection
            document.getElementById('handmade-option').classList.add('selected');
            document.getElementById('digital-option').classList.remove('selected');
            document.getElementById('travel_find-option').classList.remove('selected');

            document.querySelectorAll('.product-type-option').forEach(option => {
                option.onclick = function() {
                    document.querySelectorAll('.product-type-option').forEach(o => o.classList.remove('selected'));
                    this.classList.add('selected');
                    this.querySelector('input[type="radio"]').checked = true;
                };
            });
        }

        function closeProductModal() {
            document.getElementById('productModal').classList.remove('show');
        }

        async function saveProduct(event) {
            event.preventDefault();
            try {
                const { data: { user } } = await supabase.auth.getUser();
                if (!user) {
                    alert('Please log in to create listings');
                    return;
                }

                const productType = document.querySelector('input[name="productType"]:checked').value;
                const photoFile = document.getElementById('productPhotoInput').files[0];
                let photoUrl = '';

                // 1. Handle Photo Upload
                if (photoFile) {
                    const filePath = `${user.id}/products/${Date.now()}_${photoFile.name}`;
                    const { error: uploadError } = await supabase.storage
                        .from('product_photos')
                        .upload(filePath, photoFile);

                    if (uploadError) throw new Error('Error uploading photo: ' + uploadError.message);

                    const { data: publicUrlData } = supabase.storage.from('product_photos').getPublicUrl(filePath);
                    photoUrl = publicUrlData.publicUrl;
                }

                const productData = {
                    seller_id: user.id,
                    title: document.getElementById('productTitle').value,
                    description: document.getElementById('productDescription').value,
                    price: parseFloat(document.getElementById('productPrice').value),
                    currency: document.getElementById('productCurrency').value,
                    category: document.getElementById('productCategory').value,
                    product_type: productType,
                    photo_url: photoUrl,
                    is_active: true, // Default to active
                    is_available: true
                };

                // Add type-specific flags (if needed by your DB schema)
                if (productType === 'handmade') { productData.is_made_to_order = true; }
                if (productType === 'digital') { productData.is_digital = true; }
                if (productType === 'travel_find') { productData.is_travel_find = true; }

                let error;

                if (currentEditProductId) {
                    // Update existing product
                    const { error: updateError } = await supabase
                        .from('products')
                        .update(productData)
                        .eq('id', currentEditProductId)
                        .select();
                    error = updateError;
                } else {
                    // Insert new product
                    const { error: insertError } = await supabase
                        .from('products')
                        .insert(productData);
                    error = insertError;
                }

                if (error) throw error;

                alert(`‚úÖ Listing ${currentEditProductId ? 'updated' : 'created'} successfully!`);
                closeProductModal();
                await loadUserProducts();
            } catch (error) {
                console.error('Error saving product:', error);
                alert('Error saving listing: ' + error.message);
            }
        }

        async function editProduct(id) {
            currentEditProductId = id;
            document.getElementById('productModalTitle').textContent = 'Edit Listing';
            const product = userProducts.find(p => p.id === id);
            if (!product) return;

            document.getElementById('productTitle').value = product.title;
            document.getElementById('productDescription').value = product.description;
            document.getElementById('productPrice').value = product.price;
            document.getElementById('productCurrency').value = product.currency;
            document.getElementById('productCategory').value = product.category;
            // Photo handling for edit is complex (pre-filling is not possible for file inputs) - simple version: clear input
            document.getElementById('productPhotoInput').value = '';

            // Set radio button and selected class
            document.querySelectorAll('input[name="productType"]').forEach(input => {
                input.checked = (input.value === product.product_type);
            });
            document.querySelectorAll('.product-type-option').forEach(option => {
                option.classList.remove('selected');
            });
            document.getElementById(`${product.product_type}-option`).classList.add('selected');

            document.getElementById('productModal').classList.add('show');
        }

        async function deleteProduct(id) {
            if (!confirm('Are you sure you want to delete this product listing?')) return;

            try {
                const { error } = await supabase
                    .from('products')
                    .delete()
                    .eq('id', id);

                if (error) throw error;

                alert('Listing deleted successfully!');
                await loadUserProducts();
            } catch (error) {
                console.error('Error deleting product:', error);
                alert('Error deleting listing: ' + error.message);
            }
        }


        // Global click handler for closing dropdowns
        document.addEventListener('click', function(event) {
            // Check if the click is outside all dropdowns, icon buttons, and user profile
            if (!event.target.closest('.icon-btn') && !event.target.closest('.user-profile') && !event.target.closest('.dropdown')) {
                hideAllDropdowns();
            }
            // Close modals if clicking outside the modal content
            if (event.target.classList.contains('modal')) {
                event.target.classList.remove('show');
                // Clean up edit project modal on close
                if (event.target.id === 'edit-project-modal') {
                    closeEditProject();
                }
            }
        });

        // Initialize the app on load
        checkAuth();
    </script>
</body>
</html>