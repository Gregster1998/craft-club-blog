<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Craft Club | Your Creative Space</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --terracotta: #A0695F;
            --dark-brown: #3C2F2F;
            --cream: #F5F1E8;
            --light-beige: #EDE8DC;
            --text-dark: #3C2F2F;
            --text-muted: #8B7E74;
            --gold: #D4AF37;
            --success: #5C8B5A;
            --highlight: #E8C5B5;
            --love: #E74C3C;
        }

        body {
            font-family: 'Georgia', serif;
            color: var(--text-dark);
            line-height: 1.6;
            background: var(--cream);
        }

        /* Header */
        header {
            position: fixed;
            top: 0;
            width: 100%;
            z-index: 1000;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            padding: 1rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid rgba(0,0,0,0.05);
        }

        .logo {
            font-size: 1.125rem;
            font-weight: 400;
            letter-spacing: 0.02em;
            color: var(--dark-brown);
        }

        .user-nav {
            display: flex;
            align-items: center;
            gap: 1.5rem;
        }

        .icon-btn {
            position: relative;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: var(--cream);
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.25rem;
            transition: all 0.3s;
        }

        .icon-btn:hover {
            background: var(--highlight);
            transform: scale(1.1);
        }

        .badge-count {
            position: absolute;
            top: -5px;
            right: -5px;
            background: var(--love);
            color: white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            font-size: 0.7rem;
            display: flex;
            align-items: center;
            justify-content: center;
            font-family: -apple-system, sans-serif;
            font-weight: bold;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }

        .avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: var(--terracotta);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            object-fit: cover;
        }

        .avatar img {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            object-fit: cover;
        }

        .user-profile {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            cursor: pointer;
            position: relative;
        }

        /* Dropdowns */
        .dropdown {
            position: absolute;
            top: 100%;
            right: 0;
            margin-top: 0.5rem;
            background: white;
            border-radius: 12px;
            box-shadow: 0 8px 24px rgba(0,0,0,0.15);
            min-width: 320px;
            max-width: 400px;
            max-height: 500px;
            overflow-y: auto;
            display: none;
            z-index: 1001;
        }

        .dropdown.show { display: block; }

        .dropdown-header {
            padding: 1.25rem;
            border-bottom: 2px solid var(--light-beige);
            font-family: -apple-system, sans-serif;
            font-weight: 600;
            font-size: 1.1rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .dropdown-item {
            padding: 1rem 1.25rem;
            border-bottom: 1px solid var(--light-beige);
            cursor: pointer;
            transition: background 0.3s;
            font-family: -apple-system, sans-serif;
        }

        .dropdown-item:hover {
            background: var(--cream);
        }

        .dropdown-item:last-child {
            border-bottom: none;
        }

        .notif-content {
            font-size: 0.9rem;
            margin-bottom: 0.25rem;
        }

        .notif-time {
            font-size: 0.75rem;
            color: var(--text-muted);
        }

        .notif-unread {
            background: #E8F5E9;
        }

        /* Layout */
        .main-container {
            margin-top: 80px;
            display: flex;
            min-height: calc(100vh - 80px);
        }

        .sidebar {
            width: 280px;
            background: white;
            padding: 2rem 1.5rem;
            border-right: 1px solid rgba(0,0,0,0.05);
            position: fixed;
            height: calc(100vh - 80px);
            overflow-y: auto;
        }

        .nav-item {
            padding: 0.75rem 1rem;
            color: var(--text-dark);
            text-decoration: none;
            border-radius: 8px;
            transition: all 0.3s;
            font-family: -apple-system, sans-serif;
            font-size: 0.95rem;
            display: flex;
            align-items: center;
            gap: 0.75rem;
            cursor: pointer;
            margin-bottom: 0.5rem;
        }

        .nav-item:hover, .nav-item.active {
            background: var(--light-beige);
            color: var(--terracotta);
        }

        .content {
            margin-left: 280px;
            flex: 1;
            padding: 2rem 3rem;
        }

        .content-section {
            display: none;
        }

        .content-section.active {
            display: block;
        }

        /* Cards */
        .card {
            background: white;
            padding: 2rem;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
            margin-bottom: 2rem;
        }

        .card h3 {
            margin-bottom: 1.5rem;
            color: var(--dark-brown);
            font-size: 1.25rem;
        }

        /* Dashboard Grid */
        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 2rem;
            margin-bottom: 2rem;
        }

        /* Quick Stats */
        .quick-stats {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 1rem;
        }

        .stat-box {
            text-align: center;
            padding: 1.5rem 1rem;
            background: var(--cream);
            border-radius: 8px;
            transition: transform 0.3s;
        }

        .stat-box:hover {
            transform: translateY(-4px);
        }

        .stat-icon {
            font-size: 2rem;
            margin-bottom: 0.5rem;
        }

        .stat-value {
            font-size: 1.75rem;
            font-weight: bold;
            color: var(--terracotta);
        }

        .stat-label {
            font-size: 0.85rem;
            color: var(--text-muted);
            font-family: -apple-system, sans-serif;
        }

        /* Project Grid */
        .project-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 1.5rem;
        }

        .project-card {
            background: white;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
            cursor: pointer;
            transition: all 0.3s;
            position: relative;
        }

        .project-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 6px 20px rgba(0,0,0,0.1);
        }

        .project-image {
            width: 100%;
            height: 200px;
            background: linear-gradient(135deg, var(--light-beige), var(--highlight));
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 3rem;
            position: relative;
        }

        .like-btn {
            position: absolute;
            bottom: 10px;
            right: 10px;
            width: 48px;
            height: 48px;
            border-radius: 50%;
            background: white;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            transition: all 0.3s;
            z-index: 10;
        }

        .like-btn:hover {
            transform: scale(1.1);
        }

        .like-btn.liked {
            animation: heartBeat 0.5s;
        }

        @keyframes heartBeat {
            0%, 100% { transform: scale(1); }
            25% { transform: scale(1.3); }
            50% { transform: scale(1.1); }
        }

        .follow-btn-small {
            position: absolute;
            top: 10px;
            right: 10px;
            padding: 0.4rem 0.8rem;
            background: white;
            border: 1px solid var(--terracotta);
            color: var(--terracotta);
            border-radius: 20px;
            font-size: 0.8rem;
            cursor: pointer;
            font-family: -apple-system, sans-serif;
            z-index: 10;
            transition: all 0.3s;
        }

        .follow-btn-small:hover {
            background: var(--terracotta);
            color: white;
        }

        .follow-btn-small.following {
            background: var(--terracotta);
            color: white;
        }

        .project-info {
            padding: 1.25rem;
        }

        .project-title {
            font-size: 1.1rem;
            margin-bottom: 0.5rem;
            color: var(--dark-brown);
        }

        .project-meta {
            display: flex;
            gap: 1rem;
            font-size: 0.85rem;
            color: var(--text-muted);
            font-family: -apple-system, sans-serif;
        }

        .user-mini {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 0.75rem;
        }

        .user-mini-avatar {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            background: var(--terracotta);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.7rem;
            font-weight: bold;
            object-fit: cover;
        }

        .user-mini-avatar img {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            object-fit: cover;
        }

        /* Feed Items */
        .feed-item {
            background: white;
            padding: 1.5rem;
            border-radius: 12px;
            margin-bottom: 1rem;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }

        .feed-header {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .feed-avatar {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            background: var(--terracotta);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            object-fit: cover;
        }

        .feed-avatar img {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            object-fit: cover;
        }

        .feed-content {
            font-family: -apple-system, sans-serif;
            line-height: 1.6;
        }

        .feed-time {
            font-size: 0.8rem;
            color: var(--text-muted);
            margin-top: 0.5rem;
        }

        .mention {
            color: var(--terracotta);
            font-weight: 600;
            cursor: pointer;
        }

        .mention:hover {
            text-decoration: underline;
        }

        /* Buttons */
        .btn {
            padding: 0.75rem 2rem;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-family: -apple-system, sans-serif;
            font-size: 0.95rem;
            transition: all 0.3s;
            display: inline-block;
            text-align: center;
        }

        .btn-primary {
            background: var(--terracotta);
            color: white;
        }

        .btn-primary:hover {
            background: var(--dark-brown);
            transform: translateY(-2px);
        }

        .btn-secondary {
            background: var(--light-beige);
            color: var(--dark-brown);
        }

        .btn-danger {
            background: #C75B5B;
            color: white;
        }

        .btn-small {
            padding: 0.5rem 1rem;
            font-size: 0.85rem;
        }

        /* Forms */
        .form-group {
            margin-bottom: 1.5rem;
        }

        label {
            display: block;
            font-family: -apple-system, sans-serif;
            font-size: 0.9rem;
            color: var(--dark-brown);
            margin-bottom: 0.5rem;
            font-weight: 500;
        }

        input, textarea, select {
            width: 100%;
            padding: 0.875rem 1rem;
            border: 2px solid var(--light-beige);
            border-radius: 8px;
            font-family: -apple-system, sans-serif;
            font-size: 1rem;
            transition: all 0.3s;
        }

        input:focus, textarea:focus, select:focus {
            outline: none;
            border-color: var(--terracotta);
        }

        textarea {
            min-height: 120px;
            resize: vertical;
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 2000;
            justify-content: center;
            align-items: center;
            padding: 2rem;
            overflow-y: auto;
        }

        .modal.show { display: flex; }

        .modal-content {
            background: white;
            border-radius: 16px;
            max-width: 600px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            padding: 2rem;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
            padding-bottom: 1rem;
            border-bottom: 2px solid var(--light-beige);
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 2rem;
            cursor: pointer;
            color: var(--text-muted);
        }

        /* Profile Picture Upload */
        .profile-picture-upload {
            text-align: center;
            margin-bottom: 2rem;
        }

        .profile-picture-preview {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            margin: 0 auto 1rem;
            background: var(--terracotta);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 3rem;
            font-weight: bold;
            object-fit: cover;
            overflow: hidden;
        }

        .profile-picture-preview img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .tag-input {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            padding: 0.5rem;
            border: 2px solid var(--light-beige);
            border-radius: 8px;
            min-height: 50px;
        }

        .tag {
            padding: 0.4rem 0.8rem;
            background: var(--light-beige);
            border-radius: 20px;
            font-size: 0.85rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .tag-remove {
            cursor: pointer;
            font-weight: bold;
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 3rem 2rem;
            color: var(--text-muted);
        }

        .empty-state-icon {
            font-size: 4rem;
            margin-bottom: 1rem;
            opacity: 0.5;
        }

        /* Loading */
        .loading {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 3rem;
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid var(--light-beige);
            border-top-color: var(--terracotta);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Responsive */
        @media (max-width: 768px) {
            .sidebar {
                position: static;
                width: 100%;
                height: auto;
            }

            .content {
                margin-left: 0;
                padding: 1.5rem;
            }

            .dashboard-grid, .project-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <header>
        <div class="logo">üé® Craft Club</div>
        <div class="user-nav">
            <button class="icon-btn" onclick="toggleNotifications()">
                üîî
                <span class="badge-count" id="notif-count" style="display: none;">0</span>
            </button>
            <button class="icon-btn" onclick="toggleMessages()">
                üí¨
                <span class="badge-count" id="message-count" style="display: none;">0</span>
            </button>
            <div class="user-profile" onclick="toggleUserMenu()">
                <div class="avatar" id="header-avatar">...</div>
            </div>

            <!-- Notifications Dropdown -->
            <div class="dropdown" id="notifications-dropdown">
                <div class="dropdown-header">
                    Notifications
                    <button onclick="markAllRead()" style="background: none; border: none; color: var(--terracotta); cursor: pointer; font-size: 0.85rem;">Mark all read</button>
                </div>
                <div id="notifications-list">
                    <div class="loading"><div class="spinner"></div></div>
                </div>
            </div>

            <!-- Messages Dropdown -->
            <div class="dropdown" id="messages-dropdown">
                <div class="dropdown-header">Messages</div>
                <div id="conversations-list">
                    <div class="loading"><div class="spinner"></div></div>
                </div>
            </div>

            <!-- User Menu -->
            <div class="dropdown" id="user-menu" style="min-width: 200px;">
                <div class="dropdown-item" onclick="showSection('dashboard')">üë§ Dashboard</div>
                <div class="dropdown-item" onclick="showEditProfile()">‚úèÔ∏è Edit Profile</div>
                <div class="dropdown-item" onclick="showSettings()">‚öôÔ∏è Settings</div>
                <div class="dropdown-item" onclick="handleLogout()">üö™ Logout</div>
            </div>
        </div>
    </header>

    <div class="main-container">
        <aside class="sidebar">
            <nav>
                <a class="nav-item active" onclick="showSection('dashboard')">üè† Dashboard</a>
                <a class="nav-item" onclick="showSection('my-projects')">üé® My Projects</a>
                <a class="nav-item" onclick="showSection('community')">üåä Community Feed</a>
                <a class="nav-item" onclick="showSection('friends')">üí´ Friends</a>
                <a class="nav-item" onclick="showSection('members')">üîç Find Makers</a>
                <a class="nav-item" onclick="showSection('chat')">üí¨ Messages</a>
            </nav>
        </aside>

        <main class="content">
            <!-- Dashboard -->
            <section id="dashboard" class="content-section active">
                <h1 style="margin-bottom: 2rem;" id="welcome-text">Welcome! üëã</h1>

                <div class="dashboard-grid">
                    <div class="card">
                        <h3>üìä Your Stats</h3>
                        <div class="quick-stats">
                            <div class="stat-box">
                                <div class="stat-icon">üé®</div>
                                <div class="stat-value" id="stat-projects">0</div>
                                <div class="stat-label">Projects</div>
                            </div>
                            <div class="stat-box">
                                <div class="stat-icon">‚ù§Ô∏è</div>
                                <div class="stat-value" id="stat-likes">0</div>
                                <div class="stat-label">Total Likes</div>
                            </div>
                            <div class="stat-box">
                                <div class="stat-icon">üë•</div>
                                <div class="stat-value" id="stat-friends">0</div>
                                <div class="stat-label">Friends</div>
                            </div>
                            <div class="stat-box">
                                <div class="stat-icon">üî•</div>
                                <div class="stat-value" id="stat-streak">0</div>
                                <div class="stat-label">Day Streak</div>
                            </div>
                        </div>
                    </div>
                </div>

                <button class="btn btn-primary" onclick="showAddProject()">+ Add New Project</button>
            </section>

            <!-- My Projects -->
            <section id="my-projects" class="content-section">
                <div style="display: flex; justify-content: space-between; margin-bottom: 2rem;">
                    <h1>üé® My Projects</h1>
                    <button class="btn btn-primary" onclick="showAddProject()">+ New Project</button>
                </div>
                <div id="my-projects-container"><div class="loading"><div class="spinner"></div></div></div>
            </section>

            <!-- Community Feed -->
            <section id="community" class="content-section">
                <h1 style="margin-bottom: 2rem;">üåä Community Feed</h1>
                <p style="color: var(--text-muted); margin-bottom: 2rem; font-family: -apple-system, sans-serif;">
                    Updates from projects you follow and friends you follow
                </p>
                <div id="community-feed"><div class="loading"><div class="spinner"></div></div></div>
            </section>

            <!-- Friends -->
            <section id="friends" class="content-section">
                <h1 style="margin-bottom: 2rem;">üí´ Your Friends</h1>
                <div id="friends-container"><div class="loading"><div class="spinner"></div></div></div>
            </section>

            <!-- Find Members -->
            <section id="members" class="content-section">
                <h1 style="margin-bottom: 2rem;">üîç Find Makers</h1>
                <input type="text" id="member-search" placeholder="Search by name or username..." style="margin-bottom: 2rem;" oninput="searchMembers()">
                <div id="members-container"><div class="loading"><div class="spinner"></div></div></div>
            </section>

            <!-- Chat -->
            <section id="chat" class="content-section">
                <h1 style="margin-bottom: 2rem;">üí¨ Messages</h1>
                <div id="chat-area"></div>
            </section>
        </main>
    </div>

    <!-- Edit Profile Modal -->
    <div class="modal" id="edit-profile-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Edit Profile</h2>
                <button class="modal-close" onclick="closeEditProfile()">&times;</button>
            </div>
            <form onsubmit="handleUpdateProfile(event)">
                <div class="profile-picture-upload">
                    <div class="profile-picture-preview" id="profile-pic-preview">
                        <span id="profile-pic-initials">...</span>
                    </div>
                    <input type="file" id="profile-picture-input" accept="image/*" style="display: none;" onchange="handleProfilePictureChange(event)">
                    <button type="button" class="btn btn-secondary btn-small" onclick="document.getElementById('profile-picture-input').click()">
                        Change Picture
                    </button>
                </div>
                <div class="form-group">
                    <label>Username</label>
                    <input type="text" id="edit-username" readonly style="background: #f5f5f5;">
                    <small style="color: var(--text-muted); font-size: 0.8rem;">Username cannot be changed</small>
                </div>
                <div class="form-group">
                    <label>Full Name</label>
                    <input type="text" id="edit-fullname">
                </div>
                <div class="form-group">
                    <label>Bio</label>
                    <textarea id="edit-bio" placeholder="Tell us about yourself..."></textarea>
                </div>
                <div class="form-group">
                    <label>Location</label>
                    <input type="text" id="edit-location" placeholder="City, Country">
                </div>
                <div class="form-group">
                    <label>Interests (comma separated)</label>
                    <input type="text" id="edit-interests" placeholder="Sewing, Knitting, Crochet">
                </div>
                <button type="submit" class="btn btn-primary" style="width: 100%;">Save Changes</button>
            </form>
        </div>
    </div>

    <!-- Settings Modal -->
    <div class="modal" id="settings-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>‚öôÔ∏è Settings</h2>
                <button class="modal-close" onclick="closeSettings()">&times;</button>
            </div>
            <form onsubmit="handleUpdateSettings(event)">
                <div class="form-group">
                    <label>Measurement System</label>
                    <select id="setting-measurement">
                        <option value="metric">Metric (cm, m, kg)</option>
                        <option value="imperial">Imperial (inches, yards, lbs)</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Weight Unit</label>
                    <select id="setting-weight">
                        <option value="kg">Kilograms (kg)</option>
                        <option value="lbs">Pounds (lbs)</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Length Unit</label>
                    <select id="setting-length">
                        <option value="cm">Centimeters (cm)</option>
                        <option value="m">Meters (m)</option>
                        <option value="inches">Inches</option>
                        <option value="yards">Yards</option>
                    </select>
                </div>
                <button type="submit" class="btn btn-primary" style="width: 100%;">Save Settings</button>
            </form>
        </div>
    </div>

    <!-- Profile View Modal -->
    <div class="modal" id="profile-view-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Profile</h2>
                <button class="modal-close" onclick="closeProfileView()">&times;</button>
            </div>
            <div id="profile-view-content"></div>
        </div>
    </div>

    <!-- Add Project Modal -->
    <div class="modal" id="add-project-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Add New Project</h2>
                <button class="modal-close" onclick="closeAddProject()">&times;</button>
            </div>
            <form onsubmit="handleAddProject(event)">
                <div class="form-group">
                    <label>Title *</label>
                    <input type="text" id="project-title" required>
                </div>
                <div class="form-group">
                    <label>Description</label>
                    <textarea id="project-description"></textarea>
                </div>
                <div class="form-group">
                    <label>Craft Type *</label>
                    <select id="project-craft-type" required>
                        <option value="">Select...</option>
                        <option value="Sewing">Sewing</option>
                        <option value="Knitting">Knitting</option>
                        <option value="Crochet">Crochet</option>
                        <option value="Other">Other</option>
                    </select>
                </div>
                <button type="submit" class="btn btn-primary" style="width: 100%;">Create Project</button>
            </form>
        </div>
    </div>

    <script>
        const SUPABASE_URL = 'YOUR_SUPABASE_URL';
        const SUPABASE_ANON_KEY = 'YOUR_SUPABASE_ANON_KEY';
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        let currentUser = null;
        let userProfile = null;
        let allMembers = [];

        async function checkAuth() {
            const { data: { session } } = await supabase.auth.getSession();
            if (!session) {
                window.location.href = 'login.html';
                return;
            }
            currentUser = session.user;
            await loadUserData();
        }

        async function loadUserData() {
            const { data: profile } = await supabase
                .from('profiles')
                .select('*')
                .eq('id', currentUser.id)
                .single();

            userProfile = profile;
            
            // Update header avatar
            const headerAvatar = document.getElementById('header-avatar');
            if (profile.profile_picture_url) {
                headerAvatar.innerHTML = `<img src="${profile.profile_picture_url}" alt="${profile.full_name}">`;
            } else {
                headerAvatar.textContent = profile.avatar_initials;
            }
            
            document.getElementById('welcome-text').textContent = `Welcome back, ${profile.full_name.split(' ')[0]}! üëã`;

            await loadAllData();
            startRealtimeUpdates();
        }

        async function loadAllData() {
            await Promise.all([
                loadQuickStats(),
                loadMyProjects(),
                loadCommunityFeed(),
                loadFriends(),
                loadMembers(),
                loadNotifications(),
                loadConversations()
            ]);
        }

        async function loadQuickStats() {
            const { data: friendsCount } = await supabase.rpc('get_friends_count', { user_uuid: currentUser.id });
            
            document.getElementById('stat-projects').textContent = userProfile.projects_count || 0;
            document.getElementById('stat-likes').textContent = userProfile.total_likes_received || 0;
            document.getElementById('stat-friends').textContent = friendsCount || 0;
            document.getElementById('stat-streak').textContent = userProfile.streak_days || 0;
        }

        async function loadMyProjects() {
            const { data: projects } = await supabase
                .from('projects')
                .select('*')
                .eq('user_id', currentUser.id)
                .order('created_at', { ascending: false });

            const container = document.getElementById('my-projects-container');
            
            if (!projects || projects.length === 0) {
                container.innerHTML = `
                    <div class="card">
                        <div class="empty-state">
                            <div class="empty-state-icon">üé®</div>
                            <p>No projects yet!</p>
                            <button class="btn btn-primary" style="margin-top: 1rem;" onclick="showAddProject()">Create Your First Project</button>
                        </div>
                    </div>
                `;
                return;
            }

            container.innerHTML = `<div class="project-grid">${projects.map(project => createProjectCard(project, true)).join('')}</div>`;
        }

        async function loadCommunityFeed() {
            const { data: feedItems } = await supabase.rpc('get_user_feed', { 
                user_uuid: currentUser.id,
                limit_count: 20
            });

            const container = document.getElementById('community-feed');
            
            if (!feedItems || feedItems.length === 0) {
                container.innerHTML = `
                    <div class="card">
                        <div class="empty-state">
                            <div class="empty-state-icon">üåä</div>
                            <p>No activity yet. Follow some projects and makers!</p>
                        </div>
                    </div>
                `;
                return;
            }

            container.innerHTML = feedItems.map(item => `
                <div class="feed-item">
                    <div class="feed-header">
                        <div class="feed-avatar" onclick="showUserProfile('${item.user_id}')">
                            ${item.profile_picture_url ? 
                                `<img src="${item.profile_picture_url}" alt="${item.username}">` : 
                                item.avatar_initials
                            }
                        </div>
                        <div style="flex: 1;">
                            <div style="font-weight: 600; cursor: pointer;" onclick="showUserProfile('${item.user_id}')">
                                @${item.username}
                            </div>
                            <div style="font-size: 0.85rem; color: var(--text-muted);">
                                ${getFeedTypeText(item.type)} in "${item.project_title}"
                            </div>
                        </div>
                    </div>
                    <div class="feed-content">${formatMentions(item.content)}</div>
                    <div class="feed-time">${getTimeAgo(item.created_at)}</div>
                </div>
            `).join('');
        }

        function getFeedTypeText(type) {
            switch(type) {
                case 'project_update': return 'posted an update';
                case 'comment': return 'commented';
                case 'friend_project_update': return 'updated their project';
                default: return 'posted';
            }
        }

        async function loadFriends() {
            // Get all friendships where current user is involved
            const { data: friendships } = await supabase
                .from('friends')
                .select('user1_id, user2_id')
                .or(`user1_id.eq.${currentUser.id},user2_id.eq.${currentUser.id}`);

            const container = document.getElementById('friends-container');
            
            if (!friendships || friendships.length === 0) {
                container.innerHTML = `
                    <div class="card">
                        <div class="empty-state">
                            <div class="empty-state-icon">üí´</div>
                            <p>No friends yet!</p>
                            <p style="font-size: 0.9rem; margin-top: 0.5rem;">Friends are people who follow you AND you follow them back</p>
                        </div>
                    </div>
                `;
                return;
            }

            // Extract friend IDs
            const friendIds = friendships.map(f => 
                f.user1_id === currentUser.id ? f.user2_id : f.user1_id
            );

            // Get friend profiles
            const { data: friends } = await supabase
                .from('profiles')
                .select('*')
                .in('id', friendIds);

            container.innerHTML = `
                <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 1.5rem;">
                    ${friends.map(friend => `
                        <div class="card" style="text-align: center;">
                            <div style="width: 80px; height: 80px; border-radius: 50%; background: var(--terracotta); margin: 0 auto 1rem; display: flex; align-items: center; justify-content: center; color: white; font-size: 2rem; font-weight: bold; overflow: hidden; cursor: pointer;" onclick="showUserProfile('${friend.id}')">
                                ${friend.profile_picture_url ? 
                                    `<img src="${friend.profile_picture_url}" style="width: 100%; height: 100%; object-fit: cover;">` : 
                                    friend.avatar_initials
                                }
                            </div>
                            <h3 style="margin-bottom: 0.5rem; cursor: pointer;" onclick="showUserProfile('${friend.id}')">@${friend.username}</h3>
                            <p style="color: var(--text-muted); font-family: -apple-system, sans-serif; margin-bottom: 1rem;">${friend.full_name}</p>
                            <div style="display: flex; gap: 0.5rem;">
                                <button class="btn btn-primary btn-small" style="flex: 1;" onclick="openChat('${friend.id}', '${friend.username}', '${friend.profile_picture_url || ''}', '${friend.avatar_initials}')">üí¨ Message</button>
                                <button class="btn btn-secondary btn-small" onclick="showUserProfile('${friend.id}')">üë§ Profile</button>
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;
        }

        async function loadMembers() {
            const { data: members } = await supabase
                .from('profiles')
                .select('*')
                .neq('id', currentUser.id)
                .order('created_at', { ascending: false });

            allMembers = members || [];
            displayMembers(allMembers);
        }

        function displayMembers(members) {
            const container = document.getElementById('members-container');
            
            if (!members || members.length === 0) {
                container.innerHTML = '<div class="card"><div class="empty-state"><p>No other members yet</p></div></div>';
                return;
            }

            container.innerHTML = `
                <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 1.5rem;">
                    ${members.map(member => `
                        <div class="card" style="text-align: center; cursor: pointer;" onclick="showUserProfile('${member.id}')">
                            <div style="width: 80px; height: 80px; border-radius: 50%; background: var(--terracotta); margin: 0 auto 1rem; display: flex; align-items: center; justify-content: center; color: white; font-size: 2rem; font-weight: bold; overflow: hidden;">
                                ${member.profile_picture_url ? 
                                    `<img src="${member.profile_picture_url}" style="width: 100%; height: 100%; object-fit: cover;">` : 
                                    member.avatar_initials
                                }
                            </div>
                            <h3 style="margin-bottom: 0.5rem;">@${member.username}</h3>
                            <p style="color: var(--text-muted); font-family: -apple-system, sans-serif; margin-bottom: 0.5rem;">${member.full_name}</p>
                            <p style="color: var(--text-muted); font-family: -apple-system, sans-serif; font-size: 0.85rem; margin-bottom: 1rem;">${member.location || 'Location not set'}</p>
                            <button class="btn btn-primary btn-small" style="width: 100%;" onclick="event.stopPropagation(); toggleFollow('${member.id}')" id="follow-btn-${member.id}">Follow</button>
                        </div>
                    `).join('')}
                </div>
            `;

            members.forEach(member => checkFollowStatus(member.id));
        }

        function searchMembers() {
            const query = document.getElementById('member-search').value.toLowerCase();
            const filtered = allMembers.filter(m => 
                m.full_name.toLowerCase().includes(query) ||
                m.username.toLowerCase().includes(query)
            );
            displayMembers(filtered);
        }

        async function checkFollowStatus(userId) {
            const { data } = await supabase
                .from('follows')
                .select('id')
                .eq('follower_id', currentUser.id)
                .eq('following_id', userId)
                .single();

            const btn = document.getElementById(`follow-btn-${userId}`);
            if (btn) {
                btn.textContent = data ? 'Following' : 'Follow';
                btn.className = data ? 'btn btn-small' : 'btn btn-primary btn-small';
            }
        }

        async function toggleFollow(userId) {
            const { data: existing } = await supabase
                .from('follows')
                .select('id')
                .eq('follower_id', currentUser.id)
                .eq('following_id', userId)
                .single();

            if (existing) {
                await supabase.from('follows').delete().eq('id', existing.id);
            } else {
                await supabase.from('follows').insert({
                    follower_id: currentUser.id,
                    following_id: userId
                });
            }

            checkFollowStatus(userId);
            loadFriends();
            loadQuickStats();
        }

        function createProjectCard(project, isOwner) {
            return `
                <div class="project-card">
                    <div class="project-image" onclick="showProjectDetail('${project.id}')">
                        ${getCraftIcon(project.craft_type)}
                        ${!isOwner ? `
                            <button class="like-btn" id="like-btn-${project.id}" onclick="event.stopPropagation(); toggleLike(event, '${project.id}')">ü§ç</button>
                            <button class="follow-btn-small" id="follow-project-${project.id}" onclick="event.stopPropagation(); toggleProjectFollow('${project.id}')">Follow</button>
                        ` : ''}
                    </div>
                    <div class="project-info" onclick="showProjectDetail('${project.id}')">
                        <h3 class="project-title">${project.title}</h3>
                        <div class="project-meta">
                            <span>‚ù§Ô∏è ${project.likes_count || 0}</span>
                            <span>üí¨ ${project.comments_count || 0}</span>
                        </div>
                        ${isOwner ? `
                            <button class="btn btn-danger btn-small" style="width: 100%; margin-top: 1rem;" onclick="event.stopPropagation(); deleteProject('${project.id}')">
                                üóëÔ∏è Delete
                            </button>
                        ` : ''}
                    </div>
                </div>
            `;
        }

        async function toggleProjectFollow(projectId) {
            const { data: existing } = await supabase
                .from('project_followers')
                .select('id')
                .eq('project_id', projectId)
                .eq('user_id', currentUser.id)
                .single();

            if (existing) {
                await supabase.from('project_followers').delete().eq('id', existing.id);
            } else {
                await supabase.from('project_followers').insert({
                    project_id: projectId,
                    user_id: currentUser.id
                });
            }

            const btn = document.getElementById(`follow-project-${projectId}`);
            if (btn) {
                btn.textContent = existing ? 'Follow' : 'Following';
                btn.className = existing ? 'follow-btn-small' : 'follow-btn-small following';
            }
        }

        async function toggleLike(event, projectId) {
            const btn = document.getElementById(`like-btn-${projectId}`);
            const isLiked = btn.classList.contains('liked');

            if (isLiked) {
                await supabase.from('likes').delete().eq('project_id', projectId).eq('user_id', currentUser.id);
                btn.textContent = 'ü§ç';
                btn.classList.remove('liked');
            } else {
                await supabase.from('likes').insert({ project_id: projectId, user_id: currentUser.id });
                btn.textContent = '‚ù§Ô∏è';
                btn.classList.add('liked');
                setTimeout(() => btn.classList.remove('liked'), 500);
            }

            loadMyProjects();
            loadQuickStats();
        }

        async function deleteProject(projectId) {
            if (!confirm('Are you sure you want to delete this project? This cannot be undone.')) {
                return;
            }

            try {
                await supabase.from('projects').delete().eq('id', projectId);
                await supabase.from('profiles').update({ 
                    projects_count: Math.max(0, userProfile.projects_count - 1)
                }).eq('id', currentUser.id);
                
                alert('Project deleted successfully!');
                await loadUserData();
            } catch (error) {
                console.error('Error deleting project:', error);
                alert('Failed to delete project');
            }
        }

        async function showProjectDetail(projectId) {
            alert('Project detail view - coming in next update!');
        }

        function showAddProject() {
            document.getElementById('add-project-modal').classList.add('show');
        }

        function closeAddProject() {
            document.getElementById('add-project-modal').classList.remove('show');
        }

        async function handleAddProject(event) {
            event.preventDefault();
            
            await supabase.from('projects').insert({
                user_id: currentUser.id,
                title: document.getElementById('project-title').value,
                description: document.getElementById('project-description').value,
                craft_type: document.getElementById('project-craft-type').value,
                status: 'in_progress'
            });

            await supabase.from('profiles').update({ 
                projects_count: userProfile.projects_count + 1 
            }).eq('id', currentUser.id);

            closeAddProject();
            event.target.reset();
            await loadUserData();
        }

        function showEditProfile() {
            document.getElementById('edit-username').value = userProfile.username;
            document.getElementById('edit-fullname').value = userProfile.full_name;
            document.getElementById('edit-bio').value = userProfile.bio || '';
            document.getElementById('edit-location').value = userProfile.location || '';
            document.getElementById('edit-interests').value = userProfile.interests ? userProfile.interests.join(', ') : '';
            
            const preview = document.getElementById('profile-pic-preview');
            if (userProfile.profile_picture_url) {
                preview.innerHTML = `<img src="${userProfile.profile_picture_url}">`;
            } else {
                preview.innerHTML = `<span id="profile-pic-initials">${userProfile.avatar_initials}</span>`;
            }
            
            document.getElementById('edit-profile-modal').classList.add('show');
            hideAllDropdowns();
        }

        function closeEditProfile() {
            document.getElementById('edit-profile-modal').classList.remove('show');
        }

        async function handleProfilePictureChange(event) {
            const file = event.target.files[0];
            if (!file) return;

            const fileExt = file.name.split('.').pop();
            const fileName = `${currentUser.id}/${Date.now()}.${fileExt}`;

            const { error: uploadError } = await supabase.storage
                .from('profile-pictures')
                .upload(fileName, file);

            if (uploadError) {
                console.error('Upload error:', uploadError);
                return;
            }

            const { data: { publicUrl } } = supabase.storage
                .from('profile-pictures')
                .getPublicUrl(fileName);

            document.getElementById('profile-pic-preview').innerHTML = `<img src="${publicUrl}">`;
            userProfile.profile_picture_url = publicUrl;
        }

        async function handleUpdateProfile(event) {
            event.preventDefault();

            const interests = document.getElementById('edit-interests').value
                .split(',')
                .map(i => i.trim())
                .filter(i => i);

            await supabase.from('profiles').update({
                full_name: document.getElementById('edit-fullname').value,
                bio: document.getElementById('edit-bio').value,
                location: document.getElementById('edit-location').value,
                interests: interests,
                profile_picture_url: userProfile.profile_picture_url
            }).eq('id', currentUser.id);

            closeEditProfile();
            await loadUserData();
            alert('Profile updated!');
        }

        function showSettings() {
            document.getElementById('setting-measurement').value = userProfile.measurement_system || 'metric';
            document.getElementById('setting-weight').value = userProfile.weight_unit || 'kg';
            document.getElementById('setting-length').value = userProfile.length_unit || 'cm';
            
            document.getElementById('settings-modal').classList.add('show');
            hideAllDropdowns();
        }

        function closeSettings() {
            document.getElementById('settings-modal').classList.remove('show');
        }

        async function handleUpdateSettings(event) {
            event.preventDefault();

            await supabase.from('profiles').update({
                measurement_system: document.getElementById('setting-measurement').value,
                weight_unit: document.getElementById('setting-weight').value,
                length_unit: document.getElementById('setting-length').value
            }).eq('id', currentUser.id);

            closeSettings();
            await loadUserData();
            alert('Settings saved!');
        }

        async function showUserProfile(userId) {
            const { data: profile } = await supabase.rpc('get_user_profile', { user_uuid: userId });
            
            if (!profile || profile.length === 0) return;
            
            const user = profile[0];
            const isOwnProfile = userId === currentUser.id;

            // Get user's projects
            const { data: userProjects } = await supabase
                .from('projects')
                .select('*')
                .eq('user_id', userId)
                .order('created_at', { ascending: false })
                .limit(6);

            // Get friend count
            const { data: friendCount } = await supabase.rpc('get_friends_count', { user_uuid: userId });

            // Check if we're friends
            const { data: friendship } = await supabase
                .from('friends')
                .select('user1_id')
                .or(`user1_id.eq.${userId},user2_id.eq.${userId}`)
                .or(`user1_id.eq.${currentUser.id},user2_id.eq.${currentUser.id}`)
                .limit(1)
                .single();

            const areFriends = friendship !== null;

            const content = `
                <div style="text-align: center;">
                    <div style="width: 120px; height: 120px; border-radius: 50%; background: var(--terracotta); margin: 0 auto 1rem; display: flex; align-items: center; justify-content: center; color: white; font-size: 3rem; font-weight: bold; overflow: hidden;">
                        ${user.profile_picture_url ? 
                            `<img src="${user.profile_picture_url}" style="width: 100%; height: 100%; object-fit: cover;">` : 
                            user.avatar_initials
                        }
                    </div>
                    <h2 style="margin-bottom: 0.5rem;">@${user.username}</h2>
                    <p style="color: var(--text-muted); margin-bottom: 0.5rem; font-size: 1.1rem;">${user.full_name}</p>
                    ${user.location ? `<p style="color: var(--text-muted); margin-bottom: 1rem;">üìç ${user.location}</p>` : ''}
                    ${user.bio ? `<p style="margin: 1.5rem 0; padding: 1rem; background: var(--cream); border-radius: 8px; font-style: italic;">"${user.bio}"</p>` : ''}
                    
                    ${user.interests && user.interests.length > 0 ? `
                        <div style="margin-bottom: 1.5rem;">
                            <h4 style="margin-bottom: 0.75rem; color: var(--dark-brown);">Interests</h4>
                            <div style="display: flex; flex-wrap: wrap; gap: 0.5rem; justify-content: center;">
                                ${user.interests.map(interest => `
                                    <span style="padding: 0.4rem 0.8rem; background: var(--light-beige); border-radius: 20px; font-size: 0.85rem;">${interest}</span>
                                `).join('')}
                            </div>
                        </div>
                    ` : ''}
                    
                    <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 1rem; margin: 2rem 0; padding: 1rem; background: var(--cream); border-radius: 8px;">
                        <div style="text-align: center;">
                            <div style="font-size: 1.5rem; font-weight: bold; color: var(--terracotta);">${user.projects_count}</div>
                            <div style="font-size: 0.8rem; color: var(--text-muted);">Projects</div>
                        </div>
                        <div style="text-align: center;">
                            <div style="font-size: 1.5rem; font-weight: bold; color: var(--terracotta);">${friendCount || 0}</div>
                            <div style="font-size: 0.8rem; color: var(--text-muted);">Friends</div>
                        </div>
                        <div style="text-align: center;">
                            <div style="font-size: 1.5rem; font-weight: bold; color: var(--terracotta);">${user.level}</div>
                            <div style="font-size: 0.8rem; color: var(--text-muted);">Level</div>
                        </div>
                        <div style="text-align: center;">
                            <div style="font-size: 1.5rem; font-weight: bold; color: var(--terracotta);">${user.total_likes_received}</div>
                            <div style="font-size: 0.8rem; color: var(--text-muted);">Likes</div>
                        </div>
                    </div>

                    ${userProjects && userProjects.length > 0 ? `
                        <div style="text-align: left; margin-top: 2rem;">
                            <h3 style="margin-bottom: 1rem; color: var(--dark-brown);">Recent Projects</h3>
                            <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 1rem;">
                                ${userProjects.map(project => `
                                    <div style="background: var(--light-beige); padding: 1rem; border-radius: 8px; cursor: pointer;" onclick="closeProfileView(); showProjectDetail('${project.id}');">
                                        <div style="font-size: 2rem; text-align: center; margin-bottom: 0.5rem;">${getCraftIcon(project.craft_type)}</div>
                                        <h4 style="font-size: 0.9rem; margin-bottom: 0.25rem; text-align: center;">${project.title}</h4>
                                        <div style="text-align: center; font-size: 0.75rem; color: var(--text-muted);">
                                            ‚ù§Ô∏è ${project.likes_count || 0} ¬∑ üí¨ ${project.comments_count || 0}
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    ` : `
                        <div style="padding: 2rem; background: var(--cream); border-radius: 8px; margin-top: 2rem;">
                            <p style="color: var(--text-muted);">No projects yet</p>
                        </div>
                    `}
                    
                    ${!isOwnProfile ? `
                        <div style="display: flex; gap: 1rem; margin-top: 2rem;">
                            <button class="btn btn-primary" style="flex: 1;" onclick="toggleFollow('${userId}'); setTimeout(() => showUserProfile('${userId}'), 500);" id="profile-follow-btn-${userId}">
                                Follow
                            </button>
                            ${areFriends ? `
                                <button class="btn btn-secondary" style="flex: 1;" onclick="closeProfileView(); openChat('${userId}', '${user.username}', '${user.profile_picture_url || ''}', '${user.avatar_initials}');">
                                    üí¨ Message
                                </button>
                            ` : ''}
                        </div>
                    ` : ''}
                </div>
            `;

            document.getElementById('profile-view-content').innerHTML = content;
            document.getElementById('profile-view-modal').classList.add('show');

            // Update follow button state
            if (!isOwnProfile) {
                checkFollowStatusForProfile(userId);
            }
        }

        async function checkFollowStatusForProfile(userId) {
            const { data } = await supabase
                .from('follows')
                .select('id')
                .eq('follower_id', currentUser.id)
                .eq('following_id', userId)
                .single();

            const btn = document.getElementById(`profile-follow-btn-${userId}`);
            if (btn) {
                btn.textContent = data ? 'Following' : 'Follow';
                btn.className = data ? 'btn btn-secondary' : 'btn btn-primary';
            }
        }

        function closeProfileView() {
            document.getElementById('profile-view-modal').classList.remove('show');
        }

        async function loadNotifications() {
            const { data: notifs } = await supabase
                .from('notifications')
                .select('*')
                .eq('user_id', currentUser.id)
                .order('created_at', { ascending: false})
                .limit(20);

            const unreadCount = notifs?.filter(n => !n.is_read).length || 0;
            const badge = document.getElementById('notif-count');
            if (unreadCount > 0) {
                badge.textContent = unreadCount;
                badge.style.display = 'flex';
            } else {
                badge.style.display = 'none';
            }

            const container = document.getElementById('notifications-list');
            
            if (!notifs || notifs.length === 0) {
                container.innerHTML = '<div class="dropdown-item">No notifications yet</div>';
                return;
            }

            container.innerHTML = notifs.map(notif => `
                <div class="dropdown-item ${!notif.is_read ? 'notif-unread' : ''}">
                    <div class="notif-content">${notif.content}</div>
                    <div class="notif-time">${getTimeAgo(notif.created_at)}</div>
                </div>
            `).join('');
        }

        async function markAllRead() {
            await supabase.rpc('mark_notifications_read', { user_uuid: currentUser.id });
            loadNotifications();
        }

        async function loadConversations() {
            // Get all friends first
            const { data: friendships } = await supabase
                .from('friends')
                .select('user1_id, user2_id')
                .or(`user1_id.eq.${currentUser.id},user2_id.eq.${currentUser.id}`);

            if (!friendships || friendships.length === 0) {
                document.getElementById('conversations-list').innerHTML = '<div class="dropdown-item">No friends to message yet</div>';
                document.getElementById('chat-area').innerHTML = `
                    <div class="card">
                        <div class="empty-state">
                            <div class="empty-state-icon">üí¨</div>
                            <p>No conversations yet!</p>
                            <p style="font-size: 0.9rem; margin-top: 0.5rem;">You can message friends (mutual follows)</p>
                        </div>
                    </div>
                `;
                return;
            }

            const friendIds = friendships.map(f => 
                f.user1_id === currentUser.id ? f.user2_id : f.user1_id
            );

            // Get messages with these friends
            const { data: messages } = await supabase
                .from('messages')
                .select('*, sender:profiles!messages_sender_id_fkey(username, avatar_initials, profile_picture_url), receiver:profiles!messages_receiver_id_fkey(username, avatar_initials, profile_picture_url)')
                .or(`sender_id.eq.${currentUser.id},receiver_id.eq.${currentUser.id}`)
                .order('created_at', { ascending: false });

            // Get unread count
            const unreadCount = messages?.filter(m => m.receiver_id === currentUser.id && !m.is_read).length || 0;
            const badge = document.getElementById('message-count');
            if (unreadCount > 0) {
                badge.textContent = unreadCount;
                badge.style.display = 'flex';
            } else {
                badge.style.display = 'none';
            }

            // Group messages by conversation
            const conversations = {};
            messages?.forEach(msg => {
                const otherId = msg.sender_id === currentUser.id ? msg.receiver_id : msg.sender_id;
                if (!conversations[otherId]) {
                    conversations[otherId] = {
                        lastMessage: msg,
                        unread: 0,
                        otherUser: msg.sender_id === currentUser.id ? msg.receiver : msg.sender
                    };
                }
                if (msg.receiver_id === currentUser.id && !msg.is_read) {
                    conversations[otherId].unread++;
                }
            });

            const conversationList = Object.keys(conversations);

            // Messages dropdown
            if (conversationList.length === 0) {
                document.getElementById('conversations-list').innerHTML = '<div class="dropdown-item">No messages yet</div>';
            } else {
                document.getElementById('conversations-list').innerHTML = conversationList.map(userId => {
                    const conv = conversations[userId];
                    return `
                        <div class="dropdown-item ${conv.unread > 0 ? 'notif-unread' : ''}" onclick="hideAllDropdowns(); openChat('${userId}', '${conv.otherUser.username}', '${conv.otherUser.profile_picture_url || ''}', '${conv.otherUser.avatar_initials}')">
                            <div style="display: flex; align-items: center; gap: 0.75rem;">
                                <div style="width: 40px; height: 40px; border-radius: 50%; background: var(--terracotta); display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; overflow: hidden;">
                                    ${conv.otherUser.profile_picture_url ? 
                                        `<img src="${conv.otherUser.profile_picture_url}" style="width: 100%; height: 100%; object-fit: cover;">` : 
                                        conv.otherUser.avatar_initials
                                    }
                                </div>
                                <div style="flex: 1;">
                                    <div style="font-weight: 600;">@${conv.otherUser.username}</div>
                                    <div class="notif-content" style="margin: 0;">${conv.lastMessage.content.substring(0, 50)}${conv.lastMessage.content.length > 50 ? '...' : ''}</div>
                                </div>
                                ${conv.unread > 0 ? `<div style="background: var(--love); color: white; border-radius: 50%; width: 24px; height: 24px; display: flex; align-items: center; justify-content: center; font-size: 0.75rem; font-weight: bold;">${conv.unread}</div>` : ''}
                            </div>
                        </div>
                    `;
                }).join('');
            }

            // Chat area - show conversation list
            if (conversationList.length === 0) {
                document.getElementById('chat-area').innerHTML = `
                    <div class="card">
                        <div class="empty-state">
                            <div class="empty-state-icon">üí¨</div>
                            <p>No conversations yet!</p>
                            <p style="font-size: 0.9rem; margin-top: 0.5rem;">Go to the Friends tab to start chatting</p>
                        </div>
                    </div>
                `;
            } else {
                document.getElementById('chat-area').innerHTML = `
                    <div class="card">
                        <h3 style="margin-bottom: 1.5rem;">Your Conversations</h3>
                        <div style="display: flex; flex-direction: column; gap: 1rem;">
                            ${conversationList.map(userId => {
                                const conv = conversations[userId];
                                return `
                                    <div class="card" style="cursor: pointer; background: ${conv.unread > 0 ? 'var(--cream)' : 'white'}; padding: 1.5rem;" onclick="openChat('${userId}', '${conv.otherUser.username}', '${conv.otherUser.profile_picture_url || ''}', '${conv.otherUser.avatar_initials}')">
                                        <div style="display: flex; align-items: center; gap: 1rem;">
                                            <div style="width: 56px; height: 56px; border-radius: 50%; background: var(--terracotta); display: flex; align-items: center; justify-content: center; color: white; font-size: 1.5rem; font-weight: bold; overflow: hidden;">
                                                ${conv.otherUser.profile_picture_url ? 
                                                    `<img src="${conv.otherUser.profile_picture_url}" style="width: 100%; height: 100%; object-fit: cover;">` : 
                                                    conv.otherUser.avatar_initials
                                                }
                                            </div>
                                            <div style="flex: 1;">
                                                <h4 style="margin-bottom: 0.25rem;">@${conv.otherUser.username}</h4>
                                                <p style="color: var(--text-muted); font-family: -apple-system, sans-serif; font-size: 0.9rem;">${conv.lastMessage.content.substring(0, 80)}${conv.lastMessage.content.length > 80 ? '...' : ''}</p>
                                                <p style="color: var(--text-muted); font-size: 0.75rem; margin-top: 0.25rem;">${getTimeAgo(conv.lastMessage.created_at)}</p>
                                            </div>
                                            ${conv.unread > 0 ? `
                                                <div style="background: var(--love); color: white; border-radius: 50%; width: 32px; height: 32px; display: flex; align-items: center; justify-content: center; font-weight: bold;">
                                                    ${conv.unread}
                                                </div>
                                            ` : ''}
                                        </div>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    </div>
                `;
            }
        }

        let currentChatUser = null;
        let chatRealtimeChannel = null;

        async function openChat(friendId, friendUsername, friendPicture, friendInitials) {
            currentChatUser = { id: friendId, username: friendUsername, picture: friendPicture, initials: friendInitials };
            
            // Switch to chat section
            showSection('chat');
            
            // Mark messages as read
            await supabase
                .from('messages')
                .update({ is_read: true })
                .eq('sender_id', friendId)
                .eq('receiver_id', currentUser.id)
                .eq('is_read', false);
            
            // Load messages
            await loadChatMessages(friendId);
            
            // Setup realtime for this conversation
            if (chatRealtimeChannel) {
                supabase.removeChannel(chatRealtimeChannel);
            }
            
            chatRealtimeChannel = supabase
                .channel(`chat-${friendId}`)
                .on('postgres_changes', {
                    event: 'INSERT',
                    schema: 'public',
                    table: 'messages',
                    filter: `sender_id=eq.${friendId}`
                }, () => {
                    loadChatMessages(friendId);
                })
                .subscribe();
            
            loadConversations();
        }

        async function loadChatMessages(friendId) {
            const { data: messages } = await supabase
                .from('messages')
                .select('*')
                .or(`and(sender_id.eq.${currentUser.id},receiver_id.eq.${friendId}),and(sender_id.eq.${friendId},receiver_id.eq.${currentUser.id})`)
                .order('created_at', { ascending: true });

            const chatArea = document.getElementById('chat-area');
            
            chatArea.innerHTML = `
                <div class="card" style="height: calc(100vh - 250px); display: flex; flex-direction: column;">
                    <!-- Chat Header -->
                    <div style="display: flex; align-items: center; gap: 1rem; padding-bottom: 1rem; border-bottom: 2px solid var(--light-beige); margin-bottom: 1rem;">
                        <div style="width: 48px; height: 48px; border-radius: 50%; background: var(--terracotta); display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; overflow: hidden; cursor: pointer;" onclick="showUserProfile('${currentChatUser.id}')">
                            ${currentChatUser.picture ? 
                                `<img src="${currentChatUser.picture}" style="width: 100%; height: 100%; object-fit: cover;">` : 
                                currentChatUser.initials
                            }
                        </div>
                        <div style="flex: 1;">
                            <h3 style="margin: 0; cursor: pointer;" onclick="showUserProfile('${currentChatUser.id}')">@${currentChatUser.username}</h3>
                        </div>
                        <button onclick="showSection('chat'); currentChatUser = null; loadConversations();" style="background: none; border: none; font-size: 1.5rem; cursor: pointer; color: var(--text-muted);">‚úï</button>
                    </div>
                    
                    <!-- Messages -->
                    <div id="chat-messages" style="flex: 1; overflow-y: auto; padding: 1rem 0; display: flex; flex-direction: column; gap: 1rem;">
                        ${messages.length === 0 ? `
                            <div style="text-align: center; color: var(--text-muted); padding: 2rem;">
                                <p>No messages yet. Start the conversation! üëã</p>
                            </div>
                        ` : messages.map(msg => {
                            const isSent = msg.sender_id === currentUser.id;
                            return `
                                <div style="display: flex; justify-content: ${isSent ? 'flex-end' : 'flex-start'};">
                                    <div style="max-width: 70%; padding: 0.75rem 1rem; border-radius: 16px; background: ${isSent ? 'var(--terracotta)' : 'var(--light-beige)'}; color: ${isSent ? 'white' : 'var(--text-dark)'};">
                                        <div style="font-family: -apple-system, sans-serif; word-wrap: break-word;">${msg.content}</div>
                                        <div style="font-size: 0.7rem; margin-top: 0.25rem; opacity: 0.7;">${getTimeAgo(msg.created_at)}</div>
                                    </div>
                                </div>
                            `;
                        }).join('')}
                    </div>
                    
                    <!-- Message Input -->
                    <form onsubmit="sendMessage(event, '${friendId}')" style="display: flex; gap: 0.75rem; padding-top: 1rem; border-top: 2px solid var(--light-beige);">
                        <input type="text" id="message-input" placeholder="Type a message..." style="flex: 1; border: 2px solid var(--light-beige); padding: 0.75rem 1rem; border-radius: 24px; font-family: -apple-system, sans-serif;" required>
                        <button type="submit" class="btn btn-primary" style="border-radius: 24px; padding: 0.75rem 2rem;">Send</button>
                    </form>
                </div>
            `;
            
            // Scroll to bottom
            setTimeout(() => {
                const messagesDiv = document.getElementById('chat-messages');
                if (messagesDiv) {
                    messagesDiv.scrollTop = messagesDiv.scrollHeight;
                }
            }, 100);
        }

        async function sendMessage(event, receiverId) {
            event.preventDefault();
            
            const input = document.getElementById('message-input');
            const content = input.value.trim();
            
            if (!content) return;
            
            await supabase.from('messages').insert({
                sender_id: currentUser.id,
                receiver_id: receiverId,
                content: content
            });
            
            input.value = '';
            await loadChatMessages(receiverId);
        }

        function startRealtimeUpdates() {
            supabase
                .channel('notifications')
                .on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'notifications', filter: `user_id=eq.${currentUser.id}` }, () => {
                    loadNotifications();
                })
                .subscribe();
            
            supabase
                .channel('messages-updates')
                .on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'messages', filter: `receiver_id=eq.${currentUser.id}` }, () => {
                    loadConversations();
                })
                .subscribe();
        }

        function toggleNotifications() {
            hideAllDropdowns();
            document.getElementById('notifications-dropdown').classList.toggle('show');
        }

        function toggleMessages() {
            hideAllDropdowns();
            document.getElementById('messages-dropdown').classList.toggle('show');
        }

        function toggleUserMenu() {
            hideAllDropdowns();
            document.getElementById('user-menu').classList.toggle('show');
        }

        function hideAllDropdowns() {
            document.querySelectorAll('.dropdown').forEach(d => d.classList.remove('show'));
        }

        function showSection(sectionId) {
            document.querySelectorAll('.content-section').forEach(s => s.classList.remove('active'));
            document.getElementById(sectionId).classList.add('active');
            document.querySelectorAll('.nav-item').forEach(item => item.classList.remove('active'));
            
            // Find and activate the nav item that corresponds to this section
            const navItems = document.querySelectorAll('.nav-item');
            navItems.forEach(item => {
                const onclickAttr = item.getAttribute('onclick');
                if (onclickAttr && onclickAttr.includes(`'${sectionId}'`)) {
                    item.classList.add('active');
                }
            });
            
            // Load section-specific data if needed
            if (sectionId === 'chat' && !currentChatUser) {
                loadConversations();
            }
        }

        async function handleLogout() {
            await supabase.auth.signOut();
            window.location.href = 'login.html';
        }

        function getCraftIcon(craftType) {
            const icons = { 'Sewing': 'üßµ', 'Knitting': 'üß∂', 'Crochet': 'ü™°', 'Weaving': 'üßµ', 'Other': 'üé®' };
            return icons[craftType] || 'üé®';
        }

        function formatMentions(text) {
            return text.replace(/@(\w+)/g, '<span class="mention">@$1</span>');
        }

        function getTimeAgo(timestamp) {
            const now = new Date();
            const past = new Date(timestamp);
            const diffMs = now - past;
            const diffMins = Math.floor(diffMs / 60000);
            const diffHours = Math.floor(diffMs / 3600000);
            const diffDays = Math.floor(diffMs / 86400000);

            if (diffMins < 1) return 'Just now';
            if (diffMins < 60) return `${diffMins}m ago`;
            if (diffHours < 24) return `${diffHours}h ago`;
            return `${diffDays}d ago`;
        }

        document.addEventListener('click', function(event) {
            if (!event.target.closest('.icon-btn') && !event.target.closest('.user-profile') && !event.target.closest('.dropdown')) {
                hideAllDropdowns();
            }
        });

        checkAuth();
    </script>
</body>
</html>