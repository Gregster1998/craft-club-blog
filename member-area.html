<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Craft Club | Your Creative Space</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --terracotta: #A0695F;
            --dark-brown: #3C2F2F;
            --cream: #F5F1E8;
            --light-beige: #EDE8DC;
            --text-dark: #3C2F2F;
            --text-muted: #8B7E74;
            --gold: #D4AF37;
            --success: #5C8B5A;
            --highlight: #E8C5B5;
            --love: #E74C3C;
        }

        body {
            font-family: 'Georgia', serif;
            color: var(--text-dark);
            line-height: 1.6;
            background: var(--cream);
        }

        /* Header */
        header {
            position: fixed;
            top: 0;
            width: 100%;
            z-index: 1000;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            padding: 1rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid rgba(0,0,0,0.05);
        }

        .logo {
            font-size: 1.125rem;
            font-weight: 400;
            letter-spacing: 0.02em;
            color: var(--dark-brown);
        }

        .user-nav {
            display: flex;
            align-items: center;
            gap: 1.5rem;
        }

        .icon-btn {
            position: relative;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: var(--cream);
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.25rem;
            transition: all 0.3s;
        }

        .icon-btn:hover {
            background: var(--highlight);
            transform: scale(1.1);
        }

        .badge-count {
            position: absolute;
            top: -5px;
            right: -5px;
            background: var(--love);
            color: white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            font-size: 0.7rem;
            display: flex;
            align-items: center;
            justify-content: center;
            font-family: -apple-system, sans-serif;
            font-weight: bold;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }

        .avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: var(--terracotta);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
        }

        .user-profile {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            cursor: pointer;
            position: relative;
        }

        /* Dropdowns */
        .dropdown {
            position: absolute;
            top: 100%;
            right: 0;
            margin-top: 0.5rem;
            background: white;
            border-radius: 12px;
            box-shadow: 0 8px 24px rgba(0,0,0,0.15);
            min-width: 320px;
            max-width: 400px;
            max-height: 500px;
            overflow-y: auto;
            display: none;
            z-index: 1001;
        }

        .dropdown.show { display: block; }

        .dropdown-header {
            padding: 1.25rem;
            border-bottom: 2px solid var(--light-beige);
            font-family: -apple-system, sans-serif;
            font-weight: 600;
            font-size: 1.1rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .dropdown-item {
            padding: 1rem 1.25rem;
            border-bottom: 1px solid var(--light-beige);
            cursor: pointer;
            transition: background 0.3s;
        }

        .dropdown-item:hover {
            background: var(--cream);
        }

        .dropdown-item:last-child {
            border-bottom: none;
        }

        .notif-content {
            font-size: 0.9rem;
            font-family: -apple-system, sans-serif;
            margin-bottom: 0.25rem;
        }

        .notif-time {
            font-size: 0.75rem;
            color: var(--text-muted);
        }

        .notif-unread {
            background: #E8F5E9;
        }

        /* Layout */
        .main-container {
            margin-top: 80px;
            display: flex;
            min-height: calc(100vh - 80px);
        }

        .sidebar {
            width: 280px;
            background: white;
            padding: 2rem 1.5rem;
            border-right: 1px solid rgba(0,0,0,0.05);
            position: fixed;
            height: calc(100vh - 80px);
            overflow-y: auto;
        }

        .nav-item {
            padding: 0.75rem 1rem;
            color: var(--text-dark);
            text-decoration: none;
            border-radius: 8px;
            transition: all 0.3s;
            font-family: -apple-system, sans-serif;
            font-size: 0.95rem;
            display: flex;
            align-items: center;
            gap: 0.75rem;
            cursor: pointer;
            margin-bottom: 0.5rem;
        }

        .nav-item:hover, .nav-item.active {
            background: var(--light-beige);
            color: var(--terracotta);
        }

        .content {
            margin-left: 280px;
            flex: 1;
            padding: 2rem 3rem;
        }

        .content-section {
            display: none;
        }

        .content-section.active {
            display: block;
        }

        /* Cards */
        .card {
            background: white;
            padding: 2rem;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
            margin-bottom: 2rem;
        }

        .card h3 {
            margin-bottom: 1.5rem;
            color: var(--dark-brown);
            font-size: 1.25rem;
        }

        /* Dashboard Grid */
        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 2rem;
            margin-bottom: 2rem;
        }

        /* Inspiration Quote */
        .inspiration-quote {
            background: linear-gradient(135deg, var(--terracotta), var(--dark-brown));
            color: white;
            padding: 2rem;
            border-radius: 12px;
            text-align: center;
            font-style: italic;
            font-size: 1.1rem;
            line-height: 1.8;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        /* Quick Stats */
        .quick-stats {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 1rem;
        }

        .stat-box {
            text-align: center;
            padding: 1.5rem 1rem;
            background: var(--cream);
            border-radius: 8px;
            transition: transform 0.3s;
        }

        .stat-box:hover {
            transform: translateY(-4px);
        }

        .stat-icon {
            font-size: 2rem;
            margin-bottom: 0.5rem;
        }

        .stat-value {
            font-size: 1.75rem;
            font-weight: bold;
            color: var(--terracotta);
        }

        .stat-label {
            font-size: 0.85rem;
            color: var(--text-muted);
            font-family: -apple-system, sans-serif;
        }

        /* Goals/Todos */
        .goal-item {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.75rem;
            border-radius: 8px;
            margin-bottom: 0.5rem;
            background: var(--cream);
            cursor: pointer;
            transition: all 0.3s;
        }

        .goal-item:hover {
            background: var(--highlight);
        }

        .goal-item.completed {
            opacity: 0.6;
            text-decoration: line-through;
        }

        .goal-checkbox {
            width: 20px;
            height: 20px;
            border: 2px solid var(--terracotta);
            border-radius: 4px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        .goal-checkbox.checked {
            background: var(--terracotta);
            color: white;
        }

        /* Activity Feed */
        .activity-item {
            display: flex;
            gap: 1rem;
            padding: 1rem 0;
            border-bottom: 1px solid var(--light-beige);
        }

        .activity-avatar {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            background: var(--terracotta);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            flex-shrink: 0;
        }

        .activity-content {
            flex: 1;
        }

        .activity-text {
            font-family: -apple-system, sans-serif;
            font-size: 0.95rem;
            margin-bottom: 0.5rem;
        }

        .activity-time {
            font-size: 0.8rem;
            color: var(--text-muted);
        }

        /* Project Cards */
        .project-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 1.5rem;
        }

        .project-card {
            background: white;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
            cursor: pointer;
            transition: all 0.3s;
            position: relative;
        }

        .project-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 6px 20px rgba(0,0,0,0.1);
        }

        .project-image {
            width: 100%;
            height: 200px;
            background: linear-gradient(135deg, var(--light-beige), var(--highlight));
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 3rem;
            position: relative;
        }

        .like-btn {
            position: absolute;
            bottom: 10px;
            right: 10px;
            width: 48px;
            height: 48px;
            border-radius: 50%;
            background: white;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            transition: all 0.3s;
            z-index: 10;
        }

        .like-btn:hover {
            transform: scale(1.1);
        }

        .like-btn.liked {
            animation: heartBeat 0.5s;
        }

        @keyframes heartBeat {
            0%, 100% { transform: scale(1); }
            25% { transform: scale(1.3); }
            50% { transform: scale(1.1); }
        }

        .project-info {
            padding: 1.25rem;
        }

        .project-title {
            font-size: 1.1rem;
            margin-bottom: 0.5rem;
            color: var(--dark-brown);
        }

        .project-meta {
            display: flex;
            gap: 1rem;
            font-size: 0.85rem;
            color: var(--text-muted);
            font-family: -apple-system, sans-serif;
        }

        /* Messages */
        .messages-list {
            list-style: none;
        }

        .message-item {
            padding: 1rem;
            border-bottom: 1px solid var(--light-beige);
            cursor: pointer;
            transition: background 0.3s;
            display: flex;
            gap: 1rem;
            align-items: center;
        }

        .message-item:hover {
            background: var(--cream);
        }

        .message-item.unread {
            background: #E8F5E9;
            font-weight: 600;
        }

        .chat-container {
            display: flex;
            flex-direction: column;
            height: 600px;
            background: white;
            border-radius: 12px;
            overflow: hidden;
        }

        .chat-header {
            padding: 1rem 1.5rem;
            background: var(--terracotta);
            color: white;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .chat-messages {
            flex: 1;
            padding: 1.5rem;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .chat-message {
            display: flex;
            gap: 0.75rem;
            max-width: 70%;
        }

        .chat-message.sent {
            align-self: flex-end;
            flex-direction: row-reverse;
        }

        .chat-bubble {
            padding: 0.75rem 1rem;
            border-radius: 16px;
            font-family: -apple-system, sans-serif;
            font-size: 0.95rem;
        }

        .chat-message.received .chat-bubble {
            background: var(--light-beige);
        }

        .chat-message.sent .chat-bubble {
            background: var(--terracotta);
            color: white;
        }

        .chat-input-area {
            padding: 1rem 1.5rem;
            background: var(--cream);
            display: flex;
            gap: 1rem;
        }

        .chat-input-area input {
            flex: 1;
            padding: 0.75rem 1rem;
            border: 2px solid var(--light-beige);
            border-radius: 24px;
            font-family: -apple-system, sans-serif;
            font-size: 0.95rem;
        }

        .chat-input-area button {
            padding: 0.75rem 1.5rem;
            background: var(--terracotta);
            color: white;
            border: none;
            border-radius: 24px;
            cursor: pointer;
            font-family: -apple-system, sans-serif;
            font-weight: 600;
        }

        /* Trending Widget */
        .trending-item {
            display: flex;
            gap: 1rem;
            padding: 1rem 0;
            border-bottom: 1px solid var(--light-beige);
            cursor: pointer;
            transition: all 0.3s;
        }

        .trending-item:hover {
            background: var(--cream);
            padding-left: 0.5rem;
            padding-right: 0.5rem;
        }

        .trending-rank {
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            background: var(--terracotta);
            color: white;
            font-weight: bold;
            font-family: -apple-system, sans-serif;
            flex-shrink: 0;
        }

        .trending-info {
            flex: 1;
        }

        .trending-title {
            font-weight: 600;
            margin-bottom: 0.25rem;
        }

        .trending-author {
            font-size: 0.85rem;
            color: var(--text-muted);
        }

        /* Buttons */
        .btn {
            padding: 0.75rem 2rem;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-family: -apple-system, sans-serif;
            font-size: 0.95rem;
            transition: all 0.3s;
            display: inline-block;
            text-align: center;
        }

        .btn-primary {
            background: var(--terracotta);
            color: white;
        }

        .btn-primary:hover {
            background: var(--dark-brown);
            transform: translateY(-2px);
        }

        .btn-small {
            padding: 0.5rem 1rem;
            font-size: 0.85rem;
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 3rem 2rem;
            color: var(--text-muted);
        }

        .empty-state-icon {
            font-size: 4rem;
            margin-bottom: 1rem;
            opacity: 0.5;
        }

        /* Forms */
        .form-group {
            margin-bottom: 1.5rem;
        }

        label {
            display: block;
            font-family: -apple-system, sans-serif;
            font-size: 0.9rem;
            color: var(--dark-brown);
            margin-bottom: 0.5rem;
            font-weight: 500;
        }

        input, textarea, select {
            width: 100%;
            padding: 0.875rem 1rem;
            border: 2px solid var(--light-beige);
            border-radius: 8px;
            font-family: -apple-system, sans-serif;
            font-size: 1rem;
            transition: all 0.3s;
        }

        input:focus, textarea:focus, select:focus {
            outline: none;
            border-color: var(--terracotta);
        }

        textarea {
            min-height: 120px;
            resize: vertical;
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 2000;
            justify-content: center;
            align-items: center;
            padding: 2rem;
        }

        .modal.show { display: flex; }

        .modal-content {
            background: white;
            border-radius: 16px;
            max-width: 600px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            padding: 2rem;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
            padding-bottom: 1rem;
            border-bottom: 2px solid var(--light-beige);
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 2rem;
            cursor: pointer;
            color: var(--text-muted);
        }

        /* Loading */
        .loading {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 3rem;
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid var(--light-beige);
            border-top-color: var(--terracotta);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Responsive */
        @media (max-width: 768px) {
            .sidebar {
                position: static;
                width: 100%;
                height: auto;
            }

            .content {
                margin-left: 0;
                padding: 1.5rem;
            }

            .dashboard-grid, .project-grid {
                grid-template-columns: 1fr;
            }

            .dropdown {
                right: -100px;
            }
        }
    </style>
</head>
<body>
    <header>
        <div class="logo">üé® Craft Club</div>
        <div class="user-nav">
            <button class="icon-btn" onclick="toggleNotifications()">
                üîî
                <span class="badge-count" id="notif-count" style="display: none;">0</span>
            </button>
            <button class="icon-btn" onclick="toggleMessages()">
                üí¨
                <span class="badge-count" id="message-count" style="display: none;">0</span>
            </button>
            <div class="user-profile" onclick="toggleUserMenu()">
                <div class="avatar" id="header-avatar">...</div>
            </div>

            <!-- Notifications Dropdown -->
            <div class="dropdown" id="notifications-dropdown">
                <div class="dropdown-header">
                    Notifications
                    <button onclick="markAllRead()" style="background: none; border: none; color: var(--terracotta); cursor: pointer; font-size: 0.85rem;">Mark all read</button>
                </div>
                <div id="notifications-list">
                    <div class="loading"><div class="spinner"></div></div>
                </div>
            </div>

            <!-- Messages Dropdown -->
            <div class="dropdown" id="messages-dropdown">
                <div class="dropdown-header">Messages</div>
                <ul class="messages-list" id="conversations-list">
                    <li class="loading"><div class="spinner"></div></li>
                </ul>
            </div>

            <!-- User Menu -->
            <div class="dropdown" id="user-menu" style="min-width: 200px;">
                <div class="dropdown-item" onclick="showSection('dashboard')">üë§ Dashboard</div>
                <div class="dropdown-item" onclick="handleLogout()">üö™ Logout</div>
            </div>
        </div>
    </header>

    <div class="main-container">
        <aside class="sidebar">
            <nav>
                <a class="nav-item active" onclick="showSection('dashboard')">üè† Dashboard</a>
                <a class="nav-item" onclick="showSection('my-projects')">üé® My Projects</a>
                <a class="nav-item" onclick="showSection('community')">üåä Community</a>
                <a class="nav-item" onclick="showSection('friends')">üí´ Friends</a>
                <a class="nav-item" onclick="showSection('members')">üîç Find Makers</a>
                <a class="nav-item" onclick="showSection('chat')">üí¨ Messages</a>
            </nav>
        </aside>

        <main class="content">
            <!-- Dashboard -->
            <section id="dashboard" class="content-section active">
                <h1 style="margin-bottom: 2rem;" id="welcome-text">Welcome! üëã</h1>

                <!-- Inspiration Quote -->
                <div class="inspiration-quote" id="daily-inspiration">
                    "‚ú® Loading your daily inspiration..."
                </div>

                <!-- Dashboard Grid -->
                <div class="dashboard-grid">
                    <!-- Quick Stats -->
                    <div class="card">
                        <h3>üìä Your Stats</h3>
                        <div class="quick-stats">
                            <div class="stat-box">
                                <div class="stat-icon">üé®</div>
                                <div class="stat-value" id="stat-projects">0</div>
                                <div class="stat-label">Projects</div>
                            </div>
                            <div class="stat-box">
                                <div class="stat-icon">‚ù§Ô∏è</div>
                                <div class="stat-value" id="stat-likes">0</div>
                                <div class="stat-label">Likes</div>
                            </div>
                            <div class="stat-box">
                                <div class="stat-icon">üë•</div>
                                <div class="stat-value" id="stat-friends">0</div>
                                <div class="stat-label">Friends</div>
                            </div>
                            <div class="stat-box">
                                <div class="stat-icon">üî•</div>
                                <div class="stat-value" id="stat-streak">0</div>
                                <div class="stat-label">Day Streak</div>
                            </div>
                        </div>
                    </div>

                    <!-- Crafting Goals -->
                    <div class="card">
                        <h3>üéØ Today's Goals</h3>
                        <div id="goals-list"></div>
                        <input type="text" id="new-goal" placeholder="Add a new goal..." style="margin-top: 1rem;" onkeypress="if(event.key==='Enter') addGoal()">
                    </div>
                </div>

                <!-- Friend Activity -->
                <div class="card">
                    <h3>üí´ Friend Activity</h3>
                    <div id="friend-activity"></div>
                </div>

                <!-- Trending Projects -->
                <div class="card">
                    <h3>üî• Trending This Week</h3>
                    <div id="trending-projects"></div>
                </div>
            </section>

            <!-- My Projects -->
            <section id="my-projects" class="content-section">
                <div style="display: flex; justify-content: space-between; margin-bottom: 2rem;">
                    <h1>üé® My Projects</h1>
                    <button class="btn btn-primary" onclick="showAddProject()">+ New Project</button>
                </div>
                <div id="my-projects-container"><div class="loading"><div class="spinner"></div></div></div>
            </section>

            <!-- Community -->
            <section id="community" class="content-section">
                <h1 style="margin-bottom: 2rem;">üåä Community Feed</h1>
                <div id="community-feed"><div class="loading"><div class="spinner"></div></div></div>
            </section>

            <!-- Friends -->
            <section id="friends" class="content-section">
                <h1 style="margin-bottom: 2rem;">üí´ Your Friends</h1>
                <p style="color: var(--text-muted); margin-bottom: 2rem; font-family: -apple-system, sans-serif;">
                    Friends are people who follow each other! Send them messages and stay connected.
                </p>
                <div id="friends-container"><div class="loading"><div class="spinner"></div></div></div>
            </section>

            <!-- Find Members -->
            <section id="members" class="content-section">
                <h1 style="margin-bottom: 2rem;">üîç Find Makers</h1>
                <input type="text" id="member-search" placeholder="Search by name..." style="margin-bottom: 2rem;" oninput="searchMembers()">
                <div id="members-container"><div class="loading"><div class="spinner"></div></div></div>
            </section>

            <!-- Chat -->
            <section id="chat" class="content-section">
                <h1 style="margin-bottom: 2rem;">üí¨ Messages</h1>
                <p style="color: var(--text-muted); margin-bottom: 2rem; font-family: -apple-system, sans-serif;">
                    Chat with your friends (mutual follows)
                </p>
                <div id="chat-area"></div>
            </section>
        </main>
    </div>

    <!-- Add Project Modal -->
    <div class="modal" id="add-project-modal">
        <div class="modal-content" style="max-width: 700px;">
            <div class="modal-header">
                <h2>Add New Project</h2>
                <button class="modal-close" onclick="closeAddProject()">&times;</button>
            </div>
            <form onsubmit="handleAddProject(event)">
                <div class="form-group">
                    <label>Title *</label>
                    <input type="text" id="project-title" required>
                </div>
                <div class="form-group">
                    <label>Description</label>
                    <textarea id="project-description"></textarea>
                </div>
                <div class="form-group">
                    <label>Craft Type *</label>
                    <select id="project-craft-type" required onchange="showCraftFields()">
                        <option value="">Select...</option>
                        <option value="Sewing">Sewing</option>
                        <option value="Knitting">Knitting</option>
                        <option value="Crochet">Crochet</option>
                        <option value="Embroidery">Embroidery</option>
                        <option value="Weaving">Weaving</option>
                        <option value="Quilting">Quilting</option>
                        <option value="Leather Work">Leather Work</option>
                        <option value="Other">Other</option>
                    </select>
                </div>

                <!-- Crochet Fields -->
                <div id="crochet-fields" class="craft-specific-fields" style="display: none;">
                    <h3 style="margin: 1.5rem 0 1rem; color: var(--terracotta); font-size: 1.1rem;">üß∂ Crochet Details</h3>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                        <div class="form-group">
                            <label>Hook Size</label>
                            <input type="text" id="crochet-hook-size" placeholder="e.g., 5mm, H/8">
                        </div>
                        <div class="form-group">
                            <label>Yarn Weight</label>
                            <input type="text" id="crochet-yarn-weight" placeholder="e.g., Worsted (4)">
                        </div>
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                        <div class="form-group">
                            <label>Yarn Brand</label>
                            <input type="text" id="crochet-yarn-brand" placeholder="e.g., Lion Brand">
                        </div>
                        <div class="form-group">
                            <label>Yarn Color</label>
                            <input type="text" id="crochet-yarn-color" placeholder="e.g., Terracotta">
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Yardage Needed</label>
                        <input type="text" id="crochet-yardage" placeholder="e.g., 300 yards">
                    </div>
                    <div class="form-group">
                        <label>Gauge</label>
                        <input type="text" id="crochet-gauge" placeholder="e.g., 16 sts x 20 rows = 4 inches">
                    </div>
                    <div class="form-group">
                        <label>üîó Where to Buy Yarn</label>
                        <input type="url" id="crochet-yarn-link" placeholder="https://...">
                    </div>
                    <div class="form-group">
                        <label>üîó Pattern Link (Optional)</label>
                        <input type="url" id="crochet-pattern-link" placeholder="https://...">
                    </div>
                </div>

                <!-- Knitting Fields -->
                <div id="knitting-fields" class="craft-specific-fields" style="display: none;">
                    <h3 style="margin: 1.5rem 0 1rem; color: var(--terracotta); font-size: 1.1rem;">üß∂ Knitting Details</h3>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                        <div class="form-group">
                            <label>Needle Size</label>
                            <input type="text" id="knitting-needle-size" placeholder="e.g., US 8, 5mm">
                        </div>
                        <div class="form-group">
                            <label>Needle Type</label>
                            <input type="text" id="knitting-needle-type" placeholder="e.g., Circular, DPN">
                        </div>
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                        <div class="form-group">
                            <label>Yarn Weight</label>
                            <input type="text" id="knitting-yarn-weight" placeholder="e.g., DK (3)">
                        </div>
                        <div class="form-group">
                            <label>Yarn Brand</label>
                            <input type="text" id="knitting-yarn-brand" placeholder="e.g., Malabrigo">
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Yardage Needed</label>
                        <input type="text" id="knitting-yardage" placeholder="e.g., 400 yards">
                    </div>
                    <div class="form-group">
                        <label>üîó Where to Buy Yarn</label>
                        <input type="url" id="knitting-yarn-link" placeholder="https://...">
                    </div>
                </div>

                <!-- Sewing Fields -->
                <div id="sewing-fields" class="craft-specific-fields" style="display: none;">
                    <h3 style="margin: 1.5rem 0 1rem; color: var(--terracotta); font-size: 1.1rem;">üßµ Sewing Details</h3>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                        <div class="form-group">
                            <label>Needle Type</label>
                            <input type="text" id="sewing-needle-type" placeholder="e.g., Universal 80/12">
                        </div>
                        <div class="form-group">
                            <label>Fabric Type</label>
                            <input type="text" id="sewing-fabric-type" placeholder="e.g., Cotton, Linen">
                        </div>
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                        <div class="form-group">
                            <label>Fabric Amount</label>
                            <input type="text" id="sewing-fabric-amount" placeholder="e.g., 2 yards">
                        </div>
                        <div class="form-group">
                            <label>Fabric Brand</label>
                            <input type="text" id="sewing-fabric-brand" placeholder="e.g., Riley Blake">
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Notions Needed</label>
                        <input type="text" id="sewing-notions" placeholder="e.g., Buttons, zipper, interfacing">
                    </div>
                    <div class="form-group">
                        <label>Pattern Size</label>
                        <input type="text" id="sewing-pattern-size" placeholder="e.g., Medium, 10">
                    </div>
                    <div class="form-group">
                        <label>üîó Where to Buy Fabric</label>
                        <input type="url" id="sewing-fabric-link" placeholder="https://...">
                    </div>
                    <div class="form-group">
                        <label>üîó Pattern Link (Optional)</label>
                        <input type="url" id="sewing-pattern-link" placeholder="https://...">
                    </div>
                </div>

                <!-- Embroidery Fields -->
                <div id="embroidery-fields" class="craft-specific-fields" style="display: none;">
                    <h3 style="margin: 1.5rem 0 1rem; color: var(--terracotta); font-size: 1.1rem;">ü™° Embroidery Details</h3>
                    <div class="form-group">
                        <label>Thread Type</label>
                        <input type="text" id="embroidery-thread-type" placeholder="e.g., DMC Floss">
                    </div>
                    <div class="form-group">
                        <label>Thread Colors</label>
                        <input type="text" id="embroidery-thread-colors" placeholder="e.g., 310, 666, 972">
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                        <div class="form-group">
                            <label>Fabric Type</label>
                            <input type="text" id="embroidery-fabric-type" placeholder="e.g., Aida 14 count">
                        </div>
                        <div class="form-group">
                            <label>Hoop Size</label>
                            <input type="text" id="embroidery-hoop-size" placeholder="e.g., 6 inches">
                        </div>
                    </div>
                    <div class="form-group">
                        <label>üîó Supplies Link</label>
                        <input type="url" id="embroidery-supplies-link" placeholder="https://...">
                    </div>
                </div>

                <!-- Weaving Fields -->
                <div id="weaving-fields" class="craft-specific-fields" style="display: none;">
                    <h3 style="margin: 1.5rem 0 1rem; color: var(--terracotta); font-size: 1.1rem;">üßµ Weaving Details</h3>
                    <div class="form-group">
                        <label>Loom Type</label>
                        <input type="text" id="weaving-loom-type" placeholder="e.g., Rigid heddle">
                    </div>
                    <div class="form-group">
                        <label>Yarn/Fiber Type</label>
                        <input type="text" id="weaving-yarn-type" placeholder="e.g., Cotton warp, wool weft">
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 1rem;">
                        <div class="form-group">
                            <label>Reed Size</label>
                            <input type="text" id="weaving-reed-size" placeholder="e.g., 12 dent">
                        </div>
                        <div class="form-group">
                            <label>Width</label>
                            <input type="text" id="weaving-width" placeholder="e.g., 10 inches">
                        </div>
                        <div class="form-group">
                            <label>Length</label>
                            <input type="text" id="weaving-length" placeholder="e.g., 2 yards">
                        </div>
                    </div>
                    <div class="form-group">
                        <label>üîó Supplies Link</label>
                        <input type="url" id="weaving-supplies-link" placeholder="https://...">
                    </div>
                </div>

                <!-- Quilting Fields -->
                <div id="quilting-fields" class="craft-specific-fields" style="display: none;">
                    <h3 style="margin: 1.5rem 0 1rem; color: var(--terracotta); font-size: 1.1rem;">üßµ Quilting Details</h3>
                    <div class="form-group">
                        <label>Quilt Size</label>
                        <input type="text" id="quilting-quilt-size" placeholder="e.g., Throw (60x72)">
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                        <div class="form-group">
                            <label>Fabric Collection</label>
                            <input type="text" id="quilting-fabric-collection" placeholder="e.g., Modern Solids">
                        </div>
                        <div class="form-group">
                            <label>Batting Type</label>
                            <input type="text" id="quilting-batting-type" placeholder="e.g., Cotton 80/20">
                        </div>
                    </div>
                    <div class="form-group">
                        <label>üîó Fabric Link</label>
                        <input type="url" id="quilting-fabric-link" placeholder="https://...">
                    </div>
                </div>

                <!-- Leather Work Fields -->
                <div id="leather-fields" class="craft-specific-fields" style="display: none;">
                    <h3 style="margin: 1.5rem 0 1rem; color: var(--terracotta); font-size: 1.1rem;">üëú Leather Work Details</h3>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                        <div class="form-group">
                            <label>Leather Type</label>
                            <input type="text" id="leather-leather-type" placeholder="e.g., Vegetable tanned">
                        </div>
                        <div class="form-group">
                            <label>Leather Weight</label>
                            <input type="text" id="leather-leather-weight" placeholder="e.g., 5-6 oz">
                        </div>
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                        <div class="form-group">
                            <label>Thread Type</label>
                            <input type="text" id="leather-thread-type" placeholder="e.g., Waxed polyester">
                        </div>
                        <div class="form-group">
                            <label>Needle Size</label>
                            <input type="text" id="leather-needle-size" placeholder="e.g., Size 2">
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Hardware</label>
                        <input type="text" id="leather-hardware" placeholder="e.g., Brass rivets, D-rings">
                    </div>
                    <div class="form-group">
                        <label>üîó Supplies Link</label>
                        <input type="url" id="leather-supplies-link" placeholder="https://...">
                    </div>
                </div>

                <button type="submit" class="btn btn-primary" style="width: 100%; margin-top: 1.5rem;">Create Project</button>
            </form>
        </div>
    </div>

    <!-- Send Kudos Modal -->
    <div class="modal" id="kudos-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Send Kudos! üéâ</h2>
                <button class="modal-close" onclick="closeKudos()">&times;</button>
            </div>
            <div style="text-align: center; margin-bottom: 2rem;">
                <div style="font-size: 4rem; margin-bottom: 1rem;">
                    <span onclick="selectEmoji('üëã')" style="cursor: pointer;">üëã</span>
                    <span onclick="selectEmoji('üéâ')" style="cursor: pointer;">üéâ</span>
                    <span onclick="selectEmoji('‚≠ê')" style="cursor: pointer;">‚≠ê</span>
                    <span onclick="selectEmoji('üí™')" style="cursor: pointer;">üí™</span>
                    <span onclick="selectEmoji('üî•')" style="cursor: pointer;">üî•</span>
                </div>
            </div>
            <div class="form-group">
                <label>Add a message (optional)</label>
                <textarea id="kudos-message" placeholder="Great work on your project!"></textarea>
            </div>
            <button class="btn btn-primary" style="width: 100%;" onclick="sendKudos()">Send Kudos!</button>
        </div>
    </div>

    <script>
const SUPABASE_URL = 'https://yzuoujjzupbbekmmymqn.supabase.co';

¬† ¬† ¬† ¬† const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inl6dW91amp6dXBiYmVrbW15bXFuIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjUwMjYwOTgsImV4cCI6MjA4MDYwMjA5OH0.Ri9ibTKIin_oA0vsHthU_zbnuNnnKQsXkmF5Es8UJWc';

¬† ¬† ¬† ¬† const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        let currentUser = null;
        let userProfile = null;
        let selectedKudosUser = null;
        let selectedKudosEmoji = 'üëã';
        let allMembers = [];

        async function checkAuth() {
            const { data: { session } } = await supabase.auth.getSession();
            if (!session) {
                window.location.href = 'login.html';
                return;
            }
            currentUser = session.user;
            await loadUserData();
        }

        async function loadUserData() {
            const { data: profile } = await supabase
                .from('profiles')
                .select('*')
                .eq('id', currentUser.id)
                .single();

            userProfile = profile;
            document.getElementById('header-avatar').textContent = profile.avatar_initials;
            document.getElementById('welcome-text').textContent = `Welcome back, ${profile.full_name.split(' ')[0]}! üëã`;

            await loadAllData();
            startRealtimeUpdates();
        }

        async function loadAllData() {
            await Promise.all([
                loadDailyInspiration(),
                loadQuickStats(),
                loadGoals(),
                loadFriendActivity(),
                loadTrendingProjects(),
                loadMyProjects(),
                loadCommunityFeed(),
                loadFriends(),
                loadMembers(),
                loadNotifications(),
                loadConversations()
            ]);
        }

        async function loadDailyInspiration() {
            const { data } = await supabase.rpc('get_daily_inspiration');
            if (data) {
                document.getElementById('daily-inspiration').textContent = `‚ú® ${data}`;
            }
        }

        async function loadQuickStats() {
            const { data: friendsCount } = await supabase.rpc('get_friends_count', { user_uuid: currentUser.id });
            
            document.getElementById('stat-projects').textContent = userProfile.projects_count || 0;
            document.getElementById('stat-likes').textContent = userProfile.total_likes_received || 0;
            document.getElementById('stat-friends').textContent = friendsCount || 0;
            document.getElementById('stat-streak').textContent = userProfile.streak_days || 0;
        }

        async function loadGoals() {
            const { data: goals } = await supabase
                .from('crafting_goals')
                .select('*')
                .eq('user_id', currentUser.id)
                .order('created_at', { ascending: false })
                .limit(5);

            const container = document.getElementById('goals-list');
            
            if (!goals || goals.length === 0) {
                container.innerHTML = '<p style="color: var(--text-muted); font-family: -apple-system, sans-serif;">No goals yet. Add one above!</p>';
                return;
            }

            container.innerHTML = goals.map(goal => `
                <div class="goal-item ${goal.is_completed ? 'completed' : ''}" onclick="toggleGoal('${goal.id}', ${goal.is_completed})">
                    <div class="goal-checkbox ${goal.is_completed ? 'checked' : ''}">
                        ${goal.is_completed ? '‚úì' : ''}
                    </div>
                    <span style="font-family: -apple-system, sans-serif;">${goal.goal_text}</span>
                </div>
            `).join('');
        }

        async function addGoal() {
            const input = document.getElementById('new-goal');
            const text = input.value.trim();
            if (!text) return;

            await supabase.from('crafting_goals').insert({
                user_id: currentUser.id,
                goal_text: text
            });

            input.value = '';
            loadGoals();
        }

        async function toggleGoal(goalId, currentStatus) {
            await supabase.from('crafting_goals').update({
                is_completed: !currentStatus,
                completed_at: !currentStatus ? new Date().toISOString() : null
            }).eq('id', goalId);

            loadGoals();
        }

        async function loadFriendActivity() {
            const { data } = await supabase.rpc('get_friend_activity', { user_uuid: currentUser.id, limit_count: 10 });
            
            const container = document.getElementById('friend-activity');
            
            if (!data || data.length === 0) {
                container.innerHTML = '<div class="empty-state"><div class="empty-state-icon">üí´</div><p>No friend activity yet. Follow some makers!</p></div>';
                return;
            }

            container.innerHTML = data.map(activity => `
                <div class="activity-item">
                    <div class="activity-avatar">${activity.avatar_initials}</div>
                    <div class="activity-content">
                        <div class="activity-text">
                            <strong>${activity.full_name}</strong> ${getActivityText(activity)}
                        </div>
                        <div class="activity-time">${getTimeAgo(activity.created_at)}</div>
                    </div>
                </div>
            `).join('');
        }

        async function loadTrendingProjects() {
            const { data } = await supabase.rpc('get_trending_projects', { limit_count: 5 });
            
            const container = document.getElementById('trending-projects');
            
            if (!data || data.length === 0) {
                container.innerHTML = '<p style="color: var(--text-muted); font-family: -apple-system, sans-serif;">No trending projects this week</p>';
                return;
            }

            container.innerHTML = data.map((project, idx) => `
                <div class="trending-item" onclick="alert('Project details coming soon!')">
                    <div class="trending-rank">${idx + 1}</div>
                    <div class="trending-info">
                        <div class="trending-title">${project.title}</div>
                        <div class="trending-author">by ${project.creator_name} ¬∑ ${project.likes_count} ‚ù§Ô∏è</div>
                    </div>
                </div>
            `).join('');
        }

        async function loadMyProjects() {
            const { data: projects } = await supabase
                .from('projects')
                .select('*')
                .eq('user_id', currentUser.id)
                .order('created_at', { ascending: false });

            const container = document.getElementById('my-projects-container');
            
            if (!projects || projects.length === 0) {
                container.innerHTML = '<div class="card"><div class="empty-state"><div class="empty-state-icon">üé®</div><p>No projects yet!</p><button class="btn btn-primary" style="margin-top: 1rem;" onclick="showAddProject()">Create Your First Project</button></div></div>';
                return;
            }

            container.innerHTML = `<div class="project-grid">${projects.map(project => createProjectCard(project, true)).join('')}</div>`;
        }

        async function loadCommunityFeed() {
            const { data: projects } = await supabase
                .from('projects')
                .select('*, profiles(full_name, avatar_initials)')
                .order('created_at', { ascending: false })
                .limit(20);

            const container = document.getElementById('community-feed');
            
            if (!projects || projects.length === 0) {
                container.innerHTML = '<div class="card"><div class="empty-state"><div class="empty-state-icon">üåä</div><p>No projects yet!</p></div></div>';
                return;
            }

            container.innerHTML = `<div class="project-grid">${projects.map(project => createProjectCard(project, false)).join('')}</div>`;
            
            // Check like status for each project
            projects.forEach(project => checkLikeStatus(project.id));
        }

        function createProjectCard(project, isOwner) {
            const creator = project.profiles || { full_name: 'You', avatar_initials: userProfile.avatar_initials };
            
            // Create brief craft details preview
            let craftPreview = '';
            if (project.craft_details && Object.keys(project.craft_details).length > 0) {
                const details = project.craft_details;
                if (project.craft_type === 'Crochet' && details.hook_size) {
                    craftPreview = ` ‚Ä¢ Hook: ${details.hook_size}`;
                } else if (project.craft_type === 'Knitting' && details.needle_size) {
                    craftPreview = ` ‚Ä¢ Needles: ${details.needle_size}`;
                } else if (project.craft_type === 'Sewing' && details.fabric_type) {
                    craftPreview = ` ‚Ä¢ ${details.fabric_type}`;
                }
            }
            
            return `
                <div class="project-card" onclick="showProjectDetails('${project.id}')">
                    <div class="project-image">
                        ${getCraftIcon(project.craft_type)}
                        ${!isOwner ? `<button class="like-btn" id="like-btn-${project.id}" onclick="toggleLike(event, '${project.id}')">ü§ç</button>` : ''}
                    </div>
                    <div class="project-info">
                        ${!isOwner ? `
                            <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem;">
                                <div style="width: 24px; height: 24px; border-radius: 50%; background: var(--terracotta); color: white; display: flex; align-items: center; justify-content: center; font-size: 0.7rem; font-weight: bold;">${creator.avatar_initials}</div>
                                <span style="font-size: 0.85rem; color: var(--text-muted); font-family: -apple-system, sans-serif;">${creator.full_name}</span>
                            </div>
                        ` : ''}
                        <h3 class="project-title">${project.title}</h3>
                        <p style="font-size: 0.85rem; color: var(--text-muted); font-family: -apple-system, sans-serif; margin-bottom: 0.5rem;">${project.craft_type}${craftPreview}</p>
                        <div class="project-meta">
                            <span>‚ù§Ô∏è ${project.likes_count || 0}</span>
                            <span>üí¨ ${project.comments_count || 0}</span>
                        </div>
                    </div>
                </div>
            `;
        }

        async function showProjectDetails(projectId) {
            const { data: project } = await supabase
                .from('projects')
                .select('*, profiles(full_name, avatar_initials)')
                .eq('id', projectId)
                .single();

            if (!project) return;

            const isOwner = project.user_id === currentUser.id;
            const craftDetailsHTML = displayCraftDetails(project.craft_type, project.craft_details);

            const modalHTML = `
                <div class="modal show" id="project-detail-temp" onclick="if(event.target === this) this.remove()">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h2>${project.title}</h2>
                            <button class="modal-close" onclick="document.getElementById('project-detail-temp').remove()">&times;</button>
                        </div>
                        
                        <div style="margin-bottom: 1rem;">
                            <div style="display: inline-block; padding: 0.5rem 1rem; background: var(--light-beige); border-radius: 20px; font-family: -apple-system, sans-serif; font-size: 0.9rem;">
                                ${getCraftIcon(project.craft_type)} ${project.craft_type}
                            </div>
                        </div>

                        <div style="display: flex; align-items: center; gap: 1rem; margin-bottom: 2rem; padding-bottom: 1rem; border-bottom: 2px solid var(--light-beige);">
                            <div style="width: 48px; height: 48px; border-radius: 50%; background: var(--terracotta); color: white; display: flex; align-items: center; justify-content: center; font-size: 1.25rem; font-weight: bold;">${project.profiles.avatar_initials}</div>
                            <div>
                                <div style="font-weight: 600;">${project.profiles.full_name}</div>
                                <div style="font-size: 0.85rem; color: var(--text-muted); font-family: -apple-system, sans-serif;">Posted ${getTimeAgo(project.created_at)}</div>
                            </div>
                        </div>

                        <div style="margin-bottom: 2rem;">
                            <h3 style="margin-bottom: 0.75rem;">About This Project</h3>
                            <p style="font-family: -apple-system, sans-serif; line-height: 1.6;">${project.description || 'No description provided.'}</p>
                        </div>

                        ${craftDetailsHTML}

                        <div style="margin-top: 2rem; padding-top: 2rem; border-top: 2px solid var(--light-beige); display: flex; gap: 2rem; font-family: -apple-system, sans-serif; color: var(--text-muted);">
                            <span>‚ù§Ô∏è ${project.likes_count || 0} likes</span>
                            <span>üí¨ ${project.comments_count || 0} comments</span>
                            <span>üëÅÔ∏è ${project.views_count || 0} views</span>
                        </div>

                        ${!isOwner ? `
                            <button class="btn btn-primary" style="width: 100%; margin-top: 1.5rem;" onclick="toggleLike(event, '${project.id}'); setTimeout(() => document.getElementById('project-detail-temp').remove(), 500);" id="detail-like-btn-${project.id}">
                                Like This Project ‚ù§Ô∏è
                            </button>
                        ` : ''}
                    </div>
                </div>
            `;

            document.body.insertAdjacentHTML('beforeend', modalHTML);
            
            // Check like status
            if (!isOwner) {
                const { data } = await supabase
                    .from('likes')
                    .select('id')
                    .eq('project_id', projectId)
                    .eq('user_id', currentUser.id)
                    .single();

                const btn = document.getElementById(`detail-like-btn-${project.id}`);
                if (btn && data) {
                    btn.textContent = 'Unlike ‚ù§Ô∏è';
                }
            }
        }

        async function checkLikeStatus(projectId) {
            const { data } = await supabase
                .from('likes')
                .select('id')
                .eq('project_id', projectId)
                .eq('user_id', currentUser.id)
                .single();

            const btn = document.getElementById(`like-btn-${projectId}`);
            if (btn && data) {
                btn.textContent = '‚ù§Ô∏è';
                btn.classList.add('liked');
            }
        }

        async function toggleLike(event, projectId) {
            event.stopPropagation();
            
            const btn = document.getElementById(`like-btn-${projectId}`);
            const isLiked = btn.classList.contains('liked');

            if (isLiked) {
                await supabase.from('likes').delete().eq('project_id', projectId).eq('user_id', currentUser.id);
                btn.textContent = 'ü§ç';
                btn.classList.remove('liked');
            } else {
                await supabase.from('likes').insert({ project_id: projectId, user_id: currentUser.id });
                btn.textContent = '‚ù§Ô∏è';
                btn.classList.add('liked');
                btn.classList.add('liked');
                setTimeout(() => btn.classList.remove('liked'), 500);
            }

            loadCommunityFeed();
            loadTrendingProjects();
        }

        async function loadFriends() {
            const { data: friendData } = await supabase
                .from('friends')
                .select('user1_id, user2_id, profiles!friends_user1_id_fkey(full_name, avatar_initials, projects_count), profiles!friends_user2_id_fkey(full_name, avatar_initials, projects_count)')
                .or(`user1_id.eq.${currentUser.id},user2_id.eq.${currentUser.id}`);

            const container = document.getElementById('friends-container');
            
            if (!friendData || friendData.length === 0) {
                container.innerHTML = '<div class="card"><div class="empty-state"><div class="empty-state-icon">üí´</div><p>No friends yet! Follow someone back to become friends.</p></div></div>';
                return;
            }

            const friends = friendData.map(f => {
                if (f.user1_id === currentUser.id) {
                    return { ...f.profiles, id: f.user2_id };
                } else {
                    return { ...f.profiles, id: f.user1_id };
                }
            });

            container.innerHTML = `
                <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 1.5rem;">
                    ${friends.map(friend => `
                        <div class="card" style="text-align: center;">
                            <div style="width: 80px; height: 80px; border-radius: 50%; background: var(--terracotta); margin: 0 auto 1rem; display: flex; align-items: center; justify-content: center; color: white; font-size: 2rem; font-weight: bold;">${friend.avatar_initials}</div>
                            <h3 style="margin-bottom: 0.5rem;">${friend.full_name}</h3>
                            <p style="color: var(--text-muted); font-family: -apple-system, sans-serif; margin-bottom: 1rem;">üé® ${friend.projects_count || 0} projects</p>
                            <div style="display: flex; gap: 0.5rem;">
                                <button class="btn btn-primary btn-small" style="flex: 1;" onclick="openChat('${friend.id}')">üí¨ Message</button>
                                <button class="btn btn-primary btn-small" onclick="showKudos('${friend.id}')">üéâ</button>
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;
        }

        async function loadMembers() {
            const { data: members } = await supabase
                .from('profiles')
                .select('*')
                .neq('id', currentUser.id)
                .order('created_at', { ascending: false });

            allMembers = members || [];
            displayMembers(allMembers);
        }

        function displayMembers(members) {
            const container = document.getElementById('members-container');
            
            if (!members || members.length === 0) {
                container.innerHTML = '<div class="card"><div class="empty-state"><p>No other members yet</p></div></div>';
                return;
            }

            container.innerHTML = `
                <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 1.5rem;">
                    ${members.map(member => `
                        <div class="card" style="text-align: center;">
                            <div style="width: 80px; height: 80px; border-radius: 50%; background: var(--terracotta); margin: 0 auto 1rem; display: flex; align-items: center; justify-content: center; color: white; font-size: 2rem; font-weight: bold;">${member.avatar_initials}</div>
                            <h3 style="margin-bottom: 0.5rem;">${member.full_name}</h3>
                            <p style="color: var(--text-muted); font-family: -apple-system, sans-serif; margin-bottom: 1rem;">${member.location || 'Location not set'}</p>
                            <button class="btn btn-primary btn-small" style="width: 100%;" onclick="toggleFollow('${member.id}')" id="follow-btn-${member.id}">Follow</button>
                        </div>
                    `).join('')}
                </div>
            `;

            members.forEach(member => checkFollowStatus(member.id));
        }

        function searchMembers() {
            const query = document.getElementById('member-search').value.toLowerCase();
            const filtered = allMembers.filter(m => m.full_name.toLowerCase().includes(query));
            displayMembers(filtered);
        }

        async function checkFollowStatus(userId) {
            const { data } = await supabase
                .from('follows')
                .select('id')
                .eq('follower_id', currentUser.id)
                .eq('following_id', userId)
                .single();

            const btn = document.getElementById(`follow-btn-${userId}`);
            if (btn) {
                btn.textContent = data ? 'Following' : 'Follow';
                btn.className = data ? 'btn btn-small' : 'btn btn-primary btn-small';
            }
        }

        async function toggleFollow(userId) {
            const { data: existing } = await supabase
                .from('follows')
                .select('id')
                .eq('follower_id', currentUser.id)
                .eq('following_id', userId)
                .single();

            if (existing) {
                await supabase.from('follows').delete().eq('id', existing.id);
            } else {
                await supabase.from('follows').insert({
                    follower_id: currentUser.id,
                    following_id: userId
                });
            }

            checkFollowStatus(userId);
            loadFriends();
            loadQuickStats();
        }

        async function loadNotifications() {
            const { data: notifs } = await supabase
                .from('notifications')
                .select('*, profiles(full_name, avatar_initials)')
                .eq('user_id', currentUser.id)
                .order('created_at', { ascending: false})
                .limit(20);

            const unreadCount = notifs?.filter(n => !n.is_read).length || 0;
            const badge = document.getElementById('notif-count');
            if (unreadCount > 0) {
                badge.textContent = unreadCount;
                badge.style.display = 'flex';
            } else {
                badge.style.display = 'none';
            }

            const container = document.getElementById('notifications-list');
            
            if (!notifs || notifs.length === 0) {
                container.innerHTML = '<div class="dropdown-item">No notifications yet</div>';
                return;
            }

            container.innerHTML = notifs.map(notif => `
                <div class="dropdown-item ${!notif.is_read ? 'notif-unread' : ''}">
                    <div class="notif-content">${notif.content}</div>
                    <div class="notif-time">${getTimeAgo(notif.created_at)}</div>
                </div>
            `).join('');
        }

        async function markAllRead() {
            await supabase.rpc('mark_notifications_read', { user_uuid: currentUser.id });
            loadNotifications();
        }

        async function loadConversations() {
            // Get all friends
            const { data: friendData } = await supabase
                .from('friends')
                .select('user1_id, user2_id')
                .or(`user1_id.eq.${currentUser.id},user2_id.eq.${currentUser.id}`);

            if (!friendData || friendData.length === 0) {
                document.getElementById('conversations-list').innerHTML = '<li class="dropdown-item">No conversations yet. Message your friends!</li>';
                document.getElementById('chat-area').innerHTML = '<div class="card"><div class="empty-state"><p>No friends to chat with yet!</p></div></div>';
                return;
            }

            // Get latest message with each friend
            const conversations = [];
            for (const friend of friendData) {
                const friendId = friend.user1_id === currentUser.id ? friend.user2_id : friend.user1_id;
                
                const { data: lastMsg } = await supabase
                    .from('messages')
                    .select('*, profiles(full_name, avatar_initials)')
                    .or(`and(sender_id.eq.${currentUser.id},receiver_id.eq.${friendId}),and(sender_id.eq.${friendId},receiver_id.eq.${currentUser.id})`)
                    .order('created_at', { ascending: false })
                    .limit(1)
                    .single();

                const { data: profile } = await supabase
                    .from('profiles')
                    .select('*')
                    .eq('id', friendId)
                    .single();

                conversations.push({
                    friendId,
                    profile,
                    lastMsg
                });
            }

            // Message count
            const { data: unreadMsgs } = await supabase
                .from('messages')
                .select('id')
                .eq('receiver_id', currentUser.id)
                .eq('is_read', false);

            const unreadCount = unreadMsgs?.length || 0;
            const badge = document.getElementById('message-count');
            if (unreadCount > 0) {
                badge.textContent = unreadCount;
                badge.style.display = 'flex';
            } else {
                badge.style.display = 'none';
            }

            // Dropdown
            const dropdown = document.getElementById('conversations-list');
            dropdown.innerHTML = conversations.map(conv => `
                <li class="message-item" onclick="openChat('${conv.friendId}')">
                    <div style="width: 40px; height: 40px; border-radius: 50%; background: var(--terracotta); color: white; display: flex; align-items: center; justify-content: center; font-weight: bold;">${conv.profile.avatar_initials}</div>
                    <div style="flex: 1;">
                        <div style="font-weight: 600;">${conv.profile.full_name}</div>
                        <div style="font-size: 0.85rem; color: var(--text-muted);">${conv.lastMsg?.content.substring(0, 30) || 'Start chatting...'}</div>
                    </div>
                </li>
            `).join('');

            // Chat area
            document.getElementById('chat-area').innerHTML = `
                <div class="card">
                    <h3>Select a friend to start chatting</h3>
                    <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 1rem; margin-top: 1rem;">
                        ${conversations.map(conv => `
                            <div onclick="openChat('${conv.friendId}')" style="text-align: center; padding: 1rem; background: var(--cream); border-radius: 8px; cursor: pointer; transition: all 0.3s;">
                                <div style="width: 60px; height: 60px; border-radius: 50%; background: var(--terracotta); color: white; display: flex; align-items: center; justify-content: center; font-size: 1.5rem; font-weight: bold; margin: 0 auto 0.5rem;">${conv.profile.avatar_initials}</div>
                                <div style="font-family: -apple-system, sans-serif; font-size: 0.9rem;">${conv.profile.full_name}</div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
        }

        async function openChat(friendId) {
            const { data: friend } = await supabase
                .from('profiles')
                .select('*')
                .eq('id', friendId)
                .single();

            const { data: messages } = await supabase
                .from('messages')
                .select('*')
                .or(`and(sender_id.eq.${currentUser.id},receiver_id.eq.${friendId}),and(sender_id.eq.${friendId},receiver_id.eq.${currentUser.id})`)
                .order('created_at', { ascending: true });

            // Mark messages as read
            await supabase
                .from('messages')
                .update({ is_read: true })
                .eq('receiver_id', currentUser.id)
                .eq('sender_id', friendId);

            document.getElementById('chat-area').innerHTML = `
                <div class="chat-container">
                    <div class="chat-header">
                        <div>
                            <div style="font-weight: 600;">${friend.full_name}</div>
                            <div style="font-size: 0.85rem; opacity: 0.9;">Friend</div>
                        </div>
                        <button onclick="loadConversations()" style="background: none; border: none; color: white; cursor: pointer; font-size: 1.5rem;">&times;</button>
                    </div>
                    <div class="chat-messages" id="chat-messages">
                        ${messages?.map(msg => `
                            <div class="chat-message ${msg.sender_id === currentUser.id ? 'sent' : 'received'}">
                                <div class="chat-bubble">${msg.content}</div>
                            </div>
                        `).join('') || '<p style="text-align: center; color: var(--text-muted);">No messages yet. Say hi!</p>'}
                    </div>
                    <div class="chat-input-area">
                        <input type="text" id="chat-input" placeholder="Type a message..." onkeypress="if(event.key==='Enter') sendMessage('${friendId}')">
                        <button onclick="sendMessage('${friendId}')">Send</button>
                    </div>
                </div>
            `;

            document.getElementById('chat-messages').scrollTop = 999999;
            showSection('chat');
            hideAllDropdowns();
        }

        async function sendMessage(friendId) {
            const input = document.getElementById('chat-input');
            const content = input.value.trim();
            if (!content) return;

            await supabase.from('messages').insert({
                sender_id: currentUser.id,
                receiver_id: friendId,
                content: content
            });

            input.value = '';
            openChat(friendId);
        }

        function showKudos(userId) {
            selectedKudosUser = userId;
            document.getElementById('kudos-modal').classList.add('show');
        }

        function closeKudos() {
            document.getElementById('kudos-modal').classList.remove('show');
            document.getElementById('kudos-message').value = '';
        }

        function selectEmoji(emoji) {
            selectedKudosEmoji = emoji;
        }

        async function sendKudos() {
            const message = document.getElementById('kudos-message').value.trim();
            
            await supabase.from('kudos').insert({
                from_user_id: currentUser.id,
                to_user_id: selectedKudosUser,
                emoji: selectedKudosEmoji,
                message: message || null
            });

            closeKudos();
            alert('Kudos sent! üéâ');
        }

        function showAddProject() {
            document.getElementById('add-project-modal').classList.add('show');
        }

        function closeAddProject() {
            document.getElementById('add-project-modal').classList.remove('show');
            // Reset form and hide all craft fields
            document.querySelectorAll('.craft-specific-fields').forEach(el => el.style.display = 'none');
        }

        function showCraftFields() {
            const craftType = document.getElementById('project-craft-type').value;
            
            // Hide all craft-specific fields
            document.querySelectorAll('.craft-specific-fields').forEach(el => {
                el.style.display = 'none';
            });

            // Show relevant fields based on craft type
            const fieldMap = {
                'Crochet': 'crochet-fields',
                'Knitting': 'knitting-fields',
                'Sewing': 'sewing-fields',
                'Embroidery': 'embroidery-fields',
                'Weaving': 'weaving-fields',
                'Quilting': 'quilting-fields',
                'Leather Work': 'leather-fields'
            };

            const fieldId = fieldMap[craftType];
            if (fieldId) {
                document.getElementById(fieldId).style.display = 'block';
            }
        }

        function getCraftDetails(craftType) {
            const details = {};

            if (craftType === 'Crochet') {
                details.hook_size = document.getElementById('crochet-hook-size').value;
                details.yarn_weight = document.getElementById('crochet-yarn-weight').value;
                details.yarn_brand = document.getElementById('crochet-yarn-brand').value;
                details.yarn_color = document.getElementById('crochet-yarn-color').value;
                details.yardage = document.getElementById('crochet-yardage').value;
                details.gauge = document.getElementById('crochet-gauge').value;
                details.yarn_link = document.getElementById('crochet-yarn-link').value;
                details.pattern_link = document.getElementById('crochet-pattern-link').value;
            } else if (craftType === 'Knitting') {
                details.needle_size = document.getElementById('knitting-needle-size').value;
                details.needle_type = document.getElementById('knitting-needle-type').value;
                details.yarn_weight = document.getElementById('knitting-yarn-weight').value;
                details.yarn_brand = document.getElementById('knitting-yarn-brand').value;
                details.yardage = document.getElementById('knitting-yardage').value;
                details.yarn_link = document.getElementById('knitting-yarn-link').value;
            } else if (craftType === 'Sewing') {
                details.needle_type = document.getElementById('sewing-needle-type').value;
                details.fabric_type = document.getElementById('sewing-fabric-type').value;
                details.fabric_amount = document.getElementById('sewing-fabric-amount').value;
                details.fabric_brand = document.getElementById('sewing-fabric-brand').value;
                details.notions = document.getElementById('sewing-notions').value;
                details.pattern_size = document.getElementById('sewing-pattern-size').value;
                details.fabric_link = document.getElementById('sewing-fabric-link').value;
                details.pattern_link = document.getElementById('sewing-pattern-link').value;
            } else if (craftType === 'Embroidery') {
                details.thread_type = document.getElementById('embroidery-thread-type').value;
                details.thread_colors = document.getElementById('embroidery-thread-colors').value;
                details.fabric_type = document.getElementById('embroidery-fabric-type').value;
                details.hoop_size = document.getElementById('embroidery-hoop-size').value;
                details.supplies_link = document.getElementById('embroidery-supplies-link').value;
            } else if (craftType === 'Weaving') {
                details.loom_type = document.getElementById('weaving-loom-type').value;
                details.yarn_type = document.getElementById('weaving-yarn-type').value;
                details.reed_size = document.getElementById('weaving-reed-size').value;
                details.width = document.getElementById('weaving-width').value;
                details.length = document.getElementById('weaving-length').value;
                details.supplies_link = document.getElementById('weaving-supplies-link').value;
            } else if (craftType === 'Quilting') {
                details.quilt_size = document.getElementById('quilting-quilt-size').value;
                details.fabric_collection = document.getElementById('quilting-fabric-collection').value;
                details.batting_type = document.getElementById('quilting-batting-type').value;
                details.fabric_link = document.getElementById('quilting-fabric-link').value;
            } else if (craftType === 'Leather Work') {
                details.leather_type = document.getElementById('leather-leather-type').value;
                details.leather_weight = document.getElementById('leather-leather-weight').value;
                details.thread_type = document.getElementById('leather-thread-type').value;
                details.needle_size = document.getElementById('leather-needle-size').value;
                details.hardware = document.getElementById('leather-hardware').value;
                details.supplies_link = document.getElementById('leather-supplies-link').value;
            }

            // Remove empty fields
            Object.keys(details).forEach(key => {
                if (!details[key]) delete details[key];
            });

            return details;
        }

        async function handleAddProject(event) {
            event.preventDefault();
            
            const craftType = document.getElementById('project-craft-type').value;
            const craftDetails = getCraftDetails(craftType);

            await supabase.from('projects').insert({
                user_id: currentUser.id,
                title: document.getElementById('project-title').value,
                description: document.getElementById('project-description').value,
                craft_type: craftType,
                status: 'in_progress',
                craft_details: craftDetails
            });

            await supabase.from('profiles').update({ 
                projects_count: userProfile.projects_count + 1 
            }).eq('id', currentUser.id);

            await supabase.rpc('award_xp', { user_uuid: currentUser.id, xp_amount: 50 });

            closeAddProject();
            event.target.reset();
            await loadUserData();
        }

        function startRealtimeUpdates() {
            // Listen for new notifications
            supabase
                .channel('notifications')
                .on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'notifications', filter: `user_id=eq.${currentUser.id}` }, () => {
                    loadNotifications();
                })
                .subscribe();

            // Listen for new messages
            supabase
                .channel('messages')
                .on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'messages', filter: `receiver_id=eq.${currentUser.id}` }, () => {
                    loadConversations();
                })
                .subscribe();
        }

        function toggleNotifications() {
            hideAllDropdowns();
            document.getElementById('notifications-dropdown').classList.toggle('show');
        }

        function toggleMessages() {
            hideAllDropdowns();
            document.getElementById('messages-dropdown').classList.toggle('show');
        }

        function toggleUserMenu() {
            hideAllDropdowns();
            document.getElementById('user-menu').classList.toggle('show');
        }

        function hideAllDropdowns() {
            document.querySelectorAll('.dropdown').forEach(d => d.classList.remove('show'));
        }

        function showSection(sectionId) {
            document.querySelectorAll('.content-section').forEach(s => s.classList.remove('active'));
            document.getElementById(sectionId).classList.add('active');
            document.querySelectorAll('.nav-item').forEach(item => item.classList.remove('active'));
            event.target.classList.add('active');
        }

        async function handleLogout() {
            await supabase.auth.signOut();
            window.location.href = 'login.html';
        }

        function displayCraftDetails(craftType, craftDetails) {
            if (!craftDetails || Object.keys(craftDetails).length === 0) {
                return '';
            }

            let html = '<div style="background: var(--cream); padding: 1.5rem; border-radius: 12px; margin-top: 2rem;"><h3 style="margin-bottom: 1rem; color: var(--terracotta);">üìù Project Details</h3>';

            const formatLabel = (key) => {
                return key.split('_').map(word => word.charAt(0).toUpperCase() + word.slice(1)).join(' ');
            };

            const renderField = (label, value) => {
                if (!value) return '';
                
                // Check if it's a link
                if (value.startsWith('http://') || value.startsWith('https://')) {
                    return `
                        <div style="margin-bottom: 0.75rem;">
                            <strong style="color: var(--dark-brown); font-family: -apple-system, sans-serif; font-size: 0.9rem;">${label}:</strong>
                            <a href="${value}" target="_blank" style="color: var(--terracotta); text-decoration: none; font-family: -apple-system, sans-serif; margin-left: 0.5rem;">üîó View Link</a>
                        </div>
                    `;
                }
                
                return `
                    <div style="margin-bottom: 0.75rem;">
                        <strong style="color: var(--dark-brown); font-family: -apple-system, sans-serif; font-size: 0.9rem;">${label}:</strong>
                        <span style="font-family: -apple-system, sans-serif; margin-left: 0.5rem;">${value}</span>
                    </div>
                `;
            };

            // Render all fields
            Object.keys(craftDetails).forEach(key => {
                const label = formatLabel(key);
                html += renderField(label, craftDetails[key]);
            });

            html += '</div>';
            return html;
        }

        function getCraftIcon(craftType) {
            const icons = { 'Sewing': 'üßµ', 'Knitting': 'üß∂', 'Crochet': 'ü™°', 'Weaving': 'üßµ', 'Other': 'üé®' };
            return icons[craftType] || 'üé®';
        }

        function getActivityText(activity) {
            switch (activity.activity_type) {
                case 'project_completed': return 'completed a project';
                case 'project_liked': return 'liked a project';
                default: return 'did something awesome';
            }
        }

        function getTimeAgo(timestamp) {
            const now = new Date();
            const past = new Date(timestamp);
            const diffMs = now - past;
            const diffMins = Math.floor(diffMs / 60000);
            const diffHours = Math.floor(diffMs / 3600000);
            const diffDays = Math.floor(diffMs / 86400000);

            if (diffMins < 1) return 'Just now';
            if (diffMins < 60) return `${diffMins}m ago`;
            if (diffHours < 24) return `${diffHours}h ago`;
            return `${diffDays}d ago`;
        }

        document.addEventListener('click', function(event) {
            if (!event.target.closest('.icon-btn') && !event.target.closest('.user-profile') && !event.target.closest('.dropdown')) {
                hideAllDropdowns();
            }
        });

        checkAuth();
    </script>
</body>
</html>